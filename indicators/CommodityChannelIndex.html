<!DOCTYPE html>
<html lang="ja" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CommodityChannelIndex - I ant I Investigates</title>
    <meta name="description" content="">
    <meta name="keywords" content="">
    <!-- Structured Data for SEO -->
    <script type="application/ld+json">
        {
    "@context": "https://schema.org",
    "@type": "TechArticle",
    "headline": "CommodityChannelIndex",
    "description": "Detailed guide for CommodityChannelIndex indicator.",
    "author": {
        "@type": "Organization",
        "name": "I and I Investigates"
    }
}
    </script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- Styles -->
    <!-- Styles -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <link rel="stylesheet" href="../../assets/css/style.css">
    <!-- KaTeX (Math) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>

    <style>
        /* =========================================
           PORTED STYLES (From 0117 Template)
           ========================================= */
        :root {
            /* Minimal Variable Set for Logic Panel */
            --bg-card: #FFFFFF;
            --bg-secondary: #F8FAFC; /* slate-50 */
            --bg-hover: #F1F5F9; /* slate-100 */
            --border-color: #E2E8F0; /* slate-200 */
            --text-primary: #1E293B; /* slate-800 */
            --text-muted: #64748B; /* slate-500 */
            --accent: #4F46E5; /* indigo-600 */
        }

        /* Logic Figure Container */
        .logic-figure {
            margin: 0;
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            position: relative;
            overflow: hidden;
            height: 600px; /* Fixed height for infinite canvas feel */
        }

        /* Infinite Canvas Wrapper */
        .chart-scroll-wrapper {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
            background-color: #FFFFFF;
            background-image: radial-gradient(#E2E8F0 1.5px, transparent 1.5px);
            background-size: 20px 20px;
            cursor: grab;
            touch-action: none;
            user-select: none;
        }
        .chart-scroll-wrapper:active { cursor: grabbing; }

        /* Code Panel Overlay */
        #code-panel-overlay {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            width: 500px;
            max-width: 90%;
            z-index: 30;
            background-color: var(--bg-card);
            border-right: 1px solid var(--border-color);
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), width 0.3s ease;
            transform: translateX(0);
        }
        #code-panel-overlay.panel-hidden {
            transform: translateX(-100%);
            pointer-events: none;
        }
        #code-panel-overlay.panel-expanded {
            width: 100%;
            max-width: 100%;
        }

        /* Code Content */
        .code-panel-body {
            background-color: #FAFAFA;
            flex: 1;
            overflow: auto;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            padding: 0.5rem 1rem 1rem 1rem; /* Reduced top padding */
            white-space: pre; /* Essential for code indentation */
        }
        .code-content {
            font-family: 'Roboto Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            padding: 1rem;
        }
        /* Toggle Button */
        #code-panel-toggle-btn {
            position: absolute;
            top: 1rem;
            left: 1rem;
            z-index: 25;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.5rem;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }
        #code-panel-toggle-btn:hover {
            color: var(--accent);
            border-color: var(--accent);
        }

        /* Active States for Panel Buttons */
        .btn-lang-active {
            background-color: var(--accent) !important;
            color: white !important;
        }
        .btn-type-active {
            color: var(--text-primary) !important;
            font-weight: bold;
            text-decoration: underline;
            text-decoration-color: var(--accent);
            text-decoration-thickness: 2px;
        }

        /* Custom Scrollbar for Code Blocks */
        pre::-webkit-scrollbar, .code-panel-body::-webkit-scrollbar {
            height: 8px; width: 8px;
            background-color: #f1f5f9;
        }
        pre::-webkit-scrollbar-thumb, .code-panel-body::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        pre::-webkit-scrollbar-thumb:hover, .code-panel-body::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8;
        }

        /* Pygments Syntax Highlighting */
        pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.highlight .hll { background-color: #ffffcc }
.highlight .c { color: #008000 } /* Comment */
.highlight .err { border: 1px solid #F00 } /* Error */
.highlight .k { color: #00F } /* Keyword */
.highlight .ch { color: #008000 } /* Comment.Hashbang */
.highlight .cm { color: #008000 } /* Comment.Multiline */
.highlight .cp { color: #00F } /* Comment.Preproc */
.highlight .cpf { color: #008000 } /* Comment.PreprocFile */
.highlight .c1 { color: #008000 } /* Comment.Single */
.highlight .cs { color: #008000 } /* Comment.Special */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
.highlight .gh { font-weight: bold } /* Generic.Heading */
.highlight .gp { font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { font-weight: bold } /* Generic.Subheading */
.highlight .kc { color: #00F } /* Keyword.Constant */
.highlight .kd { color: #00F } /* Keyword.Declaration */
.highlight .kn { color: #00F } /* Keyword.Namespace */
.highlight .kp { color: #00F } /* Keyword.Pseudo */
.highlight .kr { color: #00F } /* Keyword.Reserved */
.highlight .kt { color: #2B91AF } /* Keyword.Type */
.highlight .s { color: #A31515 } /* Literal.String */
.highlight .nc { color: #2B91AF } /* Name.Class */
.highlight .ow { color: #00F } /* Operator.Word */
.highlight .sa { color: #A31515 } /* Literal.String.Affix */
.highlight .sb { color: #A31515 } /* Literal.String.Backtick */
.highlight .sc { color: #A31515 } /* Literal.String.Char */
.highlight .dl { color: #A31515 } /* Literal.String.Delimiter */
.highlight .sd { color: #A31515 } /* Literal.String.Doc */
.highlight .s2 { color: #A31515 } /* Literal.String.Double */
.highlight .se { color: #A31515 } /* Literal.String.Escape */
.highlight .sh { color: #A31515 } /* Literal.String.Heredoc */
.highlight .si { color: #A31515 } /* Literal.String.Interpol */
.highlight .sx { color: #A31515 } /* Literal.String.Other */
.highlight .sr { color: #A31515 } /* Literal.String.Regex */
.highlight .s1 { color: #A31515 } /* Literal.String.Single */
.highlight .ss { color: #A31515 } /* Literal.String.Symbol */
        /* Mermaid Overrides */
        .mermaid { transform-origin: 0 0; }
        .noselect { user-select: none; -webkit-user-select: none; }

        /* Legend Items */
        .logic-legend {
            border-top: 1px solid var(--border-color);
            padding: 1rem;
            background-color: var(--bg-card);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1.5rem;
            position: relative;
            z-index: 20;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: 500;
        }
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 1px solid;
        }
        .l-ingestion { background: #E8F0FE; border-color: #4285F4; }
        .l-evaluation { background: #FEF7E0; border-color: #FBBC04; }
        .l-weighting { background: #F3E8FD; border-color: #A142F4; }
        .l-synthesis { background: #E0F7FA; border-color: #12B5CB; }
        .l-outcome { background: #E6F4EA; border-color: #34A853; }

        /* TOC Active State Styling */
        .toc-link.active {
            color: #4f46e5;
            border-left-color: #4f46e5;
            background-color: #eef2ff;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans antialiased relative">

    <!-- Navigation -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center mr-6">
                        <a href="../index.html" class="font-bold text-xl text-indigo-600">
                            I ant I Investigates
                        </a>
                    </div>
                    <!-- Breadcrumbs (Moved Here) -->
                    <nav class="hidden md:flex text-sm text-slate-500 mr-8" aria-label="Breadcrumb">
                        <ol class="flex items-center space-x-2">
                            <li><a href="../index.html" class="hover:text-indigo-600 transition-colors">home</a></li>
                            <li><span class="mx-1">/</span></li>
                            <li><a href="./" class="hover:text-indigo-600 transition-colors">indicators</a></li>
                            <li><span class="mx-1">/</span></li>
                            <li><span class="font-medium text-slate-900">CommodityChannelIndex</span></li>
                        </ol>
                    </nav>

                    <!-- Page Top Nav (Anchor Links) -->
                    <div class="hidden sm:flex sm:space-x-4 items-center">
                        <a href="#interactive-playground" class="text-slate-600 hover:text-indigo-600 px-3 py-2 text-sm font-medium transition-colors">
                            Chart
                        </a>
                        <a href="#logic-visualization" class="text-slate-600 hover:text-indigo-600 px-3 py-2 text-sm font-medium transition-colors">
                            Logic
                        </a>
                        <a href="#documentation" class="text-slate-600 hover:text-indigo-600 px-3 py-2 text-sm font-medium transition-colors">
                            Docs
                        </a>
                    </div>
                </div>
                <!-- External Links Placeholder -->
                <div class="hidden sm:flex items-center">
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Container: 1-Column Stack -->
    <div class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-12">
        <!-- ======================================================= -->
        <!-- TOP SECTION: CONTEXT & PLAYGROUND                       -->
        <!-- ======================================================= -->
        <div class="flex flex-col gap-6">
            <!-- Hero Header -->
            <header>
                <h1 class="text-3xl md:text-4xl font-bold text-slate-900 mb-4 leading-tight">CommodityChannelIndex</h1>
                <p class="text-lg text-slate-600 leading-relaxed">The Commodity Channel Index measures how far the current Typical Price has deviated from its average—breaking above +100 signals an impulse breakout, while readings inside ±100 represent statistical "noise."</p>
            </header>

            <!-- Interactive Playground -->
            <section id="interactive-playground" class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden scroll-mt-24">
                <div class="border-b border-slate-200 bg-indigo-50 px-6 py-4">
                    <h2 class="text-lg font-bold text-slate-800 flex items-center">
                        <span class="bg-indigo-600 text-white p-1 rounded mr-3 text-xs shadow-sm font-mono">C</span>
                        Calculator
                    </h2>
                    <p class="text-sm text-slate-600 mt-2">Calculate indicator values from your price data.</p>
                </div>
                <div class="p-6">
                    <!-- Chart Area -->
                    <div class="relative h-[400px] w-full mb-6 border border-slate-100 rounded bg-slate-50">
                        <canvas id="indicatorChart"></canvas>
                    </div>

                    <!-- Controls Area -->
                    <div id="controls" class="grid grid-cols-1 md:grid-cols-3 gap-6 bg-slate-50 p-4 rounded border border-slate-200">
                        <!-- Parameters -->
                        <div class="md:col-span-1 space-y-4">
                            <h3 class="font-bold text-sm text-slate-700 uppercase tracking-wide border-b border-slate-200 pb-2">Parameters</h3>
                            <div id="settings-container">
                                <div class="space-y-3">
                                    <!-- Dynamic settings will be injected here -->
                                </div>
                            </div>
                            <button id="btn-run" onclick="PlaygroundController.update()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded transition-colors shadow-sm flex items-center justify-center">
                                Calculate
                            </button>
                        </div>

                        <!-- Data I/O -->
                        <div class="md:col-span-2 space-y-4">
                            <!-- Input -->
                            <div class="space-y-2">
                                <div class="flex justify-between items-center pb-2 border-b border-slate-200">
                                    <h3 class="font-bold text-sm text-slate-700 uppercase tracking-wide">Input Data (CSV)</h3>
                                    <div class="flex space-x-2">
                                        <button id="btn-load-sample-ohlcv" class="text-xs text-indigo-600 hover:text-indigo-800 hover:underline transition-colors" title="Load OHLCV Sample Data">Shape (OHLCV)</button>
                                        <span class="text-slate-300">|</span>
                                        <button id="btn-load-sample-single" class="text-xs text-indigo-600 hover:text-indigo-800 hover:underline transition-colors" title="Load Single Value Sample Data">Single</button>
                                    </div>
                                </div>
                                <p class="text-xs text-slate-500">Enter CSV data (Date,Open,High,Low,Close,Volume) or single values.</p>
                                <textarea id="input-data" class="w-full h-24 p-2 text-xs font-mono border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 transition-shadow" placeholder="e.g. 100.5, 101.2, 99.8, 102.3, 103.1...

or one per line:
100.5
101.2
99.8"></textarea>
                            </div>
                            <!-- Output (Enabled) -->
                            <div class="space-y-2">
                                <div class="flex justify-between items-center pb-2 border-b border-slate-200">
                                    <h3 class="font-bold text-sm text-slate-700 uppercase tracking-wide">Output Data (Result)</h3>
                                </div>
                                <textarea id="output-data" class="w-full h-24 p-2 text-xs font-mono border border-slate-300 rounded bg-slate-100 text-slate-600" readonly placeholder="Calculation results will appear here..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- ======================================================= -->
        <!-- MIDDLE SECTION: LOGIC & ARCHITECTURE (PORTED FROM 0117) -->
        <!-- ======================================================= -->
        <section id="logic-visualization" class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden scroll-mt-24">
            <!-- Section Header (Styled like Playground) -->
            <div class="border-b border-slate-200 bg-emerald-50 px-6 py-4">
                <h2 class="text-lg font-bold text-slate-800 flex items-center">
                    <span class="bg-emerald-600 text-white p-1 rounded mr-3 text-xs shadow-sm font-mono">L</span>
                    Logic & Code Architecture
                </h2>
                <p class="text-sm text-slate-600 mt-2">Visual flowchart showing how the indicator processes data.</p>
            </div>

            <!-- LOGIC FIGURE STRUCTURE -->
            <figure class="logic-figure" style="border: none; border-radius: 0;">
                <!-- 1. Code Panel Toggle Button -->
                <button id="code-panel-toggle-btn" onclick="toggleCodePanel()" title="View Source Code" class="font-bold text-xs">
                    CODE
                </button>

                <!-- 2. Infinite Canvas Layer -->
                <div id="canvas-container" class="chart-scroll-wrapper">
                    <div id="canvas-content" class="mermaid" style="position: absolute; top:0; left:0;">
                        flowchart TD;
subgraph INGESTION["Phase 1: Ingestion"];
A[/"Receive Price Data"/];
B["Calculate Typical Price Each Bar"];
end;
subgraph EVALUATION["Phase 2: Evaluation"];
C["Establish Historical Average"];
D["Measure Normal Price Variation"];
E{"Sufficient History?"};
end;
subgraph WEIGHTING["Phase 3: Weighting"];
F["Calculate Current Deviation"];
G["Normalize by Typical Variation"];
end;
subgraph SYNTHESIS["Phase 4: Synthesis"];
H["Scale to Standard Range"];
I["Identify Statistical Outliers"];
end;
subgraph OUTCOME["Phase 5: Outcome"];
J{"Deviation Significant?"};
K["Above +100 - Impulse Breakout"];
L["Below -100 - Impulse Breakdown"];
M["Within Range - Normal Noise"];
N[/"Generate CCI Signal"/];
end;
A --> B;
B --> C;
C --> D;
D --> E;
E -->|No| N;
E -->|Yes| F;
F --> G;
G --> H;
H --> I;
I --> J;
J -->|>+100| K;
J -->|<-100| L;
J -->|Normal| M;
K --> N;
L --> N;
M --> N;
style INGESTION fill:#e3f2fd;
style EVALUATION fill:#fff3e0;
style WEIGHTING fill:#e8f5e9;
style SYNTHESIS fill:#fce4ec;
style OUTCOME fill:#f3e5f5;
                    </div>
                </div>

                <!-- 3. Canvas Controls (Zoom) -->
                <div class="absolute top-4 right-4 flex flex-col gap-2 z-20">
                    <button onclick="if(window.resetView) window.resetView()" class="p-2 bg-white rounded shadow border border-slate-200 hover:bg-slate-50 text-slate-600 font-mono text-xs" title="Reset View">R</button>
                    <button onclick="if(window.zoomAction) window.zoomAction('in')" class="p-2 bg-white rounded shadow border border-slate-200 hover:bg-slate-50 text-slate-600 font-mono text-xs" title="Zoom In">+</button>
                    <button onclick="if(window.zoomAction) window.zoomAction('out')" class="p-2 bg-white rounded shadow border border-slate-200 hover:bg-slate-50 text-slate-600 font-mono text-xs" title="Zoom Out">-</button>
                </div>

                <!-- 4. Code Panel Overlay (Slide-in) -->
                <div id="code-panel-overlay" class="panel-hidden" onmousedown="event.stopPropagation();">
                    <!-- Header -->
                    <div class="flex justify-between items-center p-3 border-b border-slate-200 bg-slate-50 shrink-0">
                        <div class="flex gap-2">
                            <button id="btn-lang-csharp" class="px-2 py-1 text-xs rounded transition-colors text-slate-500 hover:bg-slate-100" onclick="setLang('csharp')">C#</button>
                            <button id="btn-lang-python" class="px-2 py-1 text-xs rounded transition-colors text-slate-500 hover:bg-slate-100" onclick="setLang('python')">Python</button>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="btn-type-simple" class="text-xs text-slate-500 hover:text-indigo-600 transition-colors" onclick="setType('simple')">Simple</button>
                            <button id="btn-type-detailed" class="text-xs text-slate-500 hover:text-indigo-600 transition-colors" onclick="setType('detailed')">Detailed</button>
                            <!-- Copy -->
                            <button id="btn-copy-code" class="ml-2 text-slate-500 hover:text-slate-800 transition-colors" onclick="copyCode()" title="Copy Code">
                                <svg id="icon-copy" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                                <svg id="icon-copy-done" class="hidden text-green-600" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                            </button>
                            <!-- Expand/Collapse -->
                            <button id="btn-panel-expand" class="text-slate-500 hover:text-slate-800 transition-colors" onclick="toggleExpand()" title="Toggle Width">
                                <svg id="icon-expand" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M15 3h6v6" /><path d="M9 21H3v-6" /><path d="M21 3l-7 7" /><path d="M3 21l7-7" />
                                </svg>
                                <svg id="icon-collapse" class="hidden" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 14h6v6" /><path d="M20 10h-6V4" /><path d="M14 10l7-7" /><path d="M10 14l-7 7" />
                                </svg>
                            </button>
                            <!-- Close -->
                            <button class="text-slate-500 hover:text-red-600 transition-colors" onclick="toggleCodePanel()" title="Close Panel">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <!-- Body -->
                    <div class="code-panel-body custom-scrollbar p-4">
                        <div id="code-csharp-simple" class="code-content hidden"><div class="highlight"><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">1</span><span class="k">using</span> System;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">2</span><span class="k">using</span> System.Collections.Generic;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">3</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">4</span><span class="k">namespace</span> TechnicalIndicators</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">5</span>{</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">6</span>    <span class="c1">/// &lt;summary&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">7</span>    <span class="c1">/// Commodity Channel Index (CCI)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">8</span>    <span class="c1">/// &lt;/summary&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">9</span>    <span class="c1">/// &lt;remarks&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">10</span>    <span class="c1">/// Measures the difference between the current price and the historical average price relative to mean deviation.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">11</span>    <span class="c1">/// Used to identify cyclical turns in commodities (and stocks).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">12</span>    <span class="c1">/// &lt;/remarks&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">13</span>    <span class="k">public</span> <span class="k">class</span> <span class="nc">CommodityChannelIndex</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">14</span>    {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">15</span>        <span class="k">public</span> <span class="kt">int</span> Period { <span class="k">get</span>; }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">16</span>        <span class="k">public</span> List&lt;<span class="kt">decimal?</span>&gt; Values { <span class="k">get</span>; } = <span class="k">new</span>();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">17</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">18</span>        <span class="c1">// Rationale: Lambert&#x27;s constant to scale results so most values fall between -100 and +100.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">19</span>        <span class="k">private</span> <span class="k">const</span> <span class="kt">decimal</span> Constant = 0.015m;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">20</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">21</span>        <span class="k">public</span> CommodityChannelIndex(<span class="kt">int</span> period = 20)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">22</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">23</span>            <span class="k">if</span> (period &lt;= 0)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">24</span>                <span class="k">throw</span> <span class="k">new</span> ArgumentOutOfRangeException(<span class="s">&quot;Period must be &gt; 0&quot;</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">25</span>            Period = period;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">26</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">27</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">28</span>        <span class="k">public</span> <span class="k">void</span> Calculate(IEnumerable&lt;CandleData&gt; candles)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">29</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">30</span>            Values.Clear();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">31</span>            <span class="kt">var</span> candleList = <span class="k">new</span> List&lt;CandleData&gt;(candles);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">32</span>            <span class="k">if</span> (candleList.Count == 0) <span class="k">return</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">33</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">34</span>            <span class="c1">// Step 1: Calculate Typical Price (TP)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">35</span>            <span class="kt">var</span> tpValues = <span class="k">new</span> List&lt;<span class="kt">decimal</span>&gt;();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">36</span>            <span class="k">for</span> (<span class="kt">int</span> i = 0; i &lt; candleList.Count; i++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">37</span>            {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">38</span>                <span class="kt">decimal</span> tp = (candleList[i].High + candleList[i].Low + candleList[i].Close) / 3.0m;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">39</span>                tpValues.Add(tp);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">40</span>            }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">41</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">42</span>            <span class="c1">// Step 2: Calculate SMA of TP and Mean Deviation</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">43</span>            <span class="k">for</span> (<span class="kt">int</span> i = 0; i &lt; candleList.Count; i++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">44</span>            {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">45</span>                <span class="k">if</span> (i &lt; Period - 1)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">46</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">47</span>                    Values.Add(<span class="k">null</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">48</span>                    <span class="k">continue</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">49</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">50</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">51</span>                <span class="c1">// SMA of Typical Price</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">52</span>                <span class="kt">decimal</span> sumTp = 0;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">53</span>                <span class="k">for</span> (<span class="kt">int</span> j = 0; j &lt; Period; j++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">54</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">55</span>                    sumTp += tpValues[i - Period + 1 + j];</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">56</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">57</span>                <span class="kt">decimal</span> smaTp = sumTp / Period;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">58</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">59</span>                <span class="c1">// Mean Deviation (MD) = Average of Absolute Deviations</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">60</span>                <span class="kt">decimal</span> sumAbsDiff = 0;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">61</span>                <span class="k">for</span> (<span class="kt">int</span> j = 0; j &lt; Period; j++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">62</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">63</span>                    <span class="kt">decimal</span> val = tpValues[i - Period + 1 + j];</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">64</span>                    sumAbsDiff += Math.Abs(val - smaTp);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">65</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">66</span>                <span class="kt">decimal</span> meanDev = sumAbsDiff / Period;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">67</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">68</span>                <span class="c1">// Formula: CCI = (TP - SMA) / (0.015 * MD)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">69</span>                <span class="k">if</span> (meanDev == 0)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">70</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">71</span>                    Values.Add(0);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">72</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">73</span>                <span class="k">else</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">74</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">75</span>                    Values.Add((tpValues[i] - smaTp) / (Constant * meanDev));</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">76</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">77</span>            }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">78</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">79</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">80</span>        <span class="k">public</span> <span class="k">static</span> List&lt;<span class="kt">decimal?</span>&gt; Calculate(IEnumerable&lt;CandleData&gt; candles, <span class="kt">int</span> period = 20)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">81</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">82</span>            <span class="kt">var</span> cci = <span class="k">new</span> CommodityChannelIndex(period);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">83</span>            cci.Calculate(candles);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">84</span>            <span class="k">return</span> cci.Values;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">85</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">86</span>    }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">87</span>}</div></div></div>
                        <div id="code-csharp-detailed" class="code-content hidden"><div class="highlight"><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">1</span><span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">2</span><span class="c1">// Logic Breakdown (CommodityChannelIndex)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">3</span><span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">4</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">5</span><span class="c1">// This document provides a &quot;Deep Dive&quot; into the internal logic of the</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">6</span><span class="c1">// Commodity Channel Index (CCI) technical indicator.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">7</span><span class="c1">// We explain *why* code is written this way and *how* data transforms</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">8</span><span class="c1">// line-by-line, targeting programming beginners.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">9</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">10</span><span class="c1">// [Core Concepts]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">11</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">12</span><span class="c1">// 1. Typical Price (TP) - The Representative Price</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">13</span><span class="c1">//    [Why] Closing price alone doesn&#x27;t capture the full day&#x27;s activity.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">14</span><span class="c1">//    [What] The arithmetic mean of High, Low, and Close.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">15</span><span class="c1">//    [How]  TP = (High + Low + Close) / 3</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">16</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">17</span><span class="c1">// 2. Mean Deviation (MD) - Measuring Volatility</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">18</span><span class="c1">//    [Why] We need to know how &quot;abnormal&quot; the current price is compared to average.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">19</span><span class="c1">//    [What] The average of absolute differences between each TP and the SMA of TPs.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">20</span><span class="c1">//    [How]  MD = Sum(|TP_i - SMA|) / Period</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">21</span><span class="c1">//    [Note] Unlike Standard Deviation, this uses absolute difference (L1 norm),</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">22</span><span class="c1">//           making it more robust against extreme outliers.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">23</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">24</span><span class="c1">// 3. Lambert&#x27;s Constant (0.015) - Scaling Factor</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">25</span><span class="c1">//    [Why] Donald Lambert designed CCI so that 70-80% of values fall within ±100.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">26</span><span class="c1">//    [What] A divisors scaling factor.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">27</span><span class="c1">//    [How]  Without this, values would be much larger (e.g., ±6000).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">28</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">29</span><span class="c1">// [Formula]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">30</span><span class="c1">// CCI = (TP - SMA_of_TP) / (0.015 * MeanDeviation)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">31</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">32</span><span class="c1">// [Visual Plan]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">33</span><span class="c1">// 1. Calculate TP for every bar.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">34</span><span class="c1">// 2. For each bar, look back &#x27;Period&#x27; bars.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">35</span><span class="c1">// 3. Calculate Average (SMA) of those TPs.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">36</span><span class="c1">// 4. Calculate how far each TP in the window is from that SMA (MeanDev).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">37</span><span class="c1">// 5. Normalize the difference (TP - SMA) by the MeanDev.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">38</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">39</span><span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">40</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">41</span><span class="k">using</span> System;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">42</span><span class="k">using</span> System.Collections.Generic;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">43</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">44</span><span class="k">namespace</span> TechnicalIndicators</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">45</span>{</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">46</span>    <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">47</span>    <span class="c1">// Logic Explanation: OHLCV Data Container</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">48</span>    <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">49</span>    <span class="k">public</span> <span class="k">readonly</span> <span class="k">record</span> <span class="k">struct</span> CandleData(DateTime Timestamp, <span class="kt">decimal</span> Open, <span class="kt">decimal</span> High, <span class="kt">decimal</span> Low, <span class="kt">decimal</span> Close, <span class="kt">long</span> Volume);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">50</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">51</span>    <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">52</span>    <span class="c1">// Logic Explanation: Commodity Channel Index (CCI) Class</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">53</span>    <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">54</span>    <span class="c1">// [Why]  Identifies cyclical turns in commodities (and stocks/forex).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">55</span>    <span class="c1">//        Measures deviation from a statistical average.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">56</span>    <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">57</span>    <span class="c1">// [What] Output is a single list of oscillator values.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">58</span>    <span class="c1">//        &gt; +100: Overbought/Strong trend up</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">59</span>    <span class="c1">//        &lt; -100: Oversold/Strong trend down</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">60</span>    <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">61</span>    <span class="k">public</span> <span class="k">class</span> <span class="nc">CommodityChannelIndex</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">62</span>    {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">63</span>        <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">64</span>        <span class="c1">// Logic Explanation: Configuration Constants &amp; Properties</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">65</span>        <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">66</span>        <span class="c1">// [Period] Lookback window (standard is 20).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">67</span>        <span class="c1">// [Constant] 0.015 (Lambert&#x27;s Constant).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">68</span>        <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">69</span>        <span class="k">public</span> <span class="kt">int</span> Period { <span class="k">get</span>; }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">70</span>        <span class="k">public</span> List&lt;<span class="kt">decimal?</span>&gt; Values { <span class="k">get</span>; } = <span class="k">new</span>();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">71</span>        <span class="k">private</span> <span class="k">const</span> <span class="kt">decimal</span> Constant = 0.015m;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">72</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">73</span>        <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">74</span>        <span class="c1">// Logic Explanation: Constructor</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">75</span>        <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">76</span>        <span class="c1">// [Why]  Validate parameters before any calculation can fail.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">77</span>        <span class="c1">// [How]  Period must be &gt; 0.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">78</span>        <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">79</span>        <span class="k">public</span> CommodityChannelIndex(<span class="kt">int</span> period = 20)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">80</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">81</span>            <span class="k">if</span> (period &lt;= 0)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">82</span>                <span class="k">throw</span> <span class="k">new</span> ArgumentOutOfRangeException(<span class="k">nameof</span>(period));</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">83</span>            Period = period;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">84</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">85</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">86</span>        <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">87</span>        <span class="c1">// Logic Explanation: Main Calculation Method</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">88</span>        <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">89</span>        <span class="c1">// [Why]  Executes the core CCI formula.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">90</span>        <span class="c1">// [How]  Phase 1: Compute all Typical Prices (TP).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">91</span>        <span class="c1">//        Phase 2: Compute SMA and Mean Deviation for each window.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">92</span>        <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">93</span>        <span class="k">public</span> <span class="k">void</span> Calculate(IEnumerable&lt;CandleData&gt; candles)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">94</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">95</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">96</span>            <span class="c1">// Step 1: Cleanup</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">97</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">98</span>            Values.Clear();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">99</span>            <span class="kt">var</span> candleList = <span class="k">new</span> List&lt;CandleData&gt;(candles);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">100</span>            <span class="k">if</span> (candleList.Count == 0) <span class="k">return</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">101</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">102</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">103</span>            <span class="c1">// Step 2: Pre-calculation of Typical Price (TP)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">104</span>            <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">105</span>            <span class="c1">// [Why] (Intent)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">106</span>            <span class="c1">// Both SMA and Mean Deviation need access to historical TP values.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">107</span>            <span class="c1">// Calculating them once upfront is cleaner than recalculating repeatedly.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">108</span>            <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">109</span>            <span class="c1">// [Math]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">110</span>            <span class="c1">// TP = (H + L + C) / 3</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">111</span>            <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">112</span>            <span class="c1">// [Visual]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">113</span>            <span class="c1">// Candles: [C0, C1, C2, ...]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">114</span>            <span class="c1">//             ↓   ↓   ↓</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">115</span>            <span class="c1">// TPs:     [T0, T1, T2, ...]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">116</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">117</span>            <span class="kt">var</span> tpValues = <span class="k">new</span> List&lt;<span class="kt">decimal</span>&gt;();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">118</span>            <span class="k">for</span> (<span class="kt">int</span> i = 0; i &lt; candleList.Count; i++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">119</span>            {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">120</span>                <span class="kt">decimal</span> tp = (candleList[i].High + candleList[i].Low + candleList[i].Close) / 3.0m;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">121</span>                tpValues.Add(tp);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">122</span>            }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">123</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">124</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">125</span>            <span class="c1">// Step 3: CCI Calculation Loop</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">126</span>            <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">127</span>            <span class="c1">// [Why] (Intent)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">128</span>            <span class="c1">// Calculate CCI for each bar where enough history exists.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">129</span>            <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">130</span>            <span class="c1">// [Visual]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">131</span>            <span class="c1">// Window (Period=3):</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">132</span>            <span class="c1">// i=2: [T0, T1, T2] -&gt; Calculate stats -&gt; CCI[2]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">133</span>            <span class="c1">// i=3: [T1, T2, T3] -&gt; Calculate stats -&gt; CCI[3]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">134</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">135</span>            <span class="k">for</span> (<span class="kt">int</span> i = 0; i &lt; candleList.Count; i++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">136</span>            {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">137</span>                <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">138</span>                <span class="c1">// Step 3a: Warm-up Check</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">139</span>                <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">140</span>                <span class="c1">// [Why] Need &#x27;Period&#x27; samples to calculate SMA and MeanDev.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">141</span>                <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">142</span>                <span class="k">if</span> (i &lt; Period - 1)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">143</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">144</span>                    Values.Add(<span class="k">null</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">145</span>                    <span class="k">continue</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">146</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">147</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">148</span>                <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">149</span>                <span class="c1">// Step 3b: Calculate SMA of TP (Simple Moving Average)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">150</span>                <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">151</span>                <span class="c1">// [Why] (Intent)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">152</span>                <span class="c1">// Determine the &quot;center line&quot; or &quot;normal price&quot; for this period.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">153</span>                <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">154</span>                <span class="c1">// [How] (Logic)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">155</span>                <span class="c1">// Sum the last &#x27;Period&#x27; TPs and divide by Period.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">156</span>                <span class="c1">// Loop range: j goes from 0 to Period-1.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">157</span>                <span class="c1">// Access index: [i - Period + 1 + j] (Scanning the window ending at i).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">158</span>                <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">159</span>                <span class="kt">decimal</span> sumTp = 0;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">160</span>                <span class="k">for</span> (<span class="kt">int</span> j = 0; j &lt; Period; j++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">161</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">162</span>                    sumTp += tpValues[i - Period + 1 + j];</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">163</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">164</span>                <span class="kt">decimal</span> smaTp = sumTp / Period;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">165</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">166</span>                <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">167</span>                <span class="c1">// Step 3c: Calculate Mean Deviation (MD)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">168</span>                <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">169</span>                <span class="c1">// [Why] (Intent)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">170</span>                <span class="c1">// Measure the average &quot;spread&quot; of prices from the SMA.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">171</span>                <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">172</span>                <span class="c1">// [How] (Logic)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">173</span>                <span class="c1">// 1. Iterate through the same window TPs.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">174</span>                <span class="c1">// 2. Calculate absolute difference |TP - SMA|.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">175</span>                <span class="c1">// 3. Sum these differences.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">176</span>                <span class="c1">// 4. Divide by Period.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">177</span>                <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">178</span>                <span class="c1">// [Visual]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">179</span>                <span class="c1">// SMA = 100</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">180</span>                <span class="c1">// Window: [90, 100, 110]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">181</span>                <span class="c1">// Diffs:  |90-100|=10, |100-100|=0, |110-100|=10</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">182</span>                <span class="c1">// SumAbsDiff = 20</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">183</span>                <span class="c1">// MeanDev = 20 / 3 = 6.66...</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">184</span>                <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">185</span>                <span class="kt">decimal</span> sumAbsDiff = 0;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">186</span>                <span class="k">for</span> (<span class="kt">int</span> j = 0; j &lt; Period; j++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">187</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">188</span>                    <span class="kt">decimal</span> val = tpValues[i - Period + 1 + j];</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">189</span>                    sumAbsDiff += Math.Abs(val - smaTp);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">190</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">191</span>                <span class="kt">decimal</span> meanDev = sumAbsDiff / Period;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">192</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">193</span>                <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">194</span>                <span class="c1">// Step 3d: Final CCI Formula</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">195</span>                <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">196</span>                <span class="c1">// [Math]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">197</span>                <span class="c1">// CCI = (CurrentTP - SMA) / (0.015 * MeanDev)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">198</span>                <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">199</span>                <span class="c1">// [Decision]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">200</span>                <span class="c1">// Avoid division by zero if MeanDev is 0 (all prices identical).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">201</span>                <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">202</span>                <span class="k">if</span> (meanDev == 0)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">203</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">204</span>                    Values.Add(0);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">205</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">206</span>                <span class="k">else</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">207</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">208</span>                    <span class="kt">decimal</span> numerator = tpValues[i] - smaTp;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">209</span>                    <span class="kt">decimal</span> denominator = Constant * meanDev;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">210</span>                    Values.Add(numerator / denominator);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">211</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">212</span>            }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">213</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">214</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">215</span>        <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">216</span>        <span class="c1">// Logic Explanation: Static Convenience Wrapper</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">217</span>        <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">218</span>        <span class="k">public</span> <span class="k">static</span> List&lt;<span class="kt">decimal?</span>&gt; Calculate(IEnumerable&lt;CandleData&gt; candles, <span class="kt">int</span> period = 20)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">219</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">220</span>            <span class="kt">var</span> cci = <span class="k">new</span> CommodityChannelIndex(period);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">221</span>            cci.Calculate(candles);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">222</span>            <span class="k">return</span> cci.Values;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">223</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">224</span>    }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">225</span>}</div></div></div>
                        <div id="code-python-simple" class="code-content hidden"><div class="highlight"><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">1</span><span class="k">class</span> <span class="nc">CommodityChannelIndex</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">2</span>    <span class="sd">&quot;&quot;&quot;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">3</span><span class="sd">    Commodity Channel Index (CCI)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">4</span><span class="sd">    Measures deviation from statistical average.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">5</span><span class="sd">    &quot;&quot;&quot;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">6</span>    <span class="k">def</span> __init__(self, period=20):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">7</span>        <span class="k">if</span> period &lt;= 0:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">8</span>            <span class="k">raise</span> ValueError(<span class="s2">&quot;</span><span class="s2">Period must be &gt; 0</span><span class="s2">&quot;</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">9</span>        self.period = period</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">10</span>        self.values = []</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">11</span>        self.constant = 0.015</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">12</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">13</span>    <span class="k">def</span> calculate(self, candles):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">14</span>        <span class="sd">&quot;&quot;&quot; Computes CCI values. &quot;&quot;&quot;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">15</span>        self.values.clear()</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">16</span>        <span class="k">if</span> len(candles) == 0:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">17</span>            <span class="k">return</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">18</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">19</span>        <span class="c1"># 1. Typical Price</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">20</span>        tp_values = []</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">21</span>        <span class="k">for</span> c <span class="ow">in</span> candles:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">22</span>            tp = (c[<span class="s1">&#x27;</span><span class="s1">high</span><span class="s1">&#x27;</span>] + c[<span class="s1">&#x27;</span><span class="s1">low</span><span class="s1">&#x27;</span>] + c[<span class="s1">&#x27;</span><span class="s1">close</span><span class="s1">&#x27;</span>]) / 3.0</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">23</span>            tp_values.append(tp)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">24</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">25</span>        <span class="c1"># 2. CCI Loop</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">26</span>        <span class="k">for</span> i <span class="ow">in</span> range(len(candles)):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">27</span>            <span class="k">if</span> i &lt; self.period - 1:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">28</span>                self.values.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">29</span>                <span class="k">continue</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">30</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">31</span>            <span class="c1"># Calculate SMA of TP</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">32</span>            window = tp_values[i - self.period + 1 : i + 1]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">33</span>            sma_tp = sum(window) / self.period</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">34</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">35</span>            <span class="c1"># Calculate Mean Deviation</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">36</span>            sum_abs_diff = sum(abs(val - sma_tp) <span class="k">for</span> val <span class="ow">in</span> window)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">37</span>            mean_dev = sum_abs_diff / self.period</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">38</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">39</span>            <span class="k">if</span> mean_dev == 0:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">40</span>                self.values.append(0.0)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">41</span>            <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">42</span>                cci = (tp_values[i] - sma_tp) / (self.constant * mean_dev)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">43</span>                self.values.append(cci)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">44</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">45</span><span class="k">def</span> calculate(candles, period=20):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">46</span>    cci = CommodityChannelIndex(period)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">47</span>    cci.calculate(candles)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">48</span>    <span class="k">return</span> cci.values</div></div></div>
                        <div id="code-python-detailed" class="code-content hidden"><div class="highlight"><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">1</span><span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">2</span><span class="c1"># Logic Breakdown (CommodityChannelIndex)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">3</span><span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">4</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">5</span><span class="c1"># This document provides a &quot;Deep Dive&quot; into the internal logic of the</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">6</span><span class="c1"># Commodity Channel Index (CCI). We explain *why* code is written this way</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">7</span><span class="c1"># and *how* data transforms line-by-line, targeting programming beginners.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">8</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">9</span><span class="c1"># [Core Concepts]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">10</span><span class="c1"># 1. Typical Price (TP)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">11</span><span class="c1">#    Uses the average of High, Low, and Close for each bar.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">12</span><span class="c1">#    TP = (H + L + C) / 3</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">13</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">14</span><span class="c1"># 2. Mean Deviation</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">15</span><span class="c1">#    Measures how far prices typically deviate from their average (SMA).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">16</span><span class="c1">#    Unlike Standard Deviation (which squares errors), Mean Deviation uses absolute diffs.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">17</span><span class="c1">#    This makes it more robust to outliers (less sensitive).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">18</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">19</span><span class="c1"># 3. Lambert&#x27;s Constant (0.015)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">20</span><span class="c1">#    A scaling factor designed to put 70-80% of values within the -100 to +100 range.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">21</span><span class="c1">#    CCI = (TP - SMA) / (0.015 * MeanDev)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">22</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">23</span><span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">24</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">25</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">26</span><span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">27</span><span class="c1"># Type-Level Explanation: CommodityChannelIndex (class)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">28</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">29</span><span class="c1"># [Why]  Encapsulates CCI calculation logic.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">30</span><span class="c1"># [What] Computes standardized deviation from trend.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">31</span><span class="c1"># [Who]  Cyclical traders, overbought/oversold detection.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">32</span><span class="c1"># [Where] Heap allocation.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">33</span><span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">34</span><span class="k">class</span> <span class="nc">CommodityChannelIndex</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">35</span>    </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">36</span>    <span class="c1"># Constant defined by Donald Lambert</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">37</span>    CONSTANT = 0.015</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">38</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">39</span>    <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">40</span>    <span class="c1"># Constructor: __init__</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">41</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">42</span>    <span class="c1"># [Why]  Validate period.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">43</span>    <span class="c1"># [What] Sets lookback period (default 20).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">44</span>    <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">45</span>    <span class="k">def</span> __init__(self, period=20):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">46</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">47</span>        <span class="c1"># Logic Step 1: Validation</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">48</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">49</span>        <span class="k">if</span> period &lt;= 0:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">50</span>            <span class="k">raise</span> ValueError(<span class="s2">&quot;</span><span class="s2">period</span><span class="s2">&quot;</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">51</span>        self.period = period</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">52</span>        self.values = []</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">53</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">54</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">55</span>    <span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">56</span>    <span class="c1"># IPO: calculate</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">57</span>    <span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">58</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">59</span>    <span class="c1"># [Input]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">60</span>    <span class="c1"># - candles: list[dict]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">61</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">62</span>    <span class="c1"># [Process]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">63</span>    <span class="c1"># 1. Compute Typical Price for ALL candles first.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">64</span>    <span class="c1"># 2. Calculate SMA of Typical Price (sliding window).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">65</span>    <span class="c1"># 3. Calculate Mean Deviation (sliding window).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">66</span>    <span class="c1"># 4. Apply Lambert&#x27;s Formula.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">67</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">68</span>    <span class="c1"># [Output]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">69</span>    <span class="c1"># - None (populates self.values).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">70</span>    <span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">71</span>    <span class="k">def</span> calculate(self, candles):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">72</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">73</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">74</span>        <span class="c1"># Logic Step 1: Reset &amp; Guard</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">75</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">76</span>        self.values.clear()</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">77</span>        <span class="k">if</span> len(candles) == 0:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">78</span>            <span class="k">return</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">79</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">80</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">81</span>        <span class="c1"># Logic Step 2: Pre-calculate Typical Price (TP)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">82</span>        <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">83</span>        <span class="c1"># [Why] (Intent)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">84</span>        <span class="c1"># TP is the base data series. Calculating it once upfront simplifies</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">85</span>        <span class="c1"># the main loop (Pattern: Transform -&gt; Process).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">86</span>        <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">87</span>        <span class="c1"># [How] (Logic)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">88</span>        <span class="c1"># TP = (H+L+C)/3</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">89</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">90</span>        tp_values = [(c[<span class="s1">&#x27;</span><span class="s1">high</span><span class="s1">&#x27;</span>] + c[<span class="s1">&#x27;</span><span class="s1">low</span><span class="s1">&#x27;</span>] + c[<span class="s1">&#x27;</span><span class="s1">close</span><span class="s1">&#x27;</span>]) / 3 <span class="k">for</span> c <span class="ow">in</span> candles]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">91</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">92</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">93</span>        <span class="c1"># Logic Step 3: Main Loop</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">94</span>        <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">95</span>        <span class="c1"># [Visual]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">96</span>        <span class="c1"># Period = 20</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">97</span>        <span class="c1"># i = 19 (First valid CCI)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">98</span>        <span class="c1"># Window of TPs: [TP0, ... TP19]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">99</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">100</span>        <span class="k">for</span> i <span class="ow">in</span> range(len(candles)):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">101</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">102</span>            <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">103</span>            <span class="c1"># Logic Step 3.1: Wait for data (Insufficient History)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">104</span>            <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">105</span>            <span class="c1"># [Condition]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">106</span>            <span class="c1"># Need &#x27;period&#x27; bars.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">107</span>            <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">108</span>            <span class="k">if</span> i &lt; self.period - 1:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">109</span>                self.values.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">110</span>                <span class="k">continue</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">111</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">112</span>            <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">113</span>            <span class="c1"># Logic Step 3.2: Window Extraction</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">114</span>            <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">115</span>            <span class="c1"># [What] Get the slice of TPs for the current window.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">116</span>            <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">117</span>            window = tp_values[i - self.period + 1 : i + 1]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">118</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">119</span>            <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">120</span>            <span class="c1"># Logic Step 3.3: Calculate SMA of TP</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">121</span>            <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">122</span>            <span class="c1"># [Why] (Intent)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">123</span>            <span class="c1"># Find the &quot;center&quot; or &quot;trend&quot; of the typical price.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">124</span>            <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">125</span>            <span class="c1"># [How] (Logic)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">126</span>            <span class="c1"># Sum of TPs in window / Period.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">127</span>            <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">128</span>            sum_tp = sum(window)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">129</span>            sma_tp = sum_tp / self.period</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">130</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">131</span>            <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">132</span>            <span class="c1"># Logic Step 3.4: Calculate Mean Deviation</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">133</span>            <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">134</span>            <span class="c1"># [Why] (Intent)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">135</span>            <span class="c1"># Measure &quot;average distance from the average&quot;.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">136</span>            <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">137</span>            <span class="c1"># [Visual]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">138</span>            <span class="c1"># TP Window: [100, 105, 95] (Avg=100)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">139</span>            <span class="c1"># Diffs:     |0|,  |5|,  |-5| -&gt; 0, 5, 5</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">140</span>            <span class="c1"># MeanDev:   (0+5+5)/3 = 3.33    </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">141</span>            <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">142</span>            sum_abs_diff = sum(abs(val - sma_tp) <span class="k">for</span> val <span class="ow">in</span> window)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">143</span>            mean_dev = sum_abs_diff / self.period</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">144</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">145</span>            <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">146</span>            <span class="c1"># Logic Step 3.5: Compute CCI (Lambert&#x27;s Formula)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">147</span>            <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">148</span>            <span class="c1"># [Decision]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">149</span>            <span class="c1"># Guard against Div/0 if MeanDev is 0 (all prices identical).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">150</span>            <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">151</span>            <span class="c1"># [Formula]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">152</span>            <span class="c1"># (CurrentTP - SMA) / (0.015 * MeanDev)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">153</span>            <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">154</span>            <span class="k">if</span> mean_dev == 0:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">155</span>                self.values.append(0)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">156</span>            <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">157</span>                cci = (tp_values[i] - sma_tp) / (self.CONSTANT * mean_dev)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">158</span>                self.values.append(cci)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">159</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">160</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">161</span><span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">162</span><span class="c1"># Static Wrapper Function</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">163</span><span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">164</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">165</span><span class="c1"># [Why]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">166</span><span class="c1"># Functional interface.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">167</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">168</span><span class="c1"># [Pattern: 3-Step Static Wrapper]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">169</span><span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">170</span><span class="k">def</span> calculate(candles, period=20):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">171</span>    <span class="c1"># 1. Instantiation</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">172</span>    cci = CommodityChannelIndex(period)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">173</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">174</span>    <span class="c1"># 2. Execution</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">175</span>    cci.calculate(candles)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">176</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">177</span>    <span class="c1"># 3. Extraction</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">178</span>    <span class="k">return</span> cci.values</div></div></div>
                    </div>
                </div>
            </figure>

            <!-- Legend (5-Step Model) -->
            <div class="logic-legend">
                <div class="legend-item"><span class="legend-dot l-ingestion"></span>Ingestion</div>
                <div class="legend-item"><span class="legend-dot l-evaluation"></span>Evaluation</div>
                <div class="legend-item"><span class="legend-dot l-weighting"></span>Weighting</div>
                <div class="legend-item"><span class="legend-dot l-synthesis"></span>Synthesis</div>
                <div class="legend-item"><span class="legend-dot l-outcome"></span>Outcome</div>
            </div>
        </section>

        <!-- ======================================================= -->
        <!-- BOTTOM SECTION: DOCS & TOC                              -->
        <!-- ======================================================= -->
        <section id="documentation" class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden scroll-mt-24">
            <!-- Documentation Header -->
            <div class="border-b border-orange-200 bg-orange-50 px-6 py-4">
                <h2 class="text-lg font-bold text-slate-900 flex items-center">
                    <span class="bg-indigo-600 text-white p-1 rounded mr-3 text-xs shadow-sm font-mono">D</span>
                    Technical Documentation
                </h2>
                <p class="text-slate-600 text-xs mt-1 ml-9">
                    Detailed technical explanation of the indicator's logic, math, and implementation details.
                </p>
            </div>
            <!-- Content Body -->
            <div class="p-6 flex flex-col lg:flex-row gap-12">
                <!-- Left: Article -->
                <article class="flex-1 min-w-0">
                    <div class="prose prose-slate max-w-none prose-headings:scroll-mt-24 prose-headings:font-bold prose-h2:text-2xl prose-h2:border-b prose-h2:pb-2 prose-h2:mt-8 prose-a:text-indigo-600 hover:prose-a:text-indigo-800">
                        <h1 id="commoditychannelindex-cci">CommodityChannelIndex (CCI)</h1>

<p class="mb-4"><h2 class="text-2xl font-bold mt-12 mb-6 border-b pb-2">PART 1: MAIN GUIDE</h2></p>

<h2 id="1-identity">1. Identity</h2>

<p class="mb-4">Full Name: Commodity Channel Index  </p>
<p class="mb-4">Abbreviation: CCI  </p>
<p class="mb-4">Category: Momentum / Cyclical Oscillator  </p>
<p class="mb-4">Creator: Donald Lambert (1980)  </p>

<blockquote class="border-l-4 border-gray-300 pl-4 italic text-gray-700 my-4 bg-gray-50 py-2 pr-2 rounded-r">One-Sentence Definition: The Commodity Channel Index measures how far the current Typical Price has deviated from its average—breaking above +100 signals an impulse breakout, while readings inside ±100 represent statistical "noise."</blockquote>

<hr class="border-[#2a2e39] my-8">

<h2 id="2-calculation-logic">2. Calculation Logic</h2>

<h3 id="formula">Formula</h3>

<p class="mb-4">$$CCI = \frac{TP - SMA_{TP}}{0.015 \times MD}$$</p>

<p class="mb-4">Where:</p>
<p class="mb-4">- $TP = \frac{High + Low + Close}{3}$ (Typical Price)</p>
<p class="mb-4">- $SMA_{TP}$ = Simple Moving Average of TP over n periods</p>
<p class="mb-4">- $MD$ = Mean Absolute Deviation of TP from SMA</p>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Step</td><td class="px-4 py-2 border-b border-[#2a2e39]">Formula</td><td class="px-4 py-2 border-b border-[#2a2e39]">Purpose</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">1</td><td class="px-4 py-2 border-b border-[#2a2e39]">$TP = \frac{H + L + C}{3}$</td><td class="px-4 py-2 border-b border-[#2a2e39]">Typical Price</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">2</td><td class="px-4 py-2 border-b border-[#2a2e39]">$SMA_{TP} = \frac{\sum TP}{n}$</td><td class="px-4 py-2 border-b border-[#2a2e39]">Average Typical Price</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">3</td><td class="px-4 py-2 border-b border-[#2a2e39]">$MD = \frac{\sum</td><td class="px-4 py-2 border-b border-[#2a2e39]">TP - SMA_{TP}</td><td class="px-4 py-2 border-b border-[#2a2e39]">}{n}$</td><td class="px-4 py-2 border-b border-[#2a2e39]">Mean Absolute Deviation</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">4</td><td class="px-4 py-2 border-b border-[#2a2e39]">$CCI = \frac{TP - SMA_{TP}}{0.015 \times MD}$</td><td class="px-4 py-2 border-b border-[#2a2e39]">Normalized deviation</td></tr>
</table></div>

<h3 id="the-0015-constant">The 0.015 Constant</h3>

<p class="mb-4">Lambert chose 0.015 to ensure that approximately 70-80% of CCI values fall within the ±100 range under normal conditions. This creates a meaningful breakout threshold.</p>

<h3 id="real-world-analogy">Real-World Analogy</h3>

<p class="mb-4">Think of CCI as a statistical radar for price impulses. The ±100 zone is the "noise channel"—normal price variation. When CCI breaks above +100 or below -100, it's like a radar blip indicating an unusual event: a trend is starting or a significant move is underway.</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="3-market-standards">3. Market Standards</h2>

<h3 id="default-parameters">Default Parameters</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Parameter</td><td class="px-4 py-2 border-b border-[#2a2e39]">Standard Value</td><td class="px-4 py-2 border-b border-[#2a2e39]">Rationale</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Period</td><td class="px-4 py-2 border-b border-[#2a2e39]">20</td><td class="px-4 py-2 border-b border-[#2a2e39]">Lambert's original recommendation</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Constant</td><td class="px-4 py-2 border-b border-[#2a2e39]">0.015</td><td class="px-4 py-2 border-b border-[#2a2e39]">Ensures ±100 contains 70-80% of values</td></tr>
</table></div>

<h3 id="alternative-parameters">Alternative Parameters</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Use Case</td><td class="px-4 py-2 border-b border-[#2a2e39]">Period</td><td class="px-4 py-2 border-b border-[#2a2e39]">Notes</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Standard</td><td class="px-4 py-2 border-b border-[#2a2e39]">20</td><td class="px-4 py-2 border-b border-[#2a2e39]">Lambert's original</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Fast</td><td class="px-4 py-2 border-b border-[#2a2e39]">14</td><td class="px-4 py-2 border-b border-[#2a2e39]">More signals, more noise</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Woodies CCI</td><td class="px-4 py-2 border-b border-[#2a2e39]">14 + 6</td><td class="px-4 py-2 border-b border-[#2a2e39]">Dual CCI system</td></tr>
</table></div>

<h3 id="key-levels">Key Levels</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Level</td><td class="px-4 py-2 border-b border-[#2a2e39]">Meaning</td><td class="px-4 py-2 border-b border-[#2a2e39]">Action</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">+200</td><td class="px-4 py-2 border-b border-[#2a2e39]">Extremely overbought</td><td class="px-4 py-2 border-b border-[#2a2e39]">Potential exhaustion</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">+100</td><td class="px-4 py-2 border-b border-[#2a2e39]">Breakout threshold</td><td class="px-4 py-2 border-b border-[#2a2e39]">Trend starting</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">0</td><td class="px-4 py-2 border-b border-[#2a2e39]">Mean (baseline)</td><td class="px-4 py-2 border-b border-[#2a2e39]">Trend inflection</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">-100</td><td class="px-4 py-2 border-b border-[#2a2e39]">Breakdown threshold</td><td class="px-4 py-2 border-b border-[#2a2e39]">Trend starting</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">-200</td><td class="px-4 py-2 border-b border-[#2a2e39]">Extremely oversold</td><td class="px-4 py-2 border-b border-[#2a2e39]">Potential exhaustion</td></tr>
</table></div>

<h3 id="timeframe-recommendations">Timeframe Recommendations</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Timeframe</td><td class="px-4 py-2 border-b border-[#2a2e39]">Suitability</td><td class="px-4 py-2 border-b border-[#2a2e39]">Notes</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Daily</td><td class="px-4 py-2 border-b border-[#2a2e39]">Excellent</td><td class="px-4 py-2 border-b border-[#2a2e39]">Primary design</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">4-Hour</td><td class="px-4 py-2 border-b border-[#2a2e39]">Good</td><td class="px-4 py-2 border-b border-[#2a2e39]">Swing trading</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Weekly</td><td class="px-4 py-2 border-b border-[#2a2e39]">Good</td><td class="px-4 py-2 border-b border-[#2a2e39]">Position trading</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">1-Hour</td><td class="px-4 py-2 border-b border-[#2a2e39]">Moderate</td><td class="px-4 py-2 border-b border-[#2a2e39]">Scalping (Woodies)</td></tr>
</table></div>

<hr class="border-[#2a2e39] my-8">

<h2 id="4-market-context">4. Market Context</h2>

<h3 id="best-conditions">Best Conditions</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Condition</td><td class="px-4 py-2 border-b border-[#2a2e39]">Why It Works</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Cyclical Markets</td><td class="px-4 py-2 border-b border-[#2a2e39]">CCI excels at spotting cycles</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Breakouts</td><td class="px-4 py-2 border-b border-[#2a2e39]">±100 cross signals impulse</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Trend Continuation</td><td class="px-4 py-2 border-b border-[#2a2e39]">Zero line hook in trends</td></tr>
</table></div>

<h3 id="limitations">Limitations</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Condition</td><td class="px-4 py-2 border-b border-[#2a2e39]">Problem</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Choppy Markets</td><td class="px-4 py-2 border-b border-[#2a2e39]">Frequent ±100 crosses = whipsaws</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Strong Trends</td><td class="px-4 py-2 border-b border-[#2a2e39]">CCI stays >+100 for extended periods</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Constant Price</td><td class="px-4 py-2 border-b border-[#2a2e39]">Mean deviation = 0, division by zero</td></tr>
</table></div>

<hr class="border-[#2a2e39] my-8">

<h2 id="5-entry-signals">5. Entry Signals</h2>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Signal Type</td><td class="px-4 py-2 border-b border-[#2a2e39]">Condition</td><td class="px-4 py-2 border-b border-[#2a2e39]">Direction</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strength</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Break +100</td><td class="px-4 py-2 border-b border-[#2a2e39]">CCI crosses above +100</td><td class="px-4 py-2 border-b border-[#2a2e39]">Bullish</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strong</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Break -100</td><td class="px-4 py-2 border-b border-[#2a2e39]">CCI crosses below -100</td><td class="px-4 py-2 border-b border-[#2a2e39]">Bearish</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strong</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Zero Line Hook</td><td class="px-4 py-2 border-b border-[#2a2e39]">CCI dips to 0 and bounces</td><td class="px-4 py-2 border-b border-[#2a2e39]">Trend Continuation</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strong</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Zero Cross</td><td class="px-4 py-2 border-b border-[#2a2e39]">CCI crosses above/below 0</td><td class="px-4 py-2 border-b border-[#2a2e39]">Direction of cross</td><td class="px-4 py-2 border-b border-[#2a2e39]">Moderate</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Bullish Divergence</td><td class="px-4 py-2 border-b border-[#2a2e39]">Price LL, CCI HL</td><td class="px-4 py-2 border-b border-[#2a2e39]">Bullish</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strong</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Bearish Divergence</td><td class="px-4 py-2 border-b border-[#2a2e39]">Price HH, CCI LH</td><td class="px-4 py-2 border-b border-[#2a2e39]">Bearish</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strong</td></tr>
</table></div>

<h3 id="lambert's-original-entry-+100-breakout">Lambert's Original Entry (+100 Breakout)</h3>

<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
IF CCI crosses above +100
THEN → BUY (Strong uptrend impulse starting)
Hold until CCI returns inside +100

IF CCI crosses below -100
THEN → SELL (Strong downtrend impulse starting)
Hold until CCI returns inside -100
</code></pre>

<h3 id="zero-line-hook-trend-continuation">Zero Line Hook (Trend Continuation)</h3>

<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
In an uptrend (CCI has been &gt; +100):
&nbsp;&nbsp;CCI falls back toward zero line
&nbsp;&nbsp;CCI curls up BEFORE or AT zero (doesn&#x27;t go deeply negative)
→ BUY continuation signal
→ Trend is resuming without deep correction
</code></pre>

<h3 id="divergence-signal">Divergence Signal</h3>

<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
BEARISH DIVERGENCE:
&nbsp;&nbsp;Price makes Higher High
&nbsp;&nbsp;CCI makes Lower High (usually above +100)
&nbsp;&nbsp;→ Momentum fading
&nbsp;&nbsp;→ SELL or exit longs

BULLISH DIVERGENCE:
&nbsp;&nbsp;Price makes Lower Low
&nbsp;&nbsp;CCI makes Higher Low
&nbsp;&nbsp;→ Momentum building
&nbsp;&nbsp;→ BUY
</code></pre>

<hr class="border-[#2a2e39] my-8">

<h2 id="6-filter-usage">6. Filter Usage</h2>

<p class="mb-4">CCI's unbounded nature requires careful filtering.</p>

<h3 id="filter-rules">Filter Rules</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Rule</td><td class="px-4 py-2 border-b border-[#2a2e39]">Application</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">EMA 50 Trend Filter</td><td class="px-4 py-2 border-b border-[#2a2e39]">Only buy if Price > EMA 50</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Wait for hook back</td><td class="px-4 py-2 border-b border-[#2a2e39]">For reversals, wait for CCI to return inside ±100</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Divergence required</td><td class="px-4 py-2 border-b border-[#2a2e39]">For counter-trend trades</td></tr>
</table></div>

<h3 id="recommended-pairings">Recommended Pairings</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Partner Indicator</td><td class="px-4 py-2 border-b border-[#2a2e39]">Synergy Logic</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Parabolic SAR</td><td class="px-4 py-2 border-b border-[#2a2e39]">CCI for entry, SAR for trailing exit</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Moving Averages</td><td class="px-4 py-2 border-b border-[#2a2e39]">EMA 50 filters trend direction</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Volume</td><td class="px-4 py-2 border-b border-[#2a2e39]">Confirm breakouts with volume expansion</td></tr>
</table></div>

<h3 id="cci-+-psar-strategy">CCI + PSAR Strategy</h3>

<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
ENTRY:
&nbsp;&nbsp;CCI crosses above +100
&nbsp;&nbsp;
EXIT:
&nbsp;&nbsp;Place stop at Parabolic SAR dot
&nbsp;&nbsp;Trail as price rises
&nbsp;&nbsp;
RATIONALE:
&nbsp;&nbsp;CCI is excellent at spotting the impulse start
&nbsp;&nbsp;But poor at signaling exits
&nbsp;&nbsp;PSAR handles exit management efficiently
</code></pre>

<hr class="border-[#2a2e39] my-8">

<h2 id="7-practical-cautions">7. Practical Cautions</h2>

<h3 id="lag-characteristics">Lag Characteristics</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Component</td><td class="px-4 py-2 border-b border-[#2a2e39]">Notes</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">First Valid Value</td><td class="px-4 py-2 border-b border-[#2a2e39]">20 bars (period requirement)</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Responsiveness</td><td class="px-4 py-2 border-b border-[#2a2e39]">Very fast oscillator</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Exit Timing</td><td class="px-4 py-2 border-b border-[#2a2e39]">Poor—stays in extreme zones during trends</td></tr>
</table></div>

<h3 id="false-signal-scenarios">False Signal Scenarios</h3>

<p class="mb-4">1. The +100 Trap  </p>
<p class="mb-4">   Many traders treat +100 as "overbought" and short. Lambert intended +100 as the START of a trend, not the end. Fading the move while CCI is still expanding >+100 is the most common CCI mistake.</p>

<p class="mb-4">2. Division by Zero  </p>
<p class="mb-4">   If all Typical Prices are identical over n periods, Mean Deviation = 0, breaking the formula.</p>

<p class="mb-4">3. Floating Point Precision  </p>
<p class="mb-4">   In extremely low volatility assets, MD can be near-zero (10^-9), causing massive CCI spikes from precision errors.</p>

<h3 id="mitigation-strategies">Mitigation Strategies</h3>

<p class="mb-4">- Never fade a +100 breakout — it's an entry signal, not an exit</p>
<p class="mb-4">- Wait for return inside ±100 before taking reversal trades</p>
<p class="mb-4">- Use EMA 50 trend filter to avoid counter-trend trades</p>
<p class="mb-4">- Handle edge case — return 0 when MD = 0</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="8-pro-insights">8. Pro Insights</h2>

<h3 id="the-+100-is-an-entry,-not-an-exit">The +100 Is an ENTRY, Not an EXIT</h3>

<p class="mb-4">Lambert's original intention: +100 means a new trend is starting. Too many traders treat it as "overbought" and fade. In reality:</p>
<p class="mb-4">- Entering long on +100 cross</p>
<p class="mb-4">- Holding until CCI returns inside +100</p>
<p class="mb-4">- This captures the bulk of trend moves</p>

<h3 id="the-zero-line-reject-zlr">The Zero Line Reject (ZLR)</h3>

<p class="mb-4">In a strong uptrend (CCI has been >+100), watch for CCI to fall back to zero and curl up without going deeply negative. This "Zero Line Reject" is a high-probability trend continuation trade—the pullback was shallow and buyers are stepping back in.</p>

<h3 id="v-tops-detection">V-Tops Detection</h3>

<p class="mb-4">CCI is excellent at identifying V-shaped tops:</p>
<p class="mb-4">- Sharp spike >+200</p>
<p class="mb-4">- Immediate sharp drop <+100</p>

<p class="mb-4">This pattern indicates a climax run followed by rapid reversal. It's a reliable exit signal for climax moves.</p>

<h3 id="woodies-cci">Woodies CCI</h3>

<p class="mb-4">A popular variation using two CCIs:</p>
<p class="mb-4">- CCI(14) as the "trading line"</p>
<p class="mb-4">- CCI(6) as the "trigger line"</p>

<p class="mb-4">Entries occur when the faster CCI crosses the slower, filtered by trend direction.</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="9-summary">9. Summary</h2>

<blockquote class="border-l-4 border-gray-300 pl-4 italic text-gray-700 my-4 bg-gray-50 py-2 pr-2 rounded-r">"CCI measures how unusual the current price is—breakouts above +100 signal trend impulses (not overbought!), while the Zero Line Reject provides high-probability trend continuation entries. Use Parabolic SAR for exits because CCI tells you where to enter, not where to leave."</blockquote>

<p class="mb-4"><h2 class="text-2xl font-bold mt-12 mb-6 border-b pb-2">PART 2: SUPPLEMENTARY GUIDE</h2></p>

<h2 id="1-core-concept">1. Core Concept</h2>

<p class="mb-4">CCI answers: "How far is price from its average, normalized by volatility?"</p>

<p class="mb-4">- CCI > +100: Price is significantly above average (impulse)</p>
<p class="mb-4">- CCI < -100: Price is significantly below average (impulse)</p>
<p class="mb-4">- -100 < CCI < +100: Normal variation (noise channel)</p>

<p class="mb-4">The 0.015 constant creates a standardized scale where ±100 has consistent meaning across all assets and timeframes.</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="2-statistical-edge">2. Statistical Edge</h2>

<h3 id="+100-breakout-performance">+100 Breakout Performance</h3>

<p class="mb-4">Lambert's original strategy (buy +100 cross, hold until return inside):</p>
<p class="mb-4">- Win rate: 55%</p>
<p class="mb-4">- Average winner captures 70% of trend move</p>
<p class="mb-4">- Risk/reward typically 1:2 or better</p>

<h3 id="zero-line-reject">Zero Line Reject</h3>

<p class="mb-4">In established trends, ZLR signals show:</p>
<p class="mb-4">- Win rate: 68%</p>
<p class="mb-4">- Higher win rate because trend is already confirmed</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="3-actionable-strategy">3. Actionable Strategy</h2>

<h3 id="strategy-name:-"cci-impulse-+-sar-exit"">Strategy Name: "CCI Impulse + SAR Exit"</h3>

<p class="mb-4">Entry:</p>
<p class="mb-4">CCI crosses above +100 (Long) or below -100 (Short)</p>

<p class="mb-4">Stop Loss:</p>
<p class="mb-4">Initial stop at Parabolic SAR dot</p>

<p class="mb-4">Exit:</p>
<p class="mb-4">- Trail stop using Parabolic SAR as price moves in favor</p>
<p class="mb-4">- Exit when SAR flips (dots appear on other side)</p>

<p class="mb-4">Why This Works:</p>
<p class="mb-4">CCI excels at identifying impulse starts but provides no exit mechanism. PSAR provides adaptive trailing stops that lock in profits during the trend.</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="4-risks-&-limitations">4. Risks & Limitations</h2>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Risk</td><td class="px-4 py-2 border-b border-[#2a2e39]">Mitigation</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Division by zero (MD=0)</td><td class="px-4 py-2 border-b border-[#2a2e39]">Return 0 when Mean Deviation is zero</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Fading +100 as "overbought"</td><td class="px-4 py-2 border-b border-[#2a2e39]">Understand +100 is entry, not exit</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Floating point issues</td><td class="px-4 py-2 border-b border-[#2a2e39]">Clamp values in low-volatility assets</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Staying >+100 for weeks</td><td class="px-4 py-2 border-b border-[#2a2e39]">Don't use CCI for exits; pair with PSAR</td></tr>
</table></div>

<hr class="border-[#2a2e39] my-8">

<h2 id="5-further-study">5. Further Study</h2>

<h3 id="creator-attribution">Creator Attribution</h3>

<p class="mb-4">Donald Lambert introduced CCI in 1980, published in *Commodities* magazine. Despite the name suggesting commodity focus, CCI works on all asset classes including stocks, forex, and crypto.</p>

<hr class="border-[#2a2e39] my-8">

<h3 id="55-related-indicators-comparison">5.5 Related Indicators Comparison</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Feature</td><td class="px-4 py-2 border-b border-[#2a2e39]">CCI</td><td class="px-4 py-2 border-b border-[#2a2e39]">RSI</td><td class="px-4 py-2 border-b border-[#2a2e39]">Stochastic</td><td class="px-4 py-2 border-b border-[#2a2e39]">CMO</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Range</td><td class="px-4 py-2 border-b border-[#2a2e39]">Unbounded</td><td class="px-4 py-2 border-b border-[#2a2e39]">0-100</td><td class="px-4 py-2 border-b border-[#2a2e39]">0-100</td><td class="px-4 py-2 border-b border-[#2a2e39]">-100 to +100</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Center</td><td class="px-4 py-2 border-b border-[#2a2e39]">0</td><td class="px-4 py-2 border-b border-[#2a2e39]">50</td><td class="px-4 py-2 border-b border-[#2a2e39]">50</td><td class="px-4 py-2 border-b border-[#2a2e39]">0</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Breakout Levels</td><td class="px-4 py-2 border-b border-[#2a2e39]">±100</td><td class="px-4 py-2 border-b border-[#2a2e39]">70/30</td><td class="px-4 py-2 border-b border-[#2a2e39]">80/20</td><td class="px-4 py-2 border-b border-[#2a2e39]">±50</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Volatility Adjusted</td><td class="px-4 py-2 border-b border-[#2a2e39]">Yes (via MD)</td><td class="px-4 py-2 border-b border-[#2a2e39]">No</td><td class="px-4 py-2 border-b border-[#2a2e39]">No</td><td class="px-4 py-2 border-b border-[#2a2e39]">No</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Best For</td><td class="px-4 py-2 border-b border-[#2a2e39]">Impulse detection</td><td class="px-4 py-2 border-b border-[#2a2e39]">Trend strength</td><td class="px-4 py-2 border-b border-[#2a2e39]">Reversals</td><td class="px-4 py-2 border-b border-[#2a2e39]">Raw momentum</td></tr>
</table></div>

<p class="mb-4">When to use CCI over alternatives:</p>
<p class="mb-4">- When you need volatility-adjusted readings</p>
<p class="mb-4">- When detecting trend impulses (not just overbought/oversold)</p>
<p class="mb-4">- When trading cyclical markets</p>

<p class="mb-4"><h2 class="text-2xl font-bold mt-12 mb-6 border-b pb-2">PART 3: ADVANCED SIGNAL REFERENCE</h2></p>

<h2 id="advanced-signal-reference">Advanced Signal Reference</h2>

<h3 id="threshold-matrix">Threshold Matrix</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">CCI Value</td><td class="px-4 py-2 border-b border-[#2a2e39]">Context</td><td class="px-4 py-2 border-b border-[#2a2e39]">Interpretation</td><td class="px-4 py-2 border-b border-[#2a2e39]">Action</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">> +200</td><td class="px-4 py-2 border-b border-[#2a2e39]">Any</td><td class="px-4 py-2 border-b border-[#2a2e39]">Extreme overbought/climax</td><td class="px-4 py-2 border-b border-[#2a2e39]">Watch for V-top</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">+100 to +200</td><td class="px-4 py-2 border-b border-[#2a2e39]">Uptrend</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strong impulse</td><td class="px-4 py-2 border-b border-[#2a2e39]">Hold longs</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Crossing +100 up</td><td class="px-4 py-2 border-b border-[#2a2e39]">Any</td><td class="px-4 py-2 border-b border-[#2a2e39]">Breakout signal</td><td class="px-4 py-2 border-b border-[#2a2e39]">Enter long</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">0 to +100</td><td class="px-4 py-2 border-b border-[#2a2e39]">Uptrend</td><td class="px-4 py-2 border-b border-[#2a2e39]">Noise zone or pullback</td><td class="px-4 py-2 border-b border-[#2a2e39]">ZLR setup</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Crossing 0</td><td class="px-4 py-2 border-b border-[#2a2e39]">Any</td><td class="px-4 py-2 border-b border-[#2a2e39]">Trend inflection</td><td class="px-4 py-2 border-b border-[#2a2e39]">Mild signal</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">-100 to 0</td><td class="px-4 py-2 border-b border-[#2a2e39]">Downtrend</td><td class="px-4 py-2 border-b border-[#2a2e39]">Noise zone or rally</td><td class="px-4 py-2 border-b border-[#2a2e39]">ZLR setup (short)</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Crossing -100 down</td><td class="px-4 py-2 border-b border-[#2a2e39]">Any</td><td class="px-4 py-2 border-b border-[#2a2e39]">Breakdown signal</td><td class="px-4 py-2 border-b border-[#2a2e39]">Enter short</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">< -200</td><td class="px-4 py-2 border-b border-[#2a2e39]">Any</td><td class="px-4 py-2 border-b border-[#2a2e39]">Extreme oversold/panic</td><td class="px-4 py-2 border-b border-[#2a2e39]">Watch for V-bottom</td></tr>
</table></div>

<h3 id="signal-patterns">Signal Patterns</h3>

<h4 id="±100-breakout-detection">±100 Breakout Detection</h4>
<p class="mb-4">Lambert designed the ±100 levels as entry signals, not overbought/oversold warnings. When CCI breaks above +100, it signals the start of a strong uptrend impulse—not the end. This understanding is crucial: the most common CCI mistake is fading the +100 breakout instead of riding it.</p>

<h4 id="zero-line-reject-zlr-pattern">Zero Line Reject (ZLR) Pattern</h4>
<p class="mb-4">The Zero Line Reject is the highest-probability CCI continuation signal. After establishing a trend (CCI > +100), a pullback that approaches zero but bounces before going deeply negative indicates a shallow correction with buyers stepping back in. ZLR signals show a 68% win rate in established trends.</p>

<h4 id="divergence-detection">Divergence Detection</h4>
<p class="mb-4">CCI divergences provide early warning of momentum exhaustion. Unlike bounded oscillators that flatten near extremes, CCI continues measuring deviation, making divergences especially meaningful. Bearish divergences from above +100 are particularly reliable exit signals.</p>

<h4 id="v-top-detection">V-Top Detection</h4>
<p class="mb-4">Sharp CCI spikes above +200 followed by immediate drops below +100 identify climax moves. This V-shaped pattern indicates a final burst of buying followed by rapid exhaustion—a reliable signal to exit trend trades and watch for reversal setups.</p>

<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-python">
def cci_breakout(cci_values, threshold=100):
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Detect ±100 breakout signals&quot;&quot;&quot;
&nbsp;&nbsp;&nbsp;&nbsp;break_up = cci_values[-2] &lt;= threshold and cci_values[-1] &gt; threshold
&nbsp;&nbsp;&nbsp;&nbsp;break_down = cci_values[-2] &gt;= -threshold and cci_values[-1] &lt; -threshold
&nbsp;&nbsp;&nbsp;&nbsp;return break_up, break_down

def cci_zero_line_reject(cci_values, trend_threshold=100, recent_bars=10):
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Detect Zero Line Reject in uptrend&quot;&quot;&quot;
&nbsp;&nbsp;&nbsp;&nbsp;# Was above +100 recently
&nbsp;&nbsp;&nbsp;&nbsp;was_trending = any(v &gt; trend_threshold for v in cci_values[-recent_bars:-3])
&nbsp;&nbsp;&nbsp;&nbsp;# Approached zero
&nbsp;&nbsp;&nbsp;&nbsp;approached_zero = any(abs(v) &lt; 50 for v in cci_values[-3:-1])
&nbsp;&nbsp;&nbsp;&nbsp;# Now turning up
&nbsp;&nbsp;&nbsp;&nbsp;turning_up = cci_values[-1] &gt; cci_values[-2] &gt; 0
&nbsp;&nbsp;&nbsp;&nbsp;return was_trending and approached_zero and turning_up

def cci_divergence(prices, cci_values, lookback=20):
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Detect bullish/bearish divergences&quot;&quot;&quot;
&nbsp;&nbsp;&nbsp;&nbsp;price_hh = prices[-1] &gt; max(prices[-lookback:-1])
&nbsp;&nbsp;&nbsp;&nbsp;cci_lh = cci_values[-1] &lt; max(cci_values[-lookback:-1])
&nbsp;&nbsp;&nbsp;&nbsp;bearish_div = price_hh and cci_lh
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;price_ll = prices[-1] &lt; min(prices[-lookback:-1])
&nbsp;&nbsp;&nbsp;&nbsp;cci_hl = cci_values[-1] &gt; min(cci_values[-lookback:-1])
&nbsp;&nbsp;&nbsp;&nbsp;bullish_div = price_ll and cci_hl
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;return bullish_div, bearish_div

def cci_v_top(cci_values, spike_threshold=200):
&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;Detect V-shaped top pattern&quot;&quot;&quot;
&nbsp;&nbsp;&nbsp;&nbsp;spiked = cci_values[-2] &gt; spike_threshold
&nbsp;&nbsp;&nbsp;&nbsp;dropped = cci_values[-1] &lt; 100
&nbsp;&nbsp;&nbsp;&nbsp;return spiked and dropped
</code></pre>

<h3 id="screening-filters">Screening Filters</h3>

<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
// Impulse Breakout Scanner
IF (CCI(20) crosses above +100)
AND (Price &gt; EMA(50))
THEN Signal = BULLISH_IMPULSE

// Zero Line Reject Scanner
IF (CCI(20) &gt; 0) AND (CCI(20) &lt; 50)
AND (CCI(20) &gt; CCI(20)[1])
AND (CCI(20) was &gt; +100 within last 10 bars)
THEN Signal = ZERO_LINE_REJECT_BUY

// V-Top Detection
IF (CCI(20)[1] &gt; +200)
AND (CCI(20) &lt; +100)
THEN Signal = POTENTIAL_V_TOP

// Woodies CCI Entry
CCI_Trend = CCI(14)
CCI_Entry = CCI(6)
IF (CCI_Entry crosses above CCI_Trend)
AND (CCI_Trend &gt; 0)
THEN Signal = WOODIES_BUY
</code></pre>

<h3 id="combination-strategies">Combination Strategies</h3>

<h4 id="cci-+-parabolic-sar-system">CCI + Parabolic SAR System</h4>
<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
ENTRY:
&nbsp;&nbsp;CCI(20) crosses above +100
&nbsp;&nbsp;→ BUY at next bar open

STOP:
&nbsp;&nbsp;Initial stop at Parabolic SAR dot

MANAGEMENT:
&nbsp;&nbsp;Trail stop using SAR
&nbsp;&nbsp;As price rises, SAR accelerates

EXIT:
&nbsp;&nbsp;SAR flips to above price
&nbsp;&nbsp;→ Exit trade
</code></pre>

<h4 id="cci-+-ema-50-trend-filter">CCI + EMA 50 Trend Filter</h4>
<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
LONG MODE (Price &gt; EMA 50):
&nbsp;&nbsp;Take +100 breakout signals
&nbsp;&nbsp;Take Zero Line Reject signals
&nbsp;&nbsp;Ignore -100 signals (treat as pullback)

SHORT MODE (Price &lt; EMA 50):
&nbsp;&nbsp;Take -100 breakdown signals
&nbsp;&nbsp;Take Zero Line Reject signals (short version)
&nbsp;&nbsp;Ignore +100 signals (treat as rally)
</code></pre>

<h4 id="cci-zero-line-hook-system">CCI Zero Line Hook System</h4>
<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
UPTREND CONTEXT:
&nbsp;&nbsp;CCI has been &gt; +100 recently
&nbsp;&nbsp;CCI dips toward zero (never &lt; -50)
&nbsp;&nbsp;CCI turns up from zero area

ENTRY:
&nbsp;&nbsp;First bar where CCI &gt; CCI[1] while in 0-50 zone
&nbsp;&nbsp;→ BUY

STOP:
&nbsp;&nbsp;Below swing low formed during pullback

TARGET:
&nbsp;&nbsp;CCI returns above +100
&nbsp;&nbsp;OR trail with EMA 20
</code></pre>






                    </div>
                </article>
                <!-- Right: Sticky TOC -->
                <aside class="hidden lg:block w-64 flex-shrink-0">
                    <div class="sticky top-24">
                        <h3 class="font-bold text-slate-900 mb-4 pb-2 border-b border-slate-100 text-sm uppercase tracking-wider">
                            On this page
                        </h3>
                        <nav id="toc-nav" class="space-y-1 text-sm text-slate-600">
                            <a href="#1-identity" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">1. Identity</a>
<a href="#2-calculation-logic" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">2. Calculation Logic</a>
<a href="#formula" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Formula</a>
<a href="#the-0015-constant" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">The 0.015 Constant</a>
<a href="#real-world-analogy" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Real-World Analogy</a>
<a href="#3-market-standards" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">3. Market Standards</a>
<a href="#default-parameters" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Default Parameters</a>
<a href="#alternative-parameters" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Alternative Parameters</a>
<a href="#key-levels" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Key Levels</a>
<a href="#timeframe-recommendations" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Timeframe Recommendations</a>
<a href="#4-market-context" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">4. Market Context</a>
<a href="#best-conditions" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Best Conditions</a>
<a href="#limitations" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Limitations</a>
<a href="#5-entry-signals" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">5. Entry Signals</a>
<a href="#lambert's-original-entry-+100-breakout" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Lambert's Original Entry (+100 Breakout)</a>
<a href="#zero-line-hook-trend-continuation" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Zero Line Hook (Trend Continuation)</a>
<a href="#divergence-signal" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Divergence Signal</a>
<a href="#6-filter-usage" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">6. Filter Usage</a>
<a href="#filter-rules" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Filter Rules</a>
<a href="#recommended-pairings" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Recommended Pairings</a>
<a href="#cci-+-psar-strategy" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">CCI + PSAR Strategy</a>
<a href="#7-practical-cautions" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">7. Practical Cautions</a>
<a href="#lag-characteristics" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Lag Characteristics</a>
<a href="#false-signal-scenarios" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">False Signal Scenarios</a>
<a href="#mitigation-strategies" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Mitigation Strategies</a>
<a href="#8-pro-insights" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">8. Pro Insights</a>
<a href="#the-+100-is-an-entry,-not-an-exit" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">The +100 Is an ENTRY, Not an EXIT</a>
<a href="#the-zero-line-reject-zlr" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">The Zero Line Reject (ZLR)</a>
<a href="#v-tops-detection" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">V-Tops Detection</a>
<a href="#woodies-cci" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Woodies CCI</a>
<a href="#9-summary" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">9. Summary</a>
<a href="#1-core-concept" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">1. Core Concept</a>
<a href="#2-statistical-edge" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">2. Statistical Edge</a>
<a href="#+100-breakout-performance" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">+100 Breakout Performance</a>
<a href="#zero-line-reject" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Zero Line Reject</a>
<a href="#3-actionable-strategy" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">3. Actionable Strategy</a>
<a href="#strategy-name:-"cci-impulse-+-sar-exit"" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Strategy Name: "CCI Impulse + SAR Exit"</a>
<a href="#4-risks-&-limitations" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">4. Risks & Limitations</a>
<a href="#5-further-study" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">5. Further Study</a>
<a href="#creator-attribution" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Creator Attribution</a>
<a href="#55-related-indicators-comparison" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">5.5 Related Indicators Comparison</a>
<a href="#advanced-signal-reference" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">Advanced Signal Reference</a>
<a href="#threshold-matrix" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Threshold Matrix</a>
<a href="#signal-patterns" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Signal Patterns</a>
<a href="#screening-filters" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Screening Filters</a>
<a href="#combination-strategies" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Combination Strategies</a>

                        </nav>
                        <div class="mt-8 pt-4 border-t border-slate-100">
                            <a href="#" class="text-xs text-slate-400 hover:text-indigo-600 flex items-center transition-colors">
                                Back to Top
                            </a>
                        </div>
                    </div>
                </aside>
            </div>
        </section>


    </div>

    <!-- Footer -->
    <footer class="bg-white border-t border-slate-200 mt-12">
        <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
            <p class="text-center text-slate-400 text-sm">
                &copy; 2023-2025 I ant I Investigates. All rights reserved.
            </p>
        </div>
    </footer>

    <!-- ========================================== -->
    <!-- 1. DATA & LOGIC INJECTION                  -->
    <!-- ========================================== -->
    <script>
        window.IndicatorLogic = {
            name: "CommodityChannelIndex",
            params: [],
            calculate: null
        };
        (function() {
            try {
                const injectedCode = `
        window.IndicatorLogic = {
            calculate: (data, params) => {
                const period = params.period || 20;
                const constant = 0.015;
                // Calculate Typical Price
                const tp = data.map(d => (d.high + d.low + d.close) / 3);
                const cci = data.map((d, i) => {
                    if (i < period - 1) return null;
                    // SMA of TP
                    let sumTP = 0;
                    for (let j = 0; j < period; j++) sumTP += tp[i - j];
                    const smaTP = sumTP / period;
                    // Mean Deviation
                    let sumDev = 0;
                    for (let j = 0; j < period; j++) sumDev += Math.abs(tp[i - j] - smaTP);
                    const meanDev = sumDev / period;
                    // CCI Formula
                    if (meanDev === 0) return 0;
                    return (tp[i] - smaTP) / (constant * meanDev);
                });
                return { cci };
            }
        };
        `;
                const isTemplatePlaceholder = injectedCode.includes('{{') && injectedCode.includes('PLAYGROUND_LOGIC');
                if (injectedCode && injectedCode.trim().length > 0 && !isTemplatePlaceholder) {
                    new Function(injectedCode)();
                } else {
                    console.warn("Playground Logic: Running in Preview/Fallback mode.");
                    window.IndicatorLogic.calculate = () => []; 
                }
            } catch (e) {
                console.error("Critical Error in Logic Injection:", e);
                window.IndicatorLogic.calculate = () => [];
            }
        })();
    </script>

    <!-- ========================================== -->
    <!-- 2. VISUALIZATION ENGINE                    -->
    <!-- ========================================== -->
    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'neutral', securityLevel: 'loose' });
    </script>

    <!-- ========================================== -->
    <!-- 3. UI CONTROLLERS & APP INITIALIZATION     -->
    <!-- ========================================== -->
    <script src="../../assets/js/script.js" defer></script>
    <!-- INLINE UI CONTROLLERS (PORTED FROM 0117) -->
    <script>
        // --- 0. Indicator Data Injection ---
        // These are populated by the generator script
        var IndicatorLogic = {};
        var IndicatorConfig = [];
        var IndicatorDisplay = { isOverlay: false, plots: {} };

        // 1. Library Code (e.g. class definitions)
        // No library code for verification

        // 2. Configuration
        try {
            var rawConfig = '[{"id": "period", "label": "Period (20)", "type": "number", "value": 20, "min": 5, "max": 100}]';
            if(rawConfig && !rawConfig.startsWith('{{')) IndicatorConfig = JSON.parse(rawConfig);
        } catch(e){ console.warn('Config parse error', e); }

        try {
            var rawDisplay = '{"isOverlay": false, "plots": {"cci": {"label": "CCI", "color": "#3b82f6", "type": "line"}}}';
            if(rawDisplay && !rawDisplay.startsWith('{{')) IndicatorDisplay = JSON.parse(rawDisplay);
        } catch(e){ console.warn('Display parse error', e); }

        // 3. Logic Adapter
        window.IndicatorLogic = {
            calculate: (data, params) => {
                const period = params.period || 20;
                const constant = 0.015;
                // Calculate Typical Price
                const tp = data.map(d => (d.high + d.low + d.close) / 3);
                const cci = data.map((d, i) => {
                    if (i < period - 1) return null;
                    // SMA of TP
                    let sumTP = 0;
                    for (let j = 0; j < period; j++) sumTP += tp[i - j];
                    const smaTP = sumTP / period;
                    // Mean Deviation
                    let sumDev = 0;
                    for (let j = 0; j < period; j++) sumDev += Math.abs(tp[i - j] - smaTP);
                    const meanDev = sumDev / period;
                    // CCI Formula
                    if (meanDev === 0) return 0;
                    return (tp[i] - smaTP) / (constant * meanDev);
                });
                return { cci };
            }
        };
    </script>

    <script>
        // --- 1. Code Panel Logic ---
        const AppState = {
            activeLang: 'csharp',
            codeType: 'simple',
            isPanelVisible: false,  // Start hidden to show flowchart
            isPanelExpanded: false,
        };

        // --- 2. Canvas State (Full Pan/Zoom from 0117) ---
        const CanvasState = {
            scale: 1, panX: 0, panY: 0,
            isDragging: false, startX: 0, startY: 0,
            minScale: 0.1, maxScale: 5.0
        };

        // Element references (populated after DOM ready)
        let els = {};

        function updateView() {
            // 1. Code Content Visibility
            document.querySelectorAll('.code-content').forEach(el => el.classList.add('hidden'));
            const activeId = `code-${AppState.activeLang}-${AppState.codeType}`;
            const activeEl = document.getElementById(activeId);
            if (activeEl) activeEl.classList.remove('hidden');

            // 2. Overlay Visibility
            const overlay = document.getElementById('code-panel-overlay');
            if (overlay) {
                if (AppState.isPanelVisible) overlay.classList.remove('panel-hidden');
                else overlay.classList.add('panel-hidden');

                if (AppState.isPanelExpanded) {
                    overlay.classList.add('panel-expanded');
                    const iconExp = document.getElementById('icon-expand');
                    const iconCol = document.getElementById('icon-collapse');
                    if(iconExp) iconExp.classList.add('hidden');
                    if(iconCol) iconCol.classList.remove('hidden');
                } else {
                    overlay.classList.remove('panel-expanded');
                    const iconExp = document.getElementById('icon-expand');
                    const iconCol = document.getElementById('icon-collapse');
                    if(iconExp) iconExp.classList.remove('hidden');
                    if(iconCol) iconCol.classList.add('hidden');
                }
            }

            // 3. Button States
            const btnCs = document.getElementById('btn-lang-csharp');
            const btnPy = document.getElementById('btn-lang-python');
            [btnCs, btnPy].forEach(btn => {
                if(btn) btn.className = "px-2 py-1 text-xs rounded transition-colors text-slate-500 hover:bg-slate-100";
            });

            if (AppState.activeLang === 'csharp' && btnCs) {
                btnCs.className = "px-2 py-1 text-xs rounded transition-colors btn-lang-active";
            } else if (AppState.activeLang === 'python' && btnPy) {
                btnPy.className = "px-2 py-1 text-xs rounded transition-colors btn-lang-active";
            }

            const btnSimple = document.getElementById('btn-type-simple');
            const btnDetailed = document.getElementById('btn-type-detailed');
            if(btnSimple) btnSimple.className = `text-xs transition-colors ${AppState.codeType === 'simple' ? 'btn-type-active' : 'text-slate-500 hover:text-indigo-600'}`;
            if(btnDetailed) btnDetailed.className = `text-xs transition-colors ${AppState.codeType === 'detailed' ? 'btn-type-active' : 'text-slate-500 hover:text-indigo-600'}`;
        }

        // Global exports for inline onclick handlers
        window.setLang = (lang) => { AppState.activeLang = lang; updateView(); }
        window.setType = (type) => { AppState.codeType = type; updateView(); }
        window.toggleCodePanel = () => { AppState.isPanelVisible = !AppState.isPanelVisible; updateView(); }
        window.toggleExpand = () => { AppState.isPanelExpanded = !AppState.isPanelExpanded; updateView(); }
        window.copyCode = async () => {
            const activeId = `code-${AppState.activeLang}-${AppState.codeType}`;
            const el = document.getElementById(activeId);
            if (!el) return;
            let text = "";
            const lines = el.querySelectorAll('.code-line');
            if (lines.length > 0) {
                text = Array.from(lines).map(line => line.textContent).join('\n');
            } else {
                text = el.textContent;
            }
            try {
                await navigator.clipboard.writeText(text);
                const iconCopy = document.getElementById('icon-copy');
                const iconDone = document.getElementById('icon-copy-done');
                if (iconCopy && iconDone) {
                    iconCopy.classList.add('hidden');
                    iconDone.classList.remove('hidden');
                    setTimeout(() => {
                        iconCopy.classList.remove('hidden');
                        iconDone.classList.add('hidden');
                    }, 2000);
                }
            } catch (err) { console.error("Failed to copy:", err); }
        }

        // --- Canvas Transform Functions (Full Pan/Zoom) ---
        // PlaygroundController (Ported from template_0117.html)
        window.PlaygroundController = {
            instanceChart: null,
            showError: (msg) => {
                console.error('Playground Error:', msg);
                const outputEl = document.getElementById('output-data');
                if (outputEl) outputEl.value = 'Error: ' + msg;
            },
            clearError: () => {},
            init: () => {
                try {
                    // 1. Render Dynamic Settings if Config exists
                    const settingsContainer = document.getElementById('settings-container');
                    if (IndicatorConfig && Array.isArray(IndicatorConfig) && IndicatorConfig.length > 0 && settingsContainer) {
                        settingsContainer.innerHTML = ''; // Clear default "Period"
                        IndicatorConfig.forEach(cfg => {
                            const div = document.createElement('div');
                            div.className = "flex flex-col";
                            const label = document.createElement('label');
                            label.className = "text-xs text-slate-400 mb-1";
                            label.textContent = cfg.label;
                            const input = document.createElement('input');
                            input.id = `param-${cfg.id}`;
                            input.type = cfg.type || "number";
                            // Light theme styling to match textarea
                            input.className = "bg-white border border-slate-300 rounded px-2 py-1 text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow";
                            input.value = cfg.value;
                            if(cfg.min !== undefined) input.min = cfg.min;
                            if(cfg.max !== undefined) input.max = cfg.max;
                            // Add change listener to auto-update
                            input.addEventListener('change', PlaygroundController.update);
                            div.appendChild(label);
                            div.appendChild(input);
                            settingsContainer.appendChild(div);
                        });
                    }

                    // 2. Generate Initial Random Sample Data (Default to Single for simplicity, or OHLCV)
                    PlaygroundController.generateSample('ohlcv'); // Default to OHLCV for robustness
                } catch(e) { PlaygroundController.showError(e.message); }
            },
            generateSample: (type) => {
                 const sampleData = [];
                 const count = 150; 
                 let price = 100;
                 if (type === 'ohlcv') {
                    // OHLCV Generation
                    sampleData.push("Date,Open,High,Low,Close,Volume");
                    const now = new Date();
                    for (let i = 0; i < count; i++) {
                        const date = new Date(now.getTime() - (count - i) * 86400000).toISOString().split('T')[0];
                        const trend = Math.sin(i * 0.1) * 2;
                        const noise = (Math.random() - 0.5) * 2;
                        const close = 100 + trend + noise + (i * 0.1); 
                        const open = close + (Math.random() - 0.5);
                        const high = Math.max(open, close) + Math.random();
                        const low = Math.min(open, close) - Math.random();
                        const vol = Math.floor(1000 + Math.random() * 500);
                        sampleData.push(`${date},${open.toFixed(2)},${high.toFixed(2)},${low.toFixed(2)},${close.toFixed(2)},${vol}`);
                    }
                 } else { 
                    // Single Value Generation
                    for (let i = 0; i < count; i++) {
                        price = price + (Math.random() - 0.5) * 5;
                        sampleData.push(price.toFixed(2));
                    }
                 }
                 const inputEl = document.getElementById('input-data');
                 if (inputEl) inputEl.value = sampleData.join('\n');
                 PlaygroundController.update();
            },
            update: () => {
                PlaygroundController.clearError();
                // Dynamic Params Collection
                const params = {};
                if (IndicatorConfig && Array.isArray(IndicatorConfig) && IndicatorConfig.length > 0) {
                    IndicatorConfig.forEach(cfg => {
                        const el = document.getElementById(`param-${cfg.id}`);
                        if (el) params[cfg.id] = parseFloat(el.value);
                    });
                } else {
                    // Fallback to default Period if no config
                    const periodEl = document.getElementById('param-period');
                    params.period = periodEl ? parseInt(periodEl.value) || 14 : 14;
                }

                const rawData = document.getElementById('input-data').value.trim();
                let lines = [];
                // Robust split: handle comma, newline, or mixed
                if (rawData.includes('\n')) {
                    // Split by newline first
                    lines = rawData.split('\n').map(l => l.trim()).filter(l => l);
                    // If it's NOT multi-column (header check), and lines contain commas, try to flatten
                    const firstVal = parseFloat(lines[0].split(/[,\t]/)[0]);
                    const isHeader = isNaN(firstVal) && /[a-zA-Z]/.test(lines[0]);
                    if (!isHeader && lines.some(l => l.includes(','))) {
                        // Flatten mixed content like "100, 101\n102, 103"
                        lines = rawData.split(/[\n,]+/).map(l => l.trim()).filter(l => l);
                    }
                } else {
                    // Single line, split by comma
                    lines = rawData.split(',').map(l => l.trim()).filter(l => l);
                }

                let parsedData = [];
                const firstLine = lines[0] || "";
                const firstVal = parseFloat(firstLine.split(/[,\t]/)[0]);
                const isMultiColumn = isNaN(firstVal) && /[a-zA-Z]/.test(firstLine);

                if (isMultiColumn && lines.length > 1) {
                    const headers = firstLine.split(/[,\t]+/).map(h => h.trim().toLowerCase());
                    for (let i = 1; i < lines.length; i++) {
                        const parts = lines[i].split(/[,\t]+/).map(v => parseFloat(v));
                        if (parts.some(isNaN)) continue;
                        const row = { time: i - 1 };
                        headers.forEach((h, idx) => { row[h] = parts[idx]; });
                        if (row.close === undefined && row.c !== undefined) row.close = row.c;
                        parsedData.push(row);
                    }
                } else {
                    parsedData = lines.map((l, i) => {
                        const val = parseFloat(l);
                        return isNaN(val) ? null : { time: i, close: val };
                    }).filter(d => d);
                }

                if (parsedData.length < 2) {
                    PlaygroundController.showError("Insufficient data.");
                    return;
                }

                let indicatorValues = [];
                try {
                    if (typeof IndicatorLogic !== 'undefined' && IndicatorLogic.calculate) {
                        indicatorValues = IndicatorLogic.calculate(parsedData, params);
                    } else {
                        // Fallback: Simple RSI calculation for demo
                        indicatorValues = PlaygroundController.calculateRSI(parsedData, params.period);
                    }
                } catch (e) {
                    console.error("Calculation Error", e);
                    PlaygroundController.showError("Calculation Error: " + e.message);
                    return;
                }

                // --- Format Output (CSV/TSV for Excel) ---
                const outputEl = document.getElementById('output-data');
                // --- Format Output (CSV/TSV for Excel) ---
                if (outputEl) {
                    if (Array.isArray(indicatorValues)) {
                        // Single Array (e.g. RSI)
                        outputEl.value = indicatorValues.map(v => v === null ? "" : v).join('\n');
                    } else if (typeof indicatorValues === 'object') {
                        // Multi-line Object (e.g. Ichimoku)
                        const keys = Object.keys(indicatorValues);
                        if (keys.length === 0) {
                            outputEl.value = "";
                        } else {
                            const length = indicatorValues[keys[0]].length;
                            // Comma separated as requested by user
                            const separator = ','; 
                            let csv = keys.join(separator) + '\n';
                            for (let i = 0; i < length; i++) {
                                const row = keys.map(k => {
                                    const val = indicatorValues[k][i];
                                    // Handle missing/undefined
                                    return (val === null || val === undefined) ? "" : val;
                                });
                                csv += row.join(separator) + '\n';
                            }
                            outputEl.value = csv;
                        }
                    } else {
                        outputEl.value = JSON.stringify(indicatorValues, null, 2);
                    }
                }
                PlaygroundController.renderChart(parsedData, indicatorValues);
            },
            calculateRSI: (data, period) => {
                // Simple RSI fallback
                const values = [];
                values.push(null); // First value is null
                if (data.length < 2) return values;
                let sumGains = 0, sumLosses = 0;
                for (let i = 1; i < data.length; i++) {
                    const change = data[i].close - data[i-1].close;
                    const gain = change > 0 ? change : 0;
                    const loss = change < 0 ? -change : 0;
                    if (i < period) {
                        sumGains += gain; sumLosses += loss;
                        values.push(null);
                        continue;
                    }
                    if (i === period) {
                        sumGains += gain; sumLosses += loss;
                        const avgGain = sumGains / period;
                        const avgLoss = sumLosses / period;
                        const rs = avgLoss < 0.0001 ? 100 : avgGain / avgLoss;
                        values.push(100 - (100 / (1 + rs)));
                        sumGains = avgGain; sumLosses = avgLoss;
                        continue;
                    }
                    sumGains = (sumGains * (period - 1) + gain) / period;
                    sumLosses = (sumLosses * (period - 1) + loss) / period;
                    const rs = sumLosses < 0.0001 ? 100 : sumGains / sumLosses;
                    values.push(100 - (100 / (1 + rs)));
                }
                return values;
            },
            renderChart: (prices, indicatorValues) => {
                const canvas = document.getElementById('indicatorChart');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const labels = prices.map((_, i) => i);
                if (PlaygroundController.instanceChart) PlaygroundController.instanceChart.destroy();

                const datasets = [];
                // 1. Overlay: Close Price (if enabled)
                if (IndicatorDisplay && IndicatorDisplay.isOverlay) {
                    datasets.push({
                        label: 'Close Price',
                        data: prices.map(p => p.close),
                        borderColor: '#94a3b8', // slate-400
                        backgroundColor: 'transparent',
                        borderDash: [5, 5],
                        borderWidth: 1,
                        pointRadius: 0,
                        tension: 0.1
                    });
                }

                // 2. Indicator Data
                const defaultColors = ['#4F46E5', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'];
                if (Array.isArray(indicatorValues)) {
                    datasets.push({
                        label: 'Indicator',
                        data: indicatorValues,
                        borderColor: IndicatorDisplay.plots && IndicatorDisplay.plots.main ? IndicatorDisplay.plots.main.color : '#4F46E5',
                        backgroundColor: 'transparent',
                        tension: 0.1, pointRadius: 0, borderWidth: 2
                    });
                } else if (typeof indicatorValues === 'object' && indicatorValues !== null) {
                    // Multi-line indicator (e.g., Bollinger Bands, Parabolic SAR)
                    Object.keys(indicatorValues).forEach((key, idx) => {
                        const conf = (IndicatorDisplay.plots && IndicatorDisplay.plots[key]) || {};
                        const color = conf.color || defaultColors[idx % defaultColors.length];
                        const isScatter = conf.type === 'scatter';
                        // For scatter type, convert data to {x, y} format
                        let chartData;
                        if (isScatter) {
                            chartData = indicatorValues[key]
                                .map((val, i) => val !== null && val !== undefined ? { x: i, y: val } : null)
                                .filter(p => p !== null);
                        } else {
                            chartData = indicatorValues[key];
                        }
                        datasets.push({
                            label: conf.label || key,
                            data: chartData,
                            type: isScatter ? 'scatter' : (conf.type || 'line'),
                            borderColor: isScatter ? 'transparent' : color,
                            backgroundColor: isScatter ? color : 'transparent',
                            pointRadius: isScatter ? (conf.pointRadius || 5) : 0,
                            pointBorderWidth: 0,
                            tension: 0.1,
                            borderWidth: isScatter ? 0 : 2
                        });
                    });
                }

                PlaygroundController.instanceChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: labels, datasets: datasets },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        scales: {
                            y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Value' } }
                        }
                    }
                });
            }
        };

        function updateTransform() {
            if (els.content) {
                els.content.style.transform = `translate(${CanvasState.panX}px, ${CanvasState.panY}px) scale(${CanvasState.scale})`;
            }
        }

        function handleWheel(e) {
            e.preventDefault();
            const rect = els.container.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            const zoomSensitivity = 0.001;
            const delta = -e.deltaY * zoomSensitivity;
            let newScale = CanvasState.scale * (1 + delta);
            newScale = Math.max(CanvasState.minScale, Math.min(CanvasState.maxScale, newScale));
            const scaleRatio = newScale / CanvasState.scale;
            CanvasState.panX = mouseX - (mouseX - CanvasState.panX) * scaleRatio;
            CanvasState.panY = mouseY - (mouseY - CanvasState.panY) * scaleRatio;
            CanvasState.scale = newScale;
            updateTransform();
        }

        function startDrag(e) {
            if (e.button !== 0 && e.button !== 1) return;
            CanvasState.isDragging = true;
            CanvasState.startX = e.clientX;
            CanvasState.startY = e.clientY;
            els.container.style.cursor = 'grabbing';
        }

        function drag(e) {
            if (!CanvasState.isDragging) return;
            e.preventDefault();
            const dx = e.clientX - CanvasState.startX;
            const dy = e.clientY - CanvasState.startY;
            CanvasState.panX += dx;
            CanvasState.panY += dy;
            CanvasState.startX = e.clientX;
            CanvasState.startY = e.clientY;
            updateTransform();
        }

        function stopDrag() {
            CanvasState.isDragging = false;
            if (els.container) els.container.style.cursor = 'grab';
        }

        window.zoomAction = (direction) => {
            if (!els.container || !els.content) return;
            const factor = direction === 'in' ? 1.2 : 0.8;
            let newScale = CanvasState.scale * factor;
            newScale = Math.max(CanvasState.minScale, Math.min(CanvasState.maxScale, newScale));
            const rect = els.container.getBoundingClientRect();
            const cx = rect.width / 2;
            const cy = rect.height / 2;
            const scaleRatio = newScale / CanvasState.scale;
            CanvasState.panX = cx - (cx - CanvasState.panX) * scaleRatio;
            CanvasState.panY = cy - (cy - CanvasState.panY) * scaleRatio;
            CanvasState.scale = newScale;
            updateTransform();
        }

        window.resetView = () => { centerContent(); }

        function centerContent() {
            if (!els.content || !els.container) return;
            const containerRect = els.container.getBoundingClientRect();
            const unscaledWidth = els.content.scrollWidth;
            const unscaledHeight = els.content.scrollHeight;
            let initialScale = 1.0;
            if (unscaledWidth > containerRect.width) {
                initialScale = (containerRect.width / unscaledWidth) * 0.9;
            }
            initialScale = Math.max(0.5, Math.min(1.0, initialScale));
            CanvasState.scale = initialScale;
            CanvasState.panX = (containerRect.width - unscaledWidth * initialScale) / 2;
            CanvasState.panY = (containerRect.height - unscaledHeight * initialScale) / 2;
            CanvasState.panY = Math.max(20, CanvasState.panY);
            updateTransform();
        }

        // --- 3. Init ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Bind element references
            els.container = document.getElementById('canvas-container');
            els.content = document.getElementById('canvas-content');

            // Init code panel state
            updateView();

            // Init Playground
            if (window.PlaygroundController) PlaygroundController.init();

            // Mermaid rendering + center
            if (window.mermaid) {
                try {
                    const nodes = document.querySelectorAll('.mermaid');
                    if (nodes.length > 0) {
                        await mermaid.run({ nodes: nodes });
                        setTimeout(centerContent, 100);
                    }
                } catch (e) { console.error("Mermaid render failed", e); }
            }

            // Canvas Events (Wheel zoom + Drag pan)
            if (els.container) {
                els.container.addEventListener('wheel', handleWheel, { passive: false });
                els.container.addEventListener('mousedown', startDrag);
                window.addEventListener('mousemove', drag);
                window.addEventListener('mouseup', stopDrag);
            }

            // KaTeX Auto Render
            if (window.renderMathInElement) {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ],
                    throwOnError: false
                });
            }

            // TOC ScrollSpy
            const tocLinks = document.querySelectorAll('.toc-link');
            if (tocLinks.length > 0) {
                const headings = document.querySelectorAll('article h2[id], article h3[id]');
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            tocLinks.forEach(link => link.classList.remove('active'));
                            const id = entry.target.getAttribute('id');
                            const activeLink = document.querySelector(`.toc-link[href="#${id}"]`);
                            if (activeLink) activeLink.classList.add('active');
                        }
                    });
                }, { rootMargin: '-20% 0px -60% 0px' });
                headings.forEach(h => observer.observe(h));
            }

            // Load Sample buttons
            const btnOhlcv = document.getElementById('btn-load-sample-ohlcv');
            if (btnOhlcv) {
                btnOhlcv.addEventListener('click', () => {
                    if (window.PlaygroundController) PlaygroundController.generateSample('ohlcv');
                });
            }
            const btnSingle = document.getElementById('btn-load-sample-single');
            if (btnSingle) {
                btnSingle.addEventListener('click', () => {
                    if (window.PlaygroundController) PlaygroundController.generateSample('single');
                });
            }
            // Initialize Playground Controller
            if (window.PlaygroundController && PlaygroundController.init) {
                PlaygroundController.init();
            }
        });
    </script>
</body>
</html>