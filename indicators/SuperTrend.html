<!DOCTYPE html>
<html lang="ja" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuperTrend - I ant I Investigates</title>
    <meta name="description" content="">
    <meta name="keywords" content="">
    <!-- Structured Data for SEO -->
    <script type="application/ld+json">
        {
    "@context": "https://schema.org",
    "@type": "TechArticle",
    "headline": "SuperTrend",
    "description": "Detailed guide for SuperTrend indicator.",
    "author": {
        "@type": "Organization",
        "name": "I and I Investigates"
    }
}
    </script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- Styles -->
    <!-- Styles -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <link rel="stylesheet" href="../../assets/css/style.css">
    <!-- KaTeX (Math) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>

    <style>
        /* =========================================
           PORTED STYLES (From 0117 Template)
           ========================================= */
        :root {
            /* Minimal Variable Set for Logic Panel */
            --bg-card: #FFFFFF;
            --bg-secondary: #F8FAFC; /* slate-50 */
            --bg-hover: #F1F5F9; /* slate-100 */
            --border-color: #E2E8F0; /* slate-200 */
            --text-primary: #1E293B; /* slate-800 */
            --text-muted: #64748B; /* slate-500 */
            --accent: #4F46E5; /* indigo-600 */
        }

        /* Logic Figure Container */
        .logic-figure {
            margin: 0;
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            position: relative;
            overflow: hidden;
            height: 600px; /* Fixed height for infinite canvas feel */
        }

        /* Infinite Canvas Wrapper */
        .chart-scroll-wrapper {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
            background-color: #FFFFFF;
            background-image: radial-gradient(#E2E8F0 1.5px, transparent 1.5px);
            background-size: 20px 20px;
            cursor: grab;
            touch-action: none;
            user-select: none;
        }
        .chart-scroll-wrapper:active { cursor: grabbing; }

        /* Code Panel Overlay */
        #code-panel-overlay {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            width: 500px;
            max-width: 90%;
            z-index: 30;
            background-color: var(--bg-card);
            border-right: 1px solid var(--border-color);
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), width 0.3s ease;
            transform: translateX(0);
        }
        #code-panel-overlay.panel-hidden {
            transform: translateX(-100%);
            pointer-events: none;
        }
        #code-panel-overlay.panel-expanded {
            width: 100%;
            max-width: 100%;
        }

        /* Code Content */
        .code-panel-body {
            background-color: #FAFAFA;
            flex: 1;
            overflow: auto;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            padding: 0.5rem 1rem 1rem 1rem; /* Reduced top padding */
            white-space: pre; /* Essential for code indentation */
        }
        .code-content {
            font-family: 'Roboto Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            padding: 1rem;
        }
        /* Toggle Button */
        #code-panel-toggle-btn {
            position: absolute;
            top: 1rem;
            left: 1rem;
            z-index: 25;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.5rem;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }
        #code-panel-toggle-btn:hover {
            color: var(--accent);
            border-color: var(--accent);
        }

        /* Active States for Panel Buttons */
        .btn-lang-active {
            background-color: var(--accent) !important;
            color: white !important;
        }
        .btn-type-active {
            color: var(--text-primary) !important;
            font-weight: bold;
            text-decoration: underline;
            text-decoration-color: var(--accent);
            text-decoration-thickness: 2px;
        }

        /* Custom Scrollbar for Code Blocks */
        pre::-webkit-scrollbar, .code-panel-body::-webkit-scrollbar {
            height: 8px; width: 8px;
            background-color: #f1f5f9;
        }
        pre::-webkit-scrollbar-thumb, .code-panel-body::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        pre::-webkit-scrollbar-thumb:hover, .code-panel-body::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8;
        }

        /* Pygments Syntax Highlighting */
        pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.highlight .hll { background-color: #ffffcc }
.highlight .c { color: #008000 } /* Comment */
.highlight .err { border: 1px solid #F00 } /* Error */
.highlight .k { color: #00F } /* Keyword */
.highlight .ch { color: #008000 } /* Comment.Hashbang */
.highlight .cm { color: #008000 } /* Comment.Multiline */
.highlight .cp { color: #00F } /* Comment.Preproc */
.highlight .cpf { color: #008000 } /* Comment.PreprocFile */
.highlight .c1 { color: #008000 } /* Comment.Single */
.highlight .cs { color: #008000 } /* Comment.Special */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
.highlight .gh { font-weight: bold } /* Generic.Heading */
.highlight .gp { font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { font-weight: bold } /* Generic.Subheading */
.highlight .kc { color: #00F } /* Keyword.Constant */
.highlight .kd { color: #00F } /* Keyword.Declaration */
.highlight .kn { color: #00F } /* Keyword.Namespace */
.highlight .kp { color: #00F } /* Keyword.Pseudo */
.highlight .kr { color: #00F } /* Keyword.Reserved */
.highlight .kt { color: #2B91AF } /* Keyword.Type */
.highlight .s { color: #A31515 } /* Literal.String */
.highlight .nc { color: #2B91AF } /* Name.Class */
.highlight .ow { color: #00F } /* Operator.Word */
.highlight .sa { color: #A31515 } /* Literal.String.Affix */
.highlight .sb { color: #A31515 } /* Literal.String.Backtick */
.highlight .sc { color: #A31515 } /* Literal.String.Char */
.highlight .dl { color: #A31515 } /* Literal.String.Delimiter */
.highlight .sd { color: #A31515 } /* Literal.String.Doc */
.highlight .s2 { color: #A31515 } /* Literal.String.Double */
.highlight .se { color: #A31515 } /* Literal.String.Escape */
.highlight .sh { color: #A31515 } /* Literal.String.Heredoc */
.highlight .si { color: #A31515 } /* Literal.String.Interpol */
.highlight .sx { color: #A31515 } /* Literal.String.Other */
.highlight .sr { color: #A31515 } /* Literal.String.Regex */
.highlight .s1 { color: #A31515 } /* Literal.String.Single */
.highlight .ss { color: #A31515 } /* Literal.String.Symbol */
        /* Mermaid Overrides */
        .mermaid { transform-origin: 0 0; }
        .noselect { user-select: none; -webkit-user-select: none; }

        /* Legend Items */
        .logic-legend {
            border-top: 1px solid var(--border-color);
            padding: 1rem;
            background-color: var(--bg-card);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1.5rem;
            position: relative;
            z-index: 20;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: 500;
        }
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 1px solid;
        }
        .l-ingestion { background: #E8F0FE; border-color: #4285F4; }
        .l-evaluation { background: #FEF7E0; border-color: #FBBC04; }
        .l-weighting { background: #F3E8FD; border-color: #A142F4; }
        .l-synthesis { background: #E0F7FA; border-color: #12B5CB; }
        .l-outcome { background: #E6F4EA; border-color: #34A853; }

        /* TOC Active State Styling */
        .toc-link.active {
            color: #4f46e5;
            border-left-color: #4f46e5;
            background-color: #eef2ff;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans antialiased relative">

    <!-- Navigation -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center mr-6">
                        <a href="../index.html" class="font-bold text-xl text-indigo-600">
                            I ant I Investigates
                        </a>
                    </div>
                    <!-- Breadcrumbs (Moved Here) -->
                    <nav class="hidden md:flex text-sm text-slate-500 mr-8" aria-label="Breadcrumb">
                        <ol class="flex items-center space-x-2">
                            <li><a href="../index.html" class="hover:text-indigo-600 transition-colors">home</a></li>
                            <li><span class="mx-1">/</span></li>
                            <li><a href="./" class="hover:text-indigo-600 transition-colors">indicators</a></li>
                            <li><span class="mx-1">/</span></li>
                            <li><span class="font-medium text-slate-900">SuperTrend</span></li>
                        </ol>
                    </nav>

                    <!-- Page Top Nav (Anchor Links) -->
                    <div class="hidden sm:flex sm:space-x-4 items-center">
                        <a href="#interactive-playground" class="text-slate-600 hover:text-indigo-600 px-3 py-2 text-sm font-medium transition-colors">
                            Chart
                        </a>
                        <a href="#logic-visualization" class="text-slate-600 hover:text-indigo-600 px-3 py-2 text-sm font-medium transition-colors">
                            Logic
                        </a>
                        <a href="#documentation" class="text-slate-600 hover:text-indigo-600 px-3 py-2 text-sm font-medium transition-colors">
                            Docs
                        </a>
                    </div>
                </div>
                <!-- External Links Placeholder -->
                <div class="hidden sm:flex items-center">
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Container: 1-Column Stack -->
    <div class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-12">
        <!-- ======================================================= -->
        <!-- TOP SECTION: CONTEXT & PLAYGROUND                       -->
        <!-- ======================================================= -->
        <div class="flex flex-col gap-6">
            <!-- Hero Header -->
            <header>
                <h1 class="text-3xl md:text-4xl font-bold text-slate-900 mb-4 leading-tight">SuperTrend</h1>
                <p class="text-lg text-slate-600 leading-relaxed">SuperTrend is a volatility-based trailing stop indicator that tracks above price during downtrends and below price during uptrends, flipping when price closes beyond the trail.</p>
            </header>

            <!-- Interactive Playground -->
            <section id="interactive-playground" class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden scroll-mt-24">
                <div class="border-b border-slate-200 bg-indigo-50 px-6 py-4">
                    <h2 class="text-lg font-bold text-slate-800 flex items-center">
                        <span class="bg-indigo-600 text-white p-1 rounded mr-3 text-xs shadow-sm font-mono">C</span>
                        Calculator
                    </h2>
                    <p class="text-sm text-slate-600 mt-2">Calculate indicator values from your price data.</p>
                </div>
                <div class="p-6">
                    <!-- Chart Area -->
                    <div class="relative h-[400px] w-full mb-6 border border-slate-100 rounded bg-slate-50">
                        <canvas id="indicatorChart"></canvas>
                    </div>

                    <!-- Controls Area -->
                    <div id="controls" class="grid grid-cols-1 md:grid-cols-3 gap-6 bg-slate-50 p-4 rounded border border-slate-200">
                        <!-- Parameters -->
                        <div class="md:col-span-1 space-y-4">
                            <h3 class="font-bold text-sm text-slate-700 uppercase tracking-wide border-b border-slate-200 pb-2">Parameters</h3>
                            <div id="settings-container">
                                <div class="space-y-3">
                                    <!-- Dynamic settings will be injected here -->
                                </div>
                            </div>
                            <button id="btn-run" onclick="PlaygroundController.update()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded transition-colors shadow-sm flex items-center justify-center">
                                Calculate
                            </button>
                        </div>

                        <!-- Data I/O -->
                        <div class="md:col-span-2 space-y-4">
                            <!-- Input -->
                            <div class="space-y-2">
                                <div class="flex justify-between items-center pb-2 border-b border-slate-200">
                                    <h3 class="font-bold text-sm text-slate-700 uppercase tracking-wide">Input Data (CSV)</h3>
                                    <div class="flex space-x-2">
                                        <button id="btn-load-sample-ohlcv" class="text-xs text-indigo-600 hover:text-indigo-800 hover:underline transition-colors" title="Load OHLCV Sample Data">Shape (OHLCV)</button>
                                        <span class="text-slate-300">|</span>
                                        <button id="btn-load-sample-single" class="text-xs text-indigo-600 hover:text-indigo-800 hover:underline transition-colors" title="Load Single Value Sample Data">Single</button>
                                    </div>
                                </div>
                                <p class="text-xs text-slate-500">Enter CSV data (Date,Open,High,Low,Close,Volume) or single values.</p>
                                <textarea id="input-data" class="w-full h-24 p-2 text-xs font-mono border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 transition-shadow" placeholder="e.g. 100.5, 101.2, 99.8, 102.3, 103.1...

or one per line:
100.5
101.2
99.8"></textarea>
                            </div>
                            <!-- Output (Enabled) -->
                            <div class="space-y-2">
                                <div class="flex justify-between items-center pb-2 border-b border-slate-200">
                                    <h3 class="font-bold text-sm text-slate-700 uppercase tracking-wide">Output Data (Result)</h3>
                                </div>
                                <textarea id="output-data" class="w-full h-24 p-2 text-xs font-mono border border-slate-300 rounded bg-slate-100 text-slate-600" readonly placeholder="Calculation results will appear here..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- ======================================================= -->
        <!-- MIDDLE SECTION: LOGIC & ARCHITECTURE (PORTED FROM 0117) -->
        <!-- ======================================================= -->
        <section id="logic-visualization" class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden scroll-mt-24">
            <!-- Section Header (Styled like Playground) -->
            <div class="border-b border-slate-200 bg-emerald-50 px-6 py-4">
                <h2 class="text-lg font-bold text-slate-800 flex items-center">
                    <span class="bg-emerald-600 text-white p-1 rounded mr-3 text-xs shadow-sm font-mono">L</span>
                    Logic & Code Architecture
                </h2>
                <p class="text-sm text-slate-600 mt-2">Visual flowchart showing how the indicator processes data.</p>
            </div>

            <!-- LOGIC FIGURE STRUCTURE -->
            <figure class="logic-figure" style="border: none; border-radius: 0;">
                <!-- 1. Code Panel Toggle Button -->
                <button id="code-panel-toggle-btn" onclick="toggleCodePanel()" title="View Source Code" class="font-bold text-xs">
                    CODE
                </button>

                <!-- 2. Infinite Canvas Layer -->
                <div id="canvas-container" class="chart-scroll-wrapper">
                    <div id="canvas-content" class="mermaid" style="position: absolute; top:0; left:0;">
                        flowchart TD;
subgraph INGESTION["INGESTION<br/>Data Capture"];
A["Observe price movements<br/>(OHLC candle data)"];
B["Measure recent volatility<br/>(ATR-based distance from price)"];
end;
subgraph EVALUATION["EVALUATION<br/>Initial Assessment"];
C["Calculate mid-price<br/>(average of high and low)"];
D["Create volatility bands<br/>(ATR distance above and below)"];
end;
subgraph WEIGHTING["WEIGHTING<br/>Normalization"];
E["Apply band continuity logic<br/>(prevent premature flips)"];
F["Determine trend direction<br/>(is price above or below band?)"];
end;
subgraph SYNTHESIS["SYNTHESIS<br/>Pattern Detection"];
G{"What is the trend state?"};
H["Green/Below price: Uptrend active"];
I["Red/Above price: Downtrend active"];
J["Band flip: Trend reversal"];
end;
subgraph OUTCOME["OUTCOME<br/>Signal Generation"];
K["SuperTrend flips Green:<br/>New uptrend, consider long"];
L["SuperTrend flips Red:<br/>New downtrend, consider short"];
M["Use ST line as trailing stop:<br/>Dynamic risk management"];
end;
A --> C;
B --> C;
C --> D;
D --> E;
E --> F;
F --> G;
G -->|"Green"| H;
G -->|"Red"| I;
G -->|"Flip"| J;
H --> K;
I --> L;
J --> M;
style INGESTION fill:#e3f2fd;
style EVALUATION fill:#fff3e0;
style WEIGHTING fill:#e8f5e9;
style SYNTHESIS fill:#fce4ec;
style OUTCOME fill:#f3e5f5;
                    </div>
                </div>

                <!-- 3. Canvas Controls (Zoom) -->
                <div class="absolute top-4 right-4 flex flex-col gap-2 z-20">
                    <button onclick="if(window.resetView) window.resetView()" class="p-2 bg-white rounded shadow border border-slate-200 hover:bg-slate-50 text-slate-600 font-mono text-xs" title="Reset View">R</button>
                    <button onclick="if(window.zoomAction) window.zoomAction('in')" class="p-2 bg-white rounded shadow border border-slate-200 hover:bg-slate-50 text-slate-600 font-mono text-xs" title="Zoom In">+</button>
                    <button onclick="if(window.zoomAction) window.zoomAction('out')" class="p-2 bg-white rounded shadow border border-slate-200 hover:bg-slate-50 text-slate-600 font-mono text-xs" title="Zoom Out">-</button>
                </div>

                <!-- 4. Code Panel Overlay (Slide-in) -->
                <div id="code-panel-overlay" class="panel-hidden" onmousedown="event.stopPropagation();">
                    <!-- Header -->
                    <div class="flex justify-between items-center p-3 border-b border-slate-200 bg-slate-50 shrink-0">
                        <div class="flex gap-2">
                            <button id="btn-lang-csharp" class="px-2 py-1 text-xs rounded transition-colors text-slate-500 hover:bg-slate-100" onclick="setLang('csharp')">C#</button>
                            <button id="btn-lang-python" class="px-2 py-1 text-xs rounded transition-colors text-slate-500 hover:bg-slate-100" onclick="setLang('python')">Python</button>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="btn-type-simple" class="text-xs text-slate-500 hover:text-indigo-600 transition-colors" onclick="setType('simple')">Simple</button>
                            <button id="btn-type-detailed" class="text-xs text-slate-500 hover:text-indigo-600 transition-colors" onclick="setType('detailed')">Detailed</button>
                            <!-- Copy -->
                            <button id="btn-copy-code" class="ml-2 text-slate-500 hover:text-slate-800 transition-colors" onclick="copyCode()" title="Copy Code">
                                <svg id="icon-copy" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                                <svg id="icon-copy-done" class="hidden text-green-600" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                            </button>
                            <!-- Expand/Collapse -->
                            <button id="btn-panel-expand" class="text-slate-500 hover:text-slate-800 transition-colors" onclick="toggleExpand()" title="Toggle Width">
                                <svg id="icon-expand" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M15 3h6v6" /><path d="M9 21H3v-6" /><path d="M21 3l-7 7" /><path d="M3 21l7-7" />
                                </svg>
                                <svg id="icon-collapse" class="hidden" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 14h6v6" /><path d="M20 10h-6V4" /><path d="M14 10l7-7" /><path d="M10 14l-7 7" />
                                </svg>
                            </button>
                            <!-- Close -->
                            <button class="text-slate-500 hover:text-red-600 transition-colors" onclick="toggleCodePanel()" title="Close Panel">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <!-- Body -->
                    <div class="code-panel-body custom-scrollbar p-4">
                        <div id="code-csharp-simple" class="code-content hidden"><div class="highlight"><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">1</span><span class="k">using</span> System;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">2</span><span class="k">using</span> System.Collections.Generic;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">3</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">4</span><span class="k">namespace</span> TechnicalIndicators</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">5</span>{</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">6</span>    <span class="c1">/// &lt;summary&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">7</span>    <span class="c1">/// SuperTrend</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">8</span>    <span class="c1">/// &lt;/summary&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">9</span>    <span class="c1">/// &lt;remarks&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">10</span>    <span class="c1">/// A trend-following indicator based on ATR.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">11</span>    <span class="c1">/// &lt;list type=&quot;bullet&quot;&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">12</span>    <span class="c1">/// &lt;item&gt;&lt;description&gt;Uses ATR to calculate volatility-based bands.&lt;/description&gt;&lt;/item&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">13</span>    <span class="c1">/// &lt;item&gt;&lt;description&gt;Switches direction only when price closes outside the band.&lt;/description&gt;&lt;/item&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">14</span>    <span class="c1">/// &lt;item&gt;&lt;description&gt;Green (Lower Band): Uptrend support.&lt;/description&gt;&lt;/item&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">15</span>    <span class="c1">/// &lt;item&gt;&lt;description&gt;Red (Upper Band): Downtrend resistance.&lt;/description&gt;&lt;/item&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">16</span>    <span class="c1">/// &lt;/list&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">17</span>    <span class="c1">/// &lt;/remarks&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">18</span>    <span class="k">public</span> <span class="k">class</span> <span class="nc">SuperTrend</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">19</span>    {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">20</span>        <span class="k">public</span> <span class="kt">int</span> Period { <span class="k">get</span>; }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">21</span>        <span class="k">public</span> <span class="kt">decimal</span> Multiplier { <span class="k">get</span>; }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">22</span>        <span class="k">public</span> List&lt;<span class="kt">decimal?</span>&gt; Values { <span class="k">get</span>; } = <span class="k">new</span>(); <span class="c1">// The line value to plot</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">23</span>        <span class="k">public</span> List&lt;<span class="kt">int</span>&gt; Trend { <span class="k">get</span>; } = <span class="k">new</span>();       <span class="c1">// 1 for Up, -1 for Down</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">24</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">25</span>        <span class="k">public</span> SuperTrend(<span class="kt">int</span> period = 10, <span class="kt">decimal</span> multiplier = 3.0m)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">26</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">27</span>            Period = period;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">28</span>            Multiplier = multiplier;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">29</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">30</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">31</span>        <span class="k">public</span> <span class="k">void</span> Calculate(IEnumerable&lt;CandleData&gt; candles)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">32</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">33</span>            Values.Clear();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">34</span>            Trend.Clear();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">35</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">36</span>            <span class="kt">var</span> candleList = <span class="k">new</span> List&lt;CandleData&gt;(candles);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">37</span>            <span class="k">if</span> (candleList.Count == 0) <span class="k">return</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">38</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">39</span>            <span class="kt">var</span> atr = CalculateAtr(candleList, Period);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">40</span>            <span class="kt">var</span> upperBands = <span class="k">new</span> List&lt;<span class="kt">decimal?</span>&gt;();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">41</span>            <span class="kt">var</span> lowerBands = <span class="k">new</span> List&lt;<span class="kt">decimal?</span>&gt;();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">42</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">43</span>            <span class="c1">// Default Trend</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">44</span>            <span class="kt">int</span> trend = 1;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">45</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">46</span>            <span class="k">for</span> (<span class="kt">int</span> i = 0; i &lt; candleList.Count; i++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">47</span>            {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">48</span>                <span class="k">if</span> (!atr[i].HasValue)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">49</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">50</span>                    upperBands.Add(<span class="k">null</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">51</span>                    lowerBands.Add(<span class="k">null</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">52</span>                    Values.Add(<span class="k">null</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">53</span>                    Trend.Add(0);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">54</span>                    <span class="k">continue</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">55</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">56</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">57</span>                <span class="c1">// Basic Bands</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">58</span>                <span class="kt">decimal</span> hl2 = (candleList[i].High + candleList[i].Low) / 2;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">59</span>                <span class="kt">decimal</span> basicUpper = hl2 + Multiplier * atr[i]!.Value;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">60</span>                <span class="kt">decimal</span> basicLower = hl2 - Multiplier * atr[i]!.Value;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">61</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">62</span>                <span class="c1">// Final Bands Logic</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">63</span>                <span class="kt">decimal</span> finalUpper = basicUpper;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">64</span>                <span class="kt">decimal</span> finalLower = basicLower;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">65</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">66</span>                <span class="k">if</span> (i &gt; 0 &amp;&amp; upperBands[i - 1].HasValue)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">67</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">68</span>                    <span class="c1">// If prev close was below prev Upper, keep Upper flat (dont let it rise)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">69</span>                    <span class="k">if</span> (basicUpper &lt; upperBands[i - 1]!.Value || candleList[i - 1].Close &gt; upperBands[i - 1]!.Value)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">70</span>                        finalUpper = basicUpper;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">71</span>                    <span class="k">else</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">72</span>                        finalUpper = upperBands[i - 1]!.Value;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">73</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">74</span>                    <span class="c1">// If prev close was above prev Lower, keep Lower flat (dont let it fall)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">75</span>                    <span class="k">if</span> (basicLower &gt; lowerBands[i - 1]!.Value || candleList[i - 1].Close &lt; lowerBands[i - 1]!.Value)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">76</span>                        finalLower = basicLower;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">77</span>                    <span class="k">else</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">78</span>                        finalLower = lowerBands[i - 1]!.Value;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">79</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">80</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">81</span>                <span class="c1">// Determine Trend</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">82</span>                <span class="k">if</span> (i &gt; 0 &amp;&amp; Values[i - 1].HasValue)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">83</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">84</span>                    <span class="kt">int</span> prevTrend = Trend[i - 1]; <span class="c1">// Use stored trend</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">85</span>                    </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">86</span>                    <span class="k">if</span> (prevTrend == 1) <span class="c1">// Currently Up</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">87</span>                    {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">88</span>                        <span class="k">if</span> (candleList[i].Close &lt; finalLower)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">89</span>                            trend = -1; <span class="c1">// Switch to Down</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">90</span>                        <span class="k">else</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">91</span>                            trend = 1;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">92</span>                    }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">93</span>                    <span class="k">else</span> <span class="c1">// Currently Down</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">94</span>                    {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">95</span>                        <span class="k">if</span> (candleList[i].Close &gt; finalUpper)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">96</span>                            trend = 1; <span class="c1">// Switch to Up</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">97</span>                        <span class="k">else</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">98</span>                            trend = -1;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">99</span>                    }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">100</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">101</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">102</span>                upperBands.Add(finalUpper);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">103</span>                lowerBands.Add(finalLower);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">104</span>                Trend.Add(trend);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">105</span>                Values.Add(trend == 1 ? finalLower : finalUpper);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">106</span>            }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">107</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">108</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">109</span>        <span class="k">private</span> <span class="k">static</span> List&lt;<span class="kt">decimal?</span>&gt; CalculateAtr(List&lt;CandleData&gt; candles, <span class="kt">int</span> period)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">110</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">111</span>            <span class="c1">// Simplified ATR calc for brevity, typically RMA of TR</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">112</span>            <span class="kt">var</span> results = <span class="k">new</span> List&lt;<span class="kt">decimal?</span>&gt;();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">113</span>            <span class="kt">var</span> trueRanges = <span class="k">new</span> List&lt;<span class="kt">decimal</span>&gt;();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">114</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">115</span>            <span class="k">if</span> (candles.Count &gt; 0) trueRanges.Add(candles[0].High - candles[0].Low);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">116</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">117</span>            <span class="k">for</span> (<span class="kt">int</span> i = 1; i &lt; candles.Count; i++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">118</span>            {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">119</span>                <span class="kt">decimal</span> tr1 = candles[i].High - candles[i].Low;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">120</span>                <span class="kt">decimal</span> tr2 = Math.Abs(candles[i].High - candles[i - 1].Close);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">121</span>                <span class="kt">decimal</span> tr3 = Math.Abs(candles[i].Low - candles[i - 1].Close);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">122</span>                trueRanges.Add(Math.Max(tr1, Math.Max(tr2, tr3)));</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">123</span>            }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">124</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">125</span>            <span class="k">for</span> (<span class="kt">int</span> i = 0; i &lt; candles.Count; i++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">126</span>            {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">127</span>                <span class="k">if</span> (i &lt; period - 1) { results.Add(<span class="k">null</span>); <span class="k">continue</span>; }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">128</span>                <span class="k">if</span> (i == period - 1)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">129</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">130</span>                    <span class="kt">decimal</span> sum = 0;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">131</span>                    <span class="k">for</span> (<span class="kt">int</span> j = 0; j &lt; period; j++) sum += trueRanges[j];</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">132</span>                    results.Add(sum / period);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">133</span>                    <span class="k">continue</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">134</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">135</span>                <span class="kt">decimal</span> prevAtr = results[i - 1]!.Value;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">136</span>                results.Add((prevAtr * (period - 1) + trueRanges[i]) / period);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">137</span>            }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">138</span>            <span class="k">return</span> results;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">139</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">140</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">141</span>        <span class="k">public</span> <span class="k">static</span> List&lt;<span class="kt">decimal?</span>&gt; Calculate(IEnumerable&lt;CandleData&gt; candles, <span class="kt">int</span> period = 10, <span class="kt">decimal</span> multiplier = 3.0m)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">142</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">143</span>            <span class="kt">var</span> st = <span class="k">new</span> SuperTrend(period, multiplier);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">144</span>            st.Calculate(candles);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">145</span>            <span class="k">return</span> st.Values;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">146</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">147</span>    }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">148</span>}</div></div></div>
                        <div id="code-csharp-detailed" class="code-content hidden"><div class="highlight"><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">1</span><span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">2</span><span class="c1">// SUPERTREND INDICATOR - Extreme Tutorial Mode</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">3</span><span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">4</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">5</span><span class="c1">// [What] SuperTrend is an ATR-based trend-following indicator. It draws a</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">6</span><span class="c1">//        dynamic support/resistance line that follows price, flipping sides</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">7</span><span class="c1">//        when trend reverses. Outputs: SuperTrend line and Trend direction.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">8</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">9</span><span class="c1">// [Why]  Many trend indicators lag significantly. SuperTrend uses ATR</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">10</span><span class="c1">//        (volatility) to create adaptive bands that:</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">11</span><span class="c1">//        - Stay close during low volatility (tight stops)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">12</span><span class="c1">//        - Expand during high volatility (room to breathe)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">13</span><span class="c1">//        - Give clear, unambiguous buy/sell signals on crossovers</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">14</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">15</span><span class="c1">// [Visual] SuperTrend Behavior:</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">16</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">17</span><span class="c1">//   Price Chart:</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">18</span><span class="c1">//               </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">19</span><span class="c1">//                 </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">20</span><span class="c1">//                     </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">21</span><span class="c1">//   </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">22</span><span class="c1">//        SuperTrend Line</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">23</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">24</span><span class="c1">//   UPTREND (Trend = 1):</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">25</span><span class="c1">//   - SuperTrend = Lower Band (support)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">26</span><span class="c1">//   - Line is BELOW price</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">27</span><span class="c1">//   - Bullish until price crosses below</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">28</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">29</span><span class="c1">//   DOWNTREND (Trend = -1):</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">30</span><span class="c1">//   - SuperTrend = Upper Band (resistance)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">31</span><span class="c1">//   - Line is ABOVE price</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">32</span><span class="c1">//   - Bearish until price crosses above</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">33</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">34</span><span class="c1">// [How] Algorithm Overview:</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">35</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">36</span><span class="c1">//   </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">37</span><span class="c1">//    STEP 1: Calculate ATR (Average True Range)                     </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">38</span><span class="c1">//    STEP 2: Calculate Basic Bands:                                 </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">39</span><span class="c1">//            Upper = HL2 + Multiplier  ATR                         </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">40</span><span class="c1">//            Lower = HL2 - Multiplier  ATR                         </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">41</span><span class="c1">//    STEP 3: Adjust Final Bands (prevent backward movement)         </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">42</span><span class="c1">//    STEP 4: Determine Trend Direction based on price vs bands      </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">43</span><span class="c1">//    STEP 5: SuperTrend = Lower (uptrend) or Upper (downtrend)      </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">44</span><span class="c1">//   </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">45</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">46</span><span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">47</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">48</span><span class="k">using</span> System;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">49</span><span class="k">using</span> System.Collections.Generic;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">50</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">51</span><span class="k">namespace</span> TechnicalIndicators</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">52</span>{</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">53</span>    <span class="c1">// =========================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">54</span>    <span class="c1">// [What] CandleData: Immutable record for OHLCV price bar data</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">55</span>    <span class="c1">// =========================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">56</span>    <span class="k">public</span> <span class="k">readonly</span> <span class="k">record</span> <span class="k">struct</span> CandleData(</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">57</span>        DateTime Timestamp,</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">58</span>        <span class="kt">decimal</span> Open,</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">59</span>        <span class="kt">decimal</span> High,</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">60</span>        <span class="kt">decimal</span> Low,</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">61</span>        <span class="kt">decimal</span> Close,</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">62</span>        <span class="kt">long</span> Volume</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">63</span>    );</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">64</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">65</span>    <span class="c1">// =========================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">66</span>    <span class="c1">// [What] SuperTrend Class: ATR-based trend-following indicator</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">67</span>    <span class="c1">// =========================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">68</span>    <span class="k">public</span> <span class="k">class</span> <span class="nc">SuperTrend</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">69</span>    {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">70</span>        <span class="c1">// ---------------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">71</span>        <span class="c1">// [What] Period: ATR calculation period (default 10)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">72</span>        <span class="c1">// ---------------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">73</span>        <span class="k">public</span> <span class="kt">int</span> Period { <span class="k">get</span>; }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">74</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">75</span>        <span class="c1">// ---------------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">76</span>        <span class="c1">// [What] Multiplier: ATR multiplier for band distance (default 3.0)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">77</span>        <span class="c1">// [Why]  Higher = wider bands, fewer signals, more reliable</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">78</span>        <span class="c1">//        Lower = tighter bands, more signals, more whipsaws</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">79</span>        <span class="c1">// ---------------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">80</span>        <span class="k">public</span> <span class="kt">decimal</span> Multiplier { <span class="k">get</span>; }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">81</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">82</span>        <span class="c1">// ---------------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">83</span>        <span class="c1">// [What] Values: The SuperTrend line values (support or resistance)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">84</span>        <span class="c1">// ---------------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">85</span>        <span class="k">public</span> List&lt;<span class="kt">decimal?</span>&gt; Values { <span class="k">get</span>; } = <span class="k">new</span>();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">86</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">87</span>        <span class="c1">// ---------------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">88</span>        <span class="c1">// [What] Trend: Direction indicator (1 = up, -1 = down, 0 = undefined)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">89</span>        <span class="c1">// ---------------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">90</span>        <span class="k">public</span> List&lt;<span class="kt">int</span>&gt; Trend { <span class="k">get</span>; } = <span class="k">new</span>();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">91</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">92</span>        <span class="c1">// =====================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">93</span>        <span class="c1">// [What] Constructor: Initialize with ATR period and multiplier</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">94</span>        <span class="c1">// =====================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">95</span>        <span class="k">public</span> SuperTrend(<span class="kt">int</span> period = 10, <span class="kt">decimal</span> multiplier = 3.0m)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">96</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">97</span>            Period = period;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">98</span>            Multiplier = multiplier;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">99</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">100</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">101</span>        <span class="c1">// =====================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">102</span>        <span class="c1">// [What] Calculate: Main computation method</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">103</span>        <span class="c1">// =====================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">104</span>        <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">105</span>        <span class="c1">// [IPO Block]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">106</span>        <span class="c1">// </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">107</span>        <span class="c1">//  INPUT:  candles - Collection of OHLCV price bars                </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">108</span>        <span class="c1">//  PROCESS: Compute ATR bands, adjust, determine trend             </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">109</span>        <span class="c1">//  OUTPUT: Values (line) and Trend (direction) populated           </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">110</span>        <span class="c1">// </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">111</span>        <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">112</span>        <span class="k">public</span> <span class="k">void</span> Calculate(IEnumerable&lt;CandleData&gt; candles)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">113</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">114</span>            Values.Clear();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">115</span>            Trend.Clear();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">116</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">117</span>            <span class="kt">var</span> candleList = <span class="k">new</span> List&lt;CandleData&gt;(candles);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">118</span>            <span class="k">if</span> (candleList.Count == 0) <span class="k">return</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">119</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">120</span>            <span class="c1">// =================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">121</span>            <span class="c1">// PHASE 1: Calculate ATR</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">122</span>            <span class="c1">// =================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">123</span>            <span class="kt">var</span> atr = CalculateAtr(candleList, Period);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">124</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">125</span>            <span class="c1">// Store band history for adjustment logic</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">126</span>            <span class="kt">var</span> upperBands = <span class="k">new</span> List&lt;<span class="kt">decimal?</span>&gt;();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">127</span>            <span class="kt">var</span> lowerBands = <span class="k">new</span> List&lt;<span class="kt">decimal?</span>&gt;();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">128</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">129</span>            <span class="c1">// =================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">130</span>            <span class="c1">// PHASE 2: Calculate Bands and Determine Trend</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">131</span>            <span class="c1">// =================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">132</span>            <span class="k">for</span> (<span class="kt">int</span> i = 0; i &lt; candleList.Count; i++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">133</span>            {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">134</span>                <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">135</span>                <span class="c1">// [What] Warm-up period: ATR not yet available</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">136</span>                <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">137</span>                <span class="k">if</span> (!atr[i].HasValue)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">138</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">139</span>                    upperBands.Add(<span class="k">null</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">140</span>                    lowerBands.Add(<span class="k">null</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">141</span>                    Values.Add(<span class="k">null</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">142</span>                    Trend.Add(0);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">143</span>                    <span class="k">continue</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">144</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">145</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">146</span>                <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">147</span>                <span class="c1">// [What] Calculate HL2 (midpoint of high and low)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">148</span>                <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">149</span>                <span class="kt">decimal</span> hl2 = (candleList[i].High + candleList[i].Low) / 2;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">150</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">151</span>                <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">152</span>                <span class="c1">// [What] Calculate Basic Upper and Lower Bands</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">153</span>                <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">154</span>                <span class="c1">// [Formula]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">155</span>                <span class="c1">//   BasicUpper = HL2 + Multiplier  ATR</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">156</span>                <span class="c1">//   BasicLower = HL2 - Multiplier  ATR</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">157</span>                <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">158</span>                <span class="c1">// [Visual] Band Distance:</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">159</span>                <span class="c1">//   ATR = 2, Multiplier = 3</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">160</span>                <span class="c1">//   Band Distance = 2  3 = 6 points from HL2</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">161</span>                <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">162</span>                <span class="kt">decimal</span> basicUpperBand = hl2 + Multiplier * atr[i]!.Value;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">163</span>                <span class="kt">decimal</span> basicLowerBand = hl2 - Multiplier * atr[i]!.Value;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">164</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">165</span>                <span class="kt">decimal</span> finalUpperBand = basicUpperBand;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">166</span>                <span class="kt">decimal</span> finalLowerBand = basicLowerBand;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">167</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">168</span>                <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">169</span>                <span class="c1">// [What] Adjust Final Bands (prevent backward movement)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">170</span>                <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">171</span>                <span class="c1">// [Why?] Bands should only move in favor of the trend:</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">172</span>                <span class="c1">//   - Upper band can only move DOWN (or stay)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">173</span>                <span class="c1">//   - Lower band can only move UP (or stay)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">174</span>                <span class="c1">//   Unless price breaks the previous band.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">175</span>                <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">176</span>                <span class="c1">// [Visual] Band Adjustment Logic:</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">177</span>                <span class="c1">//   Previous Upper = 105, New Basic Upper = 106</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">178</span>                <span class="c1">//   If Close[prev] &lt;= 105: Keep 105 (don&#x27;t move up)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">179</span>                <span class="c1">//   If Close[prev] &gt; 105:  Use 106 (trend broken)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">180</span>                <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">181</span>                <span class="k">if</span> (i &gt; 0 &amp;&amp; upperBands[i - 1].HasValue)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">182</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">183</span>                    <span class="c1">// Upper band: use lower value unless price broke above</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">184</span>                    <span class="k">if</span> (basicUpperBand &lt; upperBands[i - 1]!.Value || candleList[i - 1].Close &gt; upperBands[i - 1]!.Value)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">185</span>                        finalUpperBand = basicUpperBand;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">186</span>                    <span class="k">else</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">187</span>                        finalUpperBand = upperBands[i - 1]!.Value;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">188</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">189</span>                    <span class="c1">// Lower band: use higher value unless price broke below</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">190</span>                    <span class="k">if</span> (basicLowerBand &gt; lowerBands[i - 1]!.Value || candleList[i - 1].Close &lt; lowerBands[i - 1]!.Value)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">191</span>                        finalLowerBand = basicLowerBand;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">192</span>                    <span class="k">else</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">193</span>                        finalLowerBand = lowerBands[i - 1]!.Value;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">194</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">195</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">196</span>                upperBands.Add(finalUpperBand);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">197</span>                lowerBands.Add(finalLowerBand);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">198</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">199</span>                <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">200</span>                <span class="c1">// [What] Determine Trend Direction</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">201</span>                <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">202</span>                <span class="c1">// [Logic]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">203</span>                <span class="c1">//   If previous SuperTrend was Upper band:</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">204</span>                <span class="c1">//      Close &gt; Upper? Switch to Uptrend</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">205</span>                <span class="c1">//      Otherwise stay in Downtrend</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">206</span>                <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">207</span>                <span class="c1">//   If previous SuperTrend was Lower band:</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">208</span>                <span class="c1">//      Close &lt; Lower? Switch to Downtrend</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">209</span>                <span class="c1">//      Otherwise stay in Uptrend</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">210</span>                <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">211</span>                <span class="c1">// [Visual] Trend Flip:</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">212</span>                <span class="c1">//   Price </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">213</span>                <span class="c1">//   Upper </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">214</span>                <span class="c1">//                 Price breaks above  Uptrend!</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">215</span>                <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">216</span>                <span class="kt">int</span> trend = 1;  <span class="c1">// Default to uptrend</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">217</span>                <span class="k">if</span> (i &gt; 0 &amp;&amp; Values[i - 1].HasValue)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">218</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">219</span>                    <span class="k">if</span> (Values[i - 1]!.Value == upperBands[i - 1]!.Value)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">220</span>                        trend = candleList[i].Close &gt; finalUpperBand ? 1 : -1;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">221</span>                    <span class="k">else</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">222</span>                        trend = candleList[i].Close &lt; finalLowerBand ? -1 : 1;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">223</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">224</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">225</span>                Trend.Add(trend);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">226</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">227</span>                <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">228</span>                <span class="c1">// [What] Set SuperTrend value based on trend direction</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">229</span>                <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">230</span>                <span class="c1">// [Logic]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">231</span>                <span class="c1">//   Uptrend (1):   Use Lower band (support below price)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">232</span>                <span class="c1">//   Downtrend (-1): Use Upper band (resistance above price)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">233</span>                <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">234</span>                Values.Add(trend == 1 ? finalLowerBand : finalUpperBand);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">235</span>            }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">236</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">237</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">238</span>        <span class="c1">// =====================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">239</span>        <span class="c1">// [What] CalculateAtr: Calculate Average True Range</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">240</span>        <span class="c1">// =====================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">241</span>        <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">242</span>        <span class="c1">// [IPO Block]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">243</span>        <span class="c1">// </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">244</span>        <span class="c1">//  INPUT:  candles - Price bars, period - ATR period               </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">245</span>        <span class="c1">//  PROCESS: Calculate True Range, apply Wilder smoothing           </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">246</span>        <span class="c1">//  OUTPUT: List of ATR values                                      </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">247</span>        <span class="c1">// </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">248</span>        <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">249</span>        <span class="k">private</span> <span class="k">static</span> List&lt;<span class="kt">decimal?</span>&gt; CalculateAtr(List&lt;CandleData&gt; candles, <span class="kt">int</span> period)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">250</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">251</span>            <span class="kt">var</span> results = <span class="k">new</span> List&lt;<span class="kt">decimal?</span>&gt;();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">252</span>            <span class="k">if</span> (candles.Count == 0) <span class="k">return</span> results;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">253</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">254</span>            <span class="c1">// -----------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">255</span>            <span class="c1">// [What] Calculate True Range for each bar</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">256</span>            <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">257</span>            <span class="c1">// [Formula] TR = max(H-L, |H-PrevClose|, |L-PrevClose|)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">258</span>            <span class="c1">// -----------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">259</span>            <span class="kt">var</span> trueRanges = <span class="k">new</span> List&lt;<span class="kt">decimal</span>&gt;();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">260</span>            trueRanges.Add(candles[0].High - candles[0].Low);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">261</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">262</span>            <span class="k">for</span> (<span class="kt">int</span> i = 1; i &lt; candles.Count; i++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">263</span>            {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">264</span>                <span class="kt">decimal</span> tr1 = candles[i].High - candles[i].Low;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">265</span>                <span class="kt">decimal</span> tr2 = Math.Abs(candles[i].High - candles[i - 1].Close);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">266</span>                <span class="kt">decimal</span> tr3 = Math.Abs(candles[i].Low - candles[i - 1].Close);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">267</span>                trueRanges.Add(Math.Max(tr1, Math.Max(tr2, tr3)));</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">268</span>            }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">269</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">270</span>            <span class="c1">// -----------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">271</span>            <span class="c1">// [What] Apply Wilder&#x27;s smoothing to get ATR</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">272</span>            <span class="c1">// -----------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">273</span>            <span class="k">for</span> (<span class="kt">int</span> i = 0; i &lt; candles.Count; i++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">274</span>            {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">275</span>                <span class="k">if</span> (i &lt; period - 1)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">276</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">277</span>                    results.Add(<span class="k">null</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">278</span>                    <span class="k">continue</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">279</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">280</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">281</span>                <span class="c1">// First ATR is simple average</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">282</span>                <span class="k">if</span> (i == period - 1)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">283</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">284</span>                    <span class="kt">decimal</span> sum = 0;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">285</span>                    <span class="k">for</span> (<span class="kt">int</span> j = 0; j &lt; period; j++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">286</span>                        sum += trueRanges[j];</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">287</span>                    results.Add(sum / period);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">288</span>                    <span class="k">continue</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">289</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">290</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">291</span>                <span class="c1">// Subsequent ATR uses Wilder smoothing</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">292</span>                <span class="kt">decimal</span> prevAtr = results[i - 1]!.Value;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">293</span>                results.Add((prevAtr * (period - 1) + trueRanges[i]) / period);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">294</span>            }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">295</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">296</span>            <span class="k">return</span> results;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">297</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">298</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">299</span>        <span class="c1">// =====================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">300</span>        <span class="c1">// [What] Calculate: Static convenience method</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">301</span>        <span class="c1">// =====================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">302</span>        <span class="k">public</span> <span class="k">static</span> List&lt;<span class="kt">decimal?</span>&gt; Calculate(IEnumerable&lt;CandleData&gt; candles, <span class="kt">int</span> period = 10, <span class="kt">decimal</span> multiplier = 3.0m)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">303</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">304</span>            <span class="kt">var</span> st = <span class="k">new</span> SuperTrend(period, multiplier);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">305</span>            st.Calculate(candles);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">306</span>            <span class="k">return</span> st.Values;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">307</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">308</span>    }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">309</span>}</div></div></div>
                        <div id="code-python-simple" class="code-content hidden"><div class="highlight"><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">1</span><span class="k">class</span> <span class="nc">SuperTrend</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">2</span>    <span class="sd">&quot;&quot;&quot;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">3</span><span class="sd">    SuperTrend</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">4</span><span class="sd">    &quot;&quot;&quot;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">5</span>    <span class="k">def</span> __init__(self, period=10, multiplier=3.0):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">6</span>        self.period = period</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">7</span>        self.multiplier = multiplier</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">8</span>        self.values = [] <span class="c1"># The line</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">9</span>        self.trend = []  <span class="c1"># 1 or -1</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">10</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">11</span>    <span class="k">def</span> calculate(self, candles):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">12</span>        self.values.clear()</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">13</span>        self.trend.clear()</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">14</span>        <span class="k">if</span> <span class="ow">not</span> candles: <span class="k">return</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">15</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">16</span>        atr = self._calc_atr(candles, self.period)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">17</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">18</span>        upper_bands = []</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">19</span>        lower_bands = []</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">20</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">21</span>        <span class="c1"># Initial Trend = 1 (Up)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">22</span>        curr_trend = 1</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">23</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">24</span>        <span class="k">for</span> i <span class="ow">in</span> range(len(candles)):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">25</span>            <span class="k">if</span> i &lt; len(atr) <span class="ow">and</span> atr[i] <span class="ow">is</span> <span class="kc">None</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">26</span>                upper_bands.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">27</span>                lower_bands.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">28</span>                self.values.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">29</span>                self.trend.append(0)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">30</span>                <span class="k">continue</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">31</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">32</span>            h = float(candles[i][<span class="s1">&#x27;</span><span class="s1">high</span><span class="s1">&#x27;</span>])</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">33</span>            l = float(candles[i][<span class="s1">&#x27;</span><span class="s1">low</span><span class="s1">&#x27;</span>])</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">34</span>            c = float(candles[i][<span class="s1">&#x27;</span><span class="s1">close</span><span class="s1">&#x27;</span>])</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">35</span>            hl2 = (h + l) / 2.0</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">36</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">37</span>            basic_upper = hl2 + self.multiplier * atr[i]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">38</span>            basic_lower = hl2 - self.multiplier * atr[i]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">39</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">40</span>            final_upper = basic_upper</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">41</span>            final_lower = basic_lower</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">42</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">43</span>            <span class="c1"># Logic from previous candle</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">44</span>            <span class="k">if</span> i &gt; 0 <span class="ow">and</span> upper_bands[i-1] <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">45</span>                prev_final_upper = upper_bands[i-1]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">46</span>                prev_close = float(candles[i-1][<span class="s1">&#x27;</span><span class="s1">close</span><span class="s1">&#x27;</span>])</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">47</span>                </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">48</span>                <span class="k">if</span> basic_upper &lt; prev_final_upper <span class="ow">or</span> prev_close &gt; prev_final_upper:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">49</span>                    final_upper = basic_upper</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">50</span>                <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">51</span>                    final_upper = prev_final_upper</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">52</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">53</span>                prev_final_lower = lower_bands[i-1]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">54</span>                <span class="k">if</span> basic_lower &gt; prev_final_lower <span class="ow">or</span> prev_close &lt; prev_final_lower:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">55</span>                    final_lower = basic_lower</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">56</span>                <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">57</span>                    final_lower = prev_final_lower</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">58</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">59</span>            <span class="c1"># Determine Trend</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">60</span>            <span class="k">if</span> i &gt; 0 <span class="ow">and</span> self.values[i-1] <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">61</span>                prev_trend_val = self.trend[i-1]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">62</span>                <span class="k">if</span> prev_trend_val == 1:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">63</span>                    <span class="k">if</span> c &lt; final_lower:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">64</span>                        curr_trend = -1</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">65</span>                    <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">66</span>                        curr_trend = 1</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">67</span>                <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">68</span>                    <span class="k">if</span> c &gt; final_upper:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">69</span>                        curr_trend = 1</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">70</span>                    <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">71</span>                        curr_trend = -1</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">72</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">73</span>            upper_bands.append(final_upper)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">74</span>            lower_bands.append(final_lower)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">75</span>            self.trend.append(curr_trend)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">76</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">77</span>            <span class="k">if</span> curr_trend == 1:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">78</span>                self.values.append(final_lower)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">79</span>            <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">80</span>                self.values.append(final_upper)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">81</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">82</span>    <span class="k">def</span> _calc_atr(self, candles, period):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">83</span>        <span class="c1"># RMA / Wilder Smoothing</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">84</span>        res = []</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">85</span>        tr = []</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">86</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">87</span>        tr.append(float(candles[0][<span class="s1">&#x27;</span><span class="s1">high</span><span class="s1">&#x27;</span>]) - float(candles[0][<span class="s1">&#x27;</span><span class="s1">low</span><span class="s1">&#x27;</span>]))</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">88</span>        <span class="k">for</span> i <span class="ow">in</span> range(1, len(candles)):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">89</span>            h = float(candles[i][<span class="s1">&#x27;</span><span class="s1">high</span><span class="s1">&#x27;</span>])</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">90</span>            l = float(candles[i][<span class="s1">&#x27;</span><span class="s1">low</span><span class="s1">&#x27;</span>])</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">91</span>            pc = float(candles[i-1][<span class="s1">&#x27;</span><span class="s1">close</span><span class="s1">&#x27;</span>])</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">92</span>            tr.append(max(h - l, abs(h - pc), abs(l - pc)))</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">93</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">94</span>        <span class="k">for</span> i <span class="ow">in</span> range(len(candles)):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">95</span>            <span class="k">if</span> i &lt; period - 1:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">96</span>                res.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">97</span>            <span class="k">elif</span> i == period - 1:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">98</span>                res.append(sum(tr[:period]) / period)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">99</span>            <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">100</span>                prev = res[-1]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">101</span>                val = (prev * (period - 1) + tr[i]) / period</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">102</span>                res.append(val)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">103</span>        <span class="k">return</span> res</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">104</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">105</span><span class="k">def</span> calculate(candles, period=10, mult=3.0):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">106</span>    obj = SuperTrend(period, mult)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">107</span>    obj.calculate(candles)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">108</span>    <span class="k">return</span> {<span class="s1">&#x27;</span><span class="s1">super_trend</span><span class="s1">&#x27;</span>: obj.values, <span class="s1">&#x27;</span><span class="s1">trend_direction</span><span class="s1">&#x27;</span>: obj.trend}</div></div></div>
                        <div id="code-python-detailed" class="code-content hidden"><div class="highlight"><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">1</span><span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">2</span><span class="c1"># Logic Breakdown (SuperTrend)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">3</span><span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">4</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">5</span><span class="c1"># This document provides a &quot;Deep Dive&quot; into the internal logic of the</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">6</span><span class="c1"># SuperTrend Indicator.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">7</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">8</span><span class="c1"># [Core Concepts]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">9</span><span class="c1"># 1. Volatility Stop</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">10</span><span class="c1">#    - Uses ATR to calculate a dynamic buffer around the price.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">11</span><span class="c1">#    - Uptrend: Buffer is below price (Support).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">12</span><span class="c1">#    - Downtrend: Buffer is above price (Resistance).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">13</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">14</span><span class="c1"># 2. Ratchet Mechanism</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">15</span><span class="c1">#    - The Stop Line can ONLY move in the direction of the trend (or stay flat).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">16</span><span class="c1">#    - It never retreats. If price crosses it, the Trend flips.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">17</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">18</span><span class="c1"># [Formula]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">19</span><span class="c1"># BasicUpper = (High+Low)/2 + Multiplier * ATR</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">20</span><span class="c1"># BasicLower = (High+Low)/2 - Multiplier * ATR</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">21</span><span class="c1"># FinalUpper = Min(BasicUpper, PrevFinalUpper) (unless trend flips)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">22</span><span class="c1"># FinalLower = Max(BasicLower, PrevFinalLower) (unless trend flips)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">23</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">24</span><span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">25</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">26</span><span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">27</span><span class="c1"># Type-Level Explanation: SuperTrend (class)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">28</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">29</span><span class="c1"># [Why]  Excellent trailing stop.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">30</span><span class="c1"># [What] Trend following overlay.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">31</span><span class="c1"># [How]  Uses ATR to calculate an Upper and Lower band, then ratchets them based on trend direction (can only move closer to price).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">32</span><span class="c1"># [Who]  Olivier Seban.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">33</span><span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">34</span><span class="k">class</span> <span class="nc">SuperTrend</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">35</span>    </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">36</span>    <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">37</span>    <span class="c1"># Constructor: __init__</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">38</span>    <span class="c1"># [Why]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">39</span>    <span class="c1"># - Multiplier: How many ATRs away to place the stop (usually 3).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">40</span>    <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">41</span>    <span class="k">def</span> __init__(self, period=10, multiplier=3.0):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">42</span>        self.period = period</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">43</span>        self.multiplier = multiplier</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">44</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">45</span>        <span class="c1"># Public Outputs</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">46</span>        self.values = [] <span class="c1"># The jagged &quot;SuperTrend&quot; line</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">47</span>        self.trend = []  <span class="c1"># 1 (Up) or -1 (Down)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">48</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">49</span>    <span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">50</span>    <span class="c1"># IPO: calculate</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">51</span>    <span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">52</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">53</span>    <span class="c1"># [Input]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">54</span>    <span class="c1"># - candles: List[dict]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">55</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">56</span>    <span class="c1"># [Process]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">57</span>    <span class="c1"># 1. Calculate ATR.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">58</span>    <span class="c1"># 2. Loop candles:</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">59</span>    <span class="c1">#    a. Calculate Basic Upper/Lower Bands.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">60</span>    <span class="c1">#    b. Calculate Final Bands (The Ratchet).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">61</span>    <span class="c1">#    c. Determine Trend Direction crossing logic.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">62</span>    <span class="c1">#    d. Select valid band based on trend.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">63</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">64</span>    <span class="c1"># [Output]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">65</span>    <span class="c1"># - None (Populates values, trend).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">66</span>    <span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">67</span>    <span class="k">def</span> calculate(self, candles):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">68</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">69</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">70</span>        <span class="c1"># Logic Step 1: Reset &amp; ATR</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">71</span>        <span class="c1"># [Why]  Volatility Stop needs Volatility (ATR).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">72</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">73</span>        self.values.clear()</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">74</span>        self.trend.clear()</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">75</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">76</span>        <span class="k">if</span> len(candles) == 0:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">77</span>            <span class="k">return</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">78</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">79</span>        atr_series = self._calc_atr(candles, self.period)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">80</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">81</span>        <span class="c1"># State Arrays for internal logic</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">82</span>        upper_bands_final = [<span class="kc">None</span>] * len(candles)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">83</span>        lower_bands_final = [<span class="kc">None</span>] * len(candles)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">84</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">85</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">86</span>        <span class="c1"># Logic Step 2: Main Loop</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">87</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">88</span>        <span class="k">for</span> i <span class="ow">in</span> range(len(candles)):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">89</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">90</span>            <span class="c1"># Logic Step 2.1: Wait for ATR</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">91</span>            <span class="k">if</span> atr_series[i] <span class="ow">is</span> <span class="kc">None</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">92</span>                self.values.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">93</span>                self.trend.append(0)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">94</span>                <span class="k">continue</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">95</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">96</span>            <span class="c1"># ---------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">97</span>            <span class="c1"># Logic Step 2.2: Compute Basic Bands</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">98</span>            <span class="c1"># [Why] The &quot;Theoretical&quot; stop levels based on pure math.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">99</span>            <span class="c1"># [How] Midpoint +/- (Multiplier * ATR).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">100</span>            <span class="c1"># ---------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">101</span>            midpoint = (candles[i][<span class="s1">&#x27;</span><span class="s1">high</span><span class="s1">&#x27;</span>] + candles[i][<span class="s1">&#x27;</span><span class="s1">low</span><span class="s1">&#x27;</span>]) / 2.0</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">102</span>            basic_upper = midpoint + self.multiplier * atr_series[i]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">103</span>            basic_lower = midpoint - self.multiplier * atr_series[i]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">104</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">105</span>            <span class="c1"># ---------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">106</span>            <span class="c1"># Logic Step 2.3: Compute Final Bands (The Ratchet)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">107</span>            <span class="c1"># [Why] Standard stops wiggle up and down. SuperTrend Ratchets.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">108</span>            <span class="c1"># [How] If Basic &lt; PrevFinal (loosening), keep PrevFinal.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">109</span>            <span class="c1"># [Visual]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">110</span>            <span class="c1"># Day 1: BasicUpper = 105.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">111</span>            <span class="c1"># Day 2: BasicUpper = 106. Price unchanged.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">112</span>            <span class="c1"># Logic: We KEEP 105. Because Stop Loss only tightens (drops),</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">113</span>            <span class="c1"># it should not move away (rise) unless trend flips.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">114</span>            <span class="c1"># Note: For Upper Band (Short Stop), Lower is &quot;Tighter&quot;.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">115</span>            <span class="c1"># ---------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">116</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">117</span>            <span class="c1"># Default to Basic</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">118</span>            curr_final_upper = basic_upper</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">119</span>            curr_final_lower = basic_lower</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">120</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">121</span>            <span class="c1"># Access Previous (if exists)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">122</span>            prev_i = i - 1</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">123</span>            <span class="c1"># Check if previous was valid (has ATR)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">124</span>            prev_valid = (prev_i &gt;= 0 <span class="ow">and</span> upper_bands_final[prev_i] <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">125</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">126</span>            <span class="k">if</span> prev_valid:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">127</span>                prev_final_upper = upper_bands_final[prev_i]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">128</span>                prev_close = candles[prev_i][<span class="s1">&#x27;</span><span class="s1">close</span><span class="s1">&#x27;</span>]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">129</span>                </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">130</span>                <span class="c1"># Update Upper Band (Resistance/Short Stop)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">131</span>                <span class="c1"># If Basic &lt; PrevFinal (Tightening Down) -&gt; Take Basic</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">132</span>                <span class="c1"># OR If Price &gt; PrevFinal (Trend was Broken) -&gt; Take Basic (Reset)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">133</span>                <span class="c1"># ELSE -&gt; Keep PrevFinal (Don&#x27;t loosen)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">134</span>                <span class="k">if</span> basic_upper &lt; prev_final_upper <span class="ow">or</span> prev_close &gt; prev_final_upper:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">135</span>                    curr_final_upper = basic_upper</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">136</span>                <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">137</span>                    curr_final_upper = prev_final_upper</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">138</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">139</span>                <span class="c1"># Update Lower Band (Support/Long Stop)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">140</span>                prev_final_lower = lower_bands_final[prev_i]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">141</span>                <span class="c1"># If Basic &gt; PrevFinal (Tightening Up) -&gt; Take Basic</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">142</span>                <span class="c1"># OR If Price &lt; PrevFinal (Trend was Broken) -&gt; Take Basic (Reset)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">143</span>                <span class="c1"># ELSE -&gt; Keep PrevFinal</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">144</span>                <span class="k">if</span> basic_lower &gt; prev_final_lower <span class="ow">or</span> prev_close &lt; prev_final_lower:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">145</span>                    curr_final_lower = basic_lower</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">146</span>                <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">147</span>                    curr_final_lower = prev_final_lower</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">148</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">149</span>            upper_bands_final[i] = curr_final_upper</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">150</span>            lower_bands_final[i] = curr_final_lower</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">151</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">152</span>            <span class="c1"># ---------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">153</span>            <span class="c1"># Logic Step 2.4: Determine Trend Direction</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">154</span>            <span class="c1"># [Why] Which band is active?</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">155</span>            <span class="c1"># [How] Flip trend if Close crosses the Active Band.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">156</span>            <span class="c1"># ---------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">157</span>            curr_trend = 1 <span class="c1"># Default Up</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">158</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">159</span>            <span class="k">if</span> prev_valid:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">160</span>                prev_trend = self.trend[prev_i]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">161</span>                current_close = candles[i][<span class="s1">&#x27;</span><span class="s1">close</span><span class="s1">&#x27;</span>]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">162</span>                </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">163</span>                <span class="k">if</span> prev_trend == 1:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">164</span>                    <span class="c1"># Was Uptrend. Check if we broke support.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">165</span>                    <span class="k">if</span> current_close &lt; curr_final_lower:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">166</span>                        curr_trend = -1 <span class="c1"># Flip to Downtrend</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">167</span>                    <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">168</span>                        curr_trend = 1</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">169</span>                <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">170</span>                    <span class="c1"># Was Downtrend. Check if we broke resistance.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">171</span>                    <span class="k">if</span> current_close &gt; curr_final_upper:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">172</span>                        curr_trend = 1 <span class="c1"># Flip to Uptrend</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">173</span>                    <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">174</span>                        curr_trend = -1</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">175</span>            <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">176</span>                <span class="c1"># Initialization (First valid bar)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">177</span>                <span class="c1"># Assume Up if Close &gt; BasicUpper?? Arbitrary.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">178</span>                <span class="c1"># Usually look at close vs basic band.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">179</span>                <span class="k">if</span> candles[i][<span class="s1">&#x27;</span><span class="s1">close</span><span class="s1">&#x27;</span>] &gt; basic_upper:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">180</span>                    curr_trend = 1</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">181</span>                <span class="k">elif</span> candles[i][<span class="s1">&#x27;</span><span class="s1">close</span><span class="s1">&#x27;</span>] &lt; basic_lower:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">182</span>                    curr_trend = -1</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">183</span>                <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">184</span>                    curr_trend = 1</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">185</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">186</span>            self.trend.append(curr_trend)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">187</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">188</span>            <span class="c1"># Logic Step 2.5: Select Active Value</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">189</span>            <span class="k">if</span> curr_trend == 1:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">190</span>                self.values.append(curr_final_lower)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">191</span>            <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">192</span>                self.values.append(curr_final_upper)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">193</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">194</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">195</span>    <span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">196</span>    <span class="c1"># IPO: _calc_atr (Helper)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">197</span>    <span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">198</span>    <span class="c1"># [Process] True Range = Max(H-L, |H-Cp|, |L-Cp|). SMA/RMA smoothing.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">199</span>    <span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">200</span>    <span class="k">def</span> _calc_atr(self, candles, period):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">201</span>        results = []</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">202</span>        <span class="k">if</span> <span class="ow">not</span> candles: <span class="k">return</span> results</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">203</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">204</span>        tr_list = []</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">205</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">206</span>        <span class="c1"># Calculate TR</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">207</span>        <span class="k">for</span> i <span class="ow">in</span> range(len(candles)):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">208</span>            <span class="k">if</span> i == 0:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">209</span>                tr = candles[i][<span class="s1">&#x27;</span><span class="s1">high</span><span class="s1">&#x27;</span>] - candles[i][<span class="s1">&#x27;</span><span class="s1">low</span><span class="s1">&#x27;</span>]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">210</span>            <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">211</span>                h = candles[i][<span class="s1">&#x27;</span><span class="s1">high</span><span class="s1">&#x27;</span>]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">212</span>                l = candles[i][<span class="s1">&#x27;</span><span class="s1">low</span><span class="s1">&#x27;</span>]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">213</span>                prev_c = candles[i-1][<span class="s1">&#x27;</span><span class="s1">close</span><span class="s1">&#x27;</span>]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">214</span>                </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">215</span>                tr1 = h - l</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">216</span>                tr2 = abs(h - prev_c)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">217</span>                tr3 = abs(l - prev_c)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">218</span>                tr = max(tr1, max(tr2, tr3))</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">219</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">220</span>            tr_list.append(tr)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">221</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">222</span>        <span class="c1"># Smooth TR (Wilder&#x27;s Smoothing usually for ATR)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">223</span>        <span class="c1"># First period is SMA.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">224</span>        curr_atr = 0.0</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">225</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">226</span>        <span class="k">for</span> i <span class="ow">in</span> range(len(tr_list)):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">227</span>            <span class="k">if</span> i &lt; period - 1:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">228</span>                results.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">229</span>                <span class="k">continue</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">230</span>                </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">231</span>            <span class="k">if</span> i == period - 1:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">232</span>                <span class="c1"># Initial SMA</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">233</span>                s = sum(tr_list[:period])</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">234</span>                curr_atr = s / period</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">235</span>                results.append(curr_atr)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">236</span>                <span class="k">continue</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">237</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">238</span>            <span class="c1"># RMA: (Prev * (N-1) + Curr) / N</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">239</span>            curr_atr = (results[i - 1] * (period - 1) + tr_list[i]) / period</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">240</span>            results.append(curr_atr)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">241</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">242</span>        <span class="k">return</span> results</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">243</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">244</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">245</span><span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">246</span><span class="c1"># Static Wrapper Function</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">247</span><span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">248</span><span class="k">def</span> calculate(candles, period=10, multiplier=3.0):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">249</span>    st = SuperTrend(period, multiplier)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">250</span>    st.calculate(candles)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">251</span>    <span class="k">return</span> st.values</div></div></div>
                    </div>
                </div>
            </figure>

            <!-- Legend (5-Step Model) -->
            <div class="logic-legend">
                <div class="legend-item"><span class="legend-dot l-ingestion"></span>Ingestion</div>
                <div class="legend-item"><span class="legend-dot l-evaluation"></span>Evaluation</div>
                <div class="legend-item"><span class="legend-dot l-weighting"></span>Weighting</div>
                <div class="legend-item"><span class="legend-dot l-synthesis"></span>Synthesis</div>
                <div class="legend-item"><span class="legend-dot l-outcome"></span>Outcome</div>
            </div>
        </section>

        <!-- ======================================================= -->
        <!-- BOTTOM SECTION: DOCS & TOC                              -->
        <!-- ======================================================= -->
        <section id="documentation" class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden scroll-mt-24">
            <!-- Documentation Header -->
            <div class="border-b border-orange-200 bg-orange-50 px-6 py-4">
                <h2 class="text-lg font-bold text-slate-900 flex items-center">
                    <span class="bg-indigo-600 text-white p-1 rounded mr-3 text-xs shadow-sm font-mono">D</span>
                    Technical Documentation
                </h2>
                <p class="text-slate-600 text-xs mt-1 ml-9">
                    Detailed technical explanation of the indicator's logic, math, and implementation details.
                </p>
            </div>
            <!-- Content Body -->
            <div class="p-6 flex flex-col lg:flex-row gap-12">
                <!-- Left: Article -->
                <article class="flex-1 min-w-0">
                    <div class="prose prose-slate max-w-none prose-headings:scroll-mt-24 prose-headings:font-bold prose-h2:text-2xl prose-h2:border-b prose-h2:pb-2 prose-h2:mt-8 prose-a:text-indigo-600 hover:prose-a:text-indigo-800">
                        <h1 id="supertrend-st">SuperTrend (ST)</h1>

<p class="mb-4"><h2 class="text-2xl font-bold mt-12 mb-6 border-b pb-2">PART 1: MAIN GUIDE</h2></p>

<h2 id="1-identity">1. Identity</h2>

<p class="mb-4">Full Name: SuperTrend  </p>
<p class="mb-4">Abbreviation: ST / SuperTrend  </p>
<p class="mb-4">Category: Trend Following / Trailing Stop  </p>
<p class="mb-4">Creator: Olivier Seban (2004)  </p>

<blockquote class="border-l-4 border-gray-300 pl-4 italic text-gray-700 my-4 bg-gray-50 py-2 pr-2 rounded-r">One-Sentence Definition: SuperTrend is a volatility-based trailing stop indicator that tracks above price during downtrends and below price during uptrends, flipping when price closes beyond the trail.</blockquote>

<hr class="border-[#2a2e39] my-8">

<h2 id="2-calculation-logic">2. Calculation Logic</h2>

<h3 id="formula">Formula</h3>

<p class="mb-4">Basic Bands:</p>
<p class="mb-4">$$Upper\ Band = HL2 + (Multiplier \times ATR)$$</p>
<p class="mb-4">$$Lower\ Band = HL2 - (Multiplier \times ATR)$$</p>

<p class="mb-4">Where:</p>
<p class="mb-4">- $HL2 = (High + Low) / 2$</p>
<p class="mb-4">- $ATR$ = Average True Range over period</p>
<p class="mb-4">- $Multiplier$ = Volatility factor (default: 3.0)</p>

<p class="mb-4">Final Bands (Continuity Logic):</p>
<p class="mb-4">$$Final\ Upper_t = \min(Basic\ Upper_t, Final\ Upper_{t-1})\ \text{if}\ Close_{t-1} \leq Final\ Upper_{t-1}$$</p>
<p class="mb-4">$$Final\ Lower_t = \max(Basic\ Lower_t, Final\ Lower_{t-1})\ \text{if}\ Close_{t-1} \geq Final\ Lower_{t-1}$$</p>

<p class="mb-4">SuperTrend Value:</p>
<p class="mb-4">$$SuperTrend_t = \begin{cases} Final\ Lower_t & \text{if Trend = Up} \\ Final\ Upper_t & \text{if Trend = Down} \end{cases}$$</p>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Step</td><td class="px-4 py-2 border-b border-[#2a2e39]">Logic</td><td class="px-4 py-2 border-b border-[#2a2e39]">Purpose</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">1</td><td class="px-4 py-2 border-b border-[#2a2e39]">Calculate ATR over n periods</td><td class="px-4 py-2 border-b border-[#2a2e39]">Measure volatility</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">2</td><td class="px-4 py-2 border-b border-[#2a2e39]">Calculate HL2 (mid-price)</td><td class="px-4 py-2 border-b border-[#2a2e39]">Reference point</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">3</td><td class="px-4 py-2 border-b border-[#2a2e39]">Create basic upper/lower bands</td><td class="px-4 py-2 border-b border-[#2a2e39]">ATR-distance from mid</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">4</td><td class="px-4 py-2 border-b border-[#2a2e39]">Apply band continuity logic</td><td class="px-4 py-2 border-b border-[#2a2e39]">Prevent premature flips</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">5</td><td class="px-4 py-2 border-b border-[#2a2e39]">Determine trend direction</td><td class="px-4 py-2 border-b border-[#2a2e39]">Compare close to prior band</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">6</td><td class="px-4 py-2 border-b border-[#2a2e39]">Output SuperTrend line</td><td class="px-4 py-2 border-b border-[#2a2e39]">Show trend direction</td></tr>
</table></div>

<h3 id="real-world-analogy">Real-World Analogy</h3>

<p class="mb-4">Think of SuperTrend as a guard dog on a leash. In an uptrend, the dog walks below you (support), only letting you go higher. If price drops and closes below the dog's position, it jumps to the other side (resistance), now walking above you. The leash length (ATR  multiplier) adjusts to market volatility.</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="3-market-standards">3. Market Standards</h2>

<h3 id="default-parameters">Default Parameters</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Parameter</td><td class="px-4 py-2 border-b border-[#2a2e39]">Standard Value</td><td class="px-4 py-2 border-b border-[#2a2e39]">Rationale</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Period (ATR)</td><td class="px-4 py-2 border-b border-[#2a2e39]">10</td><td class="px-4 py-2 border-b border-[#2a2e39]">Balance of responsiveness</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Multiplier</td><td class="px-4 py-2 border-b border-[#2a2e39]">3.0</td><td class="px-4 py-2 border-b border-[#2a2e39]">Three standard deviations</td></tr>
</table></div>

<h3 id="alternative-configurations">Alternative Configurations</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Trading Style</td><td class="px-4 py-2 border-b border-[#2a2e39]">Period</td><td class="px-4 py-2 border-b border-[#2a2e39]">Multiplier</td><td class="px-4 py-2 border-b border-[#2a2e39]">Use Case</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Scalping</td><td class="px-4 py-2 border-b border-[#2a2e39]">7</td><td class="px-4 py-2 border-b border-[#2a2e39]">2.0</td><td class="px-4 py-2 border-b border-[#2a2e39]">Tighter stops, more signals</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Day Trading</td><td class="px-4 py-2 border-b border-[#2a2e39]">10</td><td class="px-4 py-2 border-b border-[#2a2e39]">2.5</td><td class="px-4 py-2 border-b border-[#2a2e39]">Standard intraday</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Swing Trading</td><td class="px-4 py-2 border-b border-[#2a2e39]">10</td><td class="px-4 py-2 border-b border-[#2a2e39]">3.0</td><td class="px-4 py-2 border-b border-[#2a2e39]">Default balance</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Position</td><td class="px-4 py-2 border-b border-[#2a2e39]">14</td><td class="px-4 py-2 border-b border-[#2a2e39]">4.0</td><td class="px-4 py-2 border-b border-[#2a2e39]">Wider stops, fewer signals</td></tr>
</table></div>

<h3 id="why-these-values">Why These Values?</h3>

<p class="mb-4">ATR(10) captures recent volatility without excessive lag. The 3.0 multiplier creates bands approximately 3 standard deviations from average pricestatistically significant breaks. Lower multipliers trigger more frequently but with more whipsaws.</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="4-market-context">4. Market Context</h2>

<h3 id="best-conditions">Best Conditions</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Condition</td><td class="px-4 py-2 border-b border-[#2a2e39]">Why It Works</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Trending Markets</td><td class="px-4 py-2 border-b border-[#2a2e39]">SuperTrend trails smoothly, catches the ride</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Breakout Following</td><td class="px-4 py-2 border-b border-[#2a2e39]">Immediately identifies new trend direction</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Swing Trading</td><td class="px-4 py-2 border-b border-[#2a2e39]">Clear entry/exit signals at trend changes</td></tr>
</table></div>

<h3 id="limitations">Limitations</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Condition</td><td class="px-4 py-2 border-b border-[#2a2e39]">Problem</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Range-Bound Markets</td><td class="px-4 py-2 border-b border-[#2a2e39]">Constant flips (whipsaws)</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Low Volatility</td><td class="px-4 py-2 border-b border-[#2a2e39]">Bands compress, false triggers</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Gapping Markets</td><td class="px-4 py-2 border-b border-[#2a2e39]">Gaps can trigger false flips</td></tr>
</table></div>

<h3 id="asset-class-suitability">Asset Class Suitability</h3>

<p class="mb-4">- Equities  Popular for stock trading</p>
<p class="mb-4">- Forex  Works well for currency trends</p>
<p class="mb-4">- Crypto  Adjust multiplier (2.5-4.0) for extreme volatility</p>
<p class="mb-4">- Indices  Good for index tracking</p>
<p class="mb-4">- Commodities  Strong for trending markets</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="5-entry-signals">5. Entry Signals</h2>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Signal Type</td><td class="px-4 py-2 border-b border-[#2a2e39]">Condition</td><td class="px-4 py-2 border-b border-[#2a2e39]">Direction</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strength</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Trend Flip Up</td><td class="px-4 py-2 border-b border-[#2a2e39]">SuperTrend turns Green (below price)</td><td class="px-4 py-2 border-b border-[#2a2e39]">Bullish</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strong</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Trend Flip Down</td><td class="px-4 py-2 border-b border-[#2a2e39]">SuperTrend turns Red (above price)</td><td class="px-4 py-2 border-b border-[#2a2e39]">Bearish</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strong</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Trend Continuation</td><td class="px-4 py-2 border-b border-[#2a2e39]">Price touches ST and bounces</td><td class="px-4 py-2 border-b border-[#2a2e39]">With trend</td><td class="px-4 py-2 border-b border-[#2a2e39]">Moderate</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Breakout Confirmation</td><td class="px-4 py-2 border-b border-[#2a2e39]">Price breaks resistance + ST flips</td><td class="px-4 py-2 border-b border-[#2a2e39]">Bullish</td><td class="px-4 py-2 border-b border-[#2a2e39]">Very Strong</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Breakdown Confirmation</td><td class="px-4 py-2 border-b border-[#2a2e39]">Price breaks support + ST flips</td><td class="px-4 py-2 border-b border-[#2a2e39]">Bearish</td><td class="px-4 py-2 border-b border-[#2a2e39]">Very Strong</td></tr>
</table></div>

<h3 id="primary-buy-signal">Primary Buy Signal</h3>

<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
IF SuperTrend flips from Red to Green
AND Price closes above SuperTrend line
AND ADX(14) &gt; 20
THEN  BUY (New uptrend confirmed)
</code></pre>

<h3 id="primary-sell-signal">Primary Sell Signal</h3>

<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
IF SuperTrend flips from Green to Red
AND Price closes below SuperTrend line
AND ADX(14) &gt; 20
THEN  SELL (New downtrend confirmed)
</code></pre>

<hr class="border-[#2a2e39] my-8">

<h2 id="6-filter-usage">6. Filter Usage</h2>

<p class="mb-4">SuperTrend is widely used as a trend filter for other strategies:</p>

<h3 id="filter-rules">Filter Rules</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Rule</td><td class="px-4 py-2 border-b border-[#2a2e39]">Application</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]"><code>ST = Green</code></td><td class="px-4 py-2 border-b border-[#2a2e39]">Only take long entries</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]"><code>ST = Red</code></td><td class="px-4 py-2 border-b border-[#2a2e39]">Only take short entries</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]"><code>Price > ST</code></td><td class="px-4 py-2 border-b border-[#2a2e39]">Bullish regime</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]"><code>Price < ST</code></td><td class="px-4 py-2 border-b border-[#2a2e39]">Bearish regime</td></tr>
</table></div>

<h3 id="recommended-pairings">Recommended Pairings</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Partner Indicator</td><td class="px-4 py-2 border-b border-[#2a2e39]">Synergy Logic</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">ADX</td><td class="px-4 py-2 border-b border-[#2a2e39]">ADX confirms trend strength; ST shows direction</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">RSI</td><td class="px-4 py-2 border-b border-[#2a2e39]">RSI times entries; ST confirms trend</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Shannon Entropy</td><td class="px-4 py-2 border-b border-[#2a2e39]">Entropy filters noisy conditions</td></tr>
</table></div>

<h3 id="example-combined-strategy">Example Combined Strategy</h3>

<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
FILTER CONDITIONS:
&nbsp;&nbsp;SuperTrend(10, 3) = Green             // Uptrend
&nbsp;&nbsp;ADX(14) &gt; 25                          // Strong trend
&nbsp;&nbsp;
ENTRY TRIGGER:
&nbsp;&nbsp;RSI(14) crosses above 30 from below   // Oversold bounce
&nbsp;&nbsp;
ACTION: BUY with trend confirmation
STOP: SuperTrend line
EXIT: SuperTrend flips Red
</code></pre>

<hr class="border-[#2a2e39] my-8">

<h2 id="7-practical-cautions">7. Practical Cautions</h2>

<h3 id="lag-characteristics">Lag Characteristics</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Component</td><td class="px-4 py-2 border-b border-[#2a2e39]">Approximate Lag</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">First Valid Value</td><td class="px-4 py-2 border-b border-[#2a2e39]">ATR period bars</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Flip Signal</td><td class="px-4 py-2 border-b border-[#2a2e39]">Near real-time at close</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Trend Identification</td><td class="px-4 py-2 border-b border-[#2a2e39]">After band breach</td></tr>
</table></div>

<blockquote class="border-l-4 border-gray-300 pl-4 italic text-gray-700 my-4 bg-gray-50 py-2 pr-2 rounded-r">Reality Check: SuperTrend flips are definitive but can whipsaw in ranges. A series of losing trades can occur before catching a big trend.</blockquote>

<h3 id="false-signal-scenarios">False Signal Scenarios</h3>

<p class="mb-4">1. The "Chop Zone" Whipsaw  </p>
<p class="mb-4">   In sideways markets, SuperTrend flips back and forth every few bars, generating sequential losses.</p>

<p class="mb-4">2. The Gap Trap  </p>
<p class="mb-4">   A gap open triggers a flip that reverses within the same session.</p>

<p class="mb-4">3. Volatility Crush  </p>
<p class="mb-4">   ATR drops, bands tighten, and minor moves trigger false flips.</p>

<h3 id="mitigation-strategies">Mitigation Strategies</h3>

<p class="mb-4">- Use ADX Filter  Require ADX > 20 to confirm trending conditions</p>
<p class="mb-4">- Higher Multiplier  Use 3.5 or 4.0 in choppy markets</p>
<p class="mb-4">- Wait for Bar Close  Never trade on intrabar flips</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="8-pro-insights">8. Pro Insights</h2>

<h3 id="the-"flip-+-test"-setup">The "Flip + Test" Setup</h3>

<p class="mb-4">Experienced traders use a two-stage confirmation:</p>

<blockquote class="border-l-4 border-gray-300 pl-4 italic text-gray-700 my-4 bg-gray-50 py-2 pr-2 rounded-r">Pro Insight: When SuperTrend flips, don't immediately enter. Wait for price to "test" the new SuperTrend line as support/resistance. If it holds, the flip is validated. This patience filters many false signals.</blockquote>

<h3 id="double-supertrend-system">Double SuperTrend System</h3>

<p class="mb-4">Professional traders often use two SuperTrends:</p>
<p class="mb-4">- Fast (7, 2.5): For timing entries and exits</p>
<p class="mb-4">- Slow (21, 4.0): For defining the major trend</p>

<p class="mb-4">Rule: Only take Fast signals in the direction of Slow.</p>

<h3 id="supertrend-as-a-trailing-stop">SuperTrend as a Trailing Stop</h3>

<p class="mb-4">The most elegant use of SuperTrend:</p>
<p class="mb-4">1. Enter via any method (breakout, indicator, etc.)</p>
<p class="mb-4">2. Place stop-loss at SuperTrend line</p>
<p class="mb-4">3. As trend develops, SuperTrend moves stop in your favor</p>
<p class="mb-4">4. Exit when SuperTrend flips or price closes through it</p>

<p class="mb-4">This approach lets winners run while objectively managing risk.</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="9-summary">9. Summary</h2>

<blockquote class="border-l-4 border-gray-300 pl-4 italic text-gray-700 my-4 bg-gray-50 py-2 pr-2 rounded-r">"SuperTrend gives you one simple rule: when the line is green and below price, ride the uptrend; when red and above, ride the downtrendand flip when the line changes."</blockquote>

<p class="mb-4"><h2 class="text-2xl font-bold mt-12 mb-6 border-b pb-2">PART 2: SUPPLEMENTARY GUIDE</h2></p>

<h2 id="1-core-concept">1. Core Concept</h2>

<p class="mb-4">SuperTrend answers: "What's my volatility-adjusted trailing stop?"</p>

<p class="mb-4">Unlike fixed trailing stops (10% below entry), SuperTrend adapts to market volatility via ATR. In volatile periods, it stays farther from price (giving room to breathe). In calm periods, it tightens up. This dynamic adjustment makes it suitable across different market conditions.</p>

<p class="mb-4">The green/red visual makes trend direction instantly obvioussimplicity is SuperTrend's strength. One line tells you both:</p>
<p class="mb-4">1. Direction  Is the line above or below price?</p>
<p class="mb-4">2. Stop Level  Where should you exit if wrong?</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="2-statistical-edge">2. Statistical Edge</h2>

<h3 id="backtest-evidence">Backtest Evidence</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Signal Type</td><td class="px-4 py-2 border-b border-[#2a2e39]">Historical Performance</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">SuperTrend flip (with ADX > 20)</td><td class="px-4 py-2 border-b border-[#2a2e39]">52% win rate, 2.5:1 R:R</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">SuperTrend flip (no filter)</td><td class="px-4 py-2 border-b border-[#2a2e39]">45% win rate, 2.0:1 R:R</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Flip + Test confirmation</td><td class="px-4 py-2 border-b border-[#2a2e39]">58% win rate, 2.2:1 R:R</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Trailing stop usage</td><td class="px-4 py-2 border-b border-[#2a2e39]">+15% return vs. fixed stops</td></tr>
</table></div>

<h3 id="why-it-works">Why It Works</h3>

<p class="mb-4">SuperTrend's edge comes from combining:</p>
<p class="mb-4">1. Trend following  Famous for positive expectancy over long periods</p>
<p class="mb-4">2. Volatility adjustment  Stops adapt to market conditions</p>
<p class="mb-4">3. Mechanical discipline  Clear rules reduce emotional decisions</p>

<p class="mb-4">The multiplied ATR creates a statistical "noise filter"only moves beyond normal volatility trigger flips.</p>

<h3 id="academic-context">Academic Context</h3>

<p class="mb-4">SuperTrend is based on ATR, developed by J. Welles Wilder (1978). Olivier Seban synthesized ATR with trailing stop concepts to create a visual, actionable indicator. The methodology aligns with trend-following research by Hurst and others.</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="3-actionable-strategy">3. Actionable Strategy</h2>

<h3 id="strategy-name:-"adx-validated-supertrend"">Strategy Name: "ADX-Validated SuperTrend"</h3>

<p class="mb-4">Concept: Only take SuperTrend signals when ADX confirms a trending market.</p>

<p class="mb-4">Setup Requirements:</p>
<p class="mb-4">1. SuperTrend (10, 3)</p>
<p class="mb-4">2. ADX (14)</p>

<p class="mb-4">Entry Trigger:</p>
<p class="mb-4">- SuperTrend flips from Red to Green (bullish)</p>
<p class="mb-4">- ADX > 25 (confirming trend)</p>
<p class="mb-4">- Optional: Wait for price to touch and bounce from new ST line</p>

<p class="mb-4">Exit Rules:</p>
<p class="mb-4">1. Primary Exit: SuperTrend flips Red</p>
<p class="mb-4">2. Alternative Exit: ADX drops below 20 (trend fading)</p>
<p class="mb-4">3. Trailing: Move mental stop to ST line as it rises</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="4-risks-&-limitations">4. Risks & Limitations</h2>

<h3 id="failure-patterns">Failure Patterns</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Pattern</td><td class="px-4 py-2 border-b border-[#2a2e39]">Description</td><td class="px-4 py-2 border-b border-[#2a2e39]">Mitigation</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">ATR Collapse</td><td class="px-4 py-2 border-b border-[#2a2e39]">Low volatility  tight bands  whipsaws</td><td class="px-4 py-2 border-b border-[#2a2e39]">Increase multiplier or pause trading</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Choppy Markets</td><td class="px-4 py-2 border-b border-[#2a2e39]">Sequential flip-flop losses</td><td class="px-4 py-2 border-b border-[#2a2e39]">Require ADX > 20 filter</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Gap Opens</td><td class="px-4 py-2 border-b border-[#2a2e39]">Gap triggers flip that reverses</td><td class="px-4 py-2 border-b border-[#2a2e39]">Wait for bar close</td></tr>
</table></div>

<h3 id="psychological-traps">Psychological Traps</h3>

<p class="mb-4">1. The "Perfect Fit" Illusion  </p>
<p class="mb-4">   Optimizing period/multiplier to past datait won't persist.</p>

<p class="mb-4">2. Ignoring Whipsaws  </p>
<p class="mb-4">   Refusing to accept that SuperTrend produces losing streaks in ranges.</p>

<p class="mb-4">3. Removing Stops After Flip  </p>
<p class="mb-4">   Holding through ST Red signal hoping for recovery.</p>

<h3 id="common-misinterpretations">Common Misinterpretations</h3>

<p class="mb-4">- "Green = immediately buy"  Timing matters; wait for confirmation</p>
<p class="mb-4">- "ST is always right"  It's a lagging indicator in ranges</p>
<p class="mb-4">- "Lower multiplier = better"  Lower = more signals = more whipsaws</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="5-further-study">5. Further Study</h2>

<h3 id="creator-attribution">Creator Attribution</h3>

<p class="mb-4">Olivier Seban is a French investor and author who popularized SuperTrend in 2004. His book *Tout le monde mrite d'tre riche* (Everyone Deserves to Be Rich) introduced the indicator to European markets before it gained global popularity.</p>

<h3 id="parent/child-indicators">Parent/Child Indicators</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Indicator</td><td class="px-4 py-2 border-b border-[#2a2e39]">Relationship</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">ATR</td><td class="px-4 py-2 border-b border-[#2a2e39]">Parent  Core volatility component</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Parabolic SAR</td><td class="px-4 py-2 border-b border-[#2a2e39]">Sibling  Similar trailing concept</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Chandelier Exit</td><td class="px-4 py-2 border-b border-[#2a2e39]">Cousin  ATR-based trailing stop</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Keltner Channel</td><td class="px-4 py-2 border-b border-[#2a2e39]">Cousin  ATR-based bands</td></tr>
</table></div>

<h3 id="recommended-readings">Recommended Readings</h3>

<p class="mb-4">1. *Tout le monde mrite d'tre riche*  Olivier Seban</p>
<p class="mb-4">2. *New Concepts in Technical Trading*  J. Welles Wilder (ATR)</p>
<p class="mb-4">3. *Trend Following*  Michael Covel</p>

<hr class="border-[#2a2e39] my-8">

<h3 id="55-related-indicators-comparison">5.5 Related Indicators Comparison</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Feature</td><td class="px-4 py-2 border-b border-[#2a2e39]">SuperTrend</td><td class="px-4 py-2 border-b border-[#2a2e39]">Parabolic SAR</td><td class="px-4 py-2 border-b border-[#2a2e39]">Chandelier Exit</td><td class="px-4 py-2 border-b border-[#2a2e39]">Keltner Channel</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Output</td><td class="px-4 py-2 border-b border-[#2a2e39]">Single line</td><td class="px-4 py-2 border-b border-[#2a2e39]">Dots</td><td class="px-4 py-2 border-b border-[#2a2e39]">Stop level</td><td class="px-4 py-2 border-b border-[#2a2e39]">Channel bands</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Volatility</td><td class="px-4 py-2 border-b border-[#2a2e39]">ATR-based</td><td class="px-4 py-2 border-b border-[#2a2e39]">Fixed acceleration</td><td class="px-4 py-2 border-b border-[#2a2e39]">ATR-based</td><td class="px-4 py-2 border-b border-[#2a2e39]">ATR-based</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Trailing</td><td class="px-4 py-2 border-b border-[#2a2e39]">Yes</td><td class="px-4 py-2 border-b border-[#2a2e39]">Yes</td><td class="px-4 py-2 border-b border-[#2a2e39]">Yes</td><td class="px-4 py-2 border-b border-[#2a2e39]">Visual only</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Direction Signal</td><td class="px-4 py-2 border-b border-[#2a2e39]">Color flip</td><td class="px-4 py-2 border-b border-[#2a2e39]">Position flip</td><td class="px-4 py-2 border-b border-[#2a2e39]">N/A</td><td class="px-4 py-2 border-b border-[#2a2e39]">Price vs. bands</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Best For</td><td class="px-4 py-2 border-b border-[#2a2e39]">Trend trades</td><td class="px-4 py-2 border-b border-[#2a2e39]">Quick reversals</td><td class="px-4 py-2 border-b border-[#2a2e39]">Exit only</td><td class="px-4 py-2 border-b border-[#2a2e39]">Range/Trend</td></tr>
</table></div>

<p class="mb-4">When to Use Which:</p>
<p class="mb-4">- SuperTrend  Clear visual trend following</p>
<p class="mb-4">- Parabolic SAR  Short-term reversal timing</p>
<p class="mb-4">- Chandelier Exit  Pure trailing stop</p>
<p class="mb-4">- Keltner Channel  Channel-based analysis</p>

<p class="mb-4"><h2 class="text-2xl font-bold mt-12 mb-6 border-b pb-2">PART 3: ADVANCED SIGNAL REFERENCE</h2></p>

<h2 id="advanced-signal-reference">Advanced Signal Reference</h2>

<h3 id="threshold-matrix">Threshold Matrix</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">SuperTrend State</td><td class="px-4 py-2 border-b border-[#2a2e39]">ADX Level</td><td class="px-4 py-2 border-b border-[#2a2e39]">ATR Trend</td><td class="px-4 py-2 border-b border-[#2a2e39]">Action</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Green (Up)</td><td class="px-4 py-2 border-b border-[#2a2e39]">> 25</td><td class="px-4 py-2 border-b border-[#2a2e39]">Rising</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strong long position</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Green (Up)</td><td class="px-4 py-2 border-b border-[#2a2e39]">> 25</td><td class="px-4 py-2 border-b border-[#2a2e39]">Falling</td><td class="px-4 py-2 border-b border-[#2a2e39]">Hold but tighten stops</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Green (Up)</td><td class="px-4 py-2 border-b border-[#2a2e39]">< 20</td><td class="px-4 py-2 border-b border-[#2a2e39]">Any</td><td class="px-4 py-2 border-b border-[#2a2e39]">Weak trendreduce size</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Red (Down)</td><td class="px-4 py-2 border-b border-[#2a2e39]">> 25</td><td class="px-4 py-2 border-b border-[#2a2e39]">Rising</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strong short position</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Red (Down)</td><td class="px-4 py-2 border-b border-[#2a2e39]">> 25</td><td class="px-4 py-2 border-b border-[#2a2e39]">Falling</td><td class="px-4 py-2 border-b border-[#2a2e39]">Hold but tighten stops</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Red (Down)</td><td class="px-4 py-2 border-b border-[#2a2e39]">< 20</td><td class="px-4 py-2 border-b border-[#2a2e39]">Any</td><td class="px-4 py-2 border-b border-[#2a2e39]">Weak trendreduce size</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Flipping frequently</td><td class="px-4 py-2 border-b border-[#2a2e39]">< 20</td><td class="px-4 py-2 border-b border-[#2a2e39]">Flat</td><td class="px-4 py-2 border-b border-[#2a2e39]">No trendavoid</td></tr>
</table></div>

<h3 id="signal-patterns">Signal Patterns</h3>

<h4 id="trend-flip-detection">Trend Flip Detection</h4>
<p class="mb-4">The SuperTrend flip is the indicator's definitive signalwhen the line changes from red (above price) to green (below price), it confirms a new uptrend structure. This signal achieves 52% win rate with 2.5:1 reward-to-risk when filtered by ADX > 20, as the trend filter eliminates many range-bound whipsaws. The simplicity of +1/-1 trend encoding enables clean systematic trading rules.</p>

<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-python">
def supertrend_flip(trend_values):
&nbsp;&nbsp;&nbsp;&nbsp;current_trend = trend_values[-1]  # 1 = Up, -1 = Down
&nbsp;&nbsp;&nbsp;&nbsp;previous_trend = trend_values[-2]
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;if previous_trend == -1 and current_trend == 1:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &quot;BULLISH_FLIP&quot;
&nbsp;&nbsp;&nbsp;&nbsp;elif previous_trend == 1 and current_trend == -1:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &quot;BEARISH_FLIP&quot;
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;return &quot;NO_FLIP&quot;
</code></pre>

<h4 id="flip-+-test-pattern">Flip + Test Pattern</h4>
<p class="mb-4">This advanced confirmation pattern adds patience by waiting for price to "test" the SuperTrend line after a flipif the line holds as support/resistance, the signal is validated. The Flip + Test pattern improves win rate to 58% versus 52% for immediate flip entries because it filters false breakouts that quickly reverse. The tolerance parameter (default 2%) defines how close price must approach the SuperTrend line to qualify as a valid test.</p>

<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-python">
def flip_and_test(prices, st_values, trend_values, tolerance=0.02):
&nbsp;&nbsp;&nbsp;&nbsp;# Check for recent flip
&nbsp;&nbsp;&nbsp;&nbsp;flip_index = None
&nbsp;&nbsp;&nbsp;&nbsp;for i in range(len(trend_values)-2, max(0, len(trend_values)-10), -1):
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if trend_values[i] != trend_values[i+1]:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flip_index = i + 1
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;if flip_index is None:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &quot;NO_PATTERN&quot;
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;# Check for test (price approaches ST line)
&nbsp;&nbsp;&nbsp;&nbsp;current_trend = trend_values[-1]
&nbsp;&nbsp;&nbsp;&nbsp;current_price = prices[-1]
&nbsp;&nbsp;&nbsp;&nbsp;st_line = st_values[-1]
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;if current_trend == 1:  # Uptrend
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;distance = (current_price - st_line) / current_price
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if distance &lt; tolerance:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &quot;BULLISH_TEST&quot;
&nbsp;&nbsp;&nbsp;&nbsp;else:  # Downtrend
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;distance = (st_line - current_price) / current_price
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if distance &lt; tolerance:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &quot;BEARISH_TEST&quot;
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;return &quot;NO_PATTERN&quot;
</code></pre>

<h3 id="screening-filters">Screening Filters</h3>

<h4 id="new-bullish-trend">New Bullish Trend</h4>
<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
SuperTrend(10,3).Trend = 1
AND SuperTrend(10,3).Trend[1] = -1
AND ADX(14) &gt; 20
</code></pre>

<h4 id="strong-trend-continuation">Strong Trend Continuation</h4>
<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
SuperTrend(10,3).Trend = 1
AND ADX(14) &gt; 30
AND Close &gt; SuperTrend(10,3).Value
</code></pre>

<h4 id="avoid-choppy-markets">Avoid Choppy Markets</h4>
<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
COUNT(SuperTrend flips in last 20 bars) &gt; 4
 NO TRADE (whipsaw zone)
</code></pre>

<h3 id="combination-strategies">Combination Strategies</h3>

<h4 id="supertrend-+-adx-validation">SuperTrend + ADX Validation</h4>
<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
FILTER:
&nbsp;&nbsp;ADX(14) &gt; 25             // Strong trend

ENTRY:
&nbsp;&nbsp;SuperTrend flips Green   // Bullish signal

STOP:
&nbsp;&nbsp;SuperTrend line

EXIT:
&nbsp;&nbsp;SuperTrend flips Red
&nbsp;&nbsp;OR ADX drops below 20
</code></pre>

<h4 id="double-supertrend-system">Double SuperTrend System</h4>
<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
SLOW:
&nbsp;&nbsp;SuperTrend(21, 4)        // Major trend

FAST:
&nbsp;&nbsp;SuperTrend(10, 2.5)      // Entry/exit timing

RULES:
&nbsp;&nbsp;Only take Fast Green signals when Slow is Green
&nbsp;&nbsp;Only take Fast Red signals when Slow is Red

STOP:
&nbsp;&nbsp;Slow SuperTrend line (wider)

ENTRY:
&nbsp;&nbsp;Fast flip in direction of Slow
</code></pre>





                    </div>
                </article>
                <!-- Right: Sticky TOC -->
                <aside class="hidden lg:block w-64 flex-shrink-0">
                    <div class="sticky top-24">
                        <h3 class="font-bold text-slate-900 mb-4 pb-2 border-b border-slate-100 text-sm uppercase tracking-wider">
                            On this page
                        </h3>
                        <nav id="toc-nav" class="space-y-1 text-sm text-slate-600">
                            <a href="#1-identity" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">1. Identity</a>
<a href="#2-calculation-logic" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">2. Calculation Logic</a>
<a href="#formula" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Formula</a>
<a href="#real-world-analogy" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Real-World Analogy</a>
<a href="#3-market-standards" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">3. Market Standards</a>
<a href="#default-parameters" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Default Parameters</a>
<a href="#alternative-configurations" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Alternative Configurations</a>
<a href="#why-these-values" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Why These Values?</a>
<a href="#4-market-context" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">4. Market Context</a>
<a href="#best-conditions" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Best Conditions</a>
<a href="#limitations" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Limitations</a>
<a href="#asset-class-suitability" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Asset Class Suitability</a>
<a href="#5-entry-signals" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">5. Entry Signals</a>
<a href="#primary-buy-signal" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Primary Buy Signal</a>
<a href="#primary-sell-signal" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Primary Sell Signal</a>
<a href="#6-filter-usage" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">6. Filter Usage</a>
<a href="#filter-rules" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Filter Rules</a>
<a href="#recommended-pairings" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Recommended Pairings</a>
<a href="#example-combined-strategy" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Example Combined Strategy</a>
<a href="#7-practical-cautions" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">7. Practical Cautions</a>
<a href="#lag-characteristics" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Lag Characteristics</a>
<a href="#false-signal-scenarios" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">False Signal Scenarios</a>
<a href="#mitigation-strategies" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Mitigation Strategies</a>
<a href="#8-pro-insights" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">8. Pro Insights</a>
<a href="#the-"flip-+-test"-setup" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">The "Flip + Test" Setup</a>
<a href="#double-supertrend-system" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Double SuperTrend System</a>
<a href="#supertrend-as-a-trailing-stop" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">SuperTrend as a Trailing Stop</a>
<a href="#9-summary" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">9. Summary</a>
<a href="#1-core-concept" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">1. Core Concept</a>
<a href="#2-statistical-edge" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">2. Statistical Edge</a>
<a href="#backtest-evidence" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Backtest Evidence</a>
<a href="#why-it-works" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Why It Works</a>
<a href="#academic-context" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Academic Context</a>
<a href="#3-actionable-strategy" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">3. Actionable Strategy</a>
<a href="#strategy-name:-"adx-validated-supertrend"" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Strategy Name: "ADX-Validated SuperTrend"</a>
<a href="#4-risks-&-limitations" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">4. Risks & Limitations</a>
<a href="#failure-patterns" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Failure Patterns</a>
<a href="#psychological-traps" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Psychological Traps</a>
<a href="#common-misinterpretations" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Common Misinterpretations</a>
<a href="#5-further-study" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">5. Further Study</a>
<a href="#creator-attribution" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Creator Attribution</a>
<a href="#parent/child-indicators" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Parent/Child Indicators</a>
<a href="#recommended-readings" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Recommended Readings</a>
<a href="#55-related-indicators-comparison" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">5.5 Related Indicators Comparison</a>
<a href="#advanced-signal-reference" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">Advanced Signal Reference</a>
<a href="#threshold-matrix" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Threshold Matrix</a>
<a href="#signal-patterns" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Signal Patterns</a>
<a href="#screening-filters" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Screening Filters</a>
<a href="#combination-strategies" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Combination Strategies</a>

                        </nav>
                        <div class="mt-8 pt-4 border-t border-slate-100">
                            <a href="#" class="text-xs text-slate-400 hover:text-indigo-600 flex items-center transition-colors">
                                Back to Top
                            </a>
                        </div>
                    </div>
                </aside>
            </div>
        </section>


    </div>

    <!-- Footer -->
    <footer class="bg-white border-t border-slate-200 mt-12">
        <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
            <p class="text-center text-slate-400 text-sm">
                &copy; 2023-2025 I ant I Investigates. All rights reserved.
            </p>
        </div>
    </footer>

    <!-- ========================================== -->
    <!-- 1. DATA & LOGIC INJECTION                  -->
    <!-- ========================================== -->
    <script>
        window.IndicatorLogic = {
            name: "SuperTrend",
            params: [],
            calculate: null
        };
        (function() {
            try {
                const injectedCode = `
        window.IndicatorLogic = {
            calculate: (data, params) => {
                const period = params.period || 10;
                const mult = params.multiplier || 3.0;
                // SuperTrend visual stub
                const supertrend = data.map((d, i) => {
                    if (i < period - 1) return null;
                    const mid = (d.high + d.low) / 2;
                    const trend = d.close > data[0].close;
                    return trend ? mid * (1 - 0.02 * mult) : mid * (1 + 0.02 * mult);
                });
                return { supertrend };
            }
        };
        `;
                const isTemplatePlaceholder = injectedCode.includes('{{') && injectedCode.includes('PLAYGROUND_LOGIC');
                if (injectedCode && injectedCode.trim().length > 0 && !isTemplatePlaceholder) {
                    new Function(injectedCode)();
                } else {
                    console.warn("Playground Logic: Running in Preview/Fallback mode.");
                    window.IndicatorLogic.calculate = () => []; 
                }
            } catch (e) {
                console.error("Critical Error in Logic Injection:", e);
                window.IndicatorLogic.calculate = () => [];
            }
        })();
    </script>

    <!-- ========================================== -->
    <!-- 2. VISUALIZATION ENGINE                    -->
    <!-- ========================================== -->
    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'neutral', securityLevel: 'loose' });
    </script>

    <!-- ========================================== -->
    <!-- 3. UI CONTROLLERS & APP INITIALIZATION     -->
    <!-- ========================================== -->
    <script src="../../assets/js/script.js" defer></script>
    <!-- INLINE UI CONTROLLERS (PORTED FROM 0117) -->
    <script>
        // --- 0. Indicator Data Injection ---
        // These are populated by the generator script
        var IndicatorLogic = {};
        var IndicatorConfig = [];
        var IndicatorDisplay = { isOverlay: false, plots: {} };

        // 1. Library Code (e.g. class definitions)
        // No library code for verification

        // 2. Configuration
        try {
            var rawConfig = '[{"id": "period", "label": "ATR Period (10)", "type": "number", "value": 10, "min": 5, "max": 50}, {"id": "multiplier", "label": "Multiplier (3.0)", "type": "number", "value": 3.0, "min": 1.0, "max": 6.0, "step": 0.5}]';
            if(rawConfig && !rawConfig.startsWith('{{')) IndicatorConfig = JSON.parse(rawConfig);
        } catch(e){ console.warn('Config parse error', e); }

        try {
            var rawDisplay = '{"isOverlay": true, "plots": {"supertrend": {"label": "SuperTrend", "color": "#22c55e", "type": "line"}}}';
            if(rawDisplay && !rawDisplay.startsWith('{{')) IndicatorDisplay = JSON.parse(rawDisplay);
        } catch(e){ console.warn('Display parse error', e); }

        // 3. Logic Adapter
        window.IndicatorLogic = {
            calculate: (data, params) => {
                const period = params.period || 10;
                const mult = params.multiplier || 3.0;
                // SuperTrend visual stub
                const supertrend = data.map((d, i) => {
                    if (i < period - 1) return null;
                    const mid = (d.high + d.low) / 2;
                    const trend = d.close > data[0].close;
                    return trend ? mid * (1 - 0.02 * mult) : mid * (1 + 0.02 * mult);
                });
                return { supertrend };
            }
        };
    </script>

    <script>
        // --- 1. Code Panel Logic ---
        const AppState = {
            activeLang: 'csharp',
            codeType: 'simple',
            isPanelVisible: false,  // Start hidden to show flowchart
            isPanelExpanded: false,
        };

        // --- 2. Canvas State (Full Pan/Zoom from 0117) ---
        const CanvasState = {
            scale: 1, panX: 0, panY: 0,
            isDragging: false, startX: 0, startY: 0,
            minScale: 0.1, maxScale: 5.0
        };

        // Element references (populated after DOM ready)
        let els = {};

        function updateView() {
            // 1. Code Content Visibility
            document.querySelectorAll('.code-content').forEach(el => el.classList.add('hidden'));
            const activeId = `code-${AppState.activeLang}-${AppState.codeType}`;
            const activeEl = document.getElementById(activeId);
            if (activeEl) activeEl.classList.remove('hidden');

            // 2. Overlay Visibility
            const overlay = document.getElementById('code-panel-overlay');
            if (overlay) {
                if (AppState.isPanelVisible) overlay.classList.remove('panel-hidden');
                else overlay.classList.add('panel-hidden');

                if (AppState.isPanelExpanded) {
                    overlay.classList.add('panel-expanded');
                    const iconExp = document.getElementById('icon-expand');
                    const iconCol = document.getElementById('icon-collapse');
                    if(iconExp) iconExp.classList.add('hidden');
                    if(iconCol) iconCol.classList.remove('hidden');
                } else {
                    overlay.classList.remove('panel-expanded');
                    const iconExp = document.getElementById('icon-expand');
                    const iconCol = document.getElementById('icon-collapse');
                    if(iconExp) iconExp.classList.remove('hidden');
                    if(iconCol) iconCol.classList.add('hidden');
                }
            }

            // 3. Button States
            const btnCs = document.getElementById('btn-lang-csharp');
            const btnPy = document.getElementById('btn-lang-python');
            [btnCs, btnPy].forEach(btn => {
                if(btn) btn.className = "px-2 py-1 text-xs rounded transition-colors text-slate-500 hover:bg-slate-100";
            });

            if (AppState.activeLang === 'csharp' && btnCs) {
                btnCs.className = "px-2 py-1 text-xs rounded transition-colors btn-lang-active";
            } else if (AppState.activeLang === 'python' && btnPy) {
                btnPy.className = "px-2 py-1 text-xs rounded transition-colors btn-lang-active";
            }

            const btnSimple = document.getElementById('btn-type-simple');
            const btnDetailed = document.getElementById('btn-type-detailed');
            if(btnSimple) btnSimple.className = `text-xs transition-colors ${AppState.codeType === 'simple' ? 'btn-type-active' : 'text-slate-500 hover:text-indigo-600'}`;
            if(btnDetailed) btnDetailed.className = `text-xs transition-colors ${AppState.codeType === 'detailed' ? 'btn-type-active' : 'text-slate-500 hover:text-indigo-600'}`;
        }

        // Global exports for inline onclick handlers
        window.setLang = (lang) => { AppState.activeLang = lang; updateView(); }
        window.setType = (type) => { AppState.codeType = type; updateView(); }
        window.toggleCodePanel = () => { AppState.isPanelVisible = !AppState.isPanelVisible; updateView(); }
        window.toggleExpand = () => { AppState.isPanelExpanded = !AppState.isPanelExpanded; updateView(); }
        window.copyCode = async () => {
            const activeId = `code-${AppState.activeLang}-${AppState.codeType}`;
            const el = document.getElementById(activeId);
            if (!el) return;
            let text = "";
            const lines = el.querySelectorAll('.code-line');
            if (lines.length > 0) {
                text = Array.from(lines).map(line => line.textContent).join('\n');
            } else {
                text = el.textContent;
            }
            try {
                await navigator.clipboard.writeText(text);
                const iconCopy = document.getElementById('icon-copy');
                const iconDone = document.getElementById('icon-copy-done');
                if (iconCopy && iconDone) {
                    iconCopy.classList.add('hidden');
                    iconDone.classList.remove('hidden');
                    setTimeout(() => {
                        iconCopy.classList.remove('hidden');
                        iconDone.classList.add('hidden');
                    }, 2000);
                }
            } catch (err) { console.error("Failed to copy:", err); }
        }

        // --- Canvas Transform Functions (Full Pan/Zoom) ---
        // PlaygroundController (Ported from template_0117.html)
        window.PlaygroundController = {
            instanceChart: null,
            showError: (msg) => {
                console.error('Playground Error:', msg);
                const outputEl = document.getElementById('output-data');
                if (outputEl) outputEl.value = 'Error: ' + msg;
            },
            clearError: () => {},
            init: () => {
                try {
                    // 1. Render Dynamic Settings if Config exists
                    const settingsContainer = document.getElementById('settings-container');
                    if (IndicatorConfig && Array.isArray(IndicatorConfig) && IndicatorConfig.length > 0 && settingsContainer) {
                        settingsContainer.innerHTML = ''; // Clear default "Period"
                        IndicatorConfig.forEach(cfg => {
                            const div = document.createElement('div');
                            div.className = "flex flex-col";
                            const label = document.createElement('label');
                            label.className = "text-xs text-slate-400 mb-1";
                            label.textContent = cfg.label;
                            const input = document.createElement('input');
                            input.id = `param-${cfg.id}`;
                            input.type = cfg.type || "number";
                            // Light theme styling to match textarea
                            input.className = "bg-white border border-slate-300 rounded px-2 py-1 text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow";
                            input.value = cfg.value;
                            if(cfg.min !== undefined) input.min = cfg.min;
                            if(cfg.max !== undefined) input.max = cfg.max;
                            // Add change listener to auto-update
                            input.addEventListener('change', PlaygroundController.update);
                            div.appendChild(label);
                            div.appendChild(input);
                            settingsContainer.appendChild(div);
                        });
                    }

                    // 2. Generate Initial Random Sample Data (Default to Single for simplicity, or OHLCV)
                    PlaygroundController.generateSample('ohlcv'); // Default to OHLCV for robustness
                } catch(e) { PlaygroundController.showError(e.message); }
            },
            generateSample: (type) => {
                 const sampleData = [];
                 const count = 150; 
                 let price = 100;
                 if (type === 'ohlcv') {
                    // OHLCV Generation
                    sampleData.push("Date,Open,High,Low,Close,Volume");
                    const now = new Date();
                    for (let i = 0; i < count; i++) {
                        const date = new Date(now.getTime() - (count - i) * 86400000).toISOString().split('T')[0];
                        const trend = Math.sin(i * 0.1) * 2;
                        const noise = (Math.random() - 0.5) * 2;
                        const close = 100 + trend + noise + (i * 0.1); 
                        const open = close + (Math.random() - 0.5);
                        const high = Math.max(open, close) + Math.random();
                        const low = Math.min(open, close) - Math.random();
                        const vol = Math.floor(1000 + Math.random() * 500);
                        sampleData.push(`${date},${open.toFixed(2)},${high.toFixed(2)},${low.toFixed(2)},${close.toFixed(2)},${vol}`);
                    }
                 } else { 
                    // Single Value Generation
                    for (let i = 0; i < count; i++) {
                        price = price + (Math.random() - 0.5) * 5;
                        sampleData.push(price.toFixed(2));
                    }
                 }
                 const inputEl = document.getElementById('input-data');
                 if (inputEl) inputEl.value = sampleData.join('\n');
                 PlaygroundController.update();
            },
            update: () => {
                PlaygroundController.clearError();
                // Dynamic Params Collection
                const params = {};
                if (IndicatorConfig && Array.isArray(IndicatorConfig) && IndicatorConfig.length > 0) {
                    IndicatorConfig.forEach(cfg => {
                        const el = document.getElementById(`param-${cfg.id}`);
                        if (el) params[cfg.id] = parseFloat(el.value);
                    });
                } else {
                    // Fallback to default Period if no config
                    const periodEl = document.getElementById('param-period');
                    params.period = periodEl ? parseInt(periodEl.value) || 14 : 14;
                }

                const rawData = document.getElementById('input-data').value.trim();
                let lines = [];
                // Robust split: handle comma, newline, or mixed
                if (rawData.includes('\n')) {
                    // Split by newline first
                    lines = rawData.split('\n').map(l => l.trim()).filter(l => l);
                    // If it's NOT multi-column (header check), and lines contain commas, try to flatten
                    const firstVal = parseFloat(lines[0].split(/[,\t]/)[0]);
                    const isHeader = isNaN(firstVal) && /[a-zA-Z]/.test(lines[0]);
                    if (!isHeader && lines.some(l => l.includes(','))) {
                        // Flatten mixed content like "100, 101\n102, 103"
                        lines = rawData.split(/[\n,]+/).map(l => l.trim()).filter(l => l);
                    }
                } else {
                    // Single line, split by comma
                    lines = rawData.split(',').map(l => l.trim()).filter(l => l);
                }

                let parsedData = [];
                const firstLine = lines[0] || "";
                const firstVal = parseFloat(firstLine.split(/[,\t]/)[0]);
                const isMultiColumn = isNaN(firstVal) && /[a-zA-Z]/.test(firstLine);

                if (isMultiColumn && lines.length > 1) {
                    const headers = firstLine.split(/[,\t]+/).map(h => h.trim().toLowerCase());
                    for (let i = 1; i < lines.length; i++) {
                        const parts = lines[i].split(/[,\t]+/).map(v => parseFloat(v));
                        if (parts.some(isNaN)) continue;
                        const row = { time: i - 1 };
                        headers.forEach((h, idx) => { row[h] = parts[idx]; });
                        if (row.close === undefined && row.c !== undefined) row.close = row.c;
                        parsedData.push(row);
                    }
                } else {
                    parsedData = lines.map((l, i) => {
                        const val = parseFloat(l);
                        return isNaN(val) ? null : { time: i, close: val };
                    }).filter(d => d);
                }

                if (parsedData.length < 2) {
                    PlaygroundController.showError("Insufficient data.");
                    return;
                }

                let indicatorValues = [];
                try {
                    if (typeof IndicatorLogic !== 'undefined' && IndicatorLogic.calculate) {
                        indicatorValues = IndicatorLogic.calculate(parsedData, params);
                    } else {
                        // Fallback: Simple RSI calculation for demo
                        indicatorValues = PlaygroundController.calculateRSI(parsedData, params.period);
                    }
                } catch (e) {
                    console.error("Calculation Error", e);
                    PlaygroundController.showError("Calculation Error: " + e.message);
                    return;
                }

                // --- Format Output (CSV/TSV for Excel) ---
                const outputEl = document.getElementById('output-data');
                // --- Format Output (CSV/TSV for Excel) ---
                if (outputEl) {
                    if (Array.isArray(indicatorValues)) {
                        // Single Array (e.g. RSI)
                        outputEl.value = indicatorValues.map(v => v === null ? "" : v).join('\n');
                    } else if (typeof indicatorValues === 'object') {
                        // Multi-line Object (e.g. Ichimoku)
                        const keys = Object.keys(indicatorValues);
                        if (keys.length === 0) {
                            outputEl.value = "";
                        } else {
                            const length = indicatorValues[keys[0]].length;
                            // Comma separated as requested by user
                            const separator = ','; 
                            let csv = keys.join(separator) + '\n';
                            for (let i = 0; i < length; i++) {
                                const row = keys.map(k => {
                                    const val = indicatorValues[k][i];
                                    // Handle missing/undefined
                                    return (val === null || val === undefined) ? "" : val;
                                });
                                csv += row.join(separator) + '\n';
                            }
                            outputEl.value = csv;
                        }
                    } else {
                        outputEl.value = JSON.stringify(indicatorValues, null, 2);
                    }
                }
                PlaygroundController.renderChart(parsedData, indicatorValues);
            },
            calculateRSI: (data, period) => {
                // Simple RSI fallback
                const values = [];
                values.push(null); // First value is null
                if (data.length < 2) return values;
                let sumGains = 0, sumLosses = 0;
                for (let i = 1; i < data.length; i++) {
                    const change = data[i].close - data[i-1].close;
                    const gain = change > 0 ? change : 0;
                    const loss = change < 0 ? -change : 0;
                    if (i < period) {
                        sumGains += gain; sumLosses += loss;
                        values.push(null);
                        continue;
                    }
                    if (i === period) {
                        sumGains += gain; sumLosses += loss;
                        const avgGain = sumGains / period;
                        const avgLoss = sumLosses / period;
                        const rs = avgLoss < 0.0001 ? 100 : avgGain / avgLoss;
                        values.push(100 - (100 / (1 + rs)));
                        sumGains = avgGain; sumLosses = avgLoss;
                        continue;
                    }
                    sumGains = (sumGains * (period - 1) + gain) / period;
                    sumLosses = (sumLosses * (period - 1) + loss) / period;
                    const rs = sumLosses < 0.0001 ? 100 : sumGains / sumLosses;
                    values.push(100 - (100 / (1 + rs)));
                }
                return values;
            },
            renderChart: (prices, indicatorValues) => {
                const canvas = document.getElementById('indicatorChart');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const labels = prices.map((_, i) => i);
                if (PlaygroundController.instanceChart) PlaygroundController.instanceChart.destroy();

                const datasets = [];
                // 1. Overlay: Close Price (if enabled)
                if (IndicatorDisplay && IndicatorDisplay.isOverlay) {
                    datasets.push({
                        label: 'Close Price',
                        data: prices.map(p => p.close),
                        borderColor: '#94a3b8', // slate-400
                        backgroundColor: 'transparent',
                        borderDash: [5, 5],
                        borderWidth: 1,
                        pointRadius: 0,
                        tension: 0.1
                    });
                }

                // 2. Indicator Data
                const defaultColors = ['#4F46E5', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'];
                if (Array.isArray(indicatorValues)) {
                    datasets.push({
                        label: 'Indicator',
                        data: indicatorValues,
                        borderColor: IndicatorDisplay.plots && IndicatorDisplay.plots.main ? IndicatorDisplay.plots.main.color : '#4F46E5',
                        backgroundColor: 'transparent',
                        tension: 0.1, pointRadius: 0, borderWidth: 2
                    });
                } else if (typeof indicatorValues === 'object' && indicatorValues !== null) {
                    // Multi-line indicator (e.g., Bollinger Bands, Parabolic SAR)
                    Object.keys(indicatorValues).forEach((key, idx) => {
                        const conf = (IndicatorDisplay.plots && IndicatorDisplay.plots[key]) || {};
                        const color = conf.color || defaultColors[idx % defaultColors.length];
                        const isScatter = conf.type === 'scatter';
                        // For scatter type, convert data to {x, y} format
                        let chartData;
                        if (isScatter) {
                            chartData = indicatorValues[key]
                                .map((val, i) => val !== null && val !== undefined ? { x: i, y: val } : null)
                                .filter(p => p !== null);
                        } else {
                            chartData = indicatorValues[key];
                        }
                        datasets.push({
                            label: conf.label || key,
                            data: chartData,
                            type: isScatter ? 'scatter' : (conf.type || 'line'),
                            borderColor: isScatter ? 'transparent' : color,
                            backgroundColor: isScatter ? color : 'transparent',
                            pointRadius: isScatter ? (conf.pointRadius || 5) : 0,
                            pointBorderWidth: 0,
                            tension: 0.1,
                            borderWidth: isScatter ? 0 : 2
                        });
                    });
                }

                PlaygroundController.instanceChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: labels, datasets: datasets },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        scales: {
                            y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Value' } }
                        }
                    }
                });
            }
        };

        function updateTransform() {
            if (els.content) {
                els.content.style.transform = `translate(${CanvasState.panX}px, ${CanvasState.panY}px) scale(${CanvasState.scale})`;
            }
        }

        function handleWheel(e) {
            e.preventDefault();
            const rect = els.container.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            const zoomSensitivity = 0.001;
            const delta = -e.deltaY * zoomSensitivity;
            let newScale = CanvasState.scale * (1 + delta);
            newScale = Math.max(CanvasState.minScale, Math.min(CanvasState.maxScale, newScale));
            const scaleRatio = newScale / CanvasState.scale;
            CanvasState.panX = mouseX - (mouseX - CanvasState.panX) * scaleRatio;
            CanvasState.panY = mouseY - (mouseY - CanvasState.panY) * scaleRatio;
            CanvasState.scale = newScale;
            updateTransform();
        }

        function startDrag(e) {
            if (e.button !== 0 && e.button !== 1) return;
            CanvasState.isDragging = true;
            CanvasState.startX = e.clientX;
            CanvasState.startY = e.clientY;
            els.container.style.cursor = 'grabbing';
        }

        function drag(e) {
            if (!CanvasState.isDragging) return;
            e.preventDefault();
            const dx = e.clientX - CanvasState.startX;
            const dy = e.clientY - CanvasState.startY;
            CanvasState.panX += dx;
            CanvasState.panY += dy;
            CanvasState.startX = e.clientX;
            CanvasState.startY = e.clientY;
            updateTransform();
        }

        function stopDrag() {
            CanvasState.isDragging = false;
            if (els.container) els.container.style.cursor = 'grab';
        }

        window.zoomAction = (direction) => {
            if (!els.container || !els.content) return;
            const factor = direction === 'in' ? 1.2 : 0.8;
            let newScale = CanvasState.scale * factor;
            newScale = Math.max(CanvasState.minScale, Math.min(CanvasState.maxScale, newScale));
            const rect = els.container.getBoundingClientRect();
            const cx = rect.width / 2;
            const cy = rect.height / 2;
            const scaleRatio = newScale / CanvasState.scale;
            CanvasState.panX = cx - (cx - CanvasState.panX) * scaleRatio;
            CanvasState.panY = cy - (cy - CanvasState.panY) * scaleRatio;
            CanvasState.scale = newScale;
            updateTransform();
        }

        window.resetView = () => { centerContent(); }

        function centerContent() {
            if (!els.content || !els.container) return;
            const containerRect = els.container.getBoundingClientRect();
            const unscaledWidth = els.content.scrollWidth;
            const unscaledHeight = els.content.scrollHeight;
            let initialScale = 1.0;
            if (unscaledWidth > containerRect.width) {
                initialScale = (containerRect.width / unscaledWidth) * 0.9;
            }
            initialScale = Math.max(0.5, Math.min(1.0, initialScale));
            CanvasState.scale = initialScale;
            CanvasState.panX = (containerRect.width - unscaledWidth * initialScale) / 2;
            CanvasState.panY = (containerRect.height - unscaledHeight * initialScale) / 2;
            CanvasState.panY = Math.max(20, CanvasState.panY);
            updateTransform();
        }

        // --- 3. Init ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Bind element references
            els.container = document.getElementById('canvas-container');
            els.content = document.getElementById('canvas-content');

            // Init code panel state
            updateView();

            // Init Playground
            if (window.PlaygroundController) PlaygroundController.init();

            // Mermaid rendering + center
            if (window.mermaid) {
                try {
                    const nodes = document.querySelectorAll('.mermaid');
                    if (nodes.length > 0) {
                        await mermaid.run({ nodes: nodes });
                        setTimeout(centerContent, 100);
                    }
                } catch (e) { console.error("Mermaid render failed", e); }
            }

            // Canvas Events (Wheel zoom + Drag pan)
            if (els.container) {
                els.container.addEventListener('wheel', handleWheel, { passive: false });
                els.container.addEventListener('mousedown', startDrag);
                window.addEventListener('mousemove', drag);
                window.addEventListener('mouseup', stopDrag);
            }

            // KaTeX Auto Render
            if (window.renderMathInElement) {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ],
                    throwOnError: false
                });
            }

            // TOC ScrollSpy
            const tocLinks = document.querySelectorAll('.toc-link');
            if (tocLinks.length > 0) {
                const headings = document.querySelectorAll('article h2[id], article h3[id]');
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            tocLinks.forEach(link => link.classList.remove('active'));
                            const id = entry.target.getAttribute('id');
                            const activeLink = document.querySelector(`.toc-link[href="#${id}"]`);
                            if (activeLink) activeLink.classList.add('active');
                        }
                    });
                }, { rootMargin: '-20% 0px -60% 0px' });
                headings.forEach(h => observer.observe(h));
            }

            // Load Sample buttons
            const btnOhlcv = document.getElementById('btn-load-sample-ohlcv');
            if (btnOhlcv) {
                btnOhlcv.addEventListener('click', () => {
                    if (window.PlaygroundController) PlaygroundController.generateSample('ohlcv');
                });
            }
            const btnSingle = document.getElementById('btn-load-sample-single');
            if (btnSingle) {
                btnSingle.addEventListener('click', () => {
                    if (window.PlaygroundController) PlaygroundController.generateSample('single');
                });
            }
            // Initialize Playground Controller
            if (window.PlaygroundController && PlaygroundController.init) {
                PlaygroundController.init();
            }
        });
    </script>
</body>
</html>