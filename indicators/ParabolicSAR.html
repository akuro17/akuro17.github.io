<!DOCTYPE html>
<html lang="ja" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParabolicSAR - I ant I Investigates</title>
    <meta name="description" content="">
    <meta name="keywords" content="">
    <!-- Structured Data for SEO -->
    <script type="application/ld+json">
        {
    "@context": "https://schema.org",
    "@type": "TechArticle",
    "headline": "ParabolicSAR",
    "description": "Detailed guide for ParabolicSAR indicator.",
    "author": {
        "@type": "Organization",
        "name": "I and I Investigates"
    }
}
    </script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- Styles -->
    <!-- Styles -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <link rel="stylesheet" href="../../assets/css/style.css">
    <!-- KaTeX (Math) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>

    <style>
        /* =========================================
           PORTED STYLES (From 0117 Template)
           ========================================= */
        :root {
            /* Minimal Variable Set for Logic Panel */
            --bg-card: #FFFFFF;
            --bg-secondary: #F8FAFC; /* slate-50 */
            --bg-hover: #F1F5F9; /* slate-100 */
            --border-color: #E2E8F0; /* slate-200 */
            --text-primary: #1E293B; /* slate-800 */
            --text-muted: #64748B; /* slate-500 */
            --accent: #4F46E5; /* indigo-600 */
        }

        /* Logic Figure Container */
        .logic-figure {
            margin: 0;
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            position: relative;
            overflow: hidden;
            height: 600px; /* Fixed height for infinite canvas feel */
        }

        /* Infinite Canvas Wrapper */
        .chart-scroll-wrapper {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
            background-color: #FFFFFF;
            background-image: radial-gradient(#E2E8F0 1.5px, transparent 1.5px);
            background-size: 20px 20px;
            cursor: grab;
            touch-action: none;
            user-select: none;
        }
        .chart-scroll-wrapper:active { cursor: grabbing; }

        /* Code Panel Overlay */
        #code-panel-overlay {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            width: 500px;
            max-width: 90%;
            z-index: 30;
            background-color: var(--bg-card);
            border-right: 1px solid var(--border-color);
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), width 0.3s ease;
            transform: translateX(0);
        }
        #code-panel-overlay.panel-hidden {
            transform: translateX(-100%);
            pointer-events: none;
        }
        #code-panel-overlay.panel-expanded {
            width: 100%;
            max-width: 100%;
        }

        /* Code Content */
        .code-panel-body {
            background-color: #FAFAFA;
            flex: 1;
            overflow: auto;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            padding: 0.5rem 1rem 1rem 1rem; /* Reduced top padding */
            white-space: pre; /* Essential for code indentation */
        }
        .code-content {
            font-family: 'Roboto Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            padding: 1rem;
        }
        /* Toggle Button */
        #code-panel-toggle-btn {
            position: absolute;
            top: 1rem;
            left: 1rem;
            z-index: 25;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.5rem;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }
        #code-panel-toggle-btn:hover {
            color: var(--accent);
            border-color: var(--accent);
        }

        /* Active States for Panel Buttons */
        .btn-lang-active {
            background-color: var(--accent) !important;
            color: white !important;
        }
        .btn-type-active {
            color: var(--text-primary) !important;
            font-weight: bold;
            text-decoration: underline;
            text-decoration-color: var(--accent);
            text-decoration-thickness: 2px;
        }

        /* Custom Scrollbar for Code Blocks */
        pre::-webkit-scrollbar, .code-panel-body::-webkit-scrollbar {
            height: 8px; width: 8px;
            background-color: #f1f5f9;
        }
        pre::-webkit-scrollbar-thumb, .code-panel-body::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        pre::-webkit-scrollbar-thumb:hover, .code-panel-body::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8;
        }

        /* Pygments Syntax Highlighting */
        pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.highlight .hll { background-color: #ffffcc }
.highlight .c { color: #008000 } /* Comment */
.highlight .err { border: 1px solid #F00 } /* Error */
.highlight .k { color: #00F } /* Keyword */
.highlight .ch { color: #008000 } /* Comment.Hashbang */
.highlight .cm { color: #008000 } /* Comment.Multiline */
.highlight .cp { color: #00F } /* Comment.Preproc */
.highlight .cpf { color: #008000 } /* Comment.PreprocFile */
.highlight .c1 { color: #008000 } /* Comment.Single */
.highlight .cs { color: #008000 } /* Comment.Special */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
.highlight .gh { font-weight: bold } /* Generic.Heading */
.highlight .gp { font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { font-weight: bold } /* Generic.Subheading */
.highlight .kc { color: #00F } /* Keyword.Constant */
.highlight .kd { color: #00F } /* Keyword.Declaration */
.highlight .kn { color: #00F } /* Keyword.Namespace */
.highlight .kp { color: #00F } /* Keyword.Pseudo */
.highlight .kr { color: #00F } /* Keyword.Reserved */
.highlight .kt { color: #2B91AF } /* Keyword.Type */
.highlight .s { color: #A31515 } /* Literal.String */
.highlight .nc { color: #2B91AF } /* Name.Class */
.highlight .ow { color: #00F } /* Operator.Word */
.highlight .sa { color: #A31515 } /* Literal.String.Affix */
.highlight .sb { color: #A31515 } /* Literal.String.Backtick */
.highlight .sc { color: #A31515 } /* Literal.String.Char */
.highlight .dl { color: #A31515 } /* Literal.String.Delimiter */
.highlight .sd { color: #A31515 } /* Literal.String.Doc */
.highlight .s2 { color: #A31515 } /* Literal.String.Double */
.highlight .se { color: #A31515 } /* Literal.String.Escape */
.highlight .sh { color: #A31515 } /* Literal.String.Heredoc */
.highlight .si { color: #A31515 } /* Literal.String.Interpol */
.highlight .sx { color: #A31515 } /* Literal.String.Other */
.highlight .sr { color: #A31515 } /* Literal.String.Regex */
.highlight .s1 { color: #A31515 } /* Literal.String.Single */
.highlight .ss { color: #A31515 } /* Literal.String.Symbol */
        /* Mermaid Overrides */
        .mermaid { transform-origin: 0 0; }
        .noselect { user-select: none; -webkit-user-select: none; }

        /* Legend Items */
        .logic-legend {
            border-top: 1px solid var(--border-color);
            padding: 1rem;
            background-color: var(--bg-card);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1.5rem;
            position: relative;
            z-index: 20;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: 500;
        }
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 1px solid;
        }
        .l-ingestion { background: #E8F0FE; border-color: #4285F4; }
        .l-evaluation { background: #FEF7E0; border-color: #FBBC04; }
        .l-weighting { background: #F3E8FD; border-color: #A142F4; }
        .l-synthesis { background: #E0F7FA; border-color: #12B5CB; }
        .l-outcome { background: #E6F4EA; border-color: #34A853; }

        /* TOC Active State Styling */
        .toc-link.active {
            color: #4f46e5;
            border-left-color: #4f46e5;
            background-color: #eef2ff;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans antialiased relative">

    <!-- Navigation -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center mr-6">
                        <a href="../index.html" class="font-bold text-xl text-indigo-600">
                            I ant I Investigates
                        </a>
                    </div>
                    <!-- Breadcrumbs (Moved Here) -->
                    <nav class="hidden md:flex text-sm text-slate-500 mr-8" aria-label="Breadcrumb">
                        <ol class="flex items-center space-x-2">
                            <li><a href="../index.html" class="hover:text-indigo-600 transition-colors">home</a></li>
                            <li><span class="mx-1">/</span></li>
                            <li><a href="./" class="hover:text-indigo-600 transition-colors">indicators</a></li>
                            <li><span class="mx-1">/</span></li>
                            <li><span class="font-medium text-slate-900">ParabolicSAR</span></li>
                        </ol>
                    </nav>

                    <!-- Page Top Nav (Anchor Links) -->
                    <div class="hidden sm:flex sm:space-x-4 items-center">
                        <a href="#interactive-playground" class="text-slate-600 hover:text-indigo-600 px-3 py-2 text-sm font-medium transition-colors">
                            Chart
                        </a>
                        <a href="#logic-visualization" class="text-slate-600 hover:text-indigo-600 px-3 py-2 text-sm font-medium transition-colors">
                            Logic
                        </a>
                        <a href="#documentation" class="text-slate-600 hover:text-indigo-600 px-3 py-2 text-sm font-medium transition-colors">
                            Docs
                        </a>
                    </div>
                </div>
                <!-- External Links Placeholder -->
                <div class="hidden sm:flex items-center">
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Container: 1-Column Stack -->
    <div class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-12">
        <!-- ======================================================= -->
        <!-- TOP SECTION: CONTEXT & PLAYGROUND                       -->
        <!-- ======================================================= -->
        <div class="flex flex-col gap-6">
            <!-- Hero Header -->
            <header>
                <h1 class="text-3xl md:text-4xl font-bold text-slate-900 mb-4 leading-tight">ParabolicSAR</h1>
                <p class="text-lg text-slate-600 leading-relaxed">Parabolic SAR plots a trailing stop that accelerates toward price as a trend matures, forcing an exit when the price touches the dotsâ€”and immediately reversing position.</p>
            </header>

            <!-- Interactive Playground -->
            <section id="interactive-playground" class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden scroll-mt-24">
                <div class="border-b border-slate-200 bg-indigo-50 px-6 py-4">
                    <h2 class="text-lg font-bold text-slate-800 flex items-center">
                        <span class="bg-indigo-600 text-white p-1 rounded mr-3 text-xs shadow-sm font-mono">C</span>
                        Calculator
                    </h2>
                    <p class="text-sm text-slate-600 mt-2">Calculate indicator values from your price data.</p>
                </div>
                <div class="p-6">
                    <!-- Chart Area -->
                    <div class="relative h-[400px] w-full mb-6 border border-slate-100 rounded bg-slate-50">
                        <canvas id="indicatorChart"></canvas>
                    </div>

                    <!-- Controls Area -->
                    <div id="controls" class="grid grid-cols-1 md:grid-cols-3 gap-6 bg-slate-50 p-4 rounded border border-slate-200">
                        <!-- Parameters -->
                        <div class="md:col-span-1 space-y-4">
                            <h3 class="font-bold text-sm text-slate-700 uppercase tracking-wide border-b border-slate-200 pb-2">Parameters</h3>
                            <div id="settings-container">
                                <div class="space-y-3">
                                    <!-- Dynamic settings will be injected here -->
                                </div>
                            </div>
                            <button id="btn-run" onclick="PlaygroundController.update()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded transition-colors shadow-sm flex items-center justify-center">
                                Calculate
                            </button>
                        </div>

                        <!-- Data I/O -->
                        <div class="md:col-span-2 space-y-4">
                            <!-- Input -->
                            <div class="space-y-2">
                                <div class="flex justify-between items-center pb-2 border-b border-slate-200">
                                    <h3 class="font-bold text-sm text-slate-700 uppercase tracking-wide">Input Data (CSV)</h3>
                                    <div class="flex space-x-2">
                                        <button id="btn-load-sample-ohlcv" class="text-xs text-indigo-600 hover:text-indigo-800 hover:underline transition-colors" title="Load OHLCV Sample Data">Shape (OHLCV)</button>
                                        <span class="text-slate-300">|</span>
                                        <button id="btn-load-sample-single" class="text-xs text-indigo-600 hover:text-indigo-800 hover:underline transition-colors" title="Load Single Value Sample Data">Single</button>
                                    </div>
                                </div>
                                <p class="text-xs text-slate-500">Enter CSV data (Date,Open,High,Low,Close,Volume) or single values.</p>
                                <textarea id="input-data" class="w-full h-24 p-2 text-xs font-mono border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 transition-shadow" placeholder="e.g. 100.5, 101.2, 99.8, 102.3, 103.1...

or one per line:
100.5
101.2
99.8"></textarea>
                            </div>
                            <!-- Output (Enabled) -->
                            <div class="space-y-2">
                                <div class="flex justify-between items-center pb-2 border-b border-slate-200">
                                    <h3 class="font-bold text-sm text-slate-700 uppercase tracking-wide">Output Data (Result)</h3>
                                </div>
                                <textarea id="output-data" class="w-full h-24 p-2 text-xs font-mono border border-slate-300 rounded bg-slate-100 text-slate-600" readonly placeholder="Calculation results will appear here..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- ======================================================= -->
        <!-- MIDDLE SECTION: LOGIC & ARCHITECTURE (PORTED FROM 0117) -->
        <!-- ======================================================= -->
        <section id="logic-visualization" class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden scroll-mt-24">
            <!-- Section Header (Styled like Playground) -->
            <div class="border-b border-slate-200 bg-emerald-50 px-6 py-4">
                <h2 class="text-lg font-bold text-slate-800 flex items-center">
                    <span class="bg-emerald-600 text-white p-1 rounded mr-3 text-xs shadow-sm font-mono">L</span>
                    Logic & Code Architecture
                </h2>
                <p class="text-sm text-slate-600 mt-2">Visual flowchart showing how the indicator processes data.</p>
            </div>

            <!-- LOGIC FIGURE STRUCTURE -->
            <figure class="logic-figure" style="border: none; border-radius: 0;">
                <!-- 1. Code Panel Toggle Button -->
                <button id="code-panel-toggle-btn" onclick="toggleCodePanel()" title="View Source Code" class="font-bold text-xs">
                    CODE
                </button>

                <!-- 2. Infinite Canvas Layer -->
                <div id="canvas-container" class="chart-scroll-wrapper">
                    <div id="canvas-content" class="mermaid" style="position: absolute; top:0; left:0;">
                        flowchart TD;
subgraph INGESTION["Phase 1: Ingestion"];
A[/"Receive Price Data Stream"/];
B["Capture High/Low Extremes"];
C["Define Acceleration Parameters"];
end;
subgraph EVALUATION["Phase 2: Evaluation"];
D["Determine Current Trend Direction"];
E["Track Extreme Points"];
F["Monitor Price vs SAR Level"];
end;
subgraph WEIGHTING["Phase 3: Weighting"];
G["Accelerate on New Extremes"];
H["Calculate Next SAR Position"];
I["Apply Speed Limits"];
end;
subgraph SYNTHESIS["Phase 4: Synthesis"];
J["Track Trend Persistence"];
K["Detect Flip Conditions"];
L["Measure Trailing Distance"];
end;
subgraph OUTCOME["Phase 5: Outcome"];
M{"Trend Status Assessment?"};
N["SAR Below Price = Uptrend Active"];
O["SAR Above Price = Downtrend Active"];
P["Price Crosses SAR = Trend Reversal"];
Q[/"Generate Trend-Following Signal"/];
end;
A --> B;
B --> C;
C --> D;
D --> E;
E --> F;
F --> G;
G --> H;
H --> I;
I --> J;
J --> K;
K --> L;
L --> M;
M -->|Bullish| N;
M -->|Bearish| O;
M -->|Reversal| P;
N --> Q;
O --> Q;
P --> Q;
style INGESTION fill:#e3f2fd;
style EVALUATION fill:#fff3e0;
style WEIGHTING fill:#e8f5e9;
style SYNTHESIS fill:#fce4ec;
style OUTCOME fill:#f3e5f5;
                    </div>
                </div>

                <!-- 3. Canvas Controls (Zoom) -->
                <div class="absolute top-4 right-4 flex flex-col gap-2 z-20">
                    <button onclick="if(window.resetView) window.resetView()" class="p-2 bg-white rounded shadow border border-slate-200 hover:bg-slate-50 text-slate-600 font-mono text-xs" title="Reset View">R</button>
                    <button onclick="if(window.zoomAction) window.zoomAction('in')" class="p-2 bg-white rounded shadow border border-slate-200 hover:bg-slate-50 text-slate-600 font-mono text-xs" title="Zoom In">+</button>
                    <button onclick="if(window.zoomAction) window.zoomAction('out')" class="p-2 bg-white rounded shadow border border-slate-200 hover:bg-slate-50 text-slate-600 font-mono text-xs" title="Zoom Out">-</button>
                </div>

                <!-- 4. Code Panel Overlay (Slide-in) -->
                <div id="code-panel-overlay" class="panel-hidden" onmousedown="event.stopPropagation();">
                    <!-- Header -->
                    <div class="flex justify-between items-center p-3 border-b border-slate-200 bg-slate-50 shrink-0">
                        <div class="flex gap-2">
                            <button id="btn-lang-csharp" class="px-2 py-1 text-xs rounded transition-colors text-slate-500 hover:bg-slate-100" onclick="setLang('csharp')">C#</button>
                            <button id="btn-lang-python" class="px-2 py-1 text-xs rounded transition-colors text-slate-500 hover:bg-slate-100" onclick="setLang('python')">Python</button>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="btn-type-simple" class="text-xs text-slate-500 hover:text-indigo-600 transition-colors" onclick="setType('simple')">Simple</button>
                            <button id="btn-type-detailed" class="text-xs text-slate-500 hover:text-indigo-600 transition-colors" onclick="setType('detailed')">Detailed</button>
                            <!-- Copy -->
                            <button id="btn-copy-code" class="ml-2 text-slate-500 hover:text-slate-800 transition-colors" onclick="copyCode()" title="Copy Code">
                                <svg id="icon-copy" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                                <svg id="icon-copy-done" class="hidden text-green-600" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                            </button>
                            <!-- Expand/Collapse -->
                            <button id="btn-panel-expand" class="text-slate-500 hover:text-slate-800 transition-colors" onclick="toggleExpand()" title="Toggle Width">
                                <svg id="icon-expand" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M15 3h6v6" /><path d="M9 21H3v-6" /><path d="M21 3l-7 7" /><path d="M3 21l7-7" />
                                </svg>
                                <svg id="icon-collapse" class="hidden" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 14h6v6" /><path d="M20 10h-6V4" /><path d="M14 10l7-7" /><path d="M10 14l-7 7" />
                                </svg>
                            </button>
                            <!-- Close -->
                            <button class="text-slate-500 hover:text-red-600 transition-colors" onclick="toggleCodePanel()" title="Close Panel">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <!-- Body -->
                    <div class="code-panel-body custom-scrollbar p-4">
                        <div id="code-csharp-simple" class="code-content hidden"><div class="highlight"><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">1</span><span class="k">using</span> System;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">2</span><span class="k">using</span> System.Collections.Generic;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">3</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">4</span><span class="k">namespace</span> TechnicalIndicators</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">5</span>{</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">6</span>    <span class="c1">/// &lt;summary&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">7</span>    <span class="c1">/// Parabolic SAR (Stop and Reverse)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">8</span>    <span class="c1">/// &lt;/summary&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">9</span>    <span class="c1">/// &lt;remarks&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">10</span>    <span class="c1">/// Trend-following indicator that sets trailing stops.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">11</span>    <span class="c1">/// &lt;list type=&quot;bullet&quot;&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">12</span>    <span class="c1">/// &lt;item&gt;&lt;description&gt;SAR(t) = SAR(t-1) + AF * (EP - SAR(t-1))&lt;/description&gt;&lt;/item&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">13</span>    <span class="c1">/// &lt;item&gt;&lt;description&gt;AF: Acceleration Factor (starts at 0.02, increases by 0.02 each new extreme).&lt;/description&gt;&lt;/item&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">14</span>    <span class="c1">/// &lt;item&gt;&lt;description&gt;EP: Extreme Point (highest High in uptrend, lowest Low in downtrend).&lt;/description&gt;&lt;/item&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">15</span>    <span class="c1">/// &lt;/list&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">16</span>    <span class="c1">/// &lt;/remarks&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">17</span>    <span class="k">public</span> <span class="k">class</span> <span class="nc">ParabolicSAR</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">18</span>    {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">19</span>        <span class="k">public</span> <span class="kt">decimal</span> AccelerationFactor { <span class="k">get</span>; }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">20</span>        <span class="k">public</span> <span class="kt">decimal</span> MaxAcceleration { <span class="k">get</span>; }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">21</span>        <span class="k">public</span> List&lt;<span class="kt">decimal?</span>&gt; Values { <span class="k">get</span>; } = <span class="k">new</span>();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">22</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">23</span>        <span class="k">public</span> ParabolicSAR(<span class="kt">decimal</span> accelerationFactor = 0.02m, <span class="kt">decimal</span> maxAcceleration = 0.2m)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">24</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">25</span>            AccelerationFactor = accelerationFactor;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">26</span>            MaxAcceleration = maxAcceleration;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">27</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">28</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">29</span>        <span class="k">public</span> <span class="k">void</span> Calculate(IEnumerable&lt;CandleData&gt; candles)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">30</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">31</span>            Values.Clear();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">32</span>            <span class="kt">var</span> candleList = <span class="k">new</span> List&lt;CandleData&gt;(candles);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">33</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">34</span>            <span class="k">if</span> (candleList.Count &lt; 2)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">35</span>            {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">36</span>                <span class="k">for</span> (<span class="kt">int</span> i = 0; i &lt; candleList.Count; i++) Values.Add(<span class="k">null</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">37</span>                <span class="k">return</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">38</span>            }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">39</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">40</span>            <span class="c1">// Step 1: Initial Trend Determination</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">41</span>            <span class="kt">bool</span> isUptrend = candleList[1].Close &gt; candleList[0].Close;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">42</span>            <span class="kt">decimal</span> sar = isUptrend ? candleList[0].Low : candleList[0].High;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">43</span>            <span class="kt">decimal</span> ep = isUptrend ? candleList[0].High : candleList[0].Low;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">44</span>            <span class="kt">decimal</span> af = AccelerationFactor;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">45</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">46</span>            Values.Add(<span class="k">null</span>); <span class="c1">// No SAR for first candle</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">47</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">48</span>            <span class="c1">// Step 2: Iterate</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">49</span>            <span class="k">for</span> (<span class="kt">int</span> i = 1; i &lt; candleList.Count; i++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">50</span>            {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">51</span>                <span class="kt">var</span> candle = candleList[i];</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">52</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">53</span>                <span class="k">if</span> (isUptrend)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">54</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">55</span>                    <span class="c1">// Switch to Downtrend?</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">56</span>                    <span class="k">if</span> (candle.Low &lt; sar)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">57</span>                    {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">58</span>                        isUptrend = <span class="k">false</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">59</span>                        sar = ep;       <span class="c1">// SAR flips to the Extreme Point</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">60</span>                        ep = candle.Low;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">61</span>                        af = AccelerationFactor; <span class="c1">// Reset AF</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">62</span>                    }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">63</span>                    <span class="k">else</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">64</span>                    {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">65</span>                        <span class="c1">// Update Uptrend</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">66</span>                        <span class="k">if</span> (candle.High &gt; ep)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">67</span>                        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">68</span>                            ep = candle.High;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">69</span>                            af = Math.Min(af + AccelerationFactor, MaxAcceleration);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">70</span>                        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">71</span>                        sar = sar + af * (ep - sar);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">72</span>                        <span class="c1">// Prevent SAR from exceeding previous lows (Protection)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">73</span>                        sar = Math.Min(sar, Math.Min(candleList[i - 1].Low, i &gt; 1 ? candleList[i - 2].Low : candleList[i - 1].Low));</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">74</span>                    }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">75</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">76</span>                <span class="k">else</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">77</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">78</span>                    <span class="c1">// Switch to Uptrend?</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">79</span>                    <span class="k">if</span> (candle.High &gt; sar)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">80</span>                    {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">81</span>                        isUptrend = <span class="k">true</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">82</span>                        sar = ep;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">83</span>                        ep = candle.High;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">84</span>                        af = AccelerationFactor;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">85</span>                    }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">86</span>                    <span class="k">else</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">87</span>                    {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">88</span>                        <span class="c1">// Update Downtrend</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">89</span>                        <span class="k">if</span> (candle.Low &lt; ep)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">90</span>                        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">91</span>                            ep = candle.Low;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">92</span>                            af = Math.Min(af + AccelerationFactor, MaxAcceleration);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">93</span>                        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">94</span>                        sar = sar + af * (ep - sar);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">95</span>                        <span class="c1">// Prevent SAR from exceeding previous highs (Protection)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">96</span>                        sar = Math.Max(sar, Math.Max(candleList[i - 1].High, i &gt; 1 ? candleList[i - 2].High : candleList[i - 1].High));</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">97</span>                    }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">98</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">99</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">100</span>                Values.Add(sar);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">101</span>            }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">102</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">103</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">104</span>        <span class="k">public</span> <span class="k">static</span> List&lt;<span class="kt">decimal?</span>&gt; Calculate(IEnumerable&lt;CandleData&gt; candles, <span class="kt">decimal</span> af = 0.02m, <span class="kt">decimal</span> maxAf = 0.2m)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">105</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">106</span>            <span class="kt">var</span> psar = <span class="k">new</span> ParabolicSAR(af, maxAf);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">107</span>            psar.Calculate(candles);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">108</span>            <span class="k">return</span> psar.Values;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">109</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">110</span>    }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">111</span>}</div></div></div>
                        <div id="code-csharp-detailed" class="code-content hidden"><div class="highlight"><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">1</span><span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">2</span><span class="c1">// Logic Breakdown (ParabolicSAR)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">3</span><span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">4</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">5</span><span class="c1">// This document provides a &quot;Deep Dive&quot; into the internal logic of the</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">6</span><span class="c1">// Parabolic SAR (Stop and Reverse) technical indicator.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">7</span><span class="c1">// We explain *why* code is written this way and *how* data transforms</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">8</span><span class="c1">// line-by-line, targeting programming beginners.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">9</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">10</span><span class="c1">// [Core Concepts]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">11</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">12</span><span class="c1">// 1. What is Parabolic SAR?</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">13</span><span class="c1">//    [Creator] J. Welles Wilder Jr. (1978)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">14</span><span class="c1">//    [Full Name] Parabolic Stop And Reverse</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">15</span><span class="c1">//    [Purpose] Trend-following indicator that provides:</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">16</span><span class="c1">//              - Entry/Exit signals (when dots flip)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">17</span><span class="c1">//              - Trailing stop levels (the dots themselves)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">18</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">19</span><span class="c1">// 2. Key Components</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">20</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">21</span><span class="c1">//    | Component | Meaning                                       |</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">22</span><span class="c1">//    |-----------|-----------------------------------------------|</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">23</span><span class="c1">//    | SAR       | Current Stop And Reverse level (the dot)      |</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">24</span><span class="c1">//    | EP        | Extreme Point (highest high or lowest low)    |</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">25</span><span class="c1">//    | AF        | Acceleration Factor (starts at 0.02)          |</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">26</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">27</span><span class="c1">// 3. Visual Representation</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">28</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">29</span><span class="c1">//    Uptrend (SAR below price):    Downtrend (SAR above price):</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">30</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">31</span><span class="c1">//       â—â”€â”€â”€â”€â—                         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">32</span><span class="c1">//      / \                                     â—</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">33</span><span class="c1">//     â—   â—                                   / \</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">34</span><span class="c1">//    /                                       â—   â—</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">35</span><span class="c1">//   â—                                       /</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">36</span><span class="c1">//  /                                       â—</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">37</span><span class="c1">// â—</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">38</span><span class="c1">//   (trailing stop rises)                 (trailing stop falls)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">39</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">40</span><span class="c1">// 4. How SAR &quot;Accelerates&quot;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">41</span><span class="c1">//    [Why] As trend continues, SAR gets closer to price (trailing stop tightens).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">42</span><span class="c1">//    [How] Each new EP increases AF by 0.02, up to maximum 0.20.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">43</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">44</span><span class="c1">// 5. Signal Interpretation</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">45</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">46</span><span class="c1">//    | Position of SAR | Trend     | Action        |</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">47</span><span class="c1">//    |-----------------|-----------|---------------|</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">48</span><span class="c1">//    | Below price     | Uptrend   | Long position |</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">49</span><span class="c1">//    | Above price     | Downtrend | Short/Exit    |</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">50</span><span class="c1">//    | Flips position  | Reversal  | Stop &amp; Reverse|</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">51</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">52</span><span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">53</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">54</span><span class="k">using</span> System;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">55</span><span class="k">using</span> System.Collections.Generic;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">56</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">57</span><span class="k">namespace</span> TechnicalIndicators</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">58</span>{</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">59</span>    <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">60</span>    <span class="c1">// Logic Explanation: OHLCV Data Container</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">61</span>    <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">62</span>    <span class="k">public</span> <span class="k">readonly</span> <span class="k">record</span> <span class="k">struct</span> CandleData(</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">63</span>        DateTime Timestamp,</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">64</span>        <span class="kt">decimal</span> Open,</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">65</span>        <span class="kt">decimal</span> High,</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">66</span>        <span class="kt">decimal</span> Low,</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">67</span>        <span class="kt">decimal</span> Close,</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">68</span>        <span class="kt">long</span> Volume</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">69</span>    );</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">70</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">71</span>    <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">72</span>    <span class="c1">// Logic Explanation: ParabolicSAR Class</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">73</span>    <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">74</span>    <span class="k">public</span> <span class="k">class</span> <span class="nc">ParabolicSAR</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">75</span>    {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">76</span>        <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">77</span>        <span class="c1">// Logic Explanation: Configuration</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">78</span>        <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">79</span>        <span class="c1">// [AccelerationFactor] Initial and increment value for AF.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">80</span>        <span class="c1">// [MaxAcceleration]    Cap for AF (prevents SAR from moving too fast).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">81</span>        <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">82</span>        <span class="k">public</span> <span class="kt">decimal</span> AccelerationFactor { <span class="k">get</span>; }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">83</span>        <span class="k">public</span> <span class="kt">decimal</span> MaxAcceleration { <span class="k">get</span>; }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">84</span>        <span class="k">public</span> List&lt;<span class="kt">decimal?</span>&gt; Values { <span class="k">get</span>; } = <span class="k">new</span>();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">85</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">86</span>        <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">87</span>        <span class="c1">// Logic Explanation: Constructor</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">88</span>        <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">89</span>        <span class="k">public</span> ParabolicSAR(<span class="kt">decimal</span> accelerationFactor = 0.02m, <span class="kt">decimal</span> maxAcceleration = 0.2m)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">90</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">91</span>            AccelerationFactor = accelerationFactor;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">92</span>            MaxAcceleration = maxAcceleration;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">93</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">94</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">95</span>        <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">96</span>        <span class="c1">// Logic Explanation: Main Calculation Method</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">97</span>        <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">98</span>        <span class="k">public</span> <span class="k">void</span> Calculate(IEnumerable&lt;CandleData&gt; candles)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">99</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">100</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">101</span>            <span class="c1">// Step 1: Cleanup &amp; Setup</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">102</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">103</span>            Values.Clear();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">104</span>            <span class="kt">var</span> candleList = <span class="k">new</span> List&lt;CandleData&gt;(candles);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">105</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">106</span>            <span class="c1">// Need at least 2 candles for initial trend determination</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">107</span>            <span class="k">if</span> (candleList.Count &lt; 2)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">108</span>            {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">109</span>                <span class="k">for</span> (<span class="kt">int</span> i = 0; i &lt; candleList.Count; i++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">110</span>                    Values.Add(<span class="k">null</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">111</span>                <span class="k">return</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">112</span>            }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">113</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">114</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">115</span>            <span class="c1">// Step 2: Initialize Trend, SAR, EP, AF</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">116</span>            <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">117</span>            <span class="c1">// [Trend Detection] Compare Close[1] vs Close[0]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">118</span>            <span class="c1">// [SAR Initial]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">119</span>            <span class="c1">//   Uptrend:   SAR = Low[0] (start below price)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">120</span>            <span class="c1">//   Downtrend: SAR = High[0] (start above price)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">121</span>            <span class="c1">// [EP Initial]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">122</span>            <span class="c1">//   Uptrend:   EP = High[0] (track highest high)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">123</span>            <span class="c1">//   Downtrend: EP = Low[0] (track lowest low)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">124</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">125</span>            <span class="kt">bool</span> isUptrend = candleList[1].Close &gt; candleList[0].Close;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">126</span>            <span class="kt">decimal</span> sar = isUptrend ? candleList[0].Low : candleList[0].High;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">127</span>            <span class="kt">decimal</span> ep = isUptrend ? candleList[0].High : candleList[0].Low;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">128</span>            <span class="kt">decimal</span> af = AccelerationFactor;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">129</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">130</span>            <span class="c1">// First candle has no SAR</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">131</span>            Values.Add(<span class="k">null</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">132</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">133</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">134</span>            <span class="c1">// Step 3: Main Loop</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">135</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">136</span>            <span class="k">for</span> (<span class="kt">int</span> i = 1; i &lt; candleList.Count; i++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">137</span>            {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">138</span>                <span class="kt">var</span> candle = candleList[i];</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">139</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">140</span>                <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">141</span>                <span class="c1">// Step 4A: Uptrend Logic</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">142</span>                <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">143</span>                <span class="k">if</span> (isUptrend)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">144</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">145</span>                    <span class="c1">// [Reversal Check] Price breaks below SAR</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">146</span>                    <span class="k">if</span> (candle.Low &lt; sar)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">147</span>                    {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">148</span>                        <span class="c1">// FLIP to downtrend</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">149</span>                        isUptrend = <span class="k">false</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">150</span>                        sar = ep;               <span class="c1">// SAR becomes previous extreme</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">151</span>                        ep = candle.Low;        <span class="c1">// New EP is current low</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">152</span>                        af = AccelerationFactor; <span class="c1">// Reset AF</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">153</span>                    }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">154</span>                    <span class="k">else</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">155</span>                    {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">156</span>                        <span class="c1">// [Continuation] Update EP and AF if new high</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">157</span>                        <span class="k">if</span> (candle.High &gt; ep)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">158</span>                        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">159</span>                            ep = candle.High;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">160</span>                            af = Math.Min(af + AccelerationFactor, MaxAcceleration);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">161</span>                        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">162</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">163</span>                        <span class="c1">// [Update SAR] Move towards EP</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">164</span>                        <span class="c1">// SAR = SAR + AF Ã— (EP - SAR)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">165</span>                        sar = sar + af * (ep - sar);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">166</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">167</span>                        <span class="c1">// [Safety Clamp] SAR cannot be above last 2 lows</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">168</span>                        sar = Math.Min(sar, Math.Min(candleList[i - 1].Low,</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">169</span>                            i &gt; 1 ? candleList[i - 2].Low : candleList[i - 1].Low));</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">170</span>                    }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">171</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">172</span>                <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">173</span>                <span class="c1">// Step 4B: Downtrend Logic</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">174</span>                <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">175</span>                <span class="k">else</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">176</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">177</span>                    <span class="c1">// [Reversal Check] Price breaks above SAR</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">178</span>                    <span class="k">if</span> (candle.High &gt; sar)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">179</span>                    {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">180</span>                        <span class="c1">// FLIP to uptrend</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">181</span>                        isUptrend = <span class="k">true</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">182</span>                        sar = ep;               <span class="c1">// SAR becomes previous extreme</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">183</span>                        ep = candle.High;       <span class="c1">// New EP is current high</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">184</span>                        af = AccelerationFactor; <span class="c1">// Reset AF</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">185</span>                    }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">186</span>                    <span class="k">else</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">187</span>                    {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">188</span>                        <span class="c1">// [Continuation] Update EP and AF if new low</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">189</span>                        <span class="k">if</span> (candle.Low &lt; ep)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">190</span>                        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">191</span>                            ep = candle.Low;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">192</span>                            af = Math.Min(af + AccelerationFactor, MaxAcceleration);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">193</span>                        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">194</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">195</span>                        <span class="c1">// [Update SAR] Move towards EP</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">196</span>                        sar = sar + af * (ep - sar);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">197</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">198</span>                        <span class="c1">// [Safety Clamp] SAR cannot be below last 2 highs</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">199</span>                        sar = Math.Max(sar, Math.Max(candleList[i - 1].High,</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">200</span>                            i &gt; 1 ? candleList[i - 2].High : candleList[i - 1].High));</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">201</span>                    }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">202</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">203</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">204</span>                Values.Add(sar);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">205</span>            }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">206</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">207</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">208</span>        <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">209</span>        <span class="c1">// Logic Explanation: Static Convenience Wrapper</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">210</span>        <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">211</span>        <span class="c1">// [IPO Block]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">212</span>        <span class="c1">// Input:   IEnumerable&lt;CandleData&gt;, af, maxAf</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">213</span>        <span class="c1">// Process: Creates instance, runs Calculate()</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">214</span>        <span class="c1">// Output:  List of SAR values (trailing stop levels)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">215</span>        <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">216</span>        <span class="k">public</span> <span class="k">static</span> List&lt;<span class="kt">decimal?</span>&gt; Calculate(IEnumerable&lt;CandleData&gt; candles, <span class="kt">decimal</span> af = 0.02m, <span class="kt">decimal</span> maxAf = 0.2m)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">217</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">218</span>            <span class="kt">var</span> psar = <span class="k">new</span> ParabolicSAR(af, maxAf);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">219</span>            psar.Calculate(candles);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">220</span>            <span class="k">return</span> psar.Values;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">221</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">222</span>    }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">223</span>}</div></div></div>
                        <div id="code-python-simple" class="code-content hidden"><div class="highlight"><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">1</span><span class="k">class</span> <span class="nc">ParabolicSAR</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">2</span>    <span class="sd">&quot;&quot;&quot;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">3</span><span class="sd">    Parabolic SAR</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">4</span><span class="sd">    &quot;&quot;&quot;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">5</span>    <span class="k">def</span> __init__(self, af=0.02, max_af=0.2):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">6</span>        self.af_start = af</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">7</span>        self.max_af = max_af</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">8</span>        self.values = []</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">9</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">10</span>    <span class="k">def</span> calculate(self, candles):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">11</span>        self.values.clear()</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">12</span>        <span class="k">if</span> len(candles) &lt; 2:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">13</span>            self.values = [<span class="kc">None</span>] * len(candles)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">14</span>            <span class="k">return</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">15</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">16</span>        is_uptrend = float(candles[1][<span class="s1">&#x27;</span><span class="s1">close</span><span class="s1">&#x27;</span>]) &gt; float(candles[0][<span class="s1">&#x27;</span><span class="s1">close</span><span class="s1">&#x27;</span>])</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">17</span>        sar = float(candles[0][<span class="s1">&#x27;</span><span class="s1">low</span><span class="s1">&#x27;</span>]) <span class="k">if</span> is_uptrend <span class="k">else</span> float(candles[0][<span class="s1">&#x27;</span><span class="s1">high</span><span class="s1">&#x27;</span>])</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">18</span>        ep = float(candles[0][<span class="s1">&#x27;</span><span class="s1">high</span><span class="s1">&#x27;</span>]) <span class="k">if</span> is_uptrend <span class="k">else</span> float(candles[0][<span class="s1">&#x27;</span><span class="s1">low</span><span class="s1">&#x27;</span>])</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">19</span>        af = self.af_start</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">20</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">21</span>        self.values.append(<span class="kc">None</span>) <span class="c1"># Index 0</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">22</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">23</span>        <span class="k">for</span> i <span class="ow">in</span> range(1, len(candles)):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">24</span>            high = float(candles[i][<span class="s1">&#x27;</span><span class="s1">high</span><span class="s1">&#x27;</span>])</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">25</span>            low = float(candles[i][<span class="s1">&#x27;</span><span class="s1">low</span><span class="s1">&#x27;</span>])</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">26</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">27</span>            <span class="c1"># Logic happens *before* calculating SAR for *tomorrow*, but here we output SAR for *today*.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">28</span>            <span class="c1"># The standard logic finds the SAR for &#x27;today&#x27; based on &#x27;yesterday&#x27;s&#x27; data.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">29</span>            <span class="c1"># But inside the loop, we check flip conditions based on current candle limits.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">30</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">31</span>            <span class="k">if</span> is_uptrend:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">32</span>                <span class="k">if</span> low &lt; sar:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">33</span>                    is_uptrend = <span class="kc">False</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">34</span>                    sar = ep</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">35</span>                    ep = low</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">36</span>                    af = self.af_start</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">37</span>                <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">38</span>                    <span class="k">if</span> high &gt; ep:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">39</span>                        ep = high</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">40</span>                        af = min(af + self.af_start, self.max_af)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">41</span>                    </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">42</span>                    sar = sar + af * (ep - sar)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">43</span>                    </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">44</span>                    prev_low1 = float(candles[i-1][<span class="s1">&#x27;</span><span class="s1">low</span><span class="s1">&#x27;</span>])</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">45</span>                    prev_low2 = float(candles[i-2][<span class="s1">&#x27;</span><span class="s1">low</span><span class="s1">&#x27;</span>]) <span class="k">if</span> i &gt; 1 <span class="k">else</span> prev_low1</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">46</span>                    sar = min(sar, prev_low1, prev_low2)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">47</span>            <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">48</span>                <span class="k">if</span> high &gt; sar:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">49</span>                    is_uptrend = <span class="kc">True</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">50</span>                    sar = ep</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">51</span>                    ep = high</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">52</span>                    af = self.af_start</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">53</span>                <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">54</span>                    <span class="k">if</span> low &lt; ep:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">55</span>                        ep = low</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">56</span>                        af = min(af + self.af_start, self.max_af)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">57</span>                    </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">58</span>                    sar = sar + af * (ep - sar)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">59</span>                    </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">60</span>                    prev_high1 = float(candles[i-1][<span class="s1">&#x27;</span><span class="s1">high</span><span class="s1">&#x27;</span>])</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">61</span>                    prev_high2 = float(candles[i-2][<span class="s1">&#x27;</span><span class="s1">high</span><span class="s1">&#x27;</span>]) <span class="k">if</span> i &gt; 1 <span class="k">else</span> prev_high1</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">62</span>                    sar = max(sar, prev_high1, prev_high2)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">63</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">64</span>            self.values.append(sar)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">65</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">66</span><span class="k">def</span> calculate(candles, af=0.02, max_af=0.2):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">67</span>    psar = ParabolicSAR(af, max_af)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">68</span>    psar.calculate(candles)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">69</span>    <span class="k">return</span> psar.values</div></div></div>
                        <div id="code-python-detailed" class="code-content hidden"><div class="highlight"><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">1</span><span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">2</span><span class="c1"># Logic Breakdown (Parabolic SAR)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">3</span><span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">4</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">5</span><span class="c1"># This document provides a &quot;Deep Dive&quot; into the internal logic of the</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">6</span><span class="c1"># Parabolic SAR (Stop and Reverse). We explain *why* code is written</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">7</span><span class="c1"># this way and *how* data transforms line-by-line.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">8</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">9</span><span class="c1"># [Core Concepts]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">10</span><span class="c1"># 1. State Machine</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">11</span><span class="c1">#    - The SAR is a system that can be in one of two states: UPTREND or DOWNTREND.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">12</span><span class="c1">#    - It flips state ONLY when price crosses the SAR line.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">13</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">14</span><span class="c1"># 2. Acceleration Factor (AF)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">15</span><span class="c1">#    - The SAR moves parabolic-ally because of the AF.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">16</span><span class="c1">#    - Starts at 0.02.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">17</span><span class="c1">#    - Increases by 0.02 every time a New High (in Uptrend) or New Low (in Downtrend) is made.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">18</span><span class="c1">#    - This tightens the stop as the trend matures, protecting profits.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">19</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">20</span><span class="c1"># 3. The &quot;Extreme Point&quot; (EP)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">21</span><span class="c1">#    - Tracks the highest high (Uptrend) or lowest low (Downtrend) reached so far.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">22</span><span class="c1">#    - When trend reverses, the SAR jumps to the old EP.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">23</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">24</span><span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">25</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">26</span><span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">27</span><span class="c1"># Type-Level Explanation: ParabolicSAR (class)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">28</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">29</span><span class="c1"># [Why]  Maintains complex state (Trend, AF, EP, SAR) between steps.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">30</span><span class="c1"># [What] A trend-following, trailing-stop indicator.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">31</span><span class="c1"># [How]  Uses an acceleration factor that increases as the trend persists to calculate a parabolic stop-and-reverse level, which flips position when the price crosses it.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">32</span><span class="c1"># [Who]  J. Welles Wilder Jr.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">33</span><span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">34</span><span class="k">class</span> <span class="nc">ParabolicSAR</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">35</span>    </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">36</span>    <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">37</span>    <span class="c1"># Variable Definition: values</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">38</span>    <span class="c1"># [Role] The calculated Stop levels.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">39</span>    <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">40</span>    <span class="c1"># values = []</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">41</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">42</span>    <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">43</span>    <span class="c1"># Constructor: __init__</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">44</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">45</span>    <span class="c1"># [Why]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">46</span>    <span class="c1"># Configure the acceleration limits.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">47</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">48</span>    <span class="c1"># [Input]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">49</span>    <span class="c1"># - acceleration_factor (default 0.02): Step size.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">50</span>    <span class="c1"># - max_acceleration (default 0.2): Cap to prevent stop from hitting price too easily.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">51</span>    <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">52</span>    <span class="k">def</span> __init__(self, acceleration_factor=0.02, max_acceleration=0.2):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">53</span>        self.acceleration_factor = acceleration_factor</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">54</span>        self.max_acceleration = max_acceleration</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">55</span>        self.values = []</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">56</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">57</span>    <span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">58</span>    <span class="c1"># IPO: calculate</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">59</span>    <span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">60</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">61</span>    <span class="c1"># [Input]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">62</span>    <span class="c1"># - candles: List[dict]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">63</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">64</span>    <span class="c1"># [Process]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">65</span>    <span class="c1"># 1. Guess initial trend (first 2 bars).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">66</span>    <span class="c1"># 2. Iterate bars.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">67</span>    <span class="c1"># 3. Check for Trend Reversal (Price Crossing SAR).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">68</span>    <span class="c1"># 4. If Trend Continues:</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">69</span>    <span class="c1">#      a. Update Extreme Point (EP).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">70</span>    <span class="c1">#      b. Accelerate AF.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">71</span>    <span class="c1">#      c. Calculate Next SAR.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">72</span>    <span class="c1">#      d. Constrain SAR (Can&#x27;t exceed previous Highs/Lows).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">73</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">74</span>    <span class="c1"># [Output]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">75</span>    <span class="c1"># - None (Populates &#x27;values&#x27;)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">76</span>    <span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">77</span>    <span class="k">def</span> calculate(self, candles):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">78</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">79</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">80</span>        <span class="c1"># Logic Step 1: Reset &amp; Validation</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">81</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">82</span>        self.values.clear()</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">83</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">84</span>        <span class="c1"># Need at least 2 bars to determine slope start</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">85</span>        <span class="k">if</span> len(candles) &lt; 2:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">86</span>            <span class="k">for</span> _ <span class="ow">in</span> range(len(candles)):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">87</span>                self.values.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">88</span>            <span class="k">return</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">89</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">90</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">91</span>        <span class="c1"># Logic Step 2: Initial State (Heuristic)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">92</span>        <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">93</span>        <span class="c1"># [Why]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">94</span>        <span class="c1"># Wilder&#x27;s original method requires previous data to start.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">95</span>        <span class="c1"># Since we start at Bar 0, we must guess the trend direction.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">96</span>        <span class="c1"># We compare Close[1] vs Close[0].</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">97</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">98</span>        is_uptrend = candles[1][<span class="s1">&#x27;</span><span class="s1">close</span><span class="s1">&#x27;</span>] &gt; candles[0][<span class="s1">&#x27;</span><span class="s1">close</span><span class="s1">&#x27;</span>]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">99</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">100</span>        <span class="c1"># Initialize EP (Extreme Point) and SAR based on this guess</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">101</span>        <span class="k">if</span> is_uptrend:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">102</span>            sar = candles[0][<span class="s1">&#x27;</span><span class="s1">low</span><span class="s1">&#x27;</span>]  <span class="c1"># In Uptrend, SAR is below</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">103</span>            ep = candles[0][<span class="s1">&#x27;</span><span class="s1">high</span><span class="s1">&#x27;</span>]  <span class="c1"># EP is the High</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">104</span>        <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">105</span>            sar = candles[0][<span class="s1">&#x27;</span><span class="s1">high</span><span class="s1">&#x27;</span>] <span class="c1"># In Downtrend, SAR is above</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">106</span>            ep = candles[0][<span class="s1">&#x27;</span><span class="s1">low</span><span class="s1">&#x27;</span>]   <span class="c1"># EP is the Low</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">107</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">108</span>        af = self.acceleration_factor</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">109</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">110</span>        <span class="c1"># First SAR value is conceptual/initial, often invalid for trading</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">111</span>        self.values.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">112</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">113</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">114</span>        <span class="c1"># Logic Step 3: Main Loop (Forward Iteration)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">115</span>        <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">116</span>        <span class="c1"># [Visual]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">117</span>        <span class="c1"># PrevSAR=100. Trend=Up. EP=110. AF=0.02.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">118</span>        <span class="c1"># NextSAR = 100 + 0.02 * (110 - 100) = 100.2</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">119</span>        <span class="c1"># Check if Price &lt; 100.2 (Reversal?)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">120</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">121</span>        <span class="k">for</span> i <span class="ow">in</span> range(1, len(candles)):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">122</span>            c = candles[i]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">123</span>            prev_low = candles[i - 1][<span class="s1">&#x27;</span><span class="s1">low</span><span class="s1">&#x27;</span>]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">124</span>            prev_high = candles[i - 1][<span class="s1">&#x27;</span><span class="s1">high</span><span class="s1">&#x27;</span>]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">125</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">126</span>            <span class="c1"># =============================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">127</span>            <span class="c1"># State A: UPTREND Logic</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">128</span>            <span class="c1"># =============================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">129</span>            <span class="k">if</span> is_uptrend:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">130</span>                </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">131</span>                <span class="c1"># Logic Step 3.1: Check Trend Reversal</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">132</span>                <span class="c1"># Decision: Did price dip below the Stop Level (SAR)?</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">133</span>                <span class="k">if</span> c[<span class="s1">&#x27;</span><span class="s1">low</span><span class="s1">&#x27;</span>] &lt; sar:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">134</span>                    <span class="c1"># [Action] REVERSAL -&gt; Switch to Downtrend</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">135</span>                    is_uptrend = <span class="kc">False</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">136</span>                    </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">137</span>                    <span class="c1"># Store current SAR before resetting (some implementations do this differently,</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">138</span>                    <span class="c1"># but here we record the level that was breached)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">139</span>                    self.values.append(sar)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">140</span>                    </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">141</span>                    <span class="c1"># Reset Logic for New Downtrend:</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">142</span>                    <span class="c1"># 1. SAR becomes the old Extreme Point (Highest High)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">143</span>                    sar = ep</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">144</span>                    <span class="c1"># 2. EP becomes the new Low causing the reversal</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">145</span>                    ep = c[<span class="s1">&#x27;</span><span class="s1">low</span><span class="s1">&#x27;</span>]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">146</span>                    <span class="c1"># 3. AF resets to base</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">147</span>                    af = self.acceleration_factor</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">148</span>                    </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">149</span>                    <span class="k">continue</span> <span class="c1"># Move to next bar with new state</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">150</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">151</span>                <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">152</span>                    <span class="c1"># [Action] CONTINUATION -&gt; Update Logic</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">153</span>                    </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">154</span>                    <span class="c1"># 1. Update Extreme Point</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">155</span>                    <span class="c1"># If this bar is higher than best high so far, update EP and Accelerate.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">156</span>                    <span class="k">if</span> c[<span class="s1">&#x27;</span><span class="s1">high</span><span class="s1">&#x27;</span>] &gt; ep:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">157</span>                        ep = c[<span class="s1">&#x27;</span><span class="s1">high</span><span class="s1">&#x27;</span>]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">158</span>                        af = min(af + self.acceleration_factor, self.max_acceleration)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">159</span>                    </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">160</span>                    <span class="c1"># 2. Store current SAR</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">161</span>                    self.values.append(sar)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">162</span>                    </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">163</span>                    <span class="c1"># 3. Calculate Next SAR for tomorrow</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">164</span>                    <span class="c1"># Formula: SAR_next = SAR_curr + AF * (EP - SAR_curr)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">165</span>                    sar = sar + af * (ep - sar)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">166</span>                    </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">167</span>                    <span class="c1"># 4. Constraint Rule (Wilder&#x27;s Rule)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">168</span>                    <span class="c1"># SAR for an uptrend can NEVER be higher than the Low of the </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">169</span>                    <span class="c1"># previous 2 bars. This prevents the stop from getting too close </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">170</span>                    <span class="c1"># too fast due to a single spike.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">171</span>                    sar = min(sar, prev_low)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">172</span>                    <span class="k">if</span> i &gt; 1:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">173</span>                        sar = min(sar, candles[i - 2][<span class="s1">&#x27;</span><span class="s1">low</span><span class="s1">&#x27;</span>])</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">174</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">175</span>            <span class="c1"># =============================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">176</span>            <span class="c1"># State B: DOWNTREND Logic</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">177</span>            <span class="c1"># =============================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">178</span>            <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">179</span>                </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">180</span>                <span class="c1"># Logic Step 3.1: Check Trend Reversal</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">181</span>                <span class="c1"># Decision: Did price pop above the Stop Level (SAR)?</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">182</span>                <span class="k">if</span> c[<span class="s1">&#x27;</span><span class="s1">high</span><span class="s1">&#x27;</span>] &gt; sar:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">183</span>                    <span class="c1"># [Action] REVERSAL -&gt; Switch to Uptrend</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">184</span>                    is_uptrend = <span class="kc">True</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">185</span>                    </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">186</span>                    self.values.append(sar)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">187</span>                    </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">188</span>                    <span class="c1"># Reset Logic for New Uptrend:</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">189</span>                    sar = ep <span class="c1"># Old Lowest Low</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">190</span>                    ep = c[<span class="s1">&#x27;</span><span class="s1">high</span><span class="s1">&#x27;</span>] <span class="c1"># New High</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">191</span>                    af = self.acceleration_factor</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">192</span>                    </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">193</span>                    <span class="k">continue</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">194</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">195</span>                <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">196</span>                    <span class="c1"># [Action] CONTINUATION -&gt; Update Logic</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">197</span>                    </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">198</span>                    <span class="c1"># 1. Update Extreme Point (Lowest Low)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">199</span>                    <span class="k">if</span> c[<span class="s1">&#x27;</span><span class="s1">low</span><span class="s1">&#x27;</span>] &lt; ep:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">200</span>                        ep = c[<span class="s1">&#x27;</span><span class="s1">low</span><span class="s1">&#x27;</span>]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">201</span>                        af = min(af + self.acceleration_factor, self.max_acceleration)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">202</span>                    </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">203</span>                    <span class="c1"># 2. Store current SAR</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">204</span>                    self.values.append(sar)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">205</span>                    </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">206</span>                    <span class="c1"># 3. Calculate Next SAR</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">207</span>                    <span class="c1"># Note: Formula looks same, but (EP - SAR) is negative, so SAR moves down.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">208</span>                    sar = sar + af * (ep - sar)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">209</span>                    </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">210</span>                    <span class="c1"># 4. Constraint Rule</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">211</span>                    <span class="c1"># SAR for downtrend cannot be lower than the High of previous 2 bars.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">212</span>                    sar = max(sar, prev_high)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">213</span>                    <span class="k">if</span> i &gt; 1:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">214</span>                        sar = max(sar, candles[i - 2][<span class="s1">&#x27;</span><span class="s1">high</span><span class="s1">&#x27;</span>])</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">215</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">216</span><span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">217</span><span class="c1"># Static Wrapper Function</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">218</span><span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">219</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">220</span><span class="c1"># [Why] Functional API.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">221</span><span class="c1"># [Usage] sar_values = calculate(candles)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">222</span><span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">223</span><span class="k">def</span> calculate(candles, af=0.02, max_af=0.2):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">224</span>    instance = ParabolicSAR(af, max_af)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">225</span>    instance.calculate(candles)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">226</span>    <span class="k">return</span> instance.values</div></div></div>
                    </div>
                </div>
            </figure>

            <!-- Legend (5-Step Model) -->
            <div class="logic-legend">
                <div class="legend-item"><span class="legend-dot l-ingestion"></span>Ingestion</div>
                <div class="legend-item"><span class="legend-dot l-evaluation"></span>Evaluation</div>
                <div class="legend-item"><span class="legend-dot l-weighting"></span>Weighting</div>
                <div class="legend-item"><span class="legend-dot l-synthesis"></span>Synthesis</div>
                <div class="legend-item"><span class="legend-dot l-outcome"></span>Outcome</div>
            </div>
        </section>

        <!-- ======================================================= -->
        <!-- BOTTOM SECTION: DOCS & TOC                              -->
        <!-- ======================================================= -->
        <section id="documentation" class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden scroll-mt-24">
            <!-- Documentation Header -->
            <div class="border-b border-orange-200 bg-orange-50 px-6 py-4">
                <h2 class="text-lg font-bold text-slate-900 flex items-center">
                    <span class="bg-indigo-600 text-white p-1 rounded mr-3 text-xs shadow-sm font-mono">D</span>
                    Technical Documentation
                </h2>
                <p class="text-slate-600 text-xs mt-1 ml-9">
                    Detailed technical explanation of the indicator's logic, math, and implementation details.
                </p>
            </div>
            <!-- Content Body -->
            <div class="p-6 flex flex-col lg:flex-row gap-12">
                <!-- Left: Article -->
                <article class="flex-1 min-w-0">
                    <div class="prose prose-slate max-w-none prose-headings:scroll-mt-24 prose-headings:font-bold prose-h2:text-2xl prose-h2:border-b prose-h2:pb-2 prose-h2:mt-8 prose-a:text-indigo-600 hover:prose-a:text-indigo-800">
                        <h1 id="parabolic-sar-stop-and-reverse">Parabolic SAR (Stop and Reverse)</h1>

<p class="mb-4"><h2 class="text-2xl font-bold mt-12 mb-6 border-b pb-2">PART 1: MAIN GUIDE</h2></p>

<h2 id="1-identity">1. Identity</h2>

<p class="mb-4">Full Name: Parabolic Stop and Reverse  </p>
<p class="mb-4">Abbreviation: PSAR, SAR  </p>
<p class="mb-4">Category: Trend Following / Trailing Stop  </p>
<p class="mb-4">Creator: J. Welles Wilder Jr. (1978)  </p>

<blockquote class="border-l-4 border-gray-300 pl-4 italic text-gray-700 my-4 bg-gray-50 py-2 pr-2 rounded-r">One-Sentence Definition: Parabolic SAR plots a trailing stop that accelerates toward price as a trend matures, forcing an exit when the price touches the dotsâ€”and immediately reversing position.</blockquote>

<hr class="border-[#2a2e39] my-8">

<h2 id="2-calculation-logic">2. Calculation Logic</h2>

<h3 id="formula">Formula</h3>

<p class="mb-4">Uptrend:</p>
<p class="mb-4">$$SAR_{t+1} = SAR_t + \alpha \times (EP - SAR_t)$$</p>

<p class="mb-4">Downtrend:</p>
<p class="mb-4">$$SAR_{t+1} = SAR_t - \alpha \times (SAR_t - EP)$$</p>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Variable</td><td class="px-4 py-2 border-b border-[#2a2e39]">Meaning</td><td class="px-4 py-2 border-b border-[#2a2e39]">Default</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">$SAR_t$</td><td class="px-4 py-2 border-b border-[#2a2e39]">Current Stop and Reverse value</td><td class="px-4 py-2 border-b border-[#2a2e39]">Prior calculation</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">$EP$</td><td class="px-4 py-2 border-b border-[#2a2e39]">Extreme Point (highest high in uptrend, lowest low in downtrend)</td><td class="px-4 py-2 border-b border-[#2a2e39]">Dynamic</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">$\alpha$</td><td class="px-4 py-2 border-b border-[#2a2e39]">Acceleration Factor</td><td class="px-4 py-2 border-b border-[#2a2e39]">Starts 0.02, increments 0.02</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">$\alpha_{max}$</td><td class="px-4 py-2 border-b border-[#2a2e39]">Maximum Acceleration</td><td class="px-4 py-2 border-b border-[#2a2e39]">0.20</td></tr>
</table></div>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Step</td><td class="px-4 py-2 border-b border-[#2a2e39]">Action</td><td class="px-4 py-2 border-b border-[#2a2e39]">Purpose</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">1</td><td class="px-4 py-2 border-b border-[#2a2e39]">Determine initial trend direction</td><td class="px-4 py-2 border-b border-[#2a2e39]">Compare first two closes</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">2</td><td class="px-4 py-2 border-b border-[#2a2e39]">Set initial SAR</td><td class="px-4 py-2 border-b border-[#2a2e39]">Opposite extreme of trend</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">3</td><td class="px-4 py-2 border-b border-[#2a2e39]">Track Extreme Point (EP)</td><td class="px-4 py-2 border-b border-[#2a2e39]">Update when new high/low made</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">4</td><td class="px-4 py-2 border-b border-[#2a2e39]">Increment Î± when EP updates</td><td class="px-4 py-2 border-b border-[#2a2e39]">Accelerate toward price</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">5</td><td class="px-4 py-2 border-b border-[#2a2e39]">Calculate next SAR</td><td class="px-4 py-2 border-b border-[#2a2e39]">Pull stop closer to price</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">6</td><td class="px-4 py-2 border-b border-[#2a2e39]">Flip on touch</td><td class="px-4 py-2 border-b border-[#2a2e39]">Reverse position when price crosses SAR</td></tr>
</table></div>

<h3 id="real-world-analogy">Real-World Analogy</h3>

<p class="mb-4">Think of Parabolic SAR like a hunting dog chasing prey. When the chase begins, the dog is cautious (slow acceleration). As confidence grows and the prey tires (trend extends), the dog speeds up. Eventually, the gap closesâ€”and either the dog catches the prey (trend ends, position exits) or the prey escapes (reversal). The parabolic curve of the acceleration mirrors how a dog's pursuit intensifies over time.</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="3-market-standards">3. Market Standards</h2>

<h3 id="default-parameters">Default Parameters</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Parameter</td><td class="px-4 py-2 border-b border-[#2a2e39]">Standard Value</td><td class="px-4 py-2 border-b border-[#2a2e39]">Rationale</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Start AF</td><td class="px-4 py-2 border-b border-[#2a2e39]">0.02</td><td class="px-4 py-2 border-b border-[#2a2e39]">Wilder's original; cautious initial acceleration</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Increment AF</td><td class="px-4 py-2 border-b border-[#2a2e39]">0.02</td><td class="px-4 py-2 border-b border-[#2a2e39]">Each new extreme tightens stop progressively</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Maximum AF</td><td class="px-4 py-2 border-b border-[#2a2e39]">0.20</td><td class="px-4 py-2 border-b border-[#2a2e39]">Cap prevents SAR from overtaking price</td></tr>
</table></div>

<h3 id="alternative-settings">Alternative Settings</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Trading Style</td><td class="px-4 py-2 border-b border-[#2a2e39]">Start AF</td><td class="px-4 py-2 border-b border-[#2a2e39]">Increment</td><td class="px-4 py-2 border-b border-[#2a2e39]">Max AF</td><td class="px-4 py-2 border-b border-[#2a2e39]">Effect</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Trend Following</td><td class="px-4 py-2 border-b border-[#2a2e39]">0.02</td><td class="px-4 py-2 border-b border-[#2a2e39]">0.02</td><td class="px-4 py-2 border-b border-[#2a2e39]">0.20</td><td class="px-4 py-2 border-b border-[#2a2e39]">Standard (Wilder)</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Less Sensitive</td><td class="px-4 py-2 border-b border-[#2a2e39]">0.01</td><td class="px-4 py-2 border-b border-[#2a2e39]">0.01</td><td class="px-4 py-2 border-b border-[#2a2e39]">0.10</td><td class="px-4 py-2 border-b border-[#2a2e39]">Fewer whipsaws, more lag</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Scalping</td><td class="px-4 py-2 border-b border-[#2a2e39]">0.02</td><td class="px-4 py-2 border-b border-[#2a2e39]">0.04</td><td class="px-4 py-2 border-b border-[#2a2e39]">0.20</td><td class="px-4 py-2 border-b border-[#2a2e39]">Quick exits, tight stops</td></tr>
</table></div>

<h3 id="timeframe-recommendations">Timeframe Recommendations</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Trading Style</td><td class="px-4 py-2 border-b border-[#2a2e39]">Timeframe</td><td class="px-4 py-2 border-b border-[#2a2e39]">Notes</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Day Trading</td><td class="px-4 py-2 border-b border-[#2a2e39]">5-min to 1-hour</td><td class="px-4 py-2 border-b border-[#2a2e39]">Use with volatility filter</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Swing Trading</td><td class="px-4 py-2 border-b border-[#2a2e39]">Daily</td><td class="px-4 py-2 border-b border-[#2a2e39]">Standard settings work well</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Position Trading</td><td class="px-4 py-2 border-b border-[#2a2e39]">Weekly</td><td class="px-4 py-2 border-b border-[#2a2e39]">Reduces whipsaws</td></tr>
</table></div>

<hr class="border-[#2a2e39] my-8">

<h2 id="4-market-context">4. Market Context</h2>

<h3 id="best-conditions">Best Conditions</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Condition</td><td class="px-4 py-2 border-b border-[#2a2e39]">Why It Works</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Strong Trending Markets</td><td class="px-4 py-2 border-b border-[#2a2e39]">SAR excels when price makes consistent highs/lows</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Breakouts from Consolidation</td><td class="px-4 py-2 border-b border-[#2a2e39]">Catches early trend and trails effectively</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Volatile but Directional</td><td class="px-4 py-2 border-b border-[#2a2e39]">Acceleration factor adapts to momentum</td></tr>
</table></div>

<h3 id="limitations">Limitations</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Condition</td><td class="px-4 py-2 border-b border-[#2a2e39]">Problem</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Sideways/Choppy Markets</td><td class="px-4 py-2 border-b border-[#2a2e39]">Constant reversals ("whipsaws") destroy capital</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Gap-Heavy Markets</td><td class="px-4 py-2 border-b border-[#2a2e39]">Price can gap past SAR causing confusion</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Low Volatility Periods</td><td class="px-4 py-2 border-b border-[#2a2e39]">Signals without follow-through</td></tr>
</table></div>

<h3 id="asset-class-suitability">Asset Class Suitability</h3>

<p class="mb-4">- Forex â€” Excellent for trending pairs with stops</p>
<p class="mb-4">- Futures/Commodities â€” Designed for these markets originally</p>
<p class="mb-4">- Trending Equities â€” Good for strong stocks in clear trends</p>
<p class="mb-4">- Crypto â€” Works but gaps and 24/7 trading create issues</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="5-entry-signals">5. Entry Signals</h2>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Signal Type</td><td class="px-4 py-2 border-b border-[#2a2e39]">Condition</td><td class="px-4 py-2 border-b border-[#2a2e39]">Direction</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strength</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Bullish Flip</td><td class="px-4 py-2 border-b border-[#2a2e39]">Price crosses above SAR dots</td><td class="px-4 py-2 border-b border-[#2a2e39]">Long Entry</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strong</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Bearish Flip</td><td class="px-4 py-2 border-b border-[#2a2e39]">Price crosses below SAR dots</td><td class="px-4 py-2 border-b border-[#2a2e39]">Short Entry</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strong</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Trend Continuation</td><td class="px-4 py-2 border-b border-[#2a2e39]">SAR unchanged, price extending</td><td class="px-4 py-2 border-b border-[#2a2e39]">Hold Position</td><td class="px-4 py-2 border-b border-[#2a2e39]">Moderate</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Gap Exhaustion</td><td class="px-4 py-2 border-b border-[#2a2e39]">SAR-Price gap at extreme</td><td class="px-4 py-2 border-b border-[#2a2e39]">Reversal Warning</td><td class="px-4 py-2 border-b border-[#2a2e39]">Moderate</td></tr>
</table></div>

<h3 id="primary-buy-signal">Primary Buy Signal</h3>

<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
IF Price_Low &gt; SAR_Value (dots below price)
AND SAR_Value[1] was above Price (flip occurred)
AND ADX &gt; 25 (trend exists)
THEN â†’ BUY (Stop at SAR value)
</code></pre>

<h3 id="primary-sell/exit-signal">Primary Sell/Exit Signal</h3>

<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
IF Price_High &lt; SAR_Value (dots above price)
AND SAR_Value[1] was below Price (flip occurred)
THEN â†’ SELL/SHORT
</code></pre>

<hr class="border-[#2a2e39] my-8">

<h2 id="6-filter-usage">6. Filter Usage</h2>

<p class="mb-4">Parabolic SAR generates signals constantly in any market. Filtering is mandatory to avoid whipsaws.</p>

<h3 id="filter-rules">Filter Rules</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Rule</td><td class="px-4 py-2 border-b border-[#2a2e39]">Application</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]"><code>ADX > 25</code></td><td class="px-4 py-2 border-b border-[#2a2e39]">MANDATORY: Only trade SAR when trend exists</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]"><code>+DI > -DI</code></td><td class="px-4 py-2 border-b border-[#2a2e39]">Only take SAR longs in bullish environment</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]"><code>Price > 50-EMA</code></td><td class="px-4 py-2 border-b border-[#2a2e39]">Confirm bullish bias before SAR long entries</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]"><code>3-Dot Rule</code></td><td class="px-4 py-2 border-b border-[#2a2e39]">Wait for 3 dots after flip for confirmation</td></tr>
</table></div>

<h3 id="recommended-pairings">Recommended Pairings</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Partner Indicator</td><td class="px-4 py-2 border-b border-[#2a2e39]">Synergy Logic</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">ADX</td><td class="px-4 py-2 border-b border-[#2a2e39]">Essential pairingâ€”Wilder's own recommendation</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Moving Averages</td><td class="px-4 py-2 border-b border-[#2a2e39]">Confirm trend direction before SAR entries</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">ATR</td><td class="px-4 py-2 border-b border-[#2a2e39]">Adjust SAR parameters based on volatility</td></tr>
</table></div>

<h3 id="example-combined-strategy">Example Combined Strategy</h3>

<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
FILTER CONDITIONS:
&nbsp;&nbsp;ADX(14) &gt; 25                        // Trend strength exists
&nbsp;&nbsp;+DI(14) &gt; -DI(14)                   // Uptrend direction

ENTRY CONDITIONS:
&nbsp;&nbsp;Price crosses above SAR (Bullish Flip)
&nbsp;&nbsp;Wait for 3 consecutive bullish dots

TRAIL:
&nbsp;&nbsp;Use SAR value as trailing stop

EXIT:
&nbsp;&nbsp;Price touches SAR OR ADX &lt; 20
</code></pre>

<hr class="border-[#2a2e39] my-8">

<h2 id="7-practical-cautions">7. Practical Cautions</h2>

<h3 id="lag-characteristics">Lag Characteristics</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Component</td><td class="px-4 py-2 border-b border-[#2a2e39]">Approximate Lag</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">First Valid SAR</td><td class="px-4 py-2 border-b border-[#2a2e39]">2 bars</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Flip Detection</td><td class="px-4 py-2 border-b border-[#2a2e39]">Immediate (same bar)</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Acceleration Effect</td><td class="px-4 py-2 border-b border-[#2a2e39]">Builds over 5-10 bars</td></tr>
</table></div>

<blockquote class="border-l-4 border-gray-300 pl-4 italic text-gray-700 my-4 bg-gray-50 py-2 pr-2 rounded-r">Reality Check: Parabolic SAR forces you to be in the market at all times (long or short). In sideways markets, this leads to catastrophic whipsaw losses. NEVER use SAR without a trend filter.</blockquote>

<h3 id="false-signal-scenarios">False Signal Scenarios</h3>

<p class="mb-4">1. The Whipsaw Death Spiral  </p>
<p class="mb-4">   In ranging markets, SAR flips constantly, each flip triggering a losing trade.</p>

<p class="mb-4">2. The Premature Catch  </p>
<p class="mb-4">   In accelerating trends, SAR may catch up to price during normal pullbacks, forcing exit before trend resumes.</p>

<p class="mb-4">3. Gap Discontinuity  </p>
<p class="mb-4">   Price gaps past SAR, leaving confusing values until recalibration.</p>

<h3 id="mitigation-strategies">Mitigation Strategies</h3>

<p class="mb-4">- ADX Filter is Non-Negotiable: If ADX < 20, ignore all SAR signals</p>
<p class="mb-4">- Wait for 3 Dots: Reduces false flips significantly</p>
<p class="mb-4">- Combine with Moving Average Direction: Only trade in direction of 50-EMA</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="8-pro-insights">8. Pro Insights</h2>

<h3 id="the-3-dot-confirmation-rule">The 3-Dot Confirmation Rule</h3>

<p class="mb-4">Professional traders never jump on the first flip. They wait for three consecutive dots after a reversal to confirm the trend is real. The first dot is often noise from a spike; three dots confirm the acceleration factor is actually engaging.</p>

<h3 id="the-sar-gap-size-indicator">The SAR Gap Size Indicator</h3>

<p class="mb-4">Measure the distance between price and SAR. In healthy trends, this gap expands initially then contracts as SAR catches up. If the gap suddenly spikes to 2+ standard deviations above average, the trend is parabolic/exhaustedâ€”prepare for reversal before the flip signals it.</p>

<h3 id="wilder's-complete-system">Wilder's Complete System</h3>

<p class="mb-4">Wilder never intended SAR to be used alone. His complete system:</p>
<p class="mb-4">1. ADX Filter: Only trade when ADX > 25</p>
<p class="mb-4">2. +DI/-DI Direction: +DI > -DI = Longs only; -DI > +DI = Shorts only</p>
<p class="mb-4">3. SAR for Entries and Stops: Use dot flips and trail positions</p>

<h3 id="dynamic-parameter-adjustment">Dynamic Parameter Adjustment</h3>

<p class="mb-4">For volatile markets, increase the starting AF to 0.025-0.03. For smooth trends, reduce to 0.01. The maximum AF should rarely exceed 0.20â€”at that acceleration, SAR catches price almost immediately.</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="9-summary">9. Summary</h2>

<blockquote class="border-l-4 border-gray-300 pl-4 italic text-gray-700 my-4 bg-gray-50 py-2 pr-2 rounded-r">"Parabolic SAR is your trend's gravitational pullâ€”it accelerates toward price as momentum matures, inevitably catching it when the trend exhausts, forcing a disciplined exit that most traders never execute on their own."</blockquote>

<p class="mb-4"><h2 class="text-2xl font-bold mt-12 mb-6 border-b pb-2">PART 2: SUPPLEMENTARY GUIDE</h2></p>

<h2 id="1-core-concept">1. Core Concept</h2>

<p class="mb-4">Parabolic SAR answers: "Where should my stop be, and when is it time to reverse?"</p>

<p class="mb-4">Unlike most indicators that suggest direction, SAR provides a specific price levelâ€”a line in the sand. If price crosses that line, the trend is presumed dead, and you immediately flip to the other side.</p>

<p class="mb-4">The "parabolic" nature comes from the acceleration factor (Î±). As a trend extends:</p>
<p class="mb-4">- New highs (uptrend) or new lows (downtrend) increment Î±</p>
<p class="mb-4">- Higher Î± pulls SAR closer to price faster</p>
<p class="mb-4">- Eventually, the curve catches up to price (parabolic shape)</p>

<p class="mb-4">This models trend exhaustion mathematically:</p>
<p class="mb-4">- Fresh trends = Wide SAR gap (loose stop, room to run)</p>
<p class="mb-4">- Mature trends = Narrow SAR gap (tight stop, protecting profits)</p>
<p class="mb-4">- Exhausted trends = SAR catches price (exit/reverse)</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="2-statistical-edge">2. Statistical Edge</h2>

<h3 id="backtest-evidence">Backtest Evidence</h3>

<p class="mb-4">Studies on Parabolic SAR with ADX filter:</p>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Metric</td><td class="px-4 py-2 border-b border-[#2a2e39]">SAR Alone</td><td class="px-4 py-2 border-b border-[#2a2e39]">SAR + ADX > 25 Filter</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Win Rate</td><td class="px-4 py-2 border-b border-[#2a2e39]">38%</td><td class="px-4 py-2 border-b border-[#2a2e39]">54%</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Profit Factor</td><td class="px-4 py-2 border-b border-[#2a2e39]">0.9</td><td class="px-4 py-2 border-b border-[#2a2e39]">1.4</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Max Drawdown</td><td class="px-4 py-2 border-b border-[#2a2e39]">-55%</td><td class="px-4 py-2 border-b border-[#2a2e39]">-28%</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Whipsaw Trades</td><td class="px-4 py-2 border-b border-[#2a2e39]">Very High</td><td class="px-4 py-2 border-b border-[#2a2e39]">Reduced by 65%</td></tr>
</table></div>

<h3 id="why-it-works">Why It Works</h3>

<p class="mb-4">The edge comes from time-based stop management. Most traders exit too late in winning trades and too early in losing trades. SAR enforces disciplineâ€”stops tighten as profits accumulate, and exits are mechanical, removing emotion.</p>

<h3 id="academic-reference">Academic Reference</h3>

<p class="mb-4">J. Welles Wilder Jr. introduced Parabolic SAR in *New Concepts in Technical Trading Systems* (1978). Wilder was a mechanical engineer, and SAR reflects engineering precisionâ€”a trailing stop that adapts to the momentum of the system it's tracking.</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="3-actionable-strategy">3. Actionable Strategy</h2>

<h3 id="strategy-name:-"wilder's-filtered-trend"">Strategy Name: "Wilder's Filtered Trend"</h3>

<p class="mb-4">Concept: Trade SAR signals only in confirmed trending environments.</p>

<p class="mb-4">Setup Requirements:</p>
<p class="mb-4">1. ADX(14) > 25 â€” Trend strength exists</p>
<p class="mb-4">2. +DI(14) > -DI(14) â€” Bullish direction (for longs)</p>
<p class="mb-4">3. Price > 50-EMA â€” Uptrend confirmation</p>

<p class="mb-4">Entry Trigger:</p>
<p class="mb-4">- Price crosses above SAR (Bullish Flip)</p>
<p class="mb-4">- Wait for 3 consecutive dots below price</p>

<p class="mb-4">Position Management:</p>
<p class="mb-4">- Initial stop: SAR value</p>
<p class="mb-4">- Trail using SAR dots as stop</p>
<p class="mb-4">- Full position when ADX > 35</p>
<p class="mb-4">- Half position when ADX 25-35</p>

<p class="mb-4">Exit Rules:</p>
<p class="mb-4">1. Price touches SAR â†’ EXIT</p>
<p class="mb-4">2. ADX falls below 20 â†’ EXIT</p>
<p class="mb-4">3. -DI crosses above +DI â†’ EXIT</p>

<p class="mb-4">Example:</p>
<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
Stock TSLA shows:
&nbsp;&nbsp;ADX = 32 âœ“
&nbsp;&nbsp;+DI = 28, -DI = 18 âœ“
&nbsp;&nbsp;Price = $250, 50-EMA = $235 âœ“
&nbsp;&nbsp;
SAR flips to $242 (below price)
3 dots confirmed â†’ ENTRY at $250

Trail stop using SAR daily
Exit when Price &lt; SAR ($248 next day)
</code></pre>

<hr class="border-[#2a2e39] my-8">

<h2 id="4-risks-&-limitations">4. Risks & Limitations</h2>

<h3 id="failure-patterns">Failure Patterns</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Pattern</td><td class="px-4 py-2 border-b border-[#2a2e39]">Description</td><td class="px-4 py-2 border-b border-[#2a2e39]">Mitigation</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Whipsaw in Ranges</td><td class="px-4 py-2 border-b border-[#2a2e39]">SAR flips every 2-3 bars</td><td class="px-4 py-2 border-b border-[#2a2e39]">ADX filter required</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Premature Exit</td><td class="px-4 py-2 border-b border-[#2a2e39]">SAR catches price on normal pullback</td><td class="px-4 py-2 border-b border-[#2a2e39]">Use lower AF (0.01) in volatile markets</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Gap Discontinuity</td><td class="px-4 py-2 border-b border-[#2a2e39]">Price gaps past SAR</td><td class="px-4 py-2 border-b border-[#2a2e39]">Use limit orders; avoid gap-prone times</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Always-In Problem</td><td class="px-4 py-2 border-b border-[#2a2e39]">SAR forces continuous positioning</td><td class="px-4 py-2 border-b border-[#2a2e39]">Accept flat periods; use regime filters</td></tr>
</table></div>

<h3 id="psychological-traps">Psychological Traps</h3>

<p class="mb-4">1. The "One More Dot" Trap  </p>
<p class="mb-4">   Traders ignore the first flip, waiting for confirmation, then miss the exit entirely as price collapses.</p>

<p class="mb-4">2. Overriding the Stop  </p>
<p class="mb-4">   SAR's value is its objectivity. If you override it ("I'll wait for a better exit"), you lose the edge.</p>

<p class="mb-4">3. Whipsaw PTSD  </p>
<p class="mb-4">   After repeated whipsaws, traders abandon SAR entirely, missing legitimate trends.</p>

<h3 id="common-misinterpretations">Common Misinterpretations</h3>

<p class="mb-4">- "SAR gives entry signals" â†’ It gives stop/exit/reversal signals</p>
<p class="mb-4">- "SAR works in all markets" â†’ It destroys accounts in ranging markets</p>
<p class="mb-4">- "Dots above = bearish" â†’ Only the FLIP is the signal, not the position</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="5-further-study">5. Further Study</h2>

<h3 id="creator-attribution">Creator Attribution</h3>

<p class="mb-4">J. Welles Wilder Jr. (1935-2021) was a mechanical engineer turned trader who revolutionized technical analysis. His 1978 book *New Concepts in Technical Trading Systems* introduced SAR, RSI, ADX, and ATRâ€”indicators that remain foundational decades later.</p>

<h3 id="parent/child-indicators">Parent/Child Indicators</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Indicator</td><td class="px-4 py-2 border-b border-[#2a2e39]">Relationship</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">ADX</td><td class="px-4 py-2 border-b border-[#2a2e39]">Companion â€” Wilder's filter for SAR validity</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">ATR</td><td class="px-4 py-2 border-b border-[#2a2e39]">Related â€” Wilder's volatility measure</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Chandelier Exit</td><td class="px-4 py-2 border-b border-[#2a2e39]">Related â€” Another trailing stop methodology</td></tr>
</table></div>

<h3 id="recommended-readings">Recommended Readings</h3>

<p class="mb-4">1. *New Concepts in Technical Trading Systems* â€” J. Welles Wilder Jr.</p>
<p class="mb-4">2. *Technical Analysis of the Financial Markets* â€” John J. Murphy</p>
<p class="mb-4">3. *Come Into My Trading Room* â€” Dr. Alexander Elder</p>

<hr class="border-[#2a2e39] my-8">

<h3 id="55-related-indicators-comparison">5.5 Related Indicators Comparison</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Feature</td><td class="px-4 py-2 border-b border-[#2a2e39]">Parabolic SAR</td><td class="px-4 py-2 border-b border-[#2a2e39]">Chandelier Exit</td><td class="px-4 py-2 border-b border-[#2a2e39]">ATR Trailing Stop</td><td class="px-4 py-2 border-b border-[#2a2e39]">Moving Average</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Type</td><td class="px-4 py-2 border-b border-[#2a2e39]">Accelerating stop</td><td class="px-4 py-2 border-b border-[#2a2e39]">Fixed ATR stop</td><td class="px-4 py-2 border-b border-[#2a2e39]">Fixed ATR stop</td><td class="px-4 py-2 border-b border-[#2a2e39]">Dynamic average</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Adapts to Trend</td><td class="px-4 py-2 border-b border-[#2a2e39]">Yes (acceleration)</td><td class="px-4 py-2 border-b border-[#2a2e39]">No</td><td class="px-4 py-2 border-b border-[#2a2e39]">No</td><td class="px-4 py-2 border-b border-[#2a2e39]">Yes (new data)</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Provides Entry</td><td class="px-4 py-2 border-b border-[#2a2e39]">Yes (flip)</td><td class="px-4 py-2 border-b border-[#2a2e39]">No</td><td class="px-4 py-2 border-b border-[#2a2e39]">No</td><td class="px-4 py-2 border-b border-[#2a2e39]">Yes (crossover)</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Always-In-Market</td><td class="px-4 py-2 border-b border-[#2a2e39]">Yes</td><td class="px-4 py-2 border-b border-[#2a2e39]">No</td><td class="px-4 py-2 border-b border-[#2a2e39]">No</td><td class="px-4 py-2 border-b border-[#2a2e39]">No</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Whipsaw Risk</td><td class="px-4 py-2 border-b border-[#2a2e39]">High</td><td class="px-4 py-2 border-b border-[#2a2e39]">Low</td><td class="px-4 py-2 border-b border-[#2a2e39]">Low</td><td class="px-4 py-2 border-b border-[#2a2e39]">Moderate</td></tr>
</table></div>

<p class="mb-4">When to Use Which:</p>
<p class="mb-4">- Parabolic SAR â€” Trending markets with ADX filter</p>
<p class="mb-4">- Chandelier Exit â€” Long-term positions needing fixed volatility stops</p>
<p class="mb-4">- ATR Trailing Stop â€” Alternative to SAR without always-in-market</p>
<p class="mb-4">- Moving Average â€” General trend direction without precise stops</p>

<p class="mb-4"><h2 class="text-2xl font-bold mt-12 mb-6 border-b pb-2">PART 3: ADVANCED SIGNAL REFERENCE</h2></p>

<h2 id="advanced-signal-reference">Advanced Signal Reference</h2>

<h3 id="threshold-matrix">Threshold Matrix</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Dots Position</td><td class="px-4 py-2 border-b border-[#2a2e39]">ADX Level</td><td class="px-4 py-2 border-b border-[#2a2e39]">Market State</td><td class="px-4 py-2 border-b border-[#2a2e39]">Action</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Below Price</td><td class="px-4 py-2 border-b border-[#2a2e39]">> 30</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strong Uptrend</td><td class="px-4 py-2 border-b border-[#2a2e39]">Trail with SAR; full long</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Below Price</td><td class="px-4 py-2 border-b border-[#2a2e39]">25-30</td><td class="px-4 py-2 border-b border-[#2a2e39]">Moderate Uptrend</td><td class="px-4 py-2 border-b border-[#2a2e39]">Trail with SAR; half size</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Below Price</td><td class="px-4 py-2 border-b border-[#2a2e39]">< 20</td><td class="px-4 py-2 border-b border-[#2a2e39]">No Trend</td><td class="px-4 py-2 border-b border-[#2a2e39]">Ignore; expect whipsaw</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Above Price</td><td class="px-4 py-2 border-b border-[#2a2e39]">> 30</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strong Downtrend</td><td class="px-4 py-2 border-b border-[#2a2e39]">Trail short; full position</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Above Price</td><td class="px-4 py-2 border-b border-[#2a2e39]">25-30</td><td class="px-4 py-2 border-b border-[#2a2e39]">Moderate Downtrend</td><td class="px-4 py-2 border-b border-[#2a2e39]">Trail short; half size</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Above Price</td><td class="px-4 py-2 border-b border-[#2a2e39]">< 20</td><td class="px-4 py-2 border-b border-[#2a2e39]">No Trend</td><td class="px-4 py-2 border-b border-[#2a2e39]">Ignore; expect whipsaw</td></tr>
</table></div>

<h3 id="signal-patterns">Signal Patterns</h3>

<h4 id="buy-signal-bullish-flip">Buy Signal (Bullish Flip)</h4>
<p class="mb-4">This signal triggers when price crosses above the SAR dots, indicating a potential trend reversal from bearish to bullish. The ADX filter is mandatoryâ€”Wilder himself recommended only trading SAR signals when ADX > 25, which reduces whipsaws by 65%. The signal is strongest when the flip occurs after a clear downtrend with the +DI crossing above -DI.</p>

<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-python">
def sar_buy_signal(price_low, sar_value, sar_prev, price_prev_low, adx):
&nbsp;&nbsp;&nbsp;&nbsp;bullish_flip = (price_low &gt; sar_value) and (price_prev_low &lt; sar_prev)
&nbsp;&nbsp;&nbsp;&nbsp;trend_exists = adx &gt; 25
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;return bullish_flip and trend_exists
</code></pre>

<h4 id="sell/exit-signal-bearish-flip">Sell/Exit Signal (Bearish Flip)</h4>
<p class="mb-4">This exit signal fires when price touches the SAR dots from below, indicating the trend has exhausted and the position should be closed or reversed. Unlike the entry, the exit doesn't require ADX confirmation since protecting profits takes priority over avoiding whipsaws. The parabolic acceleration ensures stops tighten as trends mature, forcing disciplined exits.</p>

<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-python">
def sar_exit_signal(price_high, sar_value, sar_prev, price_prev_high):
&nbsp;&nbsp;&nbsp;&nbsp;bearish_flip = (price_high &lt; sar_value) and (price_prev_high &gt; sar_prev)
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;return bearish_flip
</code></pre>

<h4 id="3-dot-confirmation">3-Dot Confirmation</h4>
<p class="mb-4">Professional traders wait for three consecutive dots after a flip before entering, significantly reducing false signals from spikes and noise. The first dot after a flip is often noiseâ€”three dots confirm the acceleration factor is genuinely engaging. This patience filter dramatically improves win rates at the cost of slightly later entries.</p>

<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-python">
def sar_3dot_confirmation(sar_values, prices, is_uptrend):
&nbsp;&nbsp;&nbsp;&nbsp;if is_uptrend:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dots_below = all(sar_values[-3:][i] &lt; prices[-3:][i] for i in range(3))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return dots_below
&nbsp;&nbsp;&nbsp;&nbsp;else:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dots_above = all(sar_values[-3:][i] &gt; prices[-3:][i] for i in range(3))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return dots_above
</code></pre>

<h3 id="screening-filters">Screening Filters</h3>

<h4 id="trend-reversal-scan">Trend Reversal Scan</h4>
<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
Low[1] &gt; SAR[1]
AND Low &lt; SAR
AND ADX(14) &gt; 25
</code></pre>

<h4 id="bullish-trend-continuation">Bullish Trend Continuation</h4>
<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
Low &gt; SAR
AND SAR[1] &lt; SAR[2] &lt; SAR[3]  // SAR accelerating up
AND ADX &gt; 30
</code></pre>

<h4 id="gap-exhaustion-warning">Gap Exhaustion Warning</h4>
<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
(Close - SAR) / ATR(14) &gt; 3
AND SAR below price
</code></pre>

<h3 id="combination-strategies">Combination Strategies</h3>

<h4 id="wilder's-complete-system">Wilder's Complete System</h4>
<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
FILTER:
&nbsp;&nbsp;ADX(14) &gt; 25

DIRECTION:
&nbsp;&nbsp;IF +DI &gt; -DI: Only LONG
&nbsp;&nbsp;IF -DI &gt; +DI: Only SHORT

ENTRY (Long):
&nbsp;&nbsp;Price crosses above SAR
&nbsp;&nbsp;AND 3 consecutive dots below price
&nbsp;&nbsp;
STOP/EXIT:
&nbsp;&nbsp;SAR value (dynamic trail)
&nbsp;&nbsp;OR ADX &lt; 20
</code></pre>

<h4 id="sar-+-adx-momentum">SAR + ADX Momentum</h4>
<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
SETUP:
&nbsp;&nbsp;ADX &gt; 25 and rising
&nbsp;&nbsp;+DI &gt; -DI (for longs)

ENTRY:
&nbsp;&nbsp;SAR flips to bullish (dots below)
&nbsp;&nbsp;
POSITION SIZE:
&nbsp;&nbsp;ADX &gt; 40: Full position
&nbsp;&nbsp;ADX 30-40: 75%
&nbsp;&nbsp;ADX 25-30: 50%
&nbsp;&nbsp;
EXIT:
&nbsp;&nbsp;Price touches SAR
</code></pre>





                    </div>
                </article>
                <!-- Right: Sticky TOC -->
                <aside class="hidden lg:block w-64 flex-shrink-0">
                    <div class="sticky top-24">
                        <h3 class="font-bold text-slate-900 mb-4 pb-2 border-b border-slate-100 text-sm uppercase tracking-wider">
                            On this page
                        </h3>
                        <nav id="toc-nav" class="space-y-1 text-sm text-slate-600">
                            <a href="#1-identity" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">1. Identity</a>
<a href="#2-calculation-logic" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">2. Calculation Logic</a>
<a href="#formula" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Formula</a>
<a href="#real-world-analogy" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Real-World Analogy</a>
<a href="#3-market-standards" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">3. Market Standards</a>
<a href="#default-parameters" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Default Parameters</a>
<a href="#alternative-settings" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Alternative Settings</a>
<a href="#timeframe-recommendations" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Timeframe Recommendations</a>
<a href="#4-market-context" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">4. Market Context</a>
<a href="#best-conditions" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Best Conditions</a>
<a href="#limitations" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Limitations</a>
<a href="#asset-class-suitability" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Asset Class Suitability</a>
<a href="#5-entry-signals" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">5. Entry Signals</a>
<a href="#primary-buy-signal" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Primary Buy Signal</a>
<a href="#primary-sell/exit-signal" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Primary Sell/Exit Signal</a>
<a href="#6-filter-usage" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">6. Filter Usage</a>
<a href="#filter-rules" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Filter Rules</a>
<a href="#recommended-pairings" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Recommended Pairings</a>
<a href="#example-combined-strategy" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Example Combined Strategy</a>
<a href="#7-practical-cautions" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">7. Practical Cautions</a>
<a href="#lag-characteristics" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Lag Characteristics</a>
<a href="#false-signal-scenarios" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">False Signal Scenarios</a>
<a href="#mitigation-strategies" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Mitigation Strategies</a>
<a href="#8-pro-insights" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">8. Pro Insights</a>
<a href="#the-3-dot-confirmation-rule" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">The 3-Dot Confirmation Rule</a>
<a href="#the-sar-gap-size-indicator" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">The SAR Gap Size Indicator</a>
<a href="#wilder's-complete-system" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Wilder's Complete System</a>
<a href="#dynamic-parameter-adjustment" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Dynamic Parameter Adjustment</a>
<a href="#9-summary" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">9. Summary</a>
<a href="#1-core-concept" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">1. Core Concept</a>
<a href="#2-statistical-edge" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">2. Statistical Edge</a>
<a href="#backtest-evidence" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Backtest Evidence</a>
<a href="#why-it-works" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Why It Works</a>
<a href="#academic-reference" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Academic Reference</a>
<a href="#3-actionable-strategy" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">3. Actionable Strategy</a>
<a href="#strategy-name:-"wilder's-filtered-trend"" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Strategy Name: "Wilder's Filtered Trend"</a>
<a href="#4-risks-&-limitations" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">4. Risks & Limitations</a>
<a href="#failure-patterns" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Failure Patterns</a>
<a href="#psychological-traps" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Psychological Traps</a>
<a href="#common-misinterpretations" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Common Misinterpretations</a>
<a href="#5-further-study" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">5. Further Study</a>
<a href="#creator-attribution" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Creator Attribution</a>
<a href="#parent/child-indicators" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Parent/Child Indicators</a>
<a href="#recommended-readings" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Recommended Readings</a>
<a href="#55-related-indicators-comparison" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">5.5 Related Indicators Comparison</a>
<a href="#advanced-signal-reference" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">Advanced Signal Reference</a>
<a href="#threshold-matrix" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Threshold Matrix</a>
<a href="#signal-patterns" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Signal Patterns</a>
<a href="#screening-filters" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Screening Filters</a>
<a href="#combination-strategies" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Combination Strategies</a>

                        </nav>
                        <div class="mt-8 pt-4 border-t border-slate-100">
                            <a href="#" class="text-xs text-slate-400 hover:text-indigo-600 flex items-center transition-colors">
                                Back to Top
                            </a>
                        </div>
                    </div>
                </aside>
            </div>
        </section>


    </div>

    <!-- Footer -->
    <footer class="bg-white border-t border-slate-200 mt-12">
        <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
            <p class="text-center text-slate-400 text-sm">
                &copy; 2023-2025 I ant I Investigates. All rights reserved.
            </p>
        </div>
    </footer>

    <!-- ========================================== -->
    <!-- 1. DATA & LOGIC INJECTION                  -->
    <!-- ========================================== -->
    <script>
        window.IndicatorLogic = {
            name: "ParabolicSAR",
            params: [],
            calculate: null
        };
        (function() {
            try {
                const injectedCode = `
        window.IndicatorLogic = {
            calculate: (data, params) => {
                const af = params.af || 0.02;
                const maxAf = params.maxAf || 0.2;
                const sar = [];
                if (data.length < 2) return { sar: data.map(() => null) };
                // Initialize: guess trend from first 2 bars
                let isUptrend = data[1].close > data[0].close;
                let currentAf = af;
                let ep = isUptrend ? data[0].high : data[0].low;
                let sarValue = isUptrend ? data[0].low : data[0].high;
                sar.push(null); // First bar
                for (let i = 1; i < data.length; i++) {
                    const d = data[i];
                    const prevD = data[i - 1];
                    if (isUptrend) {
                        // Check for reversal: price breaks below SAR
                        if (d.low < sarValue) {
                            isUptrend = false;
                            sar.push(sarValue);
                            sarValue = ep; // SAR becomes the extreme point
                            ep = d.low;
                            currentAf = af;
                        } else {
                            sar.push(sarValue);
                            // Update EP and AF if new high
                            if (d.high > ep) {
                                ep = d.high;
                                currentAf = Math.min(currentAf + af, maxAf);
                            }
                            // Calculate next SAR
                            sarValue = sarValue + currentAf * (ep - sarValue);
                            // SAR can't be above previous lows
                            sarValue = Math.min(sarValue, prevD.low, d.low);
                        }
                    } else {
                        // Check for reversal: price breaks above SAR
                        if (d.high > sarValue) {
                            isUptrend = true;
                            sar.push(sarValue);
                            sarValue = ep;
                            ep = d.high;
                            currentAf = af;
                        } else {
                            sar.push(sarValue);
                            // Update EP and AF if new low
                            if (d.low < ep) {
                                ep = d.low;
                                currentAf = Math.min(currentAf + af, maxAf);
                            }
                            // Calculate next SAR
                            sarValue = sarValue + currentAf * (ep - sarValue);
                            // SAR can't be below previous highs
                            sarValue = Math.max(sarValue, prevD.high, d.high);
                        }
                    }
                }
                return { sar };
            }
        };
        `;
                const isTemplatePlaceholder = injectedCode.includes('{{') && injectedCode.includes('PLAYGROUND_LOGIC');
                if (injectedCode && injectedCode.trim().length > 0 && !isTemplatePlaceholder) {
                    new Function(injectedCode)();
                } else {
                    console.warn("Playground Logic: Running in Preview/Fallback mode.");
                    window.IndicatorLogic.calculate = () => []; 
                }
            } catch (e) {
                console.error("Critical Error in Logic Injection:", e);
                window.IndicatorLogic.calculate = () => [];
            }
        })();
    </script>

    <!-- ========================================== -->
    <!-- 2. VISUALIZATION ENGINE                    -->
    <!-- ========================================== -->
    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'neutral', securityLevel: 'loose' });
    </script>

    <!-- ========================================== -->
    <!-- 3. UI CONTROLLERS & APP INITIALIZATION     -->
    <!-- ========================================== -->
    <script src="../../assets/js/script.js" defer></script>
    <!-- INLINE UI CONTROLLERS (PORTED FROM 0117) -->
    <script>
        // --- 0. Indicator Data Injection ---
        // These are populated by the generator script
        var IndicatorLogic = {};
        var IndicatorConfig = [];
        var IndicatorDisplay = { isOverlay: false, plots: {} };

        // 1. Library Code (e.g. class definitions)
        // No library code for verification

        // 2. Configuration
        try {
            var rawConfig = '[{"id": "af", "label": "Acceleration Factor (0.02)", "type": "number", "value": 0.02, "min": 0.01, "max": 0.1, "step": 0.01}, {"id": "maxAf", "label": "Max Acceleration (0.2)", "type": "number", "value": 0.2, "min": 0.1, "max": 0.5, "step": 0.05}]';
            if(rawConfig && !rawConfig.startsWith('{{')) IndicatorConfig = JSON.parse(rawConfig);
        } catch(e){ console.warn('Config parse error', e); }

        try {
            var rawDisplay = '{"isOverlay": true, "plots": {"sar": {"label": "Parabolic SAR", "color": "#ef4444", "type": "scatter", "pointRadius": 5}}}';
            if(rawDisplay && !rawDisplay.startsWith('{{')) IndicatorDisplay = JSON.parse(rawDisplay);
        } catch(e){ console.warn('Display parse error', e); }

        // 3. Logic Adapter
        window.IndicatorLogic = {
            calculate: (data, params) => {
                const af = params.af || 0.02;
                const maxAf = params.maxAf || 0.2;
                const sar = [];
                if (data.length < 2) return { sar: data.map(() => null) };
                // Initialize: guess trend from first 2 bars
                let isUptrend = data[1].close > data[0].close;
                let currentAf = af;
                let ep = isUptrend ? data[0].high : data[0].low;
                let sarValue = isUptrend ? data[0].low : data[0].high;
                sar.push(null); // First bar
                for (let i = 1; i < data.length; i++) {
                    const d = data[i];
                    const prevD = data[i - 1];
                    if (isUptrend) {
                        // Check for reversal: price breaks below SAR
                        if (d.low < sarValue) {
                            isUptrend = false;
                            sar.push(sarValue);
                            sarValue = ep; // SAR becomes the extreme point
                            ep = d.low;
                            currentAf = af;
                        } else {
                            sar.push(sarValue);
                            // Update EP and AF if new high
                            if (d.high > ep) {
                                ep = d.high;
                                currentAf = Math.min(currentAf + af, maxAf);
                            }
                            // Calculate next SAR
                            sarValue = sarValue + currentAf * (ep - sarValue);
                            // SAR can't be above previous lows
                            sarValue = Math.min(sarValue, prevD.low, d.low);
                        }
                    } else {
                        // Check for reversal: price breaks above SAR
                        if (d.high > sarValue) {
                            isUptrend = true;
                            sar.push(sarValue);
                            sarValue = ep;
                            ep = d.high;
                            currentAf = af;
                        } else {
                            sar.push(sarValue);
                            // Update EP and AF if new low
                            if (d.low < ep) {
                                ep = d.low;
                                currentAf = Math.min(currentAf + af, maxAf);
                            }
                            // Calculate next SAR
                            sarValue = sarValue + currentAf * (ep - sarValue);
                            // SAR can't be below previous highs
                            sarValue = Math.max(sarValue, prevD.high, d.high);
                        }
                    }
                }
                return { sar };
            }
        };
    </script>

    <script>
        // --- 1. Code Panel Logic ---
        const AppState = {
            activeLang: 'csharp',
            codeType: 'simple',
            isPanelVisible: false,  // Start hidden to show flowchart
            isPanelExpanded: false,
        };

        // --- 2. Canvas State (Full Pan/Zoom from 0117) ---
        const CanvasState = {
            scale: 1, panX: 0, panY: 0,
            isDragging: false, startX: 0, startY: 0,
            minScale: 0.1, maxScale: 5.0
        };

        // Element references (populated after DOM ready)
        let els = {};

        function updateView() {
            // 1. Code Content Visibility
            document.querySelectorAll('.code-content').forEach(el => el.classList.add('hidden'));
            const activeId = `code-${AppState.activeLang}-${AppState.codeType}`;
            const activeEl = document.getElementById(activeId);
            if (activeEl) activeEl.classList.remove('hidden');

            // 2. Overlay Visibility
            const overlay = document.getElementById('code-panel-overlay');
            if (overlay) {
                if (AppState.isPanelVisible) overlay.classList.remove('panel-hidden');
                else overlay.classList.add('panel-hidden');

                if (AppState.isPanelExpanded) {
                    overlay.classList.add('panel-expanded');
                    const iconExp = document.getElementById('icon-expand');
                    const iconCol = document.getElementById('icon-collapse');
                    if(iconExp) iconExp.classList.add('hidden');
                    if(iconCol) iconCol.classList.remove('hidden');
                } else {
                    overlay.classList.remove('panel-expanded');
                    const iconExp = document.getElementById('icon-expand');
                    const iconCol = document.getElementById('icon-collapse');
                    if(iconExp) iconExp.classList.remove('hidden');
                    if(iconCol) iconCol.classList.add('hidden');
                }
            }

            // 3. Button States
            const btnCs = document.getElementById('btn-lang-csharp');
            const btnPy = document.getElementById('btn-lang-python');
            [btnCs, btnPy].forEach(btn => {
                if(btn) btn.className = "px-2 py-1 text-xs rounded transition-colors text-slate-500 hover:bg-slate-100";
            });

            if (AppState.activeLang === 'csharp' && btnCs) {
                btnCs.className = "px-2 py-1 text-xs rounded transition-colors btn-lang-active";
            } else if (AppState.activeLang === 'python' && btnPy) {
                btnPy.className = "px-2 py-1 text-xs rounded transition-colors btn-lang-active";
            }

            const btnSimple = document.getElementById('btn-type-simple');
            const btnDetailed = document.getElementById('btn-type-detailed');
            if(btnSimple) btnSimple.className = `text-xs transition-colors ${AppState.codeType === 'simple' ? 'btn-type-active' : 'text-slate-500 hover:text-indigo-600'}`;
            if(btnDetailed) btnDetailed.className = `text-xs transition-colors ${AppState.codeType === 'detailed' ? 'btn-type-active' : 'text-slate-500 hover:text-indigo-600'}`;
        }

        // Global exports for inline onclick handlers
        window.setLang = (lang) => { AppState.activeLang = lang; updateView(); }
        window.setType = (type) => { AppState.codeType = type; updateView(); }
        window.toggleCodePanel = () => { AppState.isPanelVisible = !AppState.isPanelVisible; updateView(); }
        window.toggleExpand = () => { AppState.isPanelExpanded = !AppState.isPanelExpanded; updateView(); }
        window.copyCode = async () => {
            const activeId = `code-${AppState.activeLang}-${AppState.codeType}`;
            const el = document.getElementById(activeId);
            if (!el) return;
            let text = "";
            const lines = el.querySelectorAll('.code-line');
            if (lines.length > 0) {
                text = Array.from(lines).map(line => line.textContent).join('\n');
            } else {
                text = el.textContent;
            }
            try {
                await navigator.clipboard.writeText(text);
                const iconCopy = document.getElementById('icon-copy');
                const iconDone = document.getElementById('icon-copy-done');
                if (iconCopy && iconDone) {
                    iconCopy.classList.add('hidden');
                    iconDone.classList.remove('hidden');
                    setTimeout(() => {
                        iconCopy.classList.remove('hidden');
                        iconDone.classList.add('hidden');
                    }, 2000);
                }
            } catch (err) { console.error("Failed to copy:", err); }
        }

        // --- Canvas Transform Functions (Full Pan/Zoom) ---
        // PlaygroundController (Ported from template_0117.html)
        window.PlaygroundController = {
            instanceChart: null,
            showError: (msg) => {
                console.error('Playground Error:', msg);
                const outputEl = document.getElementById('output-data');
                if (outputEl) outputEl.value = 'Error: ' + msg;
            },
            clearError: () => {},
            init: () => {
                try {
                    // 1. Render Dynamic Settings if Config exists
                    const settingsContainer = document.getElementById('settings-container');
                    if (IndicatorConfig && Array.isArray(IndicatorConfig) && IndicatorConfig.length > 0 && settingsContainer) {
                        settingsContainer.innerHTML = ''; // Clear default "Period"
                        IndicatorConfig.forEach(cfg => {
                            const div = document.createElement('div');
                            div.className = "flex flex-col";
                            const label = document.createElement('label');
                            label.className = "text-xs text-slate-400 mb-1";
                            label.textContent = cfg.label;
                            const input = document.createElement('input');
                            input.id = `param-${cfg.id}`;
                            input.type = cfg.type || "number";
                            // Light theme styling to match textarea
                            input.className = "bg-white border border-slate-300 rounded px-2 py-1 text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow";
                            input.value = cfg.value;
                            if(cfg.min !== undefined) input.min = cfg.min;
                            if(cfg.max !== undefined) input.max = cfg.max;
                            // Add change listener to auto-update
                            input.addEventListener('change', PlaygroundController.update);
                            div.appendChild(label);
                            div.appendChild(input);
                            settingsContainer.appendChild(div);
                        });
                    }

                    // 2. Generate Initial Random Sample Data (Default to Single for simplicity, or OHLCV)
                    PlaygroundController.generateSample('ohlcv'); // Default to OHLCV for robustness
                } catch(e) { PlaygroundController.showError(e.message); }
            },
            generateSample: (type) => {
                 const sampleData = [];
                 const count = 150; 
                 let price = 100;
                 if (type === 'ohlcv') {
                    // OHLCV Generation
                    sampleData.push("Date,Open,High,Low,Close,Volume");
                    const now = new Date();
                    for (let i = 0; i < count; i++) {
                        const date = new Date(now.getTime() - (count - i) * 86400000).toISOString().split('T')[0];
                        const trend = Math.sin(i * 0.1) * 2;
                        const noise = (Math.random() - 0.5) * 2;
                        const close = 100 + trend + noise + (i * 0.1); 
                        const open = close + (Math.random() - 0.5);
                        const high = Math.max(open, close) + Math.random();
                        const low = Math.min(open, close) - Math.random();
                        const vol = Math.floor(1000 + Math.random() * 500);
                        sampleData.push(`${date},${open.toFixed(2)},${high.toFixed(2)},${low.toFixed(2)},${close.toFixed(2)},${vol}`);
                    }
                 } else { 
                    // Single Value Generation
                    for (let i = 0; i < count; i++) {
                        price = price + (Math.random() - 0.5) * 5;
                        sampleData.push(price.toFixed(2));
                    }
                 }
                 const inputEl = document.getElementById('input-data');
                 if (inputEl) inputEl.value = sampleData.join('\n');
                 PlaygroundController.update();
            },
            update: () => {
                PlaygroundController.clearError();
                // Dynamic Params Collection
                const params = {};
                if (IndicatorConfig && Array.isArray(IndicatorConfig) && IndicatorConfig.length > 0) {
                    IndicatorConfig.forEach(cfg => {
                        const el = document.getElementById(`param-${cfg.id}`);
                        if (el) params[cfg.id] = parseFloat(el.value);
                    });
                } else {
                    // Fallback to default Period if no config
                    const periodEl = document.getElementById('param-period');
                    params.period = periodEl ? parseInt(periodEl.value) || 14 : 14;
                }

                const rawData = document.getElementById('input-data').value.trim();
                let lines = [];
                // Robust split: handle comma, newline, or mixed
                if (rawData.includes('\n')) {
                    // Split by newline first
                    lines = rawData.split('\n').map(l => l.trim()).filter(l => l);
                    // If it's NOT multi-column (header check), and lines contain commas, try to flatten
                    const firstVal = parseFloat(lines[0].split(/[,\t]/)[0]);
                    const isHeader = isNaN(firstVal) && /[a-zA-Z]/.test(lines[0]);
                    if (!isHeader && lines.some(l => l.includes(','))) {
                        // Flatten mixed content like "100, 101\n102, 103"
                        lines = rawData.split(/[\n,]+/).map(l => l.trim()).filter(l => l);
                    }
                } else {
                    // Single line, split by comma
                    lines = rawData.split(',').map(l => l.trim()).filter(l => l);
                }

                let parsedData = [];
                const firstLine = lines[0] || "";
                const firstVal = parseFloat(firstLine.split(/[,\t]/)[0]);
                const isMultiColumn = isNaN(firstVal) && /[a-zA-Z]/.test(firstLine);

                if (isMultiColumn && lines.length > 1) {
                    const headers = firstLine.split(/[,\t]+/).map(h => h.trim().toLowerCase());
                    for (let i = 1; i < lines.length; i++) {
                        const parts = lines[i].split(/[,\t]+/).map(v => parseFloat(v));
                        if (parts.some(isNaN)) continue;
                        const row = { time: i - 1 };
                        headers.forEach((h, idx) => { row[h] = parts[idx]; });
                        if (row.close === undefined && row.c !== undefined) row.close = row.c;
                        parsedData.push(row);
                    }
                } else {
                    parsedData = lines.map((l, i) => {
                        const val = parseFloat(l);
                        return isNaN(val) ? null : { time: i, close: val };
                    }).filter(d => d);
                }

                if (parsedData.length < 2) {
                    PlaygroundController.showError("Insufficient data.");
                    return;
                }

                let indicatorValues = [];
                try {
                    if (typeof IndicatorLogic !== 'undefined' && IndicatorLogic.calculate) {
                        indicatorValues = IndicatorLogic.calculate(parsedData, params);
                    } else {
                        // Fallback: Simple RSI calculation for demo
                        indicatorValues = PlaygroundController.calculateRSI(parsedData, params.period);
                    }
                } catch (e) {
                    console.error("Calculation Error", e);
                    PlaygroundController.showError("Calculation Error: " + e.message);
                    return;
                }

                // --- Format Output (CSV/TSV for Excel) ---
                const outputEl = document.getElementById('output-data');
                // --- Format Output (CSV/TSV for Excel) ---
                if (outputEl) {
                    if (Array.isArray(indicatorValues)) {
                        // Single Array (e.g. RSI)
                        outputEl.value = indicatorValues.map(v => v === null ? "" : v).join('\n');
                    } else if (typeof indicatorValues === 'object') {
                        // Multi-line Object (e.g. Ichimoku)
                        const keys = Object.keys(indicatorValues);
                        if (keys.length === 0) {
                            outputEl.value = "";
                        } else {
                            const length = indicatorValues[keys[0]].length;
                            // Comma separated as requested by user
                            const separator = ','; 
                            let csv = keys.join(separator) + '\n';
                            for (let i = 0; i < length; i++) {
                                const row = keys.map(k => {
                                    const val = indicatorValues[k][i];
                                    // Handle missing/undefined
                                    return (val === null || val === undefined) ? "" : val;
                                });
                                csv += row.join(separator) + '\n';
                            }
                            outputEl.value = csv;
                        }
                    } else {
                        outputEl.value = JSON.stringify(indicatorValues, null, 2);
                    }
                }
                PlaygroundController.renderChart(parsedData, indicatorValues);
            },
            calculateRSI: (data, period) => {
                // Simple RSI fallback
                const values = [];
                values.push(null); // First value is null
                if (data.length < 2) return values;
                let sumGains = 0, sumLosses = 0;
                for (let i = 1; i < data.length; i++) {
                    const change = data[i].close - data[i-1].close;
                    const gain = change > 0 ? change : 0;
                    const loss = change < 0 ? -change : 0;
                    if (i < period) {
                        sumGains += gain; sumLosses += loss;
                        values.push(null);
                        continue;
                    }
                    if (i === period) {
                        sumGains += gain; sumLosses += loss;
                        const avgGain = sumGains / period;
                        const avgLoss = sumLosses / period;
                        const rs = avgLoss < 0.0001 ? 100 : avgGain / avgLoss;
                        values.push(100 - (100 / (1 + rs)));
                        sumGains = avgGain; sumLosses = avgLoss;
                        continue;
                    }
                    sumGains = (sumGains * (period - 1) + gain) / period;
                    sumLosses = (sumLosses * (period - 1) + loss) / period;
                    const rs = sumLosses < 0.0001 ? 100 : sumGains / sumLosses;
                    values.push(100 - (100 / (1 + rs)));
                }
                return values;
            },
            renderChart: (prices, indicatorValues) => {
                const canvas = document.getElementById('indicatorChart');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const labels = prices.map((_, i) => i);
                if (PlaygroundController.instanceChart) PlaygroundController.instanceChart.destroy();

                const datasets = [];
                // 1. Overlay: Close Price (if enabled)
                if (IndicatorDisplay && IndicatorDisplay.isOverlay) {
                    datasets.push({
                        label: 'Close Price',
                        data: prices.map(p => p.close),
                        borderColor: '#94a3b8', // slate-400
                        backgroundColor: 'transparent',
                        borderDash: [5, 5],
                        borderWidth: 1,
                        pointRadius: 0,
                        tension: 0.1
                    });
                }

                // 2. Indicator Data
                const defaultColors = ['#4F46E5', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'];
                if (Array.isArray(indicatorValues)) {
                    datasets.push({
                        label: 'Indicator',
                        data: indicatorValues,
                        borderColor: IndicatorDisplay.plots && IndicatorDisplay.plots.main ? IndicatorDisplay.plots.main.color : '#4F46E5',
                        backgroundColor: 'transparent',
                        tension: 0.1, pointRadius: 0, borderWidth: 2
                    });
                } else if (typeof indicatorValues === 'object' && indicatorValues !== null) {
                    // Multi-line indicator (e.g., Bollinger Bands, Parabolic SAR)
                    Object.keys(indicatorValues).forEach((key, idx) => {
                        const conf = (IndicatorDisplay.plots && IndicatorDisplay.plots[key]) || {};
                        const color = conf.color || defaultColors[idx % defaultColors.length];
                        const isScatter = conf.type === 'scatter';
                        // For scatter type, convert data to {x, y} format
                        let chartData;
                        if (isScatter) {
                            chartData = indicatorValues[key]
                                .map((val, i) => val !== null && val !== undefined ? { x: i, y: val } : null)
                                .filter(p => p !== null);
                        } else {
                            chartData = indicatorValues[key];
                        }
                        datasets.push({
                            label: conf.label || key,
                            data: chartData,
                            type: isScatter ? 'scatter' : (conf.type || 'line'),
                            borderColor: isScatter ? 'transparent' : color,
                            backgroundColor: isScatter ? color : 'transparent',
                            pointRadius: isScatter ? (conf.pointRadius || 5) : 0,
                            pointBorderWidth: 0,
                            tension: 0.1,
                            borderWidth: isScatter ? 0 : 2
                        });
                    });
                }

                PlaygroundController.instanceChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: labels, datasets: datasets },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        scales: {
                            y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Value' } }
                        }
                    }
                });
            }
        };

        function updateTransform() {
            if (els.content) {
                els.content.style.transform = `translate(${CanvasState.panX}px, ${CanvasState.panY}px) scale(${CanvasState.scale})`;
            }
        }

        function handleWheel(e) {
            e.preventDefault();
            const rect = els.container.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            const zoomSensitivity = 0.001;
            const delta = -e.deltaY * zoomSensitivity;
            let newScale = CanvasState.scale * (1 + delta);
            newScale = Math.max(CanvasState.minScale, Math.min(CanvasState.maxScale, newScale));
            const scaleRatio = newScale / CanvasState.scale;
            CanvasState.panX = mouseX - (mouseX - CanvasState.panX) * scaleRatio;
            CanvasState.panY = mouseY - (mouseY - CanvasState.panY) * scaleRatio;
            CanvasState.scale = newScale;
            updateTransform();
        }

        function startDrag(e) {
            if (e.button !== 0 && e.button !== 1) return;
            CanvasState.isDragging = true;
            CanvasState.startX = e.clientX;
            CanvasState.startY = e.clientY;
            els.container.style.cursor = 'grabbing';
        }

        function drag(e) {
            if (!CanvasState.isDragging) return;
            e.preventDefault();
            const dx = e.clientX - CanvasState.startX;
            const dy = e.clientY - CanvasState.startY;
            CanvasState.panX += dx;
            CanvasState.panY += dy;
            CanvasState.startX = e.clientX;
            CanvasState.startY = e.clientY;
            updateTransform();
        }

        function stopDrag() {
            CanvasState.isDragging = false;
            if (els.container) els.container.style.cursor = 'grab';
        }

        window.zoomAction = (direction) => {
            if (!els.container || !els.content) return;
            const factor = direction === 'in' ? 1.2 : 0.8;
            let newScale = CanvasState.scale * factor;
            newScale = Math.max(CanvasState.minScale, Math.min(CanvasState.maxScale, newScale));
            const rect = els.container.getBoundingClientRect();
            const cx = rect.width / 2;
            const cy = rect.height / 2;
            const scaleRatio = newScale / CanvasState.scale;
            CanvasState.panX = cx - (cx - CanvasState.panX) * scaleRatio;
            CanvasState.panY = cy - (cy - CanvasState.panY) * scaleRatio;
            CanvasState.scale = newScale;
            updateTransform();
        }

        window.resetView = () => { centerContent(); }

        function centerContent() {
            if (!els.content || !els.container) return;
            const containerRect = els.container.getBoundingClientRect();
            const unscaledWidth = els.content.scrollWidth;
            const unscaledHeight = els.content.scrollHeight;
            let initialScale = 1.0;
            if (unscaledWidth > containerRect.width) {
                initialScale = (containerRect.width / unscaledWidth) * 0.9;
            }
            initialScale = Math.max(0.5, Math.min(1.0, initialScale));
            CanvasState.scale = initialScale;
            CanvasState.panX = (containerRect.width - unscaledWidth * initialScale) / 2;
            CanvasState.panY = (containerRect.height - unscaledHeight * initialScale) / 2;
            CanvasState.panY = Math.max(20, CanvasState.panY);
            updateTransform();
        }

        // --- 3. Init ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Bind element references
            els.container = document.getElementById('canvas-container');
            els.content = document.getElementById('canvas-content');

            // Init code panel state
            updateView();

            // Init Playground
            if (window.PlaygroundController) PlaygroundController.init();

            // Mermaid rendering + center
            if (window.mermaid) {
                try {
                    const nodes = document.querySelectorAll('.mermaid');
                    if (nodes.length > 0) {
                        await mermaid.run({ nodes: nodes });
                        setTimeout(centerContent, 100);
                    }
                } catch (e) { console.error("Mermaid render failed", e); }
            }

            // Canvas Events (Wheel zoom + Drag pan)
            if (els.container) {
                els.container.addEventListener('wheel', handleWheel, { passive: false });
                els.container.addEventListener('mousedown', startDrag);
                window.addEventListener('mousemove', drag);
                window.addEventListener('mouseup', stopDrag);
            }

            // KaTeX Auto Render
            if (window.renderMathInElement) {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ],
                    throwOnError: false
                });
            }

            // TOC ScrollSpy
            const tocLinks = document.querySelectorAll('.toc-link');
            if (tocLinks.length > 0) {
                const headings = document.querySelectorAll('article h2[id], article h3[id]');
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            tocLinks.forEach(link => link.classList.remove('active'));
                            const id = entry.target.getAttribute('id');
                            const activeLink = document.querySelector(`.toc-link[href="#${id}"]`);
                            if (activeLink) activeLink.classList.add('active');
                        }
                    });
                }, { rootMargin: '-20% 0px -60% 0px' });
                headings.forEach(h => observer.observe(h));
            }

            // Load Sample buttons
            const btnOhlcv = document.getElementById('btn-load-sample-ohlcv');
            if (btnOhlcv) {
                btnOhlcv.addEventListener('click', () => {
                    if (window.PlaygroundController) PlaygroundController.generateSample('ohlcv');
                });
            }
            const btnSingle = document.getElementById('btn-load-sample-single');
            if (btnSingle) {
                btnSingle.addEventListener('click', () => {
                    if (window.PlaygroundController) PlaygroundController.generateSample('single');
                });
            }
            // Initialize Playground Controller
            if (window.PlaygroundController && PlaygroundController.init) {
                PlaygroundController.init();
            }
        });
    </script>
</body>
</html>