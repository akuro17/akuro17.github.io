<!DOCTYPE html>
<html lang="ja" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MovingAverageConvergenceDivergence - I ant I Investigates</title>
    <meta name="description" content="">
    <meta name="keywords" content="">
    <!-- Structured Data for SEO -->
    <script type="application/ld+json">
        {
    "@context": "https://schema.org",
    "@type": "TechArticle",
    "headline": "MovingAverageConvergenceDivergence",
    "description": "Detailed guide for MovingAverageConvergenceDivergence indicator.",
    "author": {
        "@type": "Organization",
        "name": "I and I Investigates"
    }
}
    </script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- Styles -->
    <!-- Styles -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <link rel="stylesheet" href="../../assets/css/style.css">
    <!-- KaTeX (Math) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>

    <style>
        /* =========================================
           PORTED STYLES (From 0117 Template)
           ========================================= */
        :root {
            /* Minimal Variable Set for Logic Panel */
            --bg-card: #FFFFFF;
            --bg-secondary: #F8FAFC; /* slate-50 */
            --bg-hover: #F1F5F9; /* slate-100 */
            --border-color: #E2E8F0; /* slate-200 */
            --text-primary: #1E293B; /* slate-800 */
            --text-muted: #64748B; /* slate-500 */
            --accent: #4F46E5; /* indigo-600 */
        }

        /* Logic Figure Container */
        .logic-figure {
            margin: 0;
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            position: relative;
            overflow: hidden;
            height: 600px; /* Fixed height for infinite canvas feel */
        }

        /* Infinite Canvas Wrapper */
        .chart-scroll-wrapper {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
            background-color: #FFFFFF;
            background-image: radial-gradient(#E2E8F0 1.5px, transparent 1.5px);
            background-size: 20px 20px;
            cursor: grab;
            touch-action: none;
            user-select: none;
        }
        .chart-scroll-wrapper:active { cursor: grabbing; }

        /* Code Panel Overlay */
        #code-panel-overlay {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            width: 500px;
            max-width: 90%;
            z-index: 30;
            background-color: var(--bg-card);
            border-right: 1px solid var(--border-color);
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), width 0.3s ease;
            transform: translateX(0);
        }
        #code-panel-overlay.panel-hidden {
            transform: translateX(-100%);
            pointer-events: none;
        }
        #code-panel-overlay.panel-expanded {
            width: 100%;
            max-width: 100%;
        }

        /* Code Content */
        .code-panel-body {
            background-color: #FAFAFA;
            flex: 1;
            overflow: auto;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            padding: 0.5rem 1rem 1rem 1rem; /* Reduced top padding */
            white-space: pre; /* Essential for code indentation */
        }
        .code-content {
            font-family: 'Roboto Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            padding: 1rem;
        }
        /* Toggle Button */
        #code-panel-toggle-btn {
            position: absolute;
            top: 1rem;
            left: 1rem;
            z-index: 25;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.5rem;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }
        #code-panel-toggle-btn:hover {
            color: var(--accent);
            border-color: var(--accent);
        }

        /* Active States for Panel Buttons */
        .btn-lang-active {
            background-color: var(--accent) !important;
            color: white !important;
        }
        .btn-type-active {
            color: var(--text-primary) !important;
            font-weight: bold;
            text-decoration: underline;
            text-decoration-color: var(--accent);
            text-decoration-thickness: 2px;
        }

        /* Custom Scrollbar for Code Blocks */
        pre::-webkit-scrollbar, .code-panel-body::-webkit-scrollbar {
            height: 8px; width: 8px;
            background-color: #f1f5f9;
        }
        pre::-webkit-scrollbar-thumb, .code-panel-body::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        pre::-webkit-scrollbar-thumb:hover, .code-panel-body::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8;
        }

        /* Pygments Syntax Highlighting */
        pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.highlight .hll { background-color: #ffffcc }
.highlight .c { color: #008000 } /* Comment */
.highlight .err { border: 1px solid #F00 } /* Error */
.highlight .k { color: #00F } /* Keyword */
.highlight .ch { color: #008000 } /* Comment.Hashbang */
.highlight .cm { color: #008000 } /* Comment.Multiline */
.highlight .cp { color: #00F } /* Comment.Preproc */
.highlight .cpf { color: #008000 } /* Comment.PreprocFile */
.highlight .c1 { color: #008000 } /* Comment.Single */
.highlight .cs { color: #008000 } /* Comment.Special */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
.highlight .gh { font-weight: bold } /* Generic.Heading */
.highlight .gp { font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { font-weight: bold } /* Generic.Subheading */
.highlight .kc { color: #00F } /* Keyword.Constant */
.highlight .kd { color: #00F } /* Keyword.Declaration */
.highlight .kn { color: #00F } /* Keyword.Namespace */
.highlight .kp { color: #00F } /* Keyword.Pseudo */
.highlight .kr { color: #00F } /* Keyword.Reserved */
.highlight .kt { color: #2B91AF } /* Keyword.Type */
.highlight .s { color: #A31515 } /* Literal.String */
.highlight .nc { color: #2B91AF } /* Name.Class */
.highlight .ow { color: #00F } /* Operator.Word */
.highlight .sa { color: #A31515 } /* Literal.String.Affix */
.highlight .sb { color: #A31515 } /* Literal.String.Backtick */
.highlight .sc { color: #A31515 } /* Literal.String.Char */
.highlight .dl { color: #A31515 } /* Literal.String.Delimiter */
.highlight .sd { color: #A31515 } /* Literal.String.Doc */
.highlight .s2 { color: #A31515 } /* Literal.String.Double */
.highlight .se { color: #A31515 } /* Literal.String.Escape */
.highlight .sh { color: #A31515 } /* Literal.String.Heredoc */
.highlight .si { color: #A31515 } /* Literal.String.Interpol */
.highlight .sx { color: #A31515 } /* Literal.String.Other */
.highlight .sr { color: #A31515 } /* Literal.String.Regex */
.highlight .s1 { color: #A31515 } /* Literal.String.Single */
.highlight .ss { color: #A31515 } /* Literal.String.Symbol */
        /* Mermaid Overrides */
        .mermaid { transform-origin: 0 0; }
        .noselect { user-select: none; -webkit-user-select: none; }

        /* Legend Items */
        .logic-legend {
            border-top: 1px solid var(--border-color);
            padding: 1rem;
            background-color: var(--bg-card);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1.5rem;
            position: relative;
            z-index: 20;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: 500;
        }
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 1px solid;
        }
        .l-ingestion { background: #E8F0FE; border-color: #4285F4; }
        .l-evaluation { background: #FEF7E0; border-color: #FBBC04; }
        .l-weighting { background: #F3E8FD; border-color: #A142F4; }
        .l-synthesis { background: #E0F7FA; border-color: #12B5CB; }
        .l-outcome { background: #E6F4EA; border-color: #34A853; }

        /* TOC Active State Styling */
        .toc-link.active {
            color: #4f46e5;
            border-left-color: #4f46e5;
            background-color: #eef2ff;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans antialiased relative">

    <!-- Navigation -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center mr-6">
                        <a href="../index.html" class="font-bold text-xl text-indigo-600">
                            I ant I Investigates
                        </a>
                    </div>
                    <!-- Breadcrumbs (Moved Here) -->
                    <nav class="hidden md:flex text-sm text-slate-500 mr-8" aria-label="Breadcrumb">
                        <ol class="flex items-center space-x-2">
                            <li><a href="../index.html" class="hover:text-indigo-600 transition-colors">home</a></li>
                            <li><span class="mx-1">/</span></li>
                            <li><a href="./" class="hover:text-indigo-600 transition-colors">indicators</a></li>
                            <li><span class="mx-1">/</span></li>
                            <li><span class="font-medium text-slate-900">MovingAverageConvergenceDivergence</span></li>
                        </ol>
                    </nav>

                    <!-- Page Top Nav (Anchor Links) -->
                    <div class="hidden sm:flex sm:space-x-4 items-center">
                        <a href="#interactive-playground" class="text-slate-600 hover:text-indigo-600 px-3 py-2 text-sm font-medium transition-colors">
                            Chart
                        </a>
                        <a href="#logic-visualization" class="text-slate-600 hover:text-indigo-600 px-3 py-2 text-sm font-medium transition-colors">
                            Logic
                        </a>
                        <a href="#documentation" class="text-slate-600 hover:text-indigo-600 px-3 py-2 text-sm font-medium transition-colors">
                            Docs
                        </a>
                    </div>
                </div>
                <!-- External Links Placeholder -->
                <div class="hidden sm:flex items-center">
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Container: 1-Column Stack -->
    <div class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-12">
        <!-- ======================================================= -->
        <!-- TOP SECTION: CONTEXT & PLAYGROUND                       -->
        <!-- ======================================================= -->
        <div class="flex flex-col gap-6">
            <!-- Hero Header -->
            <header>
                <h1 class="text-3xl md:text-4xl font-bold text-slate-900 mb-4 leading-tight">MACD</h1>
                <p class="text-lg text-slate-600 leading-relaxed">MACD transforms the relationship between two exponential moving averages into a momentum oscillator that reveals both trend direction and the acceleration of price movement.</p>
            </header>

            <!-- Interactive Playground -->
            <section id="interactive-playground" class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden scroll-mt-24">
                <div class="border-b border-slate-200 bg-indigo-50 px-6 py-4">
                    <h2 class="text-lg font-bold text-slate-800 flex items-center">
                        <span class="bg-indigo-600 text-white p-1 rounded mr-3 text-xs shadow-sm font-mono">C</span>
                        Calculator
                    </h2>
                    <p class="text-sm text-slate-600 mt-2">Calculate indicator values from your price data.</p>
                </div>
                <div class="p-6">
                    <!-- Chart Area -->
                    <div class="relative h-[400px] w-full mb-6 border border-slate-100 rounded bg-slate-50">
                        <canvas id="indicatorChart"></canvas>
                    </div>

                    <!-- Controls Area -->
                    <div id="controls" class="grid grid-cols-1 md:grid-cols-3 gap-6 bg-slate-50 p-4 rounded border border-slate-200">
                        <!-- Parameters -->
                        <div class="md:col-span-1 space-y-4">
                            <h3 class="font-bold text-sm text-slate-700 uppercase tracking-wide border-b border-slate-200 pb-2">Parameters</h3>
                            <div id="settings-container">
                                <div class="space-y-3">
                                    <!-- Dynamic settings will be injected here -->
                                </div>
                            </div>
                            <button id="btn-run" onclick="PlaygroundController.update()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded transition-colors shadow-sm flex items-center justify-center">
                                Calculate
                            </button>
                        </div>

                        <!-- Data I/O -->
                        <div class="md:col-span-2 space-y-4">
                            <!-- Input -->
                            <div class="space-y-2">
                                <div class="flex justify-between items-center pb-2 border-b border-slate-200">
                                    <h3 class="font-bold text-sm text-slate-700 uppercase tracking-wide">Input Data (CSV)</h3>
                                    <div class="flex space-x-2">
                                        <button id="btn-load-sample-ohlcv" class="text-xs text-indigo-600 hover:text-indigo-800 hover:underline transition-colors" title="Load OHLCV Sample Data">Shape (OHLCV)</button>
                                        <span class="text-slate-300">|</span>
                                        <button id="btn-load-sample-single" class="text-xs text-indigo-600 hover:text-indigo-800 hover:underline transition-colors" title="Load Single Value Sample Data">Single</button>
                                    </div>
                                </div>
                                <p class="text-xs text-slate-500">Enter CSV data (Date,Open,High,Low,Close,Volume) or single values.</p>
                                <textarea id="input-data" class="w-full h-24 p-2 text-xs font-mono border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 transition-shadow" placeholder="e.g. 100.5, 101.2, 99.8, 102.3, 103.1...

or one per line:
100.5
101.2
99.8"></textarea>
                            </div>
                            <!-- Output (Enabled) -->
                            <div class="space-y-2">
                                <div class="flex justify-between items-center pb-2 border-b border-slate-200">
                                    <h3 class="font-bold text-sm text-slate-700 uppercase tracking-wide">Output Data (Result)</h3>
                                </div>
                                <textarea id="output-data" class="w-full h-24 p-2 text-xs font-mono border border-slate-300 rounded bg-slate-100 text-slate-600" readonly placeholder="Calculation results will appear here..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- ======================================================= -->
        <!-- MIDDLE SECTION: LOGIC & ARCHITECTURE (PORTED FROM 0117) -->
        <!-- ======================================================= -->
        <section id="logic-visualization" class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden scroll-mt-24">
            <!-- Section Header (Styled like Playground) -->
            <div class="border-b border-slate-200 bg-emerald-50 px-6 py-4">
                <h2 class="text-lg font-bold text-slate-800 flex items-center">
                    <span class="bg-emerald-600 text-white p-1 rounded mr-3 text-xs shadow-sm font-mono">L</span>
                    Logic & Code Architecture
                </h2>
                <p class="text-sm text-slate-600 mt-2">Visual flowchart showing how the indicator processes data.</p>
            </div>

            <!-- LOGIC FIGURE STRUCTURE -->
            <figure class="logic-figure" style="border: none; border-radius: 0;">
                <!-- 1. Code Panel Toggle Button -->
                <button id="code-panel-toggle-btn" onclick="toggleCodePanel()" title="View Source Code" class="font-bold text-xs">
                    CODE
                </button>

                <!-- 2. Infinite Canvas Layer -->
                <div id="canvas-container" class="chart-scroll-wrapper">
                    <div id="canvas-content" class="mermaid" style="position: absolute; top:0; left:0;">
                        flowchart TD;
subgraph INGESTION["Phase 1: Ingestion"];
A[/"Receive Price Data Stream"/];
B["Capture Closing Prices"];
C["Define EMA Periods"];
end;
subgraph EVALUATION["Phase 2: Evaluation"];
D["Calculate Fast Trend via Short EMA"];
E["Calculate Slow Trend via Long EMA"];
F["Measure Trend Separation"];
end;
subgraph WEIGHTING["Phase 3: Weighting"];
G["Generate MACD Line from Spread"];
H["Smooth MACD via Signal Line"];
I["Calculate Momentum via Histogram"];
end;
subgraph SYNTHESIS["Phase 4: Synthesis"];
J["Track Crossover Events"];
K["Monitor Histogram Direction"];
L["Detect Divergence Patterns"];
end;
subgraph OUTCOME["Phase 5: Outcome"];
M{"Momentum Assessment?"};
N["MACD > Signal + Histogram Rising = Bullish"];
O["MACD < Signal + Histogram Falling = Bearish"];
P["Histogram Shrinking = Momentum Fading"];
Q[/"Generate Trend-Momentum Signal"/];
end;
A --> B;
B --> C;
C --> D;
D --> E;
E --> F;
F --> G;
G --> H;
H --> I;
I --> J;
J --> K;
K --> L;
L --> M;
M -->|Bullish| N;
M -->|Bearish| O;
M -->|Fading| P;
N --> Q;
O --> Q;
P --> Q;
style INGESTION fill:#e3f2fd;
style EVALUATION fill:#fff3e0;
style WEIGHTING fill:#e8f5e9;
style SYNTHESIS fill:#fce4ec;
style OUTCOME fill:#f3e5f5;
                    </div>
                </div>

                <!-- 3. Canvas Controls (Zoom) -->
                <div class="absolute top-4 right-4 flex flex-col gap-2 z-20">
                    <button onclick="if(window.resetView) window.resetView()" class="p-2 bg-white rounded shadow border border-slate-200 hover:bg-slate-50 text-slate-600 font-mono text-xs" title="Reset View">R</button>
                    <button onclick="if(window.zoomAction) window.zoomAction('in')" class="p-2 bg-white rounded shadow border border-slate-200 hover:bg-slate-50 text-slate-600 font-mono text-xs" title="Zoom In">+</button>
                    <button onclick="if(window.zoomAction) window.zoomAction('out')" class="p-2 bg-white rounded shadow border border-slate-200 hover:bg-slate-50 text-slate-600 font-mono text-xs" title="Zoom Out">-</button>
                </div>

                <!-- 4. Code Panel Overlay (Slide-in) -->
                <div id="code-panel-overlay" class="panel-hidden" onmousedown="event.stopPropagation();">
                    <!-- Header -->
                    <div class="flex justify-between items-center p-3 border-b border-slate-200 bg-slate-50 shrink-0">
                        <div class="flex gap-2">
                            <button id="btn-lang-csharp" class="px-2 py-1 text-xs rounded transition-colors text-slate-500 hover:bg-slate-100" onclick="setLang('csharp')">C#</button>
                            <button id="btn-lang-python" class="px-2 py-1 text-xs rounded transition-colors text-slate-500 hover:bg-slate-100" onclick="setLang('python')">Python</button>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="btn-type-simple" class="text-xs text-slate-500 hover:text-indigo-600 transition-colors" onclick="setType('simple')">Simple</button>
                            <button id="btn-type-detailed" class="text-xs text-slate-500 hover:text-indigo-600 transition-colors" onclick="setType('detailed')">Detailed</button>
                            <!-- Copy -->
                            <button id="btn-copy-code" class="ml-2 text-slate-500 hover:text-slate-800 transition-colors" onclick="copyCode()" title="Copy Code">
                                <svg id="icon-copy" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                                <svg id="icon-copy-done" class="hidden text-green-600" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                            </button>
                            <!-- Expand/Collapse -->
                            <button id="btn-panel-expand" class="text-slate-500 hover:text-slate-800 transition-colors" onclick="toggleExpand()" title="Toggle Width">
                                <svg id="icon-expand" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M15 3h6v6" /><path d="M9 21H3v-6" /><path d="M21 3l-7 7" /><path d="M3 21l7-7" />
                                </svg>
                                <svg id="icon-collapse" class="hidden" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 14h6v6" /><path d="M20 10h-6V4" /><path d="M14 10l7-7" /><path d="M10 14l-7 7" />
                                </svg>
                            </button>
                            <!-- Close -->
                            <button class="text-slate-500 hover:text-red-600 transition-colors" onclick="toggleCodePanel()" title="Close Panel">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <!-- Body -->
                    <div class="code-panel-body custom-scrollbar p-4">
                        <div id="code-csharp-simple" class="code-content hidden"><div class="highlight"><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">1</span><span class="k">using</span> System;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">2</span><span class="k">using</span> System.Collections.Generic;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">3</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">4</span><span class="k">namespace</span> TechnicalIndicators</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">5</span>{</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">6</span>    <span class="k">public</span> <span class="k">readonly</span> <span class="k">record</span> <span class="k">struct</span> CandleData(DateTime Timestamp, <span class="kt">decimal</span> Open, <span class="kt">decimal</span> High, <span class="kt">decimal</span> Low, <span class="kt">decimal</span> Close, <span class="kt">long</span> Volume);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">7</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">8</span>    <span class="c1">/// &lt;summary&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">9</span>    <span class="c1">/// Calculates Moving Average Convergence Divergence (MACD).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">10</span>    <span class="c1">/// &lt;/summary&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">11</span>    <span class="k">public</span> <span class="k">class</span> <span class="nc">MovingAverageConvergenceDivergence</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">12</span>    {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">13</span>        <span class="k">public</span> <span class="kt">int</span> ShortPeriod { <span class="k">get</span>; }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">14</span>        <span class="k">public</span> <span class="kt">int</span> LongPeriod { <span class="k">get</span>; }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">15</span>        <span class="k">public</span> <span class="kt">int</span> SignalPeriod { <span class="k">get</span>; }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">16</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">17</span>        <span class="k">public</span> List&lt;<span class="kt">decimal?</span>&gt; MacdLine { <span class="k">get</span>; } = <span class="k">new</span>();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">18</span>        <span class="k">public</span> List&lt;<span class="kt">decimal?</span>&gt; SignalLine { <span class="k">get</span>; } = <span class="k">new</span>();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">19</span>        <span class="k">public</span> List&lt;<span class="kt">decimal?</span>&gt; Histogram { <span class="k">get</span>; } = <span class="k">new</span>();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">20</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">21</span>        <span class="k">public</span> MovingAverageConvergenceDivergence(<span class="kt">int</span> shortPeriod = 12, <span class="kt">int</span> longPeriod = 26, <span class="kt">int</span> signalPeriod = 9)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">22</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">23</span>            <span class="k">if</span> (shortPeriod &lt;= 0 || longPeriod &lt;= 0 || signalPeriod &lt;= 0)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">24</span>                <span class="k">throw</span> <span class="k">new</span> ArgumentOutOfRangeException(<span class="s">&quot;Periods must be greater than 0&quot;</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">25</span>            <span class="k">if</span> (shortPeriod &gt;= longPeriod)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">26</span>                <span class="k">throw</span> <span class="k">new</span> ArgumentException(<span class="s">&quot;ShortPeriod must be less than LongPeriod&quot;</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">27</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">28</span>            ShortPeriod = shortPeriod;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">29</span>            LongPeriod = longPeriod;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">30</span>            SignalPeriod = signalPeriod;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">31</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">32</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">33</span>        <span class="k">public</span> <span class="k">void</span> Calculate(IEnumerable&lt;CandleData&gt; candles)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">34</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">35</span>            MacdLine.Clear();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">36</span>            SignalLine.Clear();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">37</span>            Histogram.Clear();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">38</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">39</span>            <span class="kt">var</span> candleList = <span class="k">new</span> List&lt;CandleData&gt;(candles);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">40</span>            <span class="k">if</span> (candleList.Count == 0) <span class="k">return</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">41</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">42</span>            <span class="c1">// Rationale: MACD is composed of EMAs. We verify using the helper method.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">43</span>            <span class="c1">// 1. Calculate Fast EMA (e.g. 12)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">44</span>            <span class="kt">var</span> shortEma = CalculateEma(candleList, ShortPeriod);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">45</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">46</span>            <span class="c1">// 2. Calculate Slow EMA (e.g. 26)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">47</span>            <span class="kt">var</span> longEma = CalculateEma(candleList, LongPeriod);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">48</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">49</span>            <span class="c1">// 3. Calculate MACD Line (Fast - Slow)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">50</span>            <span class="k">for</span> (<span class="kt">int</span> i = 0; i &lt; candleList.Count; i++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">51</span>            {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">52</span>                <span class="k">if</span> (i &lt; shortEma.Count &amp;&amp; i &lt; longEma.Count &amp;&amp;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">53</span>                    shortEma[i].HasValue &amp;&amp; longEma[i].HasValue)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">54</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">55</span>                    MacdLine.Add(shortEma[i]!.Value - longEma[i]!.Value);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">56</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">57</span>                <span class="k">else</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">58</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">59</span>                    MacdLine.Add(<span class="k">null</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">60</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">61</span>            }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">62</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">63</span>            <span class="c1">// 4. Calculate Signal Line (EMA of MACD Line)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">64</span>            <span class="c1">// Note: Reuse EMA logic but on &#x27;Values&#x27; (MACD) instead of &#x27;Candles&#x27; (Close).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">65</span>            CalculateEmaFromValues(MacdLine, SignalPeriod, SignalLine);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">66</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">67</span>            <span class="c1">// 5. Calculate Histogram (MACD - Signal)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">68</span>            <span class="k">for</span> (<span class="kt">int</span> i = 0; i &lt; MacdLine.Count; i++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">69</span>            {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">70</span>                <span class="k">if</span> (MacdLine[i].HasValue &amp;&amp; i &lt; SignalLine.Count &amp;&amp; SignalLine[i].HasValue)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">71</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">72</span>                    Histogram.Add(MacdLine[i]!.Value - SignalLine[i]!.Value);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">73</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">74</span>                <span class="k">else</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">75</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">76</span>                    Histogram.Add(<span class="k">null</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">77</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">78</span>            }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">79</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">80</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">81</span>        <span class="c1">// Rationale: Internal EMA helper for standard Close price series.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">82</span>        <span class="k">private</span> <span class="k">static</span> List&lt;<span class="kt">decimal?</span>&gt; CalculateEma(List&lt;CandleData&gt; candles, <span class="kt">int</span> period)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">83</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">84</span>            <span class="c1">// Reuse ExponentialMovingAverage logic or simplified version here</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">85</span>            <span class="k">return</span> ExponentialMovingAverage.Calculate(candles, period);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">86</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">87</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">88</span>        <span class="c1">// Rationale: Internal EMA helper for derived value series (MACD Line).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">89</span>        <span class="k">private</span> <span class="k">static</span> <span class="k">void</span> CalculateEmaFromValues(List&lt;<span class="kt">decimal?</span>&gt; source, <span class="kt">int</span> period, List&lt;<span class="kt">decimal?</span>&gt; results)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">90</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">91</span>            ExponentialMovingAverage.CalculateFromValues(source, period, results);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">92</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">93</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">94</span>        <span class="k">public</span> static (List&lt;<span class="kt">decimal?</span>&gt; macd, List&lt;<span class="kt">decimal?</span>&gt; signal, List&lt;<span class="kt">decimal?</span>&gt; histogram) Calculate(</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">95</span>            IEnumerable&lt;CandleData&gt; candles, <span class="kt">int</span> shortPeriod = 12, <span class="kt">int</span> longPeriod = 26, <span class="kt">int</span> signalPeriod = 9)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">96</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">97</span>            <span class="kt">var</span> macd = <span class="k">new</span> MovingAverageConvergenceDivergence(shortPeriod, longPeriod, signalPeriod);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">98</span>            macd.Calculate(candles);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">99</span>            <span class="k">return</span> (macd.MacdLine, macd.SignalLine, macd.Histogram);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">100</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">101</span>    }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">102</span>}</div></div></div>
                        <div id="code-csharp-detailed" class="code-content hidden"><div class="highlight"><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">1</span><span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">2</span><span class="c1">// Logic Breakdown (MovingAverageConvergenceDivergence - MACD)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">3</span><span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">4</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">5</span><span class="c1">// This document provides a &quot;Deep Dive&quot; into the internal logic of the</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">6</span><span class="c1">// MACD (Moving Average Convergence Divergence) technical indicator.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">7</span><span class="c1">// We explain *why* code is written this way and *how* data transforms</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">8</span><span class="c1">// line-by-line, targeting programming beginners.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">9</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">10</span><span class="c1">// [Core Concepts]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">11</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">12</span><span class="c1">// 1. What is MACD?</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">13</span><span class="c1">//    [Creator] Gerald Appel (1979)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">14</span><span class="c1">//    [Purpose] Shows the relationship between two EMAs to identify trends.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">15</span><span class="c1">//    [Why Popular?] All-in-one: Trend direction, strength, and momentum.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">16</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">17</span><span class="c1">// 2. The Three Components</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">18</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">19</span><span class="c1">//    | Component    | Formula                          | Default |</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">20</span><span class="c1">//    |--------------|----------------------------------|---------|</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">21</span><span class="c1">//    | MACD Line    | EMA(12) - EMA(26)                | -       |</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">22</span><span class="c1">//    | Signal Line  | EMA(MACD Line, 9)                | 9       |</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">23</span><span class="c1">//    | Histogram    | MACD Line - Signal Line          | -       |</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">24</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">25</span><span class="c1">// 3. Visual Understanding</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">26</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">27</span><span class="c1">//    [MACD Line Concept]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">28</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">29</span><span class="c1">//    Price:        ___/\___</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">30</span><span class="c1">//    Short EMA:    ___/\___     (Fast, follows price closely)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">31</span><span class="c1">//    Long EMA:     ____/\____       (Slow, lags behind)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">32</span><span class="c1">//    MACD Line:    The GAP between them (Short - Long)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">33</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">34</span><span class="c1">//    When Short &gt; Long: MACD is positive (bullish)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">35</span><span class="c1">//    When Short &lt; Long: MACD is negative (bearish)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">36</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">37</span><span class="c1">// 4. Signal Interpretation</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">38</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">39</span><span class="c1">//    | Signal               | Meaning                         |</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">40</span><span class="c1">//    |----------------------|---------------------------------|</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">41</span><span class="c1">//    | MACD crosses Signal | Buy signal (bullish crossover)  |</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">42</span><span class="c1">//    | MACD crosses Signal | Sell signal (bearish crossover) |</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">43</span><span class="c1">//    | Histogram growing    | Trend is strengthening          |</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">44</span><span class="c1">//    | Histogram shrinking  | Trend is weakening              |</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">45</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">46</span><span class="c1">// [Data Flow Diagram]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">47</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">48</span><span class="c1">//   CandleData[]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">49</span><span class="c1">//        </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">50</span><span class="c1">//        </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">51</span><span class="c1">//    Short EMA         Long EMA    </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">52</span><span class="c1">//    (period=12)       (period=26) </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">53</span><span class="c1">//        </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">54</span><span class="c1">//                             </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">55</span><span class="c1">//          </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">56</span><span class="c1">//                  </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">57</span><span class="c1">//            MACD Line = Short - Long</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">58</span><span class="c1">//                  </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">59</span><span class="c1">//          </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">60</span><span class="c1">//           Signal Line  </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">61</span><span class="c1">//           EMA(MACD, 9) </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">62</span><span class="c1">//          </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">63</span><span class="c1">//                 </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">64</span><span class="c1">//         Histogram = MACD - Signal</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">65</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">66</span><span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">67</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">68</span><span class="k">using</span> System;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">69</span><span class="k">using</span> System.Collections.Generic;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">70</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">71</span><span class="k">namespace</span> TechnicalIndicators</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">72</span>{</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">73</span>    <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">74</span>    <span class="c1">// Logic Explanation: OHLCV Data Container</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">75</span>    <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">76</span>    <span class="k">public</span> <span class="k">readonly</span> <span class="k">record</span> <span class="k">struct</span> CandleData(</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">77</span>        DateTime Timestamp,</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">78</span>        <span class="kt">decimal</span> Open,</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">79</span>        <span class="kt">decimal</span> High,</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">80</span>        <span class="kt">decimal</span> Low,</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">81</span>        <span class="kt">decimal</span> Close,</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">82</span>        <span class="kt">long</span> Volume</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">83</span>    );</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">84</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">85</span>    <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">86</span>    <span class="c1">// Logic Explanation: MACD Class</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">87</span>    <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">88</span>    <span class="k">public</span> <span class="k">class</span> <span class="nc">MovingAverageConvergenceDivergence</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">89</span>    {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">90</span>        <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">91</span>        <span class="c1">// Logic Explanation: Configuration</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">92</span>        <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">93</span>        <span class="c1">// [Default Values] 12, 26, 9 were chosen by Gerald Appel.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">94</span>        <span class="c1">//   12 = ~2 weeks, 26 = ~1 month, 9 = Signal smoothing</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">95</span>        <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">96</span>        <span class="k">public</span> <span class="kt">int</span> ShortPeriod { <span class="k">get</span>; }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">97</span>        <span class="k">public</span> <span class="kt">int</span> LongPeriod { <span class="k">get</span>; }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">98</span>        <span class="k">public</span> <span class="kt">int</span> SignalPeriod { <span class="k">get</span>; }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">99</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">100</span>        <span class="c1">// Three output lists</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">101</span>        <span class="k">public</span> List&lt;<span class="kt">decimal?</span>&gt; MacdLine { <span class="k">get</span>; } = <span class="k">new</span>();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">102</span>        <span class="k">public</span> List&lt;<span class="kt">decimal?</span>&gt; SignalLine { <span class="k">get</span>; } = <span class="k">new</span>();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">103</span>        <span class="k">public</span> List&lt;<span class="kt">decimal?</span>&gt; Histogram { <span class="k">get</span>; } = <span class="k">new</span>();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">104</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">105</span>        <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">106</span>        <span class="c1">// Logic Explanation: Constructor</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">107</span>        <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">108</span>        <span class="k">public</span> MovingAverageConvergenceDivergence(<span class="kt">int</span> shortPeriod = 12, <span class="kt">int</span> longPeriod = 26, <span class="kt">int</span> signalPeriod = 9)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">109</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">110</span>            <span class="c1">// [Validation] All periods must be positive</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">111</span>            <span class="k">if</span> (shortPeriod &lt;= 0)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">112</span>                <span class="k">throw</span> <span class="k">new</span> ArgumentOutOfRangeException(<span class="k">nameof</span>(shortPeriod), <span class="s">&quot;ShortPeriod must be greater than 0&quot;</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">113</span>            <span class="k">if</span> (longPeriod &lt;= 0)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">114</span>                <span class="k">throw</span> <span class="k">new</span> ArgumentOutOfRangeException(<span class="k">nameof</span>(longPeriod), <span class="s">&quot;LongPeriod must be greater than 0&quot;</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">115</span>            <span class="k">if</span> (signalPeriod &lt;= 0)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">116</span>                <span class="k">throw</span> <span class="k">new</span> ArgumentOutOfRangeException(<span class="k">nameof</span>(signalPeriod), <span class="s">&quot;SignalPeriod must be greater than 0&quot;</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">117</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">118</span>            <span class="c1">// [Logical Constraint] Short must be less than Long</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">119</span>            <span class="c1">// Otherwise the concept doesn&#x27;t make sense.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">120</span>            <span class="k">if</span> (shortPeriod &gt;= longPeriod)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">121</span>                <span class="k">throw</span> <span class="k">new</span> ArgumentException(<span class="s">&quot;ShortPeriod must be less than LongPeriod&quot;</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">122</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">123</span>            ShortPeriod = shortPeriod;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">124</span>            LongPeriod = longPeriod;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">125</span>            SignalPeriod = signalPeriod;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">126</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">127</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">128</span>        <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">129</span>        <span class="c1">// Logic Explanation: Main Calculation Method</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">130</span>        <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">131</span>        <span class="k">public</span> <span class="k">void</span> Calculate(IEnumerable&lt;CandleData&gt; candles)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">132</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">133</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">134</span>            <span class="c1">// Step 1: Cleanup</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">135</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">136</span>            MacdLine.Clear();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">137</span>            SignalLine.Clear();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">138</span>            Histogram.Clear();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">139</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">140</span>            <span class="kt">var</span> candleList = <span class="k">new</span> List&lt;CandleData&gt;(candles);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">141</span>            <span class="k">if</span> (candleList.Count == 0) <span class="k">return</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">142</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">143</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">144</span>            <span class="c1">// Step 2: Calculate Short and Long EMAs</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">145</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">146</span>            <span class="kt">var</span> shortEma = CalculateEma(candleList, ShortPeriod);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">147</span>            <span class="kt">var</span> longEma = CalculateEma(candleList, LongPeriod);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">148</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">149</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">150</span>            <span class="c1">// Step 3: Calculate MACD Line</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">151</span>            <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">152</span>            <span class="c1">// [Formula] MACD = Short EMA - Long EMA</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">153</span>            <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">154</span>            <span class="c1">// [Null Handling] Both EMAs must be valid to calculate MACD.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">155</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">156</span>            <span class="k">for</span> (<span class="kt">int</span> i = 0; i &lt; candleList.Count; i++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">157</span>            {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">158</span>                <span class="k">if</span> (i &lt; shortEma.Count &amp;&amp; i &lt; longEma.Count &amp;&amp;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">159</span>                    shortEma[i].HasValue &amp;&amp; longEma[i].HasValue)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">160</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">161</span>                    MacdLine.Add(shortEma[i]!.Value - longEma[i]!.Value);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">162</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">163</span>                <span class="k">else</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">164</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">165</span>                    MacdLine.Add(<span class="k">null</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">166</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">167</span>            }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">168</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">169</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">170</span>            <span class="c1">// Step 4: Calculate Signal Line (EMA of MACD Line)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">171</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">172</span>            CalculateEmaFromValues(MacdLine, SignalPeriod, SignalLine);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">173</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">174</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">175</span>            <span class="c1">// Step 5: Calculate Histogram</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">176</span>            <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">177</span>            <span class="c1">// [Formula] Histogram = MACD Line - Signal Line</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">178</span>            <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">179</span>            <span class="c1">// [Visual: Histogram Interpretation]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">180</span>            <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">181</span>            <span class="c1">//   Histogram:        (MACD &gt; Signal = Bullish)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">182</span>            <span class="c1">//              </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">183</span>            <span class="c1">//              </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">184</span>            <span class="c1">//      Zero</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">185</span>            <span class="c1">//                  </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">186</span>            <span class="c1">//                     (MACD &lt; Signal = Bearish)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">187</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">188</span>            <span class="k">for</span> (<span class="kt">int</span> i = 0; i &lt; MacdLine.Count; i++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">189</span>            {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">190</span>                <span class="k">if</span> (MacdLine[i].HasValue &amp;&amp; i &lt; SignalLine.Count &amp;&amp; SignalLine[i].HasValue)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">191</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">192</span>                    Histogram.Add(MacdLine[i]!.Value - SignalLine[i]!.Value);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">193</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">194</span>                <span class="k">else</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">195</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">196</span>                    Histogram.Add(<span class="k">null</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">197</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">198</span>            }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">199</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">200</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">201</span>        <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">202</span>        <span class="c1">// Helper Method: CalculateEma (from Candle Data)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">203</span>        <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">204</span>        <span class="c1">// [IPO Block]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">205</span>        <span class="c1">// Input:   List&lt;CandleData&gt; candles, int period</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">206</span>        <span class="c1">// Process: Standard EMA calculation on Close prices</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">207</span>        <span class="c1">// Output:  List&lt;decimal?&gt; of EMA values</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">208</span>        <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">209</span>        <span class="c1">// [EMA Formula]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">210</span>        <span class="c1">//   k = 2 / (period + 1)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">211</span>        <span class="c1">//   EMA = (Price - PrevEMA)  k + PrevEMA</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">212</span>        <span class="c1">//   First EMA = SMA of first &#x27;period&#x27; closes</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">213</span>        <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">214</span>        <span class="k">private</span> <span class="k">static</span> List&lt;<span class="kt">decimal?</span>&gt; CalculateEma(List&lt;CandleData&gt; candles, <span class="kt">int</span> period)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">215</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">216</span>            <span class="kt">var</span> results = <span class="k">new</span> List&lt;<span class="kt">decimal?</span>&gt;();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">217</span>            <span class="k">if</span> (candles.Count == 0 || period &lt;= 0) <span class="k">return</span> results;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">218</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">219</span>            <span class="kt">decimal</span> k = 2.0m / (period + 1);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">220</span>            <span class="kt">decimal?</span> prevEma = <span class="k">null</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">221</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">222</span>            <span class="k">for</span> (<span class="kt">int</span> i = 0; i &lt; candles.Count; i++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">223</span>            {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">224</span>                <span class="c1">// [Phase A] Warmup period</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">225</span>                <span class="k">if</span> (i &lt; period - 1)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">226</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">227</span>                    results.Add(<span class="k">null</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">228</span>                    <span class="k">continue</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">229</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">230</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">231</span>                <span class="c1">// [Phase B] Bootstrap with SMA</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">232</span>                <span class="k">if</span> (i == period - 1)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">233</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">234</span>                    <span class="kt">decimal</span> sum = 0;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">235</span>                    <span class="k">for</span> (<span class="kt">int</span> j = 0; j &lt; period; j++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">236</span>                        sum += candles[i - j].Close;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">237</span>                    </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">238</span>                    prevEma = sum / period;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">239</span>                    results.Add(prevEma);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">240</span>                    <span class="k">continue</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">241</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">242</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">243</span>                <span class="c1">// [Phase C] Recursive EMA</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">244</span>                <span class="k">if</span> (prevEma != <span class="k">null</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">245</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">246</span>                    <span class="kt">decimal</span> ema = (candles[i].Close - prevEma.Value) * k + prevEma.Value;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">247</span>                    results.Add(ema);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">248</span>                    prevEma = ema;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">249</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">250</span>                <span class="k">else</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">251</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">252</span>                    results.Add(<span class="k">null</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">253</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">254</span>            }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">255</span>            <span class="k">return</span> results;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">256</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">257</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">258</span>        <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">259</span>        <span class="c1">// Helper Method: CalculateEmaFromValues (from decimal? list)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">260</span>        <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">261</span>        <span class="c1">// [IPO Block]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">262</span>        <span class="c1">// Input:   List&lt;decimal?&gt; source, int period, List&lt;decimal?&gt; results (output)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">263</span>        <span class="c1">// Process: EMA calculation that handles nulls in source</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">264</span>        <span class="c1">// Output:  void (populates &#x27;results&#x27; list)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">265</span>        <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">266</span>        <span class="c1">// [Why Reference Parameter?]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">267</span>        <span class="c1">//   Allows caller to pass the output list to be populated.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">268</span>        <span class="c1">//   Avoids creating a new list internally.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">269</span>        <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">270</span>        <span class="c1">// [Null Handling]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">271</span>        <span class="c1">//   Counts only valid (non-null) values for warmup.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">272</span>        <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">273</span>        <span class="k">private</span> <span class="k">static</span> <span class="k">void</span> CalculateEmaFromValues(List&lt;<span class="kt">decimal?</span>&gt; source, <span class="kt">int</span> period, List&lt;<span class="kt">decimal?</span>&gt; results)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">274</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">275</span>            results.Clear();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">276</span>            <span class="k">if</span> (source.Count == 0 || period &lt;= 0) <span class="k">return</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">277</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">278</span>            <span class="kt">decimal</span> k = 2.0m / (period + 1);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">279</span>            <span class="kt">decimal?</span> prevEma = <span class="k">null</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">280</span>            <span class="kt">int</span> validCount = 0;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">281</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">282</span>            <span class="k">for</span> (<span class="kt">int</span> i = 0; i &lt; source.Count; i++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">283</span>            {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">284</span>                <span class="c1">// Skip nulls in source</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">285</span>                <span class="k">if</span> (!source[i].HasValue)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">286</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">287</span>                    results.Add(<span class="k">null</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">288</span>                    <span class="k">continue</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">289</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">290</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">291</span>                validCount++;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">292</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">293</span>                <span class="c1">// Not enough valid values yet</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">294</span>                <span class="k">if</span> (validCount &lt; period)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">295</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">296</span>                    results.Add(<span class="k">null</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">297</span>                    <span class="k">continue</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">298</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">299</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">300</span>                <span class="c1">// Bootstrap with SMA of last &#x27;period&#x27; valid values</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">301</span>                <span class="k">if</span> (validCount == period)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">302</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">303</span>                    <span class="kt">decimal</span> sum = 0;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">304</span>                    <span class="kt">int</span> count = 0;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">305</span>                    <span class="k">for</span> (<span class="kt">int</span> j = i; j &gt;= 0 &amp;&amp; count &lt; period; j--)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">306</span>                    {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">307</span>                        <span class="k">if</span> (source[j].HasValue)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">308</span>                        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">309</span>                            sum += source[j]!.Value;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">310</span>                            count++;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">311</span>                        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">312</span>                    }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">313</span>                    prevEma = count &gt; 0 ? sum / count : <span class="k">null</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">314</span>                    results.Add(prevEma);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">315</span>                    <span class="k">continue</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">316</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">317</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">318</span>                <span class="c1">// Recursive EMA</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">319</span>                <span class="k">if</span> (prevEma.HasValue)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">320</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">321</span>                    <span class="kt">decimal</span> ema = (source[i]!.Value - prevEma.Value) * k + prevEma.Value;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">322</span>                    results.Add(ema);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">323</span>                    prevEma = ema;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">324</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">325</span>                <span class="k">else</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">326</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">327</span>                    results.Add(<span class="k">null</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">328</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">329</span>            }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">330</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">331</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">332</span>        <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">333</span>        <span class="c1">// Logic Explanation: Static Convenience Wrapper</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">334</span>        <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">335</span>        <span class="c1">// [IPO Block]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">336</span>        <span class="c1">// Input:   IEnumerable&lt;CandleData&gt;, period parameters</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">337</span>        <span class="c1">// Process: Creates instance, runs Calculate()</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">338</span>        <span class="c1">// Output:  Tuple of (MACD Line, Signal Line, Histogram)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">339</span>        <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">340</span>        <span class="k">public</span> static (List&lt;<span class="kt">decimal?</span>&gt; macd, List&lt;<span class="kt">decimal?</span>&gt; signal, List&lt;<span class="kt">decimal?</span>&gt; histogram) Calculate(</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">341</span>            IEnumerable&lt;CandleData&gt; candles, <span class="kt">int</span> shortPeriod = 12, <span class="kt">int</span> longPeriod = 26, <span class="kt">int</span> signalPeriod = 9)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">342</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">343</span>            <span class="kt">var</span> macd = <span class="k">new</span> MovingAverageConvergenceDivergence(shortPeriod, longPeriod, signalPeriod);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">344</span>            macd.Calculate(candles);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">345</span>            <span class="k">return</span> (macd.MacdLine, macd.SignalLine, macd.Histogram);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">346</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">347</span>    }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">348</span>}</div></div></div>
                        <div id="code-python-simple" class="code-content hidden"><div class="highlight"><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">1</span><span class="kn">import</span> collections</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">2</span><span class="kn">from</span> .ExponentialMovingAverage <span class="kn">import</span> ExponentialMovingAverage, calculate <span class="k">as</span> calc_ema</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">3</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">4</span><span class="k">class</span> <span class="nc">MovingAverageConvergenceDivergence</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">5</span>    <span class="sd">&quot;&quot;&quot;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">6</span><span class="sd">    Calculates MACD. Requires ExponentialMovingAverage to be implemented/imported.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">7</span><span class="sd">    &quot;&quot;&quot;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">8</span>    <span class="k">def</span> __init__(self, short_period=12, long_period=26, signal_period=9):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">9</span>        <span class="k">if</span> short_period &lt;= 0:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">10</span>            <span class="k">raise</span> ValueError(<span class="s2">&quot;</span><span class="s2">short_period</span><span class="s2">&quot;</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">11</span>        <span class="k">if</span> long_period &lt;= 0:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">12</span>            <span class="k">raise</span> ValueError(<span class="s2">&quot;</span><span class="s2">long_period</span><span class="s2">&quot;</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">13</span>        <span class="k">if</span> signal_period &lt;= 0:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">14</span>            <span class="k">raise</span> ValueError(<span class="s2">&quot;</span><span class="s2">signal_period</span><span class="s2">&quot;</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">15</span>        <span class="k">if</span> short_period &gt;= long_period:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">16</span>            <span class="k">raise</span> ValueError(<span class="s2">&quot;</span><span class="s2">short_period must be less than long_period</span><span class="s2">&quot;</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">17</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">18</span>        self.short_period = short_period</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">19</span>        self.long_period = long_period</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">20</span>        self.signal_period = signal_period</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">21</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">22</span>        self.macd_line = []</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">23</span>        self.signal_line = []</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">24</span>        self.histogram = []</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">25</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">26</span>    <span class="k">def</span> calculate(self, candles):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">27</span>        self.macd_line.clear()</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">28</span>        self.signal_line.clear()</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">29</span>        self.histogram.clear()</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">30</span>        <span class="k">if</span> len(candles) == 0:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">31</span>            <span class="k">return</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">32</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">33</span>        <span class="c1"># Rationale: Delegate EMA logic to reuse existing verified code.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">34</span>        short_ema = self._calc_ema(candles, self.short_period)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">35</span>        long_ema = self._calc_ema(candles, self.long_period)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">36</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">37</span>        <span class="c1"># Rationale: Calculate MACD (Fast - Slow)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">38</span>        <span class="k">for</span> i <span class="ow">in</span> range(len(candles)):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">39</span>            <span class="k">if</span> i &lt; len(short_ema) <span class="ow">and</span> i &lt; len(long_ema) <span class="ow">and</span> short_ema[i] <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> long_ema[i] <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">40</span>                self.macd_line.append(short_ema[i] - long_ema[i])</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">41</span>            <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">42</span>                self.macd_line.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">43</span>                </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">44</span>        <span class="c1"># Rationale: Calculate Signal (EMA of MACD)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">45</span>        self._calc_ema_from_values(self.macd_line, self.signal_period, self.signal_line)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">46</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">47</span>        <span class="c1"># Rationale: Calculate Histogram (MACD - Signal)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">48</span>        <span class="k">for</span> i <span class="ow">in</span> range(len(self.macd_line)):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">49</span>            <span class="k">if</span> self.macd_line[i] <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> i &lt; len(self.signal_line) <span class="ow">and</span> self.signal_line[i] <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">50</span>                self.histogram.append(self.macd_line[i] - self.signal_line[i])</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">51</span>            <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">52</span>                self.histogram.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">53</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">54</span>    <span class="k">def</span> _calc_ema(self, candles, period):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">55</span>        <span class="c1"># Internal helper calling standard EMA</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">56</span>        <span class="k">return</span> calc_ema(candles, period)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">57</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">58</span>    <span class="k">def</span> _calc_ema_from_values(self, source, period, results):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">59</span>        <span class="c1"># Logic matches C# CalculateEmaFromValues</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">60</span>        results.clear()</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">61</span>        <span class="k">if</span> len(source) == 0 <span class="ow">or</span> period &lt;= 0:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">62</span>            <span class="k">return</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">63</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">64</span>        k = 2.0 / (period + 1)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">65</span>        prev_ema = <span class="kc">None</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">66</span>        valid_count = 0</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">67</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">68</span>        <span class="k">for</span> i <span class="ow">in</span> range(len(source)):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">69</span>            <span class="k">if</span> source[i] <span class="ow">is</span> <span class="kc">None</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">70</span>                results.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">71</span>                <span class="k">continue</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">72</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">73</span>            valid_count += 1</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">74</span>            <span class="k">if</span> valid_count &lt; period:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">75</span>                results.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">76</span>                <span class="k">continue</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">77</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">78</span>            <span class="k">if</span> valid_count == period:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">79</span>                <span class="c1"># Seeding with SMA of valid values</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">80</span>                s = 0</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">81</span>                count = 0</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">82</span>                j = i</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">83</span>                <span class="c1"># Backtrack to find &#x27;period&#x27; valid numbers</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">84</span>                <span class="k">while</span> j &gt;= 0 <span class="ow">and</span> count &lt; period:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">85</span>                    <span class="k">if</span> source[j] <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">86</span>                        s += source[j]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">87</span>                        count += 1</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">88</span>                    j -= 1</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">89</span>                </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">90</span>                prev_ema = s / count <span class="k">if</span> count &gt; 0 <span class="k">else</span> <span class="kc">None</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">91</span>                results.append(prev_ema)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">92</span>                <span class="k">continue</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">93</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">94</span>            <span class="c1"># Recursive EMA</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">95</span>            <span class="k">if</span> prev_ema <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">96</span>                ema = (source[i] - prev_ema) * k + prev_ema</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">97</span>                results.append(ema)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">98</span>                prev_ema = ema</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">99</span>            <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">100</span>                results.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">101</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">102</span><span class="k">def</span> calculate(candles, short_period=12, long_period=26, signal_period=9):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">103</span>    <span class="sd">&quot;&quot;&quot; Static wrapper &quot;&quot;&quot;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">104</span>    macd = MovingAverageConvergenceDivergence(short_period, long_period, signal_period)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">105</span>    macd.calculate(candles)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">106</span>    <span class="k">return</span> macd.macd_line, macd.signal_line, macd.histogram</div></div></div>
                        <div id="code-python-detailed" class="code-content hidden"><div class="highlight"><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">1</span><span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">2</span><span class="c1"># Logic Breakdown (Moving Average Convergence Divergence)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">3</span><span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">4</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">5</span><span class="c1"># This document provides a &quot;Deep Dive&quot; into the internal logic of the</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">6</span><span class="c1"># MACD (Moving Average Convergence Divergence). We explain *why* code is</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">7</span><span class="c1"># written this way and *how* data transforms line-by-line, targeting </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">8</span><span class="c1"># programming beginners.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">9</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">10</span><span class="c1"># [Core Concepts]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">11</span><span class="c1"># 1. Convergence/Divergence</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">12</span><span class="c1">#    - Convergence: The Fast EMA moves towards the Slow EMA (momentum decreasing).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">13</span><span class="c1">#    - Divergence: The Fast EMA moves away from the Slow EMA (momentum increasing).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">14</span><span class="c1">#    - This relationship reveals the strength and direction of a trend.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">15</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">16</span><span class="c1"># 2. Three Component System</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">17</span><span class="c1">#    - MACD Line: The core metric (Fast EMA - Slow EMA).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">18</span><span class="c1">#    - Signal Line: A smoothed average of the MACD Line itself (EMA of MACD).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">19</span><span class="c1">#    - Histogram: The difference between MACD Line and Signal Line (Visualizes momentum).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">20</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">21</span><span class="c1"># 3. Standard Configuration</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">22</span><span class="c1">#    - Fast Period (12): Represents short-term price action.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">23</span><span class="c1">#    - Slow Period (26): Represents medium-term trend.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">24</span><span class="c1">#    - Signal Period (9): Smoothes the MACD line to generate buy/sell signals.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">25</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">26</span><span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">27</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">28</span><span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">29</span><span class="c1"># Type-Level Explanation: MovingAverageConvergenceDivergence (class)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">30</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">31</span><span class="c1"># [Why]  Encapsulates the complex state of three interacting series.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">32</span><span class="c1"># [What] A trend-following momentum indicator.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">33</span><span class="c1"># [Who]  Used by traders for Signal Line crossovers and Zero Line crossovers.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">34</span><span class="c1"># [Where] Stored in the &#x27;Indicators&#x27; namespace usually.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">35</span><span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">36</span><span class="k">class</span> <span class="nc">MovingAverageConvergenceDivergence</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">37</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">38</span>    <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">39</span>    <span class="c1"># Variable Definition: macd_line</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">40</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">41</span>    <span class="c1"># [Role]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">42</span>    <span class="c1"># Primary Output. Stores the difference between Short and Long EMAs.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">43</span>    <span class="c1"># Pattern: Oscillator that fluctuates above/below zero.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">44</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">45</span>    <span class="c1"># [Type Choice]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">46</span>    <span class="c1"># List[float] (nullable) because earlier values might be undefined (None).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">47</span>    <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">48</span>    <span class="c1"># macd_line = []</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">49</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">50</span>    <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">51</span>    <span class="c1"># Variable Definition: signal_line</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">52</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">53</span>    <span class="c1"># [Role]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">54</span>    <span class="c1"># Secondary Output. A moving average of the macd_line.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">55</span>    <span class="c1"># Acts as a &quot;trigger&quot; line for buy/sell signals.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">56</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">57</span>    <span class="c1"># [Type Choice]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">58</span>    <span class="c1"># List[float] (nullable).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">59</span>    <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">60</span>    <span class="c1"># signal_line = []</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">61</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">62</span>    <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">63</span>    <span class="c1"># Variable Definition: histogram</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">64</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">65</span>    <span class="c1"># [Role]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">66</span>    <span class="c1"># Tertiary Output. Represents the gap between MACD and Signal.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">67</span>    <span class="c1"># Positive = Bullish momentum. Negative = Bearish momentum.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">68</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">69</span>    <span class="c1"># [Type Choice]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">70</span>    <span class="c1"># List[float] (nullable).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">71</span>    <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">72</span>    <span class="c1"># histogram = []</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">73</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">74</span>    <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">75</span>    <span class="c1"># Constructor: __init__</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">76</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">77</span>    <span class="c1"># [Why]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">78</span>    <span class="c1"># To establish the indicator&#x27;s sensitivity (Short/Long periods)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">79</span>    <span class="c1"># and smoothing (Signal period) before processing data.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">80</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">81</span>    <span class="c1"># [Fail Fast]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">82</span>    <span class="c1"># We validate inputs immediately to prevent &quot;silent failures&quot;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">83</span>    <span class="c1"># or division-by-zero errors later in the calculation.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">84</span>    <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">85</span>    <span class="k">def</span> __init__(self, short_period=12, long_period=26, signal_period=9):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">86</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">87</span>        <span class="c1"># Logic Step 1: Input Validation</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">88</span>        <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">89</span>        <span class="c1"># [Decision]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">90</span>        <span class="c1"># Are the periods positive numbers?</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">91</span>        <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">92</span>        <span class="c1"># [True Branch]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">93</span>        <span class="c1"># Periods are valid. Continue.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">94</span>        <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">95</span>        <span class="c1"># [False Branch]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">96</span>        <span class="c1"># Raise ValueError. Negative periods make no mathematical sense.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">97</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">98</span>        <span class="k">if</span> short_period &lt;= 0 <span class="ow">or</span> long_period &lt;= 0 <span class="ow">or</span> signal_period &lt;= 0:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">99</span>            <span class="k">raise</span> ValueError(<span class="s2">&quot;</span><span class="s2">All periods must be positive.</span><span class="s2">&quot;</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">100</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">101</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">102</span>        <span class="c1"># Logic Step 2: Logical Consistency Check</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">103</span>        <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">104</span>        <span class="c1"># [Decision]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">105</span>        <span class="c1"># Is the Short Period actually shorter than or equal to Long Period?</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">106</span>        <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">107</span>        <span class="c1"># [True Branch]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">108</span>        <span class="c1"># Configuration is logical.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">109</span>        <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">110</span>        <span class="c1"># [False Branch]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">111</span>        <span class="c1"># Raise ValueError. Swapped periods would invert the indicator&#x27;s meaning.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">112</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">113</span>        <span class="k">if</span> short_period &gt;= long_period:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">114</span>            <span class="k">raise</span> ValueError(<span class="s2">&quot;</span><span class="s2">short_period must be less than long_period.</span><span class="s2">&quot;</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">115</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">116</span>        self.short_period = short_period</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">117</span>        self.long_period = long_period</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">118</span>        self.signal_period = signal_period</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">119</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">120</span>        <span class="c1"># Initialize output containers</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">121</span>        self.macd_line = []</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">122</span>        self.signal_line = []</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">123</span>        self.histogram = []</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">124</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">125</span>    <span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">126</span>    <span class="c1"># IPO: calculate</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">127</span>    <span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">128</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">129</span>    <span class="c1"># [Input]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">130</span>    <span class="c1"># - candles: List[dict] (Each dict contains &#x27;close&#x27; price)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">131</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">132</span>    <span class="c1"># [Process]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">133</span>    <span class="c1"># 1. Compute Short EMA (Fast Trend).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">134</span>    <span class="c1"># 2. Compute Long EMA (Slow Trend).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">135</span>    <span class="c1"># 3. Subtract Long from Short to get MACD Line.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">136</span>    <span class="c1"># 4. Compute EMA of *MACD Line* to get Signal Line.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">137</span>    <span class="c1"># 5. Subtract Signal from MACD to get Histogram.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">138</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">139</span>    <span class="c1"># [Output]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">140</span>    <span class="c1"># - None (Results are stored in instance variables).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">141</span>    <span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">142</span>    <span class="k">def</span> calculate(self, candles):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">143</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">144</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">145</span>        <span class="c1"># Logic Step 1: Reset State</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">146</span>        <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">147</span>        <span class="c1"># [Why]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">148</span>        <span class="c1"># Ensures clean state if the instance is reused for new data.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">149</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">150</span>        self.macd_line.clear()</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">151</span>        self.signal_line.clear()</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">152</span>        self.histogram.clear()</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">153</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">154</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">155</span>        <span class="c1"># Logic Step 2: Empty Data Check</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">156</span>        <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">157</span>        <span class="c1"># [Decision]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">158</span>        <span class="c1"># Do we have any data to process?</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">159</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">160</span>        <span class="k">if</span> len(candles) == 0:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">161</span>            <span class="k">return</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">162</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">163</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">164</span>        <span class="c1"># Logic Step 3: Calculate Component EMAs</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">165</span>        <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">166</span>        <span class="c1"># [Why]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">167</span>        <span class="c1"># MACD is a &quot;derivative&quot; indicator; it is derived from other indicators</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">168</span>        <span class="c1"># (EMAs), not directly from price alone.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">169</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">170</span>        short_ema = self._calc_ema(candles, self.short_period)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">171</span>        long_ema = self._calc_ema(candles, self.long_period)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">172</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">173</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">174</span>        <span class="c1"># Logic Step 4: Compute MACD Line (Loop)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">175</span>        <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">176</span>        <span class="c1"># [Action]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">177</span>        <span class="c1"># Subtract Slow Trend from Fast Trend.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">178</span>        <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">179</span>        <span class="c1"># [Visual]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">180</span>        <span class="c1"># i=0: Short=None, Long=None -&gt; MACD=None</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">181</span>        <span class="c1"># ...</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">182</span>        <span class="c1"># i=30: Short=105, Long=100 -&gt; MACD=5.0 (Bullish)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">183</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">184</span>        <span class="k">for</span> i <span class="ow">in</span> range(len(candles)):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">185</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">186</span>            <span class="c1"># [Decision] Are both EMAs available?</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">187</span>            <span class="c1"># We need both values to compute the difference.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">188</span>            <span class="k">if</span> (i &lt; len(short_ema) <span class="ow">and</span> i &lt; len(long_ema) <span class="ow">and</span> </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">189</span>                short_ema[i] <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> long_ema[i] <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">190</span>                </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">191</span>                <span class="c1"># Logic Step 4.1: Subtraction</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">192</span>                val = short_ema[i] - long_ema[i]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">193</span>                self.macd_line.append(val)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">194</span>            <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">195</span>                self.macd_line.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">196</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">197</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">198</span>        <span class="c1"># Logic Step 5: Compute Signal Line</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">199</span>        <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">200</span>        <span class="c1"># [How]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">201</span>        <span class="c1"># We recursively apply EMA logic to the *MACD Line* we just built.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">202</span>        <span class="c1"># Note: We use a specialized helper that accepts a list of numbers (values),</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">203</span>        <span class="c1"># not candles.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">204</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">205</span>        self._calc_ema_from_values(self.macd_line, self.signal_period, self.signal_line)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">206</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">207</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">208</span>        <span class="c1"># Logic Step 6: Compute Histogram (Loop)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">209</span>        <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">210</span>        <span class="c1"># [Action]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">211</span>        <span class="c1"># Subtract Signal Line from MACD Line.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">212</span>        <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">213</span>        <span class="c1"># [Visual]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">214</span>        <span class="c1"># MACD=5.0, Signal=4.0 -&gt; Hist=1.0 (Momentum Up)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">215</span>        <span class="c1"># MACD=4.0, Signal=4.5 -&gt; Hist=-0.5 (Momentum Down)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">216</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">217</span>        <span class="k">for</span> i <span class="ow">in</span> range(len(self.macd_line)):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">218</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">219</span>            <span class="c1"># [Decision] Do we have both components?</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">220</span>            <span class="k">if</span> (self.macd_line[i] <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">221</span>                i &lt; len(self.signal_line) <span class="ow">and</span> </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">222</span>                self.signal_line[i] <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">223</span>                </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">224</span>                <span class="c1"># Logic Step 6.1: Subtraction</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">225</span>                hist_val = self.macd_line[i] - self.signal_line[i]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">226</span>                self.histogram.append(hist_val)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">227</span>            <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">228</span>                self.histogram.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">229</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">230</span>    <span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">231</span>    <span class="c1"># IPO: _calc_ema (Private Helper)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">232</span>    <span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">233</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">234</span>    <span class="c1"># [Input]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">235</span>    <span class="c1"># - candles: List[dict] (Source data)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">236</span>    <span class="c1"># - period: int (Lookback)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">237</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">238</span>    <span class="c1"># [Process]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">239</span>    <span class="c1"># 1. Determine Weighting Multiplier &#x27;k&#x27;.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">240</span>    <span class="c1"># 2. Iterate through candles.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">241</span>    <span class="c1"># 3. For first valid point, use SMA as seed.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">242</span>    <span class="c1"># 4. For subsequent points, use EMA formula: (Price - Prev) * k + Prev.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">243</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">244</span>    <span class="c1"># [Output]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">245</span>    <span class="c1"># - List[float] (The EMA series)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">246</span>    <span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">247</span>    <span class="k">def</span> _calc_ema(self, candles, period):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">248</span>        results = []</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">249</span>        <span class="k">if</span> len(candles) == 0 <span class="ow">or</span> period &lt;= 0:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">250</span>            <span class="k">return</span> results</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">251</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">252</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">253</span>        <span class="c1"># Logic Step 1: Calculate Multiplier (Weight)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">254</span>        <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">255</span>        <span class="c1"># [Why]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">256</span>        <span class="c1"># Controls how much weight recent prices get.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">257</span>        <span class="c1"># k = 2 / (N + 1) is the standard EMA smoothing factor.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">258</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">259</span>        k = 2.0 / (period + 1)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">260</span>        prev_ema = <span class="kc">None</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">261</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">262</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">263</span>        <span class="c1"># Logic Step 2: Main Loop</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">264</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">265</span>        <span class="k">for</span> i <span class="ow">in</span> range(len(candles)):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">266</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">267</span>            <span class="c1"># Logic Step 2.1: Skip insufficient data</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">268</span>            <span class="k">if</span> i &lt; period - 1:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">269</span>                results.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">270</span>                <span class="k">continue</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">271</span>                </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">272</span>            <span class="c1"># Logic Step 2.2: Initial Seed (SMA)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">273</span>            <span class="c1"># EMA requires a starting value. We use the SMA of the first &#x27;period&#x27;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">274</span>            <span class="c1"># candles as the seed.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">275</span>            <span class="k">if</span> i == period - 1:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">276</span>                s = sum(candles[i - j][<span class="s1">&#x27;</span><span class="s1">close</span><span class="s1">&#x27;</span>] <span class="k">for</span> j <span class="ow">in</span> range(period))</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">277</span>                prev_ema = s / period</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">278</span>                results.append(prev_ema)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">279</span>                <span class="k">continue</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">280</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">281</span>            <span class="c1"># Logic Step 2.3: EMA Calculation</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">282</span>            <span class="c1"># [Visual]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">283</span>            <span class="c1"># PrevEMA=100, Price=110, k=0.1</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">284</span>            <span class="c1"># EMA = (110 - 100)*0.1 + 100 = 101.0</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">285</span>            <span class="k">if</span> prev_ema <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">286</span>                ema = (candles[i][<span class="s1">&#x27;</span><span class="s1">close</span><span class="s1">&#x27;</span>] - prev_ema) * k + prev_ema</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">287</span>                results.append(ema)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">288</span>                prev_ema = ema</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">289</span>            <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">290</span>                results.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">291</span>                </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">292</span>        <span class="k">return</span> results</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">293</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">294</span>    <span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">295</span>    <span class="c1"># IPO: _calc_ema_from_values (Private Helper)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">296</span>    <span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">297</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">298</span>    <span class="c1"># [Input]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">299</span>    <span class="c1"># - source: List[float] (The MACD Line values)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">300</span>    <span class="c1"># - period: int (Signal Period)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">301</span>    <span class="c1"># - results: List[float] (Output list to populate)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">302</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">303</span>    <span class="c1"># [Process]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">304</span>    <span class="c1"># Identical to _calc_ema but handles &#x27;None&#x27; values in the source list</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">305</span>    <span class="c1"># (since macd_line has leading Nones).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">306</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">307</span>    <span class="c1"># [Output]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">308</span>    <span class="c1"># - None (Modifies &#x27;results&#x27; in-place)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">309</span>    <span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">310</span>    <span class="k">def</span> _calc_ema_from_values(self, source, period, results):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">311</span>        results.clear()</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">312</span>        <span class="k">if</span> len(source) == 0 <span class="ow">or</span> period &lt;= 0:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">313</span>            <span class="k">return</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">314</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">315</span>        k = 2.0 / (period + 1)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">316</span>        prev_ema = <span class="kc">None</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">317</span>        valid_count = 0</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">318</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">319</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">320</span>        <span class="c1"># Logic Step 1: Sequential Processing</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">321</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">322</span>        <span class="k">for</span> i <span class="ow">in</span> range(len(source)):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">323</span>            val = source[i]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">324</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">325</span>            <span class="c1"># Case A: Source is missing</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">326</span>            <span class="k">if</span> val <span class="ow">is</span> <span class="kc">None</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">327</span>                results.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">328</span>                <span class="k">continue</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">329</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">330</span>            <span class="c1"># Case B: Accumulating valid data for Seed</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">331</span>            valid_count += 1</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">332</span>            <span class="k">if</span> valid_count &lt; period:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">333</span>                results.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">334</span>                <span class="k">continue</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">335</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">336</span>            <span class="c1"># Case C: Create Seed (SMA)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">337</span>            <span class="k">if</span> valid_count == period:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">338</span>                <span class="c1"># Calculate SMA of the first &#x27;period&#x27; valid numbers</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">339</span>                <span class="c1"># We backtrack to find them.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">340</span>                s = 0</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">341</span>                count = 0</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">342</span>                j = i</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">343</span>                <span class="k">while</span> j &gt;= 0 <span class="ow">and</span> count &lt; period:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">344</span>                    <span class="k">if</span> source[j] <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">345</span>                        s += source[j]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">346</span>                        count += 1</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">347</span>                    j -= 1</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">348</span>                </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">349</span>                prev_ema = s / count <span class="k">if</span> count &gt; 0 <span class="k">else</span> <span class="kc">None</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">350</span>                results.append(prev_ema)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">351</span>                <span class="k">continue</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">352</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">353</span>            <span class="c1"># Case D: Calculate EMA</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">354</span>            <span class="k">if</span> prev_ema <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">355</span>                ema = (val - prev_ema) * k + prev_ema</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">356</span>                results.append(ema)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">357</span>                prev_ema = ema</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">358</span>            <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">359</span>                results.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">360</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">361</span><span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">362</span><span class="c1"># Static Wrapper Function</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">363</span><span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">364</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">365</span><span class="c1"># [Why]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">366</span><span class="c1"># Provides a functional interface for users who don&#x27;t want to manage</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">367</span><span class="c1"># objects/state manually.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">368</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">369</span><span class="c1"># [Usage]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">370</span><span class="c1"># macd, signal, hist = calculate(candles)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">371</span><span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">372</span><span class="k">def</span> calculate(candles, short_period=12, long_period=26, signal_period=9):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">373</span>    <span class="c1"># 1. Instantiation</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">374</span>    <span class="c1">#    [Why: Setup state]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">375</span>    instance = MovingAverageConvergenceDivergence(short_period, long_period, signal_period)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">376</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">377</span>    <span class="c1"># 2. Execution</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">378</span>    <span class="c1">#    [Why: Process data]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">379</span>    instance.calculate(candles)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">380</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">381</span>    <span class="c1"># 3. Extraction</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">382</span>    <span class="c1">#    [Why: Return clean result tuples]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">383</span>    <span class="k">return</span> instance.macd_line, instance.signal_line, instance.histogram</div></div></div>
                    </div>
                </div>
            </figure>

            <!-- Legend (5-Step Model) -->
            <div class="logic-legend">
                <div class="legend-item"><span class="legend-dot l-ingestion"></span>Ingestion</div>
                <div class="legend-item"><span class="legend-dot l-evaluation"></span>Evaluation</div>
                <div class="legend-item"><span class="legend-dot l-weighting"></span>Weighting</div>
                <div class="legend-item"><span class="legend-dot l-synthesis"></span>Synthesis</div>
                <div class="legend-item"><span class="legend-dot l-outcome"></span>Outcome</div>
            </div>
        </section>

        <!-- ======================================================= -->
        <!-- BOTTOM SECTION: DOCS & TOC                              -->
        <!-- ======================================================= -->
        <section id="documentation" class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden scroll-mt-24">
            <!-- Documentation Header -->
            <div class="border-b border-orange-200 bg-orange-50 px-6 py-4">
                <h2 class="text-lg font-bold text-slate-900 flex items-center">
                    <span class="bg-indigo-600 text-white p-1 rounded mr-3 text-xs shadow-sm font-mono">D</span>
                    Technical Documentation
                </h2>
                <p class="text-slate-600 text-xs mt-1 ml-9">
                    Detailed technical explanation of the indicator's logic, math, and implementation details.
                </p>
            </div>
            <!-- Content Body -->
            <div class="p-6 flex flex-col lg:flex-row gap-12">
                <!-- Left: Article -->
                <article class="flex-1 min-w-0">
                    <div class="prose prose-slate max-w-none prose-headings:scroll-mt-24 prose-headings:font-bold prose-h2:text-2xl prose-h2:border-b prose-h2:pb-2 prose-h2:mt-8 prose-a:text-indigo-600 hover:prose-a:text-indigo-800">
                        <h1 id="moving-average-convergence-divergence-macd">Moving Average Convergence Divergence (MACD)</h1>

<p class="mb-4"><h2 class="text-2xl font-bold mt-12 mb-6 border-b pb-2">PART 1: MAIN GUIDE</h2></p>

<h2 id="1-identity">1. Identity</h2>

<p class="mb-4">Full Name: Moving Average Convergence Divergence  </p>
<p class="mb-4">Abbreviation: MACD  </p>
<p class="mb-4">Category: Momentum / Trend Following  </p>
<p class="mb-4">Creator: Gerald Appel (1979), Histogram by Thomas Aspray (1986)  </p>

<blockquote class="border-l-4 border-gray-300 pl-4 italic text-gray-700 my-4 bg-gray-50 py-2 pr-2 rounded-r">One-Sentence Definition: MACD transforms the relationship between two exponential moving averages into a momentum oscillator that reveals both trend direction and the acceleration of price movement.</blockquote>

<hr class="border-[#2a2e39] my-8">

<h2 id="2-calculation-logic">2. Calculation Logic</h2>

<h3 id="formula">Formula</h3>

<p class="mb-4">$$MACD_{Line} = EMA_{fast}(Price) - EMA_{slow}(Price)$$</p>

<p class="mb-4">$$Signal_{Line} = EMA_{signal}(MACD_{Line})$$</p>

<p class="mb-4">$$Histogram = MACD_{Line} - Signal_{Line}$$</p>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Step</td><td class="px-4 py-2 border-b border-[#2a2e39]">Formula</td><td class="px-4 py-2 border-b border-[#2a2e39]">Purpose</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">1</td><td class="px-4 py-2 border-b border-[#2a2e39]">$k = \frac{2}{period + 1}$</td><td class="px-4 py-2 border-b border-[#2a2e39]">EMA smoothing multiplier</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">2</td><td class="px-4 py-2 border-b border-[#2a2e39]">$EMA_{12} = (Close - EMA_{prev}) \times k_{12} + EMA_{prev}$</td><td class="px-4 py-2 border-b border-[#2a2e39]">Fast EMA (short-term trend)</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">3</td><td class="px-4 py-2 border-b border-[#2a2e39]">$EMA_{26} = (Close - EMA_{prev}) \times k_{26} + EMA_{prev}$</td><td class="px-4 py-2 border-b border-[#2a2e39]">Slow EMA (long-term trend)</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">4</td><td class="px-4 py-2 border-b border-[#2a2e39]">$MACD = EMA_{12} - EMA_{26}$</td><td class="px-4 py-2 border-b border-[#2a2e39]">Momentum line</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">5</td><td class="px-4 py-2 border-b border-[#2a2e39]">$Signal = EMA_9(MACD)$</td><td class="px-4 py-2 border-b border-[#2a2e39]">Trigger line</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">6</td><td class="px-4 py-2 border-b border-[#2a2e39]">$Histogram = MACD - Signal$</td><td class="px-4 py-2 border-b border-[#2a2e39]">Momentum acceleration</td></tr>
</table></div>

<h3 id="real-world-analogy">Real-World Analogy</h3>

<p class="mb-4">Think of MACD like a car's acceleration meter combined with its speedometer. The MACD line shows how fast you're "pulling away" from your average cruising speed (momentum). The Signal line shows the trend of that acceleration. The Histogram reveals whether you're pressing the gas harder (bars growing) or easing off (bars shrinking)even if you're still moving forward.</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="3-market-standards">3. Market Standards</h2>

<h3 id="default-parameters">Default Parameters</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Parameter</td><td class="px-4 py-2 border-b border-[#2a2e39]">Standard Value</td><td class="px-4 py-2 border-b border-[#2a2e39]">Rationale</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Fast EMA</td><td class="px-4 py-2 border-b border-[#2a2e39]">12</td><td class="px-4 py-2 border-b border-[#2a2e39]">Originally two trading weeks (6-day weeks in 1979)</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Slow EMA</td><td class="px-4 py-2 border-b border-[#2a2e39]">26</td><td class="px-4 py-2 border-b border-[#2a2e39]">Approximately one trading month</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Signal EMA</td><td class="px-4 py-2 border-b border-[#2a2e39]">9</td><td class="px-4 py-2 border-b border-[#2a2e39]">Smooths MACD for crossover signals</td></tr>
</table></div>

<h3 id="alternative-settings">Alternative Settings</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Trading Style</td><td class="px-4 py-2 border-b border-[#2a2e39]">Settings (Fast, Slow, Signal)</td><td class="px-4 py-2 border-b border-[#2a2e39]">Use Case</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Scalping</td><td class="px-4 py-2 border-b border-[#2a2e39]">(5, 35, 5)</td><td class="px-4 py-2 border-b border-[#2a2e39]">Higher sensitivity, more signals</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Swing Trading</td><td class="px-4 py-2 border-b border-[#2a2e39]">(12, 26, 9)</td><td class="px-4 py-2 border-b border-[#2a2e39]">Standard balanced approach</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Position Trading</td><td class="px-4 py-2 border-b border-[#2a2e39]">(19, 39, 9)</td><td class="px-4 py-2 border-b border-[#2a2e39]">Smoother, fewer false signals</td></tr>
</table></div>

<h3 id="timeframe-recommendations">Timeframe Recommendations</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Trading Style</td><td class="px-4 py-2 border-b border-[#2a2e39]">Timeframe</td><td class="px-4 py-2 border-b border-[#2a2e39]">Notes</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Day Trading</td><td class="px-4 py-2 border-b border-[#2a2e39]">5-min to 1-hour</td><td class="px-4 py-2 border-b border-[#2a2e39]">Use (5, 35, 5) for sensitivity</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Swing Trading</td><td class="px-4 py-2 border-b border-[#2a2e39]">Daily</td><td class="px-4 py-2 border-b border-[#2a2e39]">Standard (12, 26, 9) works best</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Position Trading</td><td class="px-4 py-2 border-b border-[#2a2e39]">Daily/Weekly</td><td class="px-4 py-2 border-b border-[#2a2e39]">Consider (19, 39, 9)</td></tr>
</table></div>

<hr class="border-[#2a2e39] my-8">

<h2 id="4-market-context">4. Market Context</h2>

<h3 id="best-conditions">Best Conditions</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Condition</td><td class="px-4 py-2 border-b border-[#2a2e39]">Why It Works</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Strong Trending Markets</td><td class="px-4 py-2 border-b border-[#2a2e39]">MACD excels at capturing sustained directional moves</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Post-Consolidation Breakouts</td><td class="px-4 py-2 border-b border-[#2a2e39]">Histogram expansion signals new trend birth</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Clear Bull/Bear Phases</td><td class="px-4 py-2 border-b border-[#2a2e39]">Crossovers provide reliable entry/exit timing</td></tr>
</table></div>

<h3 id="limitations">Limitations</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Condition</td><td class="px-4 py-2 border-b border-[#2a2e39]">Problem</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Sideways/Choppy Markets</td><td class="px-4 py-2 border-b border-[#2a2e39]">Generates whipsaw signals causing consecutive losses</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Fast V-Shaped Reversals</td><td class="px-4 py-2 border-b border-[#2a2e39]">Lagging nature misses first 10-15% of moves</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Low Volatility Periods</td><td class="px-4 py-2 border-b border-[#2a2e39]">Flat MACD produces meaningless crossovers</td></tr>
</table></div>

<h3 id="asset-class-suitability">Asset Class Suitability</h3>

<p class="mb-4">- Equities  Excellent for trending stocks and indices</p>
<p class="mb-4">- Forex  Works well on major pairs with clear trends</p>
<p class="mb-4">- Futures/Commodities  Strong performer in trending markets</p>
<p class="mb-4">- Crypto  Works but requires faster settings due to 24/7 volatility</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="5-entry-signals">5. Entry Signals</h2>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Signal Type</td><td class="px-4 py-2 border-b border-[#2a2e39]">Condition</td><td class="px-4 py-2 border-b border-[#2a2e39]">Direction</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strength</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Golden Cross</td><td class="px-4 py-2 border-b border-[#2a2e39]">MACD crosses above Signal Line</td><td class="px-4 py-2 border-b border-[#2a2e39]">Bullish</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strong</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Dead Cross</td><td class="px-4 py-2 border-b border-[#2a2e39]">MACD crosses below Signal Line</td><td class="px-4 py-2 border-b border-[#2a2e39]">Bearish</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strong</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Zero Line Bullish</td><td class="px-4 py-2 border-b border-[#2a2e39]">MACD crosses above Zero</td><td class="px-4 py-2 border-b border-[#2a2e39]">Bullish Confirmation</td><td class="px-4 py-2 border-b border-[#2a2e39]">Moderate</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Zero Line Bearish</td><td class="px-4 py-2 border-b border-[#2a2e39]">MACD crosses below Zero</td><td class="px-4 py-2 border-b border-[#2a2e39]">Bearish Confirmation</td><td class="px-4 py-2 border-b border-[#2a2e39]">Moderate</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Bullish Divergence</td><td class="px-4 py-2 border-b border-[#2a2e39]">Price Lower Low + MACD Higher Low</td><td class="px-4 py-2 border-b border-[#2a2e39]">Reversal Warning</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strong</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Bearish Divergence</td><td class="px-4 py-2 border-b border-[#2a2e39]">Price Higher High + MACD Lower High</td><td class="px-4 py-2 border-b border-[#2a2e39]">Reversal Warning</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strong</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Histogram Reversal</td><td class="px-4 py-2 border-b border-[#2a2e39]">Histogram bars shrinking after peak</td><td class="px-4 py-2 border-b border-[#2a2e39]">Early Exit Warning</td><td class="px-4 py-2 border-b border-[#2a2e39]">Moderate</td></tr>
</table></div>

<h3 id="primary-buy-signal">Primary Buy Signal</h3>

<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
IF MACD_Line crosses above Signal_Line
AND MACD_Line &lt; 0 (oversold territory)
AND Histogram &gt; Histogram[1] (momentum increasing)
THEN  BUY
</code></pre>

<h3 id="primary-sell/exit-signal">Primary Sell/Exit Signal</h3>

<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
IF MACD_Line crosses below Signal_Line
OR MACD_Line &gt; 0 AND Histogram &lt; Histogram[1] (momentum fading)
THEN  EXIT/SELL
</code></pre>

<hr class="border-[#2a2e39] my-8">

<h2 id="6-filter-usage">6. Filter Usage</h2>

<p class="mb-4">MACD works best as a trend confirmation tool rather than a standalone entry trigger. Use it to validate the direction before employing timing indicators.</p>

<h3 id="filter-rules">Filter Rules</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Rule</td><td class="px-4 py-2 border-b border-[#2a2e39]">Application</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]"><code>MACD > Signal</code></td><td class="px-4 py-2 border-b border-[#2a2e39]">Only take long entries from other indicators</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]"><code>MACD < Signal</code></td><td class="px-4 py-2 border-b border-[#2a2e39]">Only take short entries from other indicators</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]"><code>MACD > 0</code></td><td class="px-4 py-2 border-b border-[#2a2e39]">Market in bullish territory</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]"><code>Histogram expanding</code></td><td class="px-4 py-2 border-b border-[#2a2e39]">Momentum accelerating, safe to add positions</td></tr>
</table></div>

<h3 id="recommended-pairings">Recommended Pairings</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Partner Indicator</td><td class="px-4 py-2 border-b border-[#2a2e39]">Synergy Logic</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Stochastic Oscillator</td><td class="px-4 py-2 border-b border-[#2a2e39]">MACD defines trend; Stochastic times pullback entries</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">ADX</td><td class="px-4 py-2 border-b border-[#2a2e39]">Filter MACD signals: only trade when ADX > 25</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">RSI</td><td class="px-4 py-2 border-b border-[#2a2e39]">Confirm divergences with RSI divergence</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Bollinger Bands</td><td class="px-4 py-2 border-b border-[#2a2e39]">MACD for direction; Bands for volatility context</td></tr>
</table></div>

<h3 id="example-combined-strategy">Example Combined Strategy</h3>

<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
ENTRY CONDITIONS:
&nbsp;&nbsp;MACD_Line &gt; Signal_Line               // Bullish trend active
&nbsp;&nbsp;MACD_Line &lt; 0                         // Still in oversold zone
&nbsp;&nbsp;Stochastic drops below 20             // Pullback occurring
&nbsp;&nbsp;Stochastic crosses above 20           // Pullback ending

ACTION: BUY on the pullback within a confirmed uptrend
</code></pre>

<hr class="border-[#2a2e39] my-8">

<h2 id="7-practical-cautions">7. Practical Cautions</h2>

<h3 id="lag-characteristics">Lag Characteristics</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Component</td><td class="px-4 py-2 border-b border-[#2a2e39]">Approximate Lag</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">First Valid MACD</td><td class="px-4 py-2 border-b border-[#2a2e39]">~26 bars (Slow Period)</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">First Valid Signal</td><td class="px-4 py-2 border-b border-[#2a2e39]">~35 bars (26 + 9)</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">First Valid Histogram</td><td class="px-4 py-2 border-b border-[#2a2e39]">~35 bars</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Signal Responsiveness</td><td class="px-4 py-2 border-b border-[#2a2e39]">3-8 bars after trend begins</td></tr>
</table></div>

<blockquote class="border-l-4 border-gray-300 pl-4 italic text-gray-700 my-4 bg-gray-50 py-2 pr-2 rounded-r">Reality Check: MACD is a lagging indicator by design. By the time you get a Golden Cross, price has already moved. Use the Histogram for earlier signals.</blockquote>

<h3 id="false-signal-scenarios">False Signal Scenarios</h3>

<p class="mb-4">1. Whipsaws in Ranging Markets  </p>
<p class="mb-4">   Multiple crossovers in sideways action destroy capital. Filter with ADX > 25.</p>

<p class="mb-4">2. The "Hollow Rally" Trap  </p>
<p class="mb-4">   Price rises but Histogram shrinksmomentum is fading despite bullish crossover.</p>

<p class="mb-4">3. Zero Line Hesitation  </p>
<p class="mb-4">   MACD hovers around zero creating multiple false signals. Wait for decisive movement.</p>

<h3 id="mitigation-strategies">Mitigation Strategies</h3>

<p class="mb-4">- ADX Filter: Only trade MACD signals when ADX > 25</p>
<p class="mb-4">- Zero Line Bias: Buy signals stronger below zero; sell signals stronger above</p>
<p class="mb-4">- Histogram Confirmation: Wait for 2-3 bars of histogram expansion before entry</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="8-pro-insights">8. Pro Insights</h2>

<h3 id="the-histogram-slingshot">The Histogram Slingshot</h3>

<p class="mb-4">Most traders focus on line crossovers, but professionals watch the Histogram. When the Histogram makes a peak and starts decliningeven while MACD is still above Signalthe "energy" is dissipating. This often precedes the actual crossover by 2-5 bars, giving you an early exit signal.</p>

<h3 id="the-zero-line-rejection">The Zero Line Rejection</h3>

<p class="mb-4">In strong trends, watch for MACD to pull back toward the zero line but bounce off rather than cross. This "Zero Line Rejection" is a high-probability continuation signal. The trend was strong enough to bring momentum back to neutral but not reverse it.</p>

<h3 id="divergence-hierarchy">Divergence Hierarchy</h3>

<p class="mb-4">Not all divergences are equal:</p>
<p class="mb-4">1. Hidden Divergence (trend continuation): Price makes higher low but MACD makes lower low  trend resumption</p>
<p class="mb-4">2. Regular Divergence (reversal): Price makes lower low but MACD makes higher low  potential reversal</p>
<p class="mb-4">3. Triple Divergence: Three divergent swings dramatically increase reversal probability</p>

<h3 id="multi-timeframe-confirmation">Multi-Timeframe Confirmation</h3>

<p class="mb-4">Check MACD direction on a higher timeframe before trading the lower timeframe:</p>
<p class="mb-4">- Daily MACD bullish + 4-hour MACD Golden Cross = High-probability long</p>
<p class="mb-4">- Weekly MACD bearish + Daily crossover down = Strong short confirmation</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="9-summary">9. Summary</h2>

<blockquote class="border-l-4 border-gray-300 pl-4 italic text-gray-700 my-4 bg-gray-50 py-2 pr-2 rounded-r">"MACD is your market's heartbeat monitorthe crossover tells you the pulse changed, but the histogram reveals whether the heart is beating stronger or about to flatline."</blockquote>

<p class="mb-4"><h2 class="text-2xl font-bold mt-12 mb-6 border-b pb-2">PART 2: SUPPLEMENTARY GUIDE</h2></p>

<h2 id="1-core-concept">1. Core Concept</h2>

<p class="mb-4">MACD answers one fundamental question: "Is momentum accelerating or decelerating?"</p>

<p class="mb-4">While moving averages tell you the trend's direction, MACD reveals the trend's *velocity*. The MACD Line measures how far the fast average has pulled away from the slow averagelike measuring the gap between a sprinter and a jogger. When this gap widens, momentum is building. When it narrows, momentum is fading.</p>

<p class="mb-4">The genius of MACD lies in converting two lagging trend-following indicators (EMAs) into a leading momentum indicator (the Histogram). The Histogram's direction often changes before the MACD Line crosses the Signal Line, providing an early warning system.</p>

<p class="mb-4">Think of it this way:</p>
<p class="mb-4">- MACD Line = How fast is the spread between averages changing?</p>
<p class="mb-4">- Signal Line = What's the average speed of that change?</p>
<p class="mb-4">- Histogram = Is the change accelerating or decelerating?</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="2-statistical-edge">2. Statistical Edge</h2>

<h3 id="backtest-evidence">Backtest Evidence</h3>

<p class="mb-4">Studies on MACD strategies show:</p>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Metric</td><td class="px-4 py-2 border-b border-[#2a2e39]">MACD Crossover Only</td><td class="px-4 py-2 border-b border-[#2a2e39]">With ADX > 25 Filter</td><td class="px-4 py-2 border-b border-[#2a2e39]">With Divergence Confirmation</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Win Rate</td><td class="px-4 py-2 border-b border-[#2a2e39]">45%</td><td class="px-4 py-2 border-b border-[#2a2e39]">54%</td><td class="px-4 py-2 border-b border-[#2a2e39]">62%</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Profit Factor</td><td class="px-4 py-2 border-b border-[#2a2e39]">1.2</td><td class="px-4 py-2 border-b border-[#2a2e39]">1.5</td><td class="px-4 py-2 border-b border-[#2a2e39]">1.9</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Max Drawdown</td><td class="px-4 py-2 border-b border-[#2a2e39]">-40%</td><td class="px-4 py-2 border-b border-[#2a2e39]">-28%</td><td class="px-4 py-2 border-b border-[#2a2e39]">-22%</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Trades/Year</td><td class="px-4 py-2 border-b border-[#2a2e39]">High</td><td class="px-4 py-2 border-b border-[#2a2e39]">Moderate</td><td class="px-4 py-2 border-b border-[#2a2e39]">Low</td></tr>
</table></div>

<h3 id="why-it-works">Why It Works</h3>

<p class="mb-4">The statistical edge comes from momentum persistence. Academic research (Jegadeesh & Titman, 1993) shows that assets that outperform tend to continue outperforming for 3-12 months. MACD captures this momentum effect by identifying when short-term performance diverges from longer-term trends.</p>

<h3 id="academic-reference">Academic Reference</h3>

<p class="mb-4">Gerald Appel's original research was published in his 1979 book *The Moving Average Convergence-Divergence Trading Method*. Thomas Aspray's Histogram enhancement appeared in *Technical Analysis of Stocks & Commodities* magazine in 1986, addressing the lag problem in crossover signals.</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="3-actionable-strategy">3. Actionable Strategy</h2>

<h3 id="strategy-name:-"macd-hook-entry"">Strategy Name: "MACD Hook Entry"</h3>

<p class="mb-4">Concept: Enter trending markets on momentum pullbacks using MACD and Stochastic coordination.</p>

<p class="mb-4">Setup Requirements:</p>
<p class="mb-4">1. MACD Line > Signal Line (bullish trend active)</p>
<p class="mb-4">2. MACD Line < 0 (still in oversold territory)</p>
<p class="mb-4">3. ADX(14) > 25 (trend strength confirmed)</p>

<p class="mb-4">Entry Trigger:</p>
<p class="mb-4">- Stochastic %K drops below 20 (oversold pullback)</p>
<p class="mb-4">- Stochastic %K crosses back above 20 (reversal)</p>

<p class="mb-4">Position Sizing:</p>
<p class="mb-4">- Full size when Histogram expanding</p>
<p class="mb-4">- Half size when Histogram flat</p>

<p class="mb-4">Exit Rules:</p>
<p class="mb-4">1. Primary Exit: MACD Line crosses below Signal Line</p>
<p class="mb-4">2. Early Exit: Histogram makes 3 consecutive lower bars</p>
<p class="mb-4">3. Stop Loss: 2 ATR(14) below entry</p>
<p class="mb-4">4. Profit Target: 3:1 risk-reward or trail with Histogram</p>

<p class="mb-4">Example:</p>
<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
Stock XYZ shows:
&nbsp;&nbsp;MACD = -0.50, Signal = -0.65 (MACD &gt; Signal )
&nbsp;&nbsp;MACD &lt; 0 (oversold territory )
&nbsp;&nbsp;ADX = 28 (trending )
&nbsp;&nbsp;Stochastic drops to 18, crosses above 20  ENTRY

Position: Full size (Histogram expanding)
Stop: Entry - 2ATR
Exit: When MACD &lt; Signal or Histogram shrinks
</code></pre>

<hr class="border-[#2a2e39] my-8">

<h2 id="4-risks-&-limitations">4. Risks & Limitations</h2>

<h3 id="failure-patterns">Failure Patterns</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Pattern</td><td class="px-4 py-2 border-b border-[#2a2e39]">Description</td><td class="px-4 py-2 border-b border-[#2a2e39]">Mitigation</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Ranging Market Whipsaws</td><td class="px-4 py-2 border-b border-[#2a2e39]">Multiple crossovers in tight range</td><td class="px-4 py-2 border-b border-[#2a2e39]">ADX filter: only trade when ADX > 25</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Late Entry Problem</td><td class="px-4 py-2 border-b border-[#2a2e39]">By crossover, first 10-15% already gone</td><td class="px-4 py-2 border-b border-[#2a2e39]">Use Histogram reversal for earlier signals</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Divergence False Positives</td><td class="px-4 py-2 border-b border-[#2a2e39]">Divergence can persist for weeks</td><td class="px-4 py-2 border-b border-[#2a2e39]">Require price pattern confirmation</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">EMA Startup Ghosting</td><td class="px-4 py-2 border-b border-[#2a2e39]">First 100+ bars show unstable values</td><td class="px-4 py-2 border-b border-[#2a2e39]">Ignore signals in first 150 bars of data</td></tr>
</table></div>

<h3 id="psychological-traps">Psychological Traps</h3>

<p class="mb-4">1. The "It's Still Bullish" Trap  </p>
<p class="mb-4">   MACD above Signal feels safe, but shrinking Histogram warns of fading momentum. Don't hold too long.</p>

<p class="mb-4">2. Divergence Impatience  </p>
<p class="mb-4">   Spotting a divergence doesn't mean acting immediately. Wait for price structure break.</p>

<p class="mb-4">3. Overtrading Crossovers  </p>
<p class="mb-4">   Each crossover feels significant. In reality, 40-50% fail in normal markets. Be selective.</p>

<h3 id="common-misinterpretations">Common Misinterpretations</h3>

<p class="mb-4">- "MACD above zero means buy"  It shows bulls in control, not entry timing</p>
<p class="mb-4">- "Bigger Histogram = stronger signal"  Extreme Histogram often precedes reversal</p>
<p class="mb-4">- "Crossover is the entry"  It's confirmation; Histogram reversal is the early signal</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="5-further-study">5. Further Study</h2>

<h3 id="creator-attribution">Creator Attribution</h3>

<p class="mb-4">Gerald Appel developed MACD in 1979 as a money manager seeking a systematic approach to momentum. His psychology background influenced his understanding of market crowd behavior. Thomas Aspray added the Histogram in 1986 to address crossover lag.</p>

<h3 id="parent/child-indicators">Parent/Child Indicators</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Indicator</td><td class="px-4 py-2 border-b border-[#2a2e39]">Relationship</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">EMA</td><td class="px-4 py-2 border-b border-[#2a2e39]">Foundation  MACD is the difference of two EMAs</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">PPO</td><td class="px-4 py-2 border-b border-[#2a2e39]">Sibling  Percentage version of MACD for cross-asset comparison</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">MACD Histogram</td><td class="px-4 py-2 border-b border-[#2a2e39]">Child  The derivative of MACD for leading signals</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Signal Line</td><td class="px-4 py-2 border-b border-[#2a2e39]">Child  EMA of MACD for crossover triggers</td></tr>
</table></div>

<h3 id="recommended-readings">Recommended Readings</h3>

<p class="mb-4">1. *The Moving Average Convergence-Divergence Trading Method*  Gerald Appel</p>
<p class="mb-4">2. *Technical Analysis of the Financial Markets*  John J. Murphy</p>
<p class="mb-4">3. *Trading for a Living*  Dr. Alexander Elder (MACD Histogram analysis)</p>

<hr class="border-[#2a2e39] my-8">

<h3 id="55-related-indicators-comparison">5.5 Related Indicators Comparison</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Feature</td><td class="px-4 py-2 border-b border-[#2a2e39]">MACD</td><td class="px-4 py-2 border-b border-[#2a2e39]">PPO</td><td class="px-4 py-2 border-b border-[#2a2e39]">RSI</td><td class="px-4 py-2 border-b border-[#2a2e39]">Stochastic</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Type</td><td class="px-4 py-2 border-b border-[#2a2e39]">Momentum</td><td class="px-4 py-2 border-b border-[#2a2e39]">Momentum</td><td class="px-4 py-2 border-b border-[#2a2e39]">Momentum</td><td class="px-4 py-2 border-b border-[#2a2e39]">Momentum</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Bounded</td><td class="px-4 py-2 border-b border-[#2a2e39]">No</td><td class="px-4 py-2 border-b border-[#2a2e39]">No</td><td class="px-4 py-2 border-b border-[#2a2e39]">Yes (0-100)</td><td class="px-4 py-2 border-b border-[#2a2e39]">Yes (0-100)</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Best For</td><td class="px-4 py-2 border-b border-[#2a2e39]">Trend confirmation</td><td class="px-4 py-2 border-b border-[#2a2e39]">Cross-asset comparison</td><td class="px-4 py-2 border-b border-[#2a2e39]">Overbought/Oversold</td><td class="px-4 py-2 border-b border-[#2a2e39]">Entry timing</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Lag</td><td class="px-4 py-2 border-b border-[#2a2e39]">Moderate</td><td class="px-4 py-2 border-b border-[#2a2e39]">Moderate</td><td class="px-4 py-2 border-b border-[#2a2e39]">Low</td><td class="px-4 py-2 border-b border-[#2a2e39]">Low</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Divergence Use</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strong</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strong</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strong</td><td class="px-4 py-2 border-b border-[#2a2e39]">Moderate</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Default Period</td><td class="px-4 py-2 border-b border-[#2a2e39]">12, 26, 9</td><td class="px-4 py-2 border-b border-[#2a2e39]">12, 26, 9</td><td class="px-4 py-2 border-b border-[#2a2e39]">14</td><td class="px-4 py-2 border-b border-[#2a2e39]">14, 3, 3</td></tr>
</table></div>

<p class="mb-4">When to Use Which:</p>
<p class="mb-4">- MACD  Trend direction and momentum confirmation on single assets</p>
<p class="mb-4">- PPO  Same as MACD but for comparing momentum across different-priced assets</p>
<p class="mb-4">- RSI  Overbought/oversold extremes and divergence detection</p>
<p class="mb-4">- Stochastic  Precise entry timing on pullbacks within trends</p>

<p class="mb-4"><h2 class="text-2xl font-bold mt-12 mb-6 border-b pb-2">PART 3: ADVANCED SIGNAL REFERENCE</h2></p>

<h2 id="advanced-signal-reference">Advanced Signal Reference</h2>

<h3 id="threshold-matrix">Threshold Matrix</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">MACD Position</td><td class="px-4 py-2 border-b border-[#2a2e39]">Histogram State</td><td class="px-4 py-2 border-b border-[#2a2e39]">Market Interpretation</td><td class="px-4 py-2 border-b border-[#2a2e39]">Action</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">MACD < 0, Signal < 0</td><td class="px-4 py-2 border-b border-[#2a2e39]">Expanding Down</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strong bearish momentum</td><td class="px-4 py-2 border-b border-[#2a2e39]">Avoid longs; consider shorts</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">MACD < 0, Signal < 0</td><td class="px-4 py-2 border-b border-[#2a2e39]">Shrinking</td><td class="px-4 py-2 border-b border-[#2a2e39]">Selling pressure easing</td><td class="px-4 py-2 border-b border-[#2a2e39]">Watch for bottoming signals</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">MACD > Signal, MACD < 0</td><td class="px-4 py-2 border-b border-[#2a2e39]">Expanding Up</td><td class="px-4 py-2 border-b border-[#2a2e39]">Bullish crossover in oversold</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strong buy zone</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">MACD > Signal, MACD > 0</td><td class="px-4 py-2 border-b border-[#2a2e39]">Expanding Up</td><td class="px-4 py-2 border-b border-[#2a2e39]">Bullish acceleration</td><td class="px-4 py-2 border-b border-[#2a2e39]">Trail stops, don't add</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">MACD > Signal, MACD > 0</td><td class="px-4 py-2 border-b border-[#2a2e39]">Shrinking</td><td class="px-4 py-2 border-b border-[#2a2e39]">Momentum fading</td><td class="px-4 py-2 border-b border-[#2a2e39]">Prepare to exit</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">MACD < Signal, MACD > 0</td><td class="px-4 py-2 border-b border-[#2a2e39]">Expanding Down</td><td class="px-4 py-2 border-b border-[#2a2e39]">Bearish crossover in overbought</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strong sell/short zone</td></tr>
</table></div>

<h3 id="signal-patterns">Signal Patterns</h3>

<h4 id="buy-signal-golden-cross">Buy Signal (Golden Cross)</h4>
<p class="mb-4">This signal triggers when the MACD line crosses above the Signal line, indicating a shift from bearish to bullish momentum. The signal is strongest when the crossover occurs in oversold territory (MACD < 0) with expanding histogram bars confirming accelerating upward momentum. Reliability increases when combined with ADX > 25 to filter out sideways market whipsaws.</p>

<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-python">
def macd_buy_signal(macd, signal, histogram):
&nbsp;&nbsp;&nbsp;&nbsp;condition_1 = macd &gt; signal                    # MACD above Signal
&nbsp;&nbsp;&nbsp;&nbsp;condition_2 = macd_prev &lt;= signal_prev         # Just crossed (was below)
&nbsp;&nbsp;&nbsp;&nbsp;condition_3 = histogram &gt; histogram_prev       # Momentum building
&nbsp;&nbsp;&nbsp;&nbsp;condition_4 = macd &lt; 0                         # Oversold territory (bonus)
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;return condition_1 and condition_2 and condition_3
</code></pre>

<h4 id="sell/exit-signal-dead-cross">Sell/Exit Signal (Dead Cross)</h4>
<p class="mb-4">This exit signal identifies when bullish momentum is fading, either through a direct bearish crossover or through consecutive declining histogram bars. The signal is particularly reliable when MACD is in overbought territory (above zero) and the histogram has turned negative while MACD remains above Signal. Early exits can be taken on momentum fade before the actual crossover occurs.</p>

<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-python">
def macd_exit_signal(macd, signal, histogram):
&nbsp;&nbsp;&nbsp;&nbsp;dead_cross = macd &lt; signal and macd_prev &gt;= signal_prev
&nbsp;&nbsp;&nbsp;&nbsp;momentum_fade = histogram &lt; histogram_prev and histogram_prev &lt; histogram_prev2
&nbsp;&nbsp;&nbsp;&nbsp;extreme_overbought = macd &gt; 0 and histogram &lt; 0
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;return dead_cross or (momentum_fade and macd &gt; signal)
</code></pre>

<h4 id="divergence-detection">Divergence Detection</h4>
<p class="mb-4">Bullish divergence occurs when price makes a lower low while MACD makes a higher low, signaling that selling pressure is weakening despite continued price decline. This pattern often precedes trend reversals and is one of the most powerful MACD signals. The divergence is most reliable when confirmed by a subsequent MACD crossover above the Signal line within 3-5 bars.</p>

<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-python">
def macd_bullish_divergence(prices, macd):
&nbsp;&nbsp;&nbsp;&nbsp;price_lower_low = prices[-1] &lt; min(prices[-20:-1])
&nbsp;&nbsp;&nbsp;&nbsp;macd_higher_low = macd[-1] &gt; min(macd[-20:-1])
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;return price_lower_low and macd_higher_low
</code></pre>

<h3 id="screening-filters">Screening Filters</h3>

<h4 id="classic-bullish-scan">Classic Bullish Scan</h4>
<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
MACD_Line(12, 26) &gt; Signal_Line(9)
AND MACD_Histogram &gt; MACD_Histogram[1]
AND MACD_Line &lt; 0
AND ADX(14) &gt; 25
</code></pre>

<h4 id="momentum-acceleration-scan">Momentum Acceleration Scan</h4>
<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
MACD_Histogram &gt; MACD_Histogram[1]
AND MACD_Histogram[1] &gt; MACD_Histogram[2]
AND MACD_Line &gt; Signal_Line
</code></pre>

<h4 id="divergence-scanner">Divergence Scanner</h4>
<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
Close &lt; Lowest(Close, 20)
AND MACD_Line &gt; Lowest(MACD_Line, 20)
AND MACD_Line crosses above Signal_Line within 3 bars
</code></pre>

<h3 id="combination-strategies">Combination Strategies</h3>

<h4 id="macd-+-stochastic-pullback-strategy">MACD + Stochastic Pullback Strategy</h4>
<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
SETUP:
&nbsp;&nbsp;MACD_Line(12, 26) &gt; Signal_Line(9)
&nbsp;&nbsp;MACD_Line &lt; 0
&nbsp;&nbsp;ADX(14) &gt; 25

ENTRY:
&nbsp;&nbsp;Stochastic_K(14, 3) crosses above 20 from below

STOP_LOSS:
&nbsp;&nbsp;2  ATR(14) below entry

TAKE_PROFIT:
&nbsp;&nbsp;MACD_Line crosses below Signal_Line
&nbsp;&nbsp;OR 3  ATR(14) above entry
</code></pre>

<h4 id="macd-+-bollinger-band-reversal">MACD + Bollinger Band Reversal</h4>
<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
FILTER:
&nbsp;&nbsp;MACD_Histogram &lt; 0 for 5+ bars (selling exhausted)

ENTRY:
&nbsp;&nbsp;Price touches Lower Bollinger Band
&nbsp;&nbsp;AND MACD_Histogram starts turning up (less negative)

TRAIL:
&nbsp;&nbsp;Exit when MACD_Histogram turns negative again
</code></pre>

<h4 id="macd-+-rsi-confirmation">MACD + RSI Confirmation</h4>
<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
FILTER:
&nbsp;&nbsp;MACD_Line &gt; Signal_Line

ENTRY:
&nbsp;&nbsp;RSI(14) drops below 30
&nbsp;&nbsp;RSI(14) crosses back above 30

EXIT:
&nbsp;&nbsp;RSI &gt; 70 OR MACD crosses below Signal
</code></pre>





                    </div>
                </article>
                <!-- Right: Sticky TOC -->
                <aside class="hidden lg:block w-64 flex-shrink-0">
                    <div class="sticky top-24">
                        <h3 class="font-bold text-slate-900 mb-4 pb-2 border-b border-slate-100 text-sm uppercase tracking-wider">
                            On this page
                        </h3>
                        <nav id="toc-nav" class="space-y-1 text-sm text-slate-600">
                            <a href="#1-identity" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">1. Identity</a>
<a href="#2-calculation-logic" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">2. Calculation Logic</a>
<a href="#formula" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Formula</a>
<a href="#real-world-analogy" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Real-World Analogy</a>
<a href="#3-market-standards" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">3. Market Standards</a>
<a href="#default-parameters" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Default Parameters</a>
<a href="#alternative-settings" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Alternative Settings</a>
<a href="#timeframe-recommendations" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Timeframe Recommendations</a>
<a href="#4-market-context" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">4. Market Context</a>
<a href="#best-conditions" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Best Conditions</a>
<a href="#limitations" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Limitations</a>
<a href="#asset-class-suitability" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Asset Class Suitability</a>
<a href="#5-entry-signals" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">5. Entry Signals</a>
<a href="#primary-buy-signal" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Primary Buy Signal</a>
<a href="#primary-sell/exit-signal" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Primary Sell/Exit Signal</a>
<a href="#6-filter-usage" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">6. Filter Usage</a>
<a href="#filter-rules" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Filter Rules</a>
<a href="#recommended-pairings" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Recommended Pairings</a>
<a href="#example-combined-strategy" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Example Combined Strategy</a>
<a href="#7-practical-cautions" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">7. Practical Cautions</a>
<a href="#lag-characteristics" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Lag Characteristics</a>
<a href="#false-signal-scenarios" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">False Signal Scenarios</a>
<a href="#mitigation-strategies" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Mitigation Strategies</a>
<a href="#8-pro-insights" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">8. Pro Insights</a>
<a href="#the-histogram-slingshot" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">The Histogram Slingshot</a>
<a href="#the-zero-line-rejection" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">The Zero Line Rejection</a>
<a href="#divergence-hierarchy" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Divergence Hierarchy</a>
<a href="#multi-timeframe-confirmation" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Multi-Timeframe Confirmation</a>
<a href="#9-summary" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">9. Summary</a>
<a href="#1-core-concept" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">1. Core Concept</a>
<a href="#2-statistical-edge" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">2. Statistical Edge</a>
<a href="#backtest-evidence" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Backtest Evidence</a>
<a href="#why-it-works" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Why It Works</a>
<a href="#academic-reference" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Academic Reference</a>
<a href="#3-actionable-strategy" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">3. Actionable Strategy</a>
<a href="#strategy-name:-"macd-hook-entry"" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Strategy Name: "MACD Hook Entry"</a>
<a href="#4-risks-&-limitations" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">4. Risks & Limitations</a>
<a href="#failure-patterns" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Failure Patterns</a>
<a href="#psychological-traps" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Psychological Traps</a>
<a href="#common-misinterpretations" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Common Misinterpretations</a>
<a href="#5-further-study" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">5. Further Study</a>
<a href="#creator-attribution" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Creator Attribution</a>
<a href="#parent/child-indicators" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Parent/Child Indicators</a>
<a href="#recommended-readings" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Recommended Readings</a>
<a href="#55-related-indicators-comparison" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">5.5 Related Indicators Comparison</a>
<a href="#advanced-signal-reference" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">Advanced Signal Reference</a>
<a href="#threshold-matrix" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Threshold Matrix</a>
<a href="#signal-patterns" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Signal Patterns</a>
<a href="#screening-filters" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Screening Filters</a>
<a href="#combination-strategies" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Combination Strategies</a>

                        </nav>
                        <div class="mt-8 pt-4 border-t border-slate-100">
                            <a href="#" class="text-xs text-slate-400 hover:text-indigo-600 flex items-center transition-colors">
                                Back to Top
                            </a>
                        </div>
                    </div>
                </aside>
            </div>
        </section>


    </div>

    <!-- Footer -->
    <footer class="bg-white border-t border-slate-200 mt-12">
        <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
            <p class="text-center text-slate-400 text-sm">
                &copy; 2023-2025 I ant I Investigates. All rights reserved.
            </p>
        </div>
    </footer>

    <!-- ========================================== -->
    <!-- 1. DATA & LOGIC INJECTION                  -->
    <!-- ========================================== -->
    <script>
        window.IndicatorLogic = {
            name: "MovingAverageConvergenceDivergence",
            params: [],
            calculate: null
        };
        (function() {
            try {
                const injectedCode = `
        window.IndicatorLogic = {
            calculate: (data, params) => {
                const close = data.map(d => d.close);
                const fastP = params.fastPeriod || 12;
                const slowP = params.slowPeriod || 26;
                const sigP = params.signalPeriod || 9;
                // EMA helper
                const ema = (arr, period) => {
                    const k = 2 / (period + 1);
                    const result = [];
                    let prev = null;
                    for (let i = 0; i < arr.length; i++) {
                        if (i < period - 1) { result.push(null); continue; }
                        if (i === period - 1) {
                            let sum = 0;
                            for (let j = 0; j < period; j++) sum += arr[i - j];
                            prev = sum / period;
                            result.push(prev);
                            continue;
                        }
                        prev = (arr[i] - prev) * k + prev;
                        result.push(prev);
                    }
                    return result;
                };
                const fastEma = ema(close, fastP);
                const slowEma = ema(close, slowP);
                const macd = fastEma.map((f, i) => f && slowEma[i] ? f - slowEma[i] : null);
                // Signal line: EMA of MACD (filter nulls)
                const validMacd = macd.filter(v => v !== null);
                const signalEma = ema(validMacd, sigP);
                let sigIdx = 0;
                const signal = macd.map(v => {
                    if (v === null) return null;
                    return signalEma[sigIdx++] || null;
                });
                const histogram = macd.map((m, i) => m && signal[i] ? m - signal[i] : null);
                return { macd, signal, histogram };
            }
        };
        `;
                const isTemplatePlaceholder = injectedCode.includes('{{') && injectedCode.includes('PLAYGROUND_LOGIC');
                if (injectedCode && injectedCode.trim().length > 0 && !isTemplatePlaceholder) {
                    new Function(injectedCode)();
                } else {
                    console.warn("Playground Logic: Running in Preview/Fallback mode.");
                    window.IndicatorLogic.calculate = () => []; 
                }
            } catch (e) {
                console.error("Critical Error in Logic Injection:", e);
                window.IndicatorLogic.calculate = () => [];
            }
        })();
    </script>

    <!-- ========================================== -->
    <!-- 2. VISUALIZATION ENGINE                    -->
    <!-- ========================================== -->
    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'neutral', securityLevel: 'loose' });
    </script>

    <!-- ========================================== -->
    <!-- 3. UI CONTROLLERS & APP INITIALIZATION     -->
    <!-- ========================================== -->
    <script src="../../assets/js/script.js" defer></script>
    <!-- INLINE UI CONTROLLERS (PORTED FROM 0117) -->
    <script>
        // --- 0. Indicator Data Injection ---
        // These are populated by the generator script
        var IndicatorLogic = {};
        var IndicatorConfig = [];
        var IndicatorDisplay = { isOverlay: false, plots: {} };

        // 1. Library Code (e.g. class definitions)
        // No library code for verification

        // 2. Configuration
        try {
            var rawConfig = '[{"id": "fastPeriod", "label": "Fast Period (12)", "type": "number", "value": 12, "min": 2, "max": 50}, {"id": "slowPeriod", "label": "Slow Period (26)", "type": "number", "value": 26, "min": 10, "max": 100}, {"id": "signalPeriod", "label": "Signal Period (9)", "type": "number", "value": 9, "min": 2, "max": 50}]';
            if(rawConfig && !rawConfig.startsWith('{{')) IndicatorConfig = JSON.parse(rawConfig);
        } catch(e){ console.warn('Config parse error', e); }

        try {
            var rawDisplay = '{"isOverlay": false, "plots": {"macd": {"label": "MACD Line", "color": "#3b82f6", "type": "line"}, "signal": {"label": "Signal Line", "color": "#ef4444", "type": "line"}, "histogram": {"label": "Histogram", "color": "#fbbf24", "type": "bar"}}}';
            if(rawDisplay && !rawDisplay.startsWith('{{')) IndicatorDisplay = JSON.parse(rawDisplay);
        } catch(e){ console.warn('Display parse error', e); }

        // 3. Logic Adapter
        window.IndicatorLogic = {
            calculate: (data, params) => {
                const close = data.map(d => d.close);
                const fastP = params.fastPeriod || 12;
                const slowP = params.slowPeriod || 26;
                const sigP = params.signalPeriod || 9;
                // EMA helper
                const ema = (arr, period) => {
                    const k = 2 / (period + 1);
                    const result = [];
                    let prev = null;
                    for (let i = 0; i < arr.length; i++) {
                        if (i < period - 1) { result.push(null); continue; }
                        if (i === period - 1) {
                            let sum = 0;
                            for (let j = 0; j < period; j++) sum += arr[i - j];
                            prev = sum / period;
                            result.push(prev);
                            continue;
                        }
                        prev = (arr[i] - prev) * k + prev;
                        result.push(prev);
                    }
                    return result;
                };
                const fastEma = ema(close, fastP);
                const slowEma = ema(close, slowP);
                const macd = fastEma.map((f, i) => f && slowEma[i] ? f - slowEma[i] : null);
                // Signal line: EMA of MACD (filter nulls)
                const validMacd = macd.filter(v => v !== null);
                const signalEma = ema(validMacd, sigP);
                let sigIdx = 0;
                const signal = macd.map(v => {
                    if (v === null) return null;
                    return signalEma[sigIdx++] || null;
                });
                const histogram = macd.map((m, i) => m && signal[i] ? m - signal[i] : null);
                return { macd, signal, histogram };
            }
        };
    </script>

    <script>
        // --- 1. Code Panel Logic ---
        const AppState = {
            activeLang: 'csharp',
            codeType: 'simple',
            isPanelVisible: false,  // Start hidden to show flowchart
            isPanelExpanded: false,
        };

        // --- 2. Canvas State (Full Pan/Zoom from 0117) ---
        const CanvasState = {
            scale: 1, panX: 0, panY: 0,
            isDragging: false, startX: 0, startY: 0,
            minScale: 0.1, maxScale: 5.0
        };

        // Element references (populated after DOM ready)
        let els = {};

        function updateView() {
            // 1. Code Content Visibility
            document.querySelectorAll('.code-content').forEach(el => el.classList.add('hidden'));
            const activeId = `code-${AppState.activeLang}-${AppState.codeType}`;
            const activeEl = document.getElementById(activeId);
            if (activeEl) activeEl.classList.remove('hidden');

            // 2. Overlay Visibility
            const overlay = document.getElementById('code-panel-overlay');
            if (overlay) {
                if (AppState.isPanelVisible) overlay.classList.remove('panel-hidden');
                else overlay.classList.add('panel-hidden');

                if (AppState.isPanelExpanded) {
                    overlay.classList.add('panel-expanded');
                    const iconExp = document.getElementById('icon-expand');
                    const iconCol = document.getElementById('icon-collapse');
                    if(iconExp) iconExp.classList.add('hidden');
                    if(iconCol) iconCol.classList.remove('hidden');
                } else {
                    overlay.classList.remove('panel-expanded');
                    const iconExp = document.getElementById('icon-expand');
                    const iconCol = document.getElementById('icon-collapse');
                    if(iconExp) iconExp.classList.remove('hidden');
                    if(iconCol) iconCol.classList.add('hidden');
                }
            }

            // 3. Button States
            const btnCs = document.getElementById('btn-lang-csharp');
            const btnPy = document.getElementById('btn-lang-python');
            [btnCs, btnPy].forEach(btn => {
                if(btn) btn.className = "px-2 py-1 text-xs rounded transition-colors text-slate-500 hover:bg-slate-100";
            });

            if (AppState.activeLang === 'csharp' && btnCs) {
                btnCs.className = "px-2 py-1 text-xs rounded transition-colors btn-lang-active";
            } else if (AppState.activeLang === 'python' && btnPy) {
                btnPy.className = "px-2 py-1 text-xs rounded transition-colors btn-lang-active";
            }

            const btnSimple = document.getElementById('btn-type-simple');
            const btnDetailed = document.getElementById('btn-type-detailed');
            if(btnSimple) btnSimple.className = `text-xs transition-colors ${AppState.codeType === 'simple' ? 'btn-type-active' : 'text-slate-500 hover:text-indigo-600'}`;
            if(btnDetailed) btnDetailed.className = `text-xs transition-colors ${AppState.codeType === 'detailed' ? 'btn-type-active' : 'text-slate-500 hover:text-indigo-600'}`;
        }

        // Global exports for inline onclick handlers
        window.setLang = (lang) => { AppState.activeLang = lang; updateView(); }
        window.setType = (type) => { AppState.codeType = type; updateView(); }
        window.toggleCodePanel = () => { AppState.isPanelVisible = !AppState.isPanelVisible; updateView(); }
        window.toggleExpand = () => { AppState.isPanelExpanded = !AppState.isPanelExpanded; updateView(); }
        window.copyCode = async () => {
            const activeId = `code-${AppState.activeLang}-${AppState.codeType}`;
            const el = document.getElementById(activeId);
            if (!el) return;
            let text = "";
            const lines = el.querySelectorAll('.code-line');
            if (lines.length > 0) {
                text = Array.from(lines).map(line => line.textContent).join('\n');
            } else {
                text = el.textContent;
            }
            try {
                await navigator.clipboard.writeText(text);
                const iconCopy = document.getElementById('icon-copy');
                const iconDone = document.getElementById('icon-copy-done');
                if (iconCopy && iconDone) {
                    iconCopy.classList.add('hidden');
                    iconDone.classList.remove('hidden');
                    setTimeout(() => {
                        iconCopy.classList.remove('hidden');
                        iconDone.classList.add('hidden');
                    }, 2000);
                }
            } catch (err) { console.error("Failed to copy:", err); }
        }

        // --- Canvas Transform Functions (Full Pan/Zoom) ---
        // PlaygroundController (Ported from template_0117.html)
        window.PlaygroundController = {
            instanceChart: null,
            showError: (msg) => {
                console.error('Playground Error:', msg);
                const outputEl = document.getElementById('output-data');
                if (outputEl) outputEl.value = 'Error: ' + msg;
            },
            clearError: () => {},
            init: () => {
                try {
                    // 1. Render Dynamic Settings if Config exists
                    const settingsContainer = document.getElementById('settings-container');
                    if (IndicatorConfig && Array.isArray(IndicatorConfig) && IndicatorConfig.length > 0 && settingsContainer) {
                        settingsContainer.innerHTML = ''; // Clear default "Period"
                        IndicatorConfig.forEach(cfg => {
                            const div = document.createElement('div');
                            div.className = "flex flex-col";
                            const label = document.createElement('label');
                            label.className = "text-xs text-slate-400 mb-1";
                            label.textContent = cfg.label;
                            const input = document.createElement('input');
                            input.id = `param-${cfg.id}`;
                            input.type = cfg.type || "number";
                            // Light theme styling to match textarea
                            input.className = "bg-white border border-slate-300 rounded px-2 py-1 text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow";
                            input.value = cfg.value;
                            if(cfg.min !== undefined) input.min = cfg.min;
                            if(cfg.max !== undefined) input.max = cfg.max;
                            // Add change listener to auto-update
                            input.addEventListener('change', PlaygroundController.update);
                            div.appendChild(label);
                            div.appendChild(input);
                            settingsContainer.appendChild(div);
                        });
                    }

                    // 2. Generate Initial Random Sample Data (Default to Single for simplicity, or OHLCV)
                    PlaygroundController.generateSample('ohlcv'); // Default to OHLCV for robustness
                } catch(e) { PlaygroundController.showError(e.message); }
            },
            generateSample: (type) => {
                 const sampleData = [];
                 const count = 150; 
                 let price = 100;
                 if (type === 'ohlcv') {
                    // OHLCV Generation
                    sampleData.push("Date,Open,High,Low,Close,Volume");
                    const now = new Date();
                    for (let i = 0; i < count; i++) {
                        const date = new Date(now.getTime() - (count - i) * 86400000).toISOString().split('T')[0];
                        const trend = Math.sin(i * 0.1) * 2;
                        const noise = (Math.random() - 0.5) * 2;
                        const close = 100 + trend + noise + (i * 0.1); 
                        const open = close + (Math.random() - 0.5);
                        const high = Math.max(open, close) + Math.random();
                        const low = Math.min(open, close) - Math.random();
                        const vol = Math.floor(1000 + Math.random() * 500);
                        sampleData.push(`${date},${open.toFixed(2)},${high.toFixed(2)},${low.toFixed(2)},${close.toFixed(2)},${vol}`);
                    }
                 } else { 
                    // Single Value Generation
                    for (let i = 0; i < count; i++) {
                        price = price + (Math.random() - 0.5) * 5;
                        sampleData.push(price.toFixed(2));
                    }
                 }
                 const inputEl = document.getElementById('input-data');
                 if (inputEl) inputEl.value = sampleData.join('\n');
                 PlaygroundController.update();
            },
            update: () => {
                PlaygroundController.clearError();
                // Dynamic Params Collection
                const params = {};
                if (IndicatorConfig && Array.isArray(IndicatorConfig) && IndicatorConfig.length > 0) {
                    IndicatorConfig.forEach(cfg => {
                        const el = document.getElementById(`param-${cfg.id}`);
                        if (el) params[cfg.id] = parseFloat(el.value);
                    });
                } else {
                    // Fallback to default Period if no config
                    const periodEl = document.getElementById('param-period');
                    params.period = periodEl ? parseInt(periodEl.value) || 14 : 14;
                }

                const rawData = document.getElementById('input-data').value.trim();
                let lines = [];
                // Robust split: handle comma, newline, or mixed
                if (rawData.includes('\n')) {
                    // Split by newline first
                    lines = rawData.split('\n').map(l => l.trim()).filter(l => l);
                    // If it's NOT multi-column (header check), and lines contain commas, try to flatten
                    const firstVal = parseFloat(lines[0].split(/[,\t]/)[0]);
                    const isHeader = isNaN(firstVal) && /[a-zA-Z]/.test(lines[0]);
                    if (!isHeader && lines.some(l => l.includes(','))) {
                        // Flatten mixed content like "100, 101\n102, 103"
                        lines = rawData.split(/[\n,]+/).map(l => l.trim()).filter(l => l);
                    }
                } else {
                    // Single line, split by comma
                    lines = rawData.split(',').map(l => l.trim()).filter(l => l);
                }

                let parsedData = [];
                const firstLine = lines[0] || "";
                const firstVal = parseFloat(firstLine.split(/[,\t]/)[0]);
                const isMultiColumn = isNaN(firstVal) && /[a-zA-Z]/.test(firstLine);

                if (isMultiColumn && lines.length > 1) {
                    const headers = firstLine.split(/[,\t]+/).map(h => h.trim().toLowerCase());
                    for (let i = 1; i < lines.length; i++) {
                        const parts = lines[i].split(/[,\t]+/).map(v => parseFloat(v));
                        if (parts.some(isNaN)) continue;
                        const row = { time: i - 1 };
                        headers.forEach((h, idx) => { row[h] = parts[idx]; });
                        if (row.close === undefined && row.c !== undefined) row.close = row.c;
                        parsedData.push(row);
                    }
                } else {
                    parsedData = lines.map((l, i) => {
                        const val = parseFloat(l);
                        return isNaN(val) ? null : { time: i, close: val };
                    }).filter(d => d);
                }

                if (parsedData.length < 2) {
                    PlaygroundController.showError("Insufficient data.");
                    return;
                }

                let indicatorValues = [];
                try {
                    if (typeof IndicatorLogic !== 'undefined' && IndicatorLogic.calculate) {
                        indicatorValues = IndicatorLogic.calculate(parsedData, params);
                    } else {
                        // Fallback: Simple RSI calculation for demo
                        indicatorValues = PlaygroundController.calculateRSI(parsedData, params.period);
                    }
                } catch (e) {
                    console.error("Calculation Error", e);
                    PlaygroundController.showError("Calculation Error: " + e.message);
                    return;
                }

                // --- Format Output (CSV/TSV for Excel) ---
                const outputEl = document.getElementById('output-data');
                // --- Format Output (CSV/TSV for Excel) ---
                if (outputEl) {
                    if (Array.isArray(indicatorValues)) {
                        // Single Array (e.g. RSI)
                        outputEl.value = indicatorValues.map(v => v === null ? "" : v).join('\n');
                    } else if (typeof indicatorValues === 'object') {
                        // Multi-line Object (e.g. Ichimoku)
                        const keys = Object.keys(indicatorValues);
                        if (keys.length === 0) {
                            outputEl.value = "";
                        } else {
                            const length = indicatorValues[keys[0]].length;
                            // Comma separated as requested by user
                            const separator = ','; 
                            let csv = keys.join(separator) + '\n';
                            for (let i = 0; i < length; i++) {
                                const row = keys.map(k => {
                                    const val = indicatorValues[k][i];
                                    // Handle missing/undefined
                                    return (val === null || val === undefined) ? "" : val;
                                });
                                csv += row.join(separator) + '\n';
                            }
                            outputEl.value = csv;
                        }
                    } else {
                        outputEl.value = JSON.stringify(indicatorValues, null, 2);
                    }
                }
                PlaygroundController.renderChart(parsedData, indicatorValues);
            },
            calculateRSI: (data, period) => {
                // Simple RSI fallback
                const values = [];
                values.push(null); // First value is null
                if (data.length < 2) return values;
                let sumGains = 0, sumLosses = 0;
                for (let i = 1; i < data.length; i++) {
                    const change = data[i].close - data[i-1].close;
                    const gain = change > 0 ? change : 0;
                    const loss = change < 0 ? -change : 0;
                    if (i < period) {
                        sumGains += gain; sumLosses += loss;
                        values.push(null);
                        continue;
                    }
                    if (i === period) {
                        sumGains += gain; sumLosses += loss;
                        const avgGain = sumGains / period;
                        const avgLoss = sumLosses / period;
                        const rs = avgLoss < 0.0001 ? 100 : avgGain / avgLoss;
                        values.push(100 - (100 / (1 + rs)));
                        sumGains = avgGain; sumLosses = avgLoss;
                        continue;
                    }
                    sumGains = (sumGains * (period - 1) + gain) / period;
                    sumLosses = (sumLosses * (period - 1) + loss) / period;
                    const rs = sumLosses < 0.0001 ? 100 : sumGains / sumLosses;
                    values.push(100 - (100 / (1 + rs)));
                }
                return values;
            },
            renderChart: (prices, indicatorValues) => {
                const canvas = document.getElementById('indicatorChart');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const labels = prices.map((_, i) => i);
                if (PlaygroundController.instanceChart) PlaygroundController.instanceChart.destroy();

                const datasets = [];
                // 1. Overlay: Close Price (if enabled)
                if (IndicatorDisplay && IndicatorDisplay.isOverlay) {
                    datasets.push({
                        label: 'Close Price',
                        data: prices.map(p => p.close),
                        borderColor: '#94a3b8', // slate-400
                        backgroundColor: 'transparent',
                        borderDash: [5, 5],
                        borderWidth: 1,
                        pointRadius: 0,
                        tension: 0.1
                    });
                }

                // 2. Indicator Data
                const defaultColors = ['#4F46E5', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'];
                if (Array.isArray(indicatorValues)) {
                    datasets.push({
                        label: 'Indicator',
                        data: indicatorValues,
                        borderColor: IndicatorDisplay.plots && IndicatorDisplay.plots.main ? IndicatorDisplay.plots.main.color : '#4F46E5',
                        backgroundColor: 'transparent',
                        tension: 0.1, pointRadius: 0, borderWidth: 2
                    });
                } else if (typeof indicatorValues === 'object' && indicatorValues !== null) {
                    // Multi-line indicator (e.g., Bollinger Bands, Parabolic SAR)
                    Object.keys(indicatorValues).forEach((key, idx) => {
                        const conf = (IndicatorDisplay.plots && IndicatorDisplay.plots[key]) || {};
                        const color = conf.color || defaultColors[idx % defaultColors.length];
                        const isScatter = conf.type === 'scatter';
                        // For scatter type, convert data to {x, y} format
                        let chartData;
                        if (isScatter) {
                            chartData = indicatorValues[key]
                                .map((val, i) => val !== null && val !== undefined ? { x: i, y: val } : null)
                                .filter(p => p !== null);
                        } else {
                            chartData = indicatorValues[key];
                        }
                        datasets.push({
                            label: conf.label || key,
                            data: chartData,
                            type: isScatter ? 'scatter' : (conf.type || 'line'),
                            borderColor: isScatter ? 'transparent' : color,
                            backgroundColor: isScatter ? color : 'transparent',
                            pointRadius: isScatter ? (conf.pointRadius || 5) : 0,
                            pointBorderWidth: 0,
                            tension: 0.1,
                            borderWidth: isScatter ? 0 : 2
                        });
                    });
                }

                PlaygroundController.instanceChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: labels, datasets: datasets },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        scales: {
                            y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Value' } }
                        }
                    }
                });
            }
        };

        function updateTransform() {
            if (els.content) {
                els.content.style.transform = `translate(${CanvasState.panX}px, ${CanvasState.panY}px) scale(${CanvasState.scale})`;
            }
        }

        function handleWheel(e) {
            e.preventDefault();
            const rect = els.container.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            const zoomSensitivity = 0.001;
            const delta = -e.deltaY * zoomSensitivity;
            let newScale = CanvasState.scale * (1 + delta);
            newScale = Math.max(CanvasState.minScale, Math.min(CanvasState.maxScale, newScale));
            const scaleRatio = newScale / CanvasState.scale;
            CanvasState.panX = mouseX - (mouseX - CanvasState.panX) * scaleRatio;
            CanvasState.panY = mouseY - (mouseY - CanvasState.panY) * scaleRatio;
            CanvasState.scale = newScale;
            updateTransform();
        }

        function startDrag(e) {
            if (e.button !== 0 && e.button !== 1) return;
            CanvasState.isDragging = true;
            CanvasState.startX = e.clientX;
            CanvasState.startY = e.clientY;
            els.container.style.cursor = 'grabbing';
        }

        function drag(e) {
            if (!CanvasState.isDragging) return;
            e.preventDefault();
            const dx = e.clientX - CanvasState.startX;
            const dy = e.clientY - CanvasState.startY;
            CanvasState.panX += dx;
            CanvasState.panY += dy;
            CanvasState.startX = e.clientX;
            CanvasState.startY = e.clientY;
            updateTransform();
        }

        function stopDrag() {
            CanvasState.isDragging = false;
            if (els.container) els.container.style.cursor = 'grab';
        }

        window.zoomAction = (direction) => {
            if (!els.container || !els.content) return;
            const factor = direction === 'in' ? 1.2 : 0.8;
            let newScale = CanvasState.scale * factor;
            newScale = Math.max(CanvasState.minScale, Math.min(CanvasState.maxScale, newScale));
            const rect = els.container.getBoundingClientRect();
            const cx = rect.width / 2;
            const cy = rect.height / 2;
            const scaleRatio = newScale / CanvasState.scale;
            CanvasState.panX = cx - (cx - CanvasState.panX) * scaleRatio;
            CanvasState.panY = cy - (cy - CanvasState.panY) * scaleRatio;
            CanvasState.scale = newScale;
            updateTransform();
        }

        window.resetView = () => { centerContent(); }

        function centerContent() {
            if (!els.content || !els.container) return;
            const containerRect = els.container.getBoundingClientRect();
            const unscaledWidth = els.content.scrollWidth;
            const unscaledHeight = els.content.scrollHeight;
            let initialScale = 1.0;
            if (unscaledWidth > containerRect.width) {
                initialScale = (containerRect.width / unscaledWidth) * 0.9;
            }
            initialScale = Math.max(0.5, Math.min(1.0, initialScale));
            CanvasState.scale = initialScale;
            CanvasState.panX = (containerRect.width - unscaledWidth * initialScale) / 2;
            CanvasState.panY = (containerRect.height - unscaledHeight * initialScale) / 2;
            CanvasState.panY = Math.max(20, CanvasState.panY);
            updateTransform();
        }

        // --- 3. Init ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Bind element references
            els.container = document.getElementById('canvas-container');
            els.content = document.getElementById('canvas-content');

            // Init code panel state
            updateView();

            // Init Playground
            if (window.PlaygroundController) PlaygroundController.init();

            // Mermaid rendering + center
            if (window.mermaid) {
                try {
                    const nodes = document.querySelectorAll('.mermaid');
                    if (nodes.length > 0) {
                        await mermaid.run({ nodes: nodes });
                        setTimeout(centerContent, 100);
                    }
                } catch (e) { console.error("Mermaid render failed", e); }
            }

            // Canvas Events (Wheel zoom + Drag pan)
            if (els.container) {
                els.container.addEventListener('wheel', handleWheel, { passive: false });
                els.container.addEventListener('mousedown', startDrag);
                window.addEventListener('mousemove', drag);
                window.addEventListener('mouseup', stopDrag);
            }

            // KaTeX Auto Render
            if (window.renderMathInElement) {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ],
                    throwOnError: false
                });
            }

            // TOC ScrollSpy
            const tocLinks = document.querySelectorAll('.toc-link');
            if (tocLinks.length > 0) {
                const headings = document.querySelectorAll('article h2[id], article h3[id]');
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            tocLinks.forEach(link => link.classList.remove('active'));
                            const id = entry.target.getAttribute('id');
                            const activeLink = document.querySelector(`.toc-link[href="#${id}"]`);
                            if (activeLink) activeLink.classList.add('active');
                        }
                    });
                }, { rootMargin: '-20% 0px -60% 0px' });
                headings.forEach(h => observer.observe(h));
            }

            // Load Sample buttons
            const btnOhlcv = document.getElementById('btn-load-sample-ohlcv');
            if (btnOhlcv) {
                btnOhlcv.addEventListener('click', () => {
                    if (window.PlaygroundController) PlaygroundController.generateSample('ohlcv');
                });
            }
            const btnSingle = document.getElementById('btn-load-sample-single');
            if (btnSingle) {
                btnSingle.addEventListener('click', () => {
                    if (window.PlaygroundController) PlaygroundController.generateSample('single');
                });
            }
            // Initialize Playground Controller
            if (window.PlaygroundController && PlaygroundController.init) {
                PlaygroundController.init();
            }
        });
    </script>
</body>
</html>