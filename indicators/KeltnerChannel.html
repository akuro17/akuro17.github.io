<!DOCTYPE html>
<html lang="ja" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KeltnerChannel - I ant I Investigates</title>
    <meta name="description" content="">
    <meta name="keywords" content="">
    <!-- Structured Data for SEO -->
    <script type="application/ld+json">
        {
    "@context": "https://schema.org",
    "@type": "TechArticle",
    "headline": "KeltnerChannel",
    "description": "Detailed guide for KeltnerChannel indicator.",
    "author": {
        "@type": "Organization",
        "name": "I and I Investigates"
    }
}
    </script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- Styles -->
    <!-- Styles -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <link rel="stylesheet" href="../../assets/css/style.css">
    <!-- KaTeX (Math) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>

    <style>
        /* =========================================
           PORTED STYLES (From 0117 Template)
           ========================================= */
        :root {
            /* Minimal Variable Set for Logic Panel */
            --bg-card: #FFFFFF;
            --bg-secondary: #F8FAFC; /* slate-50 */
            --bg-hover: #F1F5F9; /* slate-100 */
            --border-color: #E2E8F0; /* slate-200 */
            --text-primary: #1E293B; /* slate-800 */
            --text-muted: #64748B; /* slate-500 */
            --accent: #4F46E5; /* indigo-600 */
        }

        /* Logic Figure Container */
        .logic-figure {
            margin: 0;
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            position: relative;
            overflow: hidden;
            height: 600px; /* Fixed height for infinite canvas feel */
        }

        /* Infinite Canvas Wrapper */
        .chart-scroll-wrapper {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
            background-color: #FFFFFF;
            background-image: radial-gradient(#E2E8F0 1.5px, transparent 1.5px);
            background-size: 20px 20px;
            cursor: grab;
            touch-action: none;
            user-select: none;
        }
        .chart-scroll-wrapper:active { cursor: grabbing; }

        /* Code Panel Overlay */
        #code-panel-overlay {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            width: 500px;
            max-width: 90%;
            z-index: 30;
            background-color: var(--bg-card);
            border-right: 1px solid var(--border-color);
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), width 0.3s ease;
            transform: translateX(0);
        }
        #code-panel-overlay.panel-hidden {
            transform: translateX(-100%);
            pointer-events: none;
        }
        #code-panel-overlay.panel-expanded {
            width: 100%;
            max-width: 100%;
        }

        /* Code Content */
        .code-panel-body {
            background-color: #FAFAFA;
            flex: 1;
            overflow: auto;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            padding: 0.5rem 1rem 1rem 1rem; /* Reduced top padding */
            white-space: pre; /* Essential for code indentation */
        }
        .code-content {
            font-family: 'Roboto Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            padding: 1rem;
        }
        /* Toggle Button */
        #code-panel-toggle-btn {
            position: absolute;
            top: 1rem;
            left: 1rem;
            z-index: 25;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.5rem;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }
        #code-panel-toggle-btn:hover {
            color: var(--accent);
            border-color: var(--accent);
        }

        /* Active States for Panel Buttons */
        .btn-lang-active {
            background-color: var(--accent) !important;
            color: white !important;
        }
        .btn-type-active {
            color: var(--text-primary) !important;
            font-weight: bold;
            text-decoration: underline;
            text-decoration-color: var(--accent);
            text-decoration-thickness: 2px;
        }

        /* Custom Scrollbar for Code Blocks */
        pre::-webkit-scrollbar, .code-panel-body::-webkit-scrollbar {
            height: 8px; width: 8px;
            background-color: #f1f5f9;
        }
        pre::-webkit-scrollbar-thumb, .code-panel-body::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        pre::-webkit-scrollbar-thumb:hover, .code-panel-body::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8;
        }

        /* Pygments Syntax Highlighting */
        pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.highlight .hll { background-color: #ffffcc }
.highlight .c { color: #008000 } /* Comment */
.highlight .err { border: 1px solid #F00 } /* Error */
.highlight .k { color: #00F } /* Keyword */
.highlight .ch { color: #008000 } /* Comment.Hashbang */
.highlight .cm { color: #008000 } /* Comment.Multiline */
.highlight .cp { color: #00F } /* Comment.Preproc */
.highlight .cpf { color: #008000 } /* Comment.PreprocFile */
.highlight .c1 { color: #008000 } /* Comment.Single */
.highlight .cs { color: #008000 } /* Comment.Special */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
.highlight .gh { font-weight: bold } /* Generic.Heading */
.highlight .gp { font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { font-weight: bold } /* Generic.Subheading */
.highlight .kc { color: #00F } /* Keyword.Constant */
.highlight .kd { color: #00F } /* Keyword.Declaration */
.highlight .kn { color: #00F } /* Keyword.Namespace */
.highlight .kp { color: #00F } /* Keyword.Pseudo */
.highlight .kr { color: #00F } /* Keyword.Reserved */
.highlight .kt { color: #2B91AF } /* Keyword.Type */
.highlight .s { color: #A31515 } /* Literal.String */
.highlight .nc { color: #2B91AF } /* Name.Class */
.highlight .ow { color: #00F } /* Operator.Word */
.highlight .sa { color: #A31515 } /* Literal.String.Affix */
.highlight .sb { color: #A31515 } /* Literal.String.Backtick */
.highlight .sc { color: #A31515 } /* Literal.String.Char */
.highlight .dl { color: #A31515 } /* Literal.String.Delimiter */
.highlight .sd { color: #A31515 } /* Literal.String.Doc */
.highlight .s2 { color: #A31515 } /* Literal.String.Double */
.highlight .se { color: #A31515 } /* Literal.String.Escape */
.highlight .sh { color: #A31515 } /* Literal.String.Heredoc */
.highlight .si { color: #A31515 } /* Literal.String.Interpol */
.highlight .sx { color: #A31515 } /* Literal.String.Other */
.highlight .sr { color: #A31515 } /* Literal.String.Regex */
.highlight .s1 { color: #A31515 } /* Literal.String.Single */
.highlight .ss { color: #A31515 } /* Literal.String.Symbol */
        /* Mermaid Overrides */
        .mermaid { transform-origin: 0 0; }
        .noselect { user-select: none; -webkit-user-select: none; }

        /* Legend Items */
        .logic-legend {
            border-top: 1px solid var(--border-color);
            padding: 1rem;
            background-color: var(--bg-card);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1.5rem;
            position: relative;
            z-index: 20;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: 500;
        }
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 1px solid;
        }
        .l-ingestion { background: #E8F0FE; border-color: #4285F4; }
        .l-evaluation { background: #FEF7E0; border-color: #FBBC04; }
        .l-weighting { background: #F3E8FD; border-color: #A142F4; }
        .l-synthesis { background: #E0F7FA; border-color: #12B5CB; }
        .l-outcome { background: #E6F4EA; border-color: #34A853; }

        /* TOC Active State Styling */
        .toc-link.active {
            color: #4f46e5;
            border-left-color: #4f46e5;
            background-color: #eef2ff;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans antialiased relative">

    <!-- Navigation -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center mr-6">
                        <a href="../index.html" class="font-bold text-xl text-indigo-600">
                            I ant I Investigates
                        </a>
                    </div>
                    <!-- Breadcrumbs (Moved Here) -->
                    <nav class="hidden md:flex text-sm text-slate-500 mr-8" aria-label="Breadcrumb">
                        <ol class="flex items-center space-x-2">
                            <li><a href="../index.html" class="hover:text-indigo-600 transition-colors">home</a></li>
                            <li><span class="mx-1">/</span></li>
                            <li><a href="./" class="hover:text-indigo-600 transition-colors">indicators</a></li>
                            <li><span class="mx-1">/</span></li>
                            <li><span class="font-medium text-slate-900">KeltnerChannel</span></li>
                        </ol>
                    </nav>

                    <!-- Page Top Nav (Anchor Links) -->
                    <div class="hidden sm:flex sm:space-x-4 items-center">
                        <a href="#interactive-playground" class="text-slate-600 hover:text-indigo-600 px-3 py-2 text-sm font-medium transition-colors">
                            Chart
                        </a>
                        <a href="#logic-visualization" class="text-slate-600 hover:text-indigo-600 px-3 py-2 text-sm font-medium transition-colors">
                            Logic
                        </a>
                        <a href="#documentation" class="text-slate-600 hover:text-indigo-600 px-3 py-2 text-sm font-medium transition-colors">
                            Docs
                        </a>
                    </div>
                </div>
                <!-- External Links Placeholder -->
                <div class="hidden sm:flex items-center">
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Container: 1-Column Stack -->
    <div class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-12">
        <!-- ======================================================= -->
        <!-- TOP SECTION: CONTEXT & PLAYGROUND                       -->
        <!-- ======================================================= -->
        <div class="flex flex-col gap-6">
            <!-- Hero Header -->
            <header>
                <h1 class="text-3xl md:text-4xl font-bold text-slate-900 mb-4 leading-tight">KeltnerChannel</h1>
                <p class="text-lg text-slate-600 leading-relaxed">Keltner Channels are volatility-based envelopes set above and below an EMA using Average True Range (ATR), providing a stable framework for identifying trend breakouts and mean-reversion opportunities.</p>
            </header>

            <!-- Interactive Playground -->
            <section id="interactive-playground" class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden scroll-mt-24">
                <div class="border-b border-slate-200 bg-indigo-50 px-6 py-4">
                    <h2 class="text-lg font-bold text-slate-800 flex items-center">
                        <span class="bg-indigo-600 text-white p-1 rounded mr-3 text-xs shadow-sm font-mono">C</span>
                        Calculator
                    </h2>
                    <p class="text-sm text-slate-600 mt-2">Calculate indicator values from your price data.</p>
                </div>
                <div class="p-6">
                    <!-- Chart Area -->
                    <div class="relative h-[400px] w-full mb-6 border border-slate-100 rounded bg-slate-50">
                        <canvas id="indicatorChart"></canvas>
                    </div>

                    <!-- Controls Area -->
                    <div id="controls" class="grid grid-cols-1 md:grid-cols-3 gap-6 bg-slate-50 p-4 rounded border border-slate-200">
                        <!-- Parameters -->
                        <div class="md:col-span-1 space-y-4">
                            <h3 class="font-bold text-sm text-slate-700 uppercase tracking-wide border-b border-slate-200 pb-2">Parameters</h3>
                            <div id="settings-container">
                                <div class="space-y-3">
                                    <!-- Dynamic settings will be injected here -->
                                </div>
                            </div>
                            <button id="btn-run" onclick="PlaygroundController.update()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded transition-colors shadow-sm flex items-center justify-center">
                                Calculate
                            </button>
                        </div>

                        <!-- Data I/O -->
                        <div class="md:col-span-2 space-y-4">
                            <!-- Input -->
                            <div class="space-y-2">
                                <div class="flex justify-between items-center pb-2 border-b border-slate-200">
                                    <h3 class="font-bold text-sm text-slate-700 uppercase tracking-wide">Input Data (CSV)</h3>
                                    <div class="flex space-x-2">
                                        <button id="btn-load-sample-ohlcv" class="text-xs text-indigo-600 hover:text-indigo-800 hover:underline transition-colors" title="Load OHLCV Sample Data">Shape (OHLCV)</button>
                                        <span class="text-slate-300">|</span>
                                        <button id="btn-load-sample-single" class="text-xs text-indigo-600 hover:text-indigo-800 hover:underline transition-colors" title="Load Single Value Sample Data">Single</button>
                                    </div>
                                </div>
                                <p class="text-xs text-slate-500">Enter CSV data (Date,Open,High,Low,Close,Volume) or single values.</p>
                                <textarea id="input-data" class="w-full h-24 p-2 text-xs font-mono border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 transition-shadow" placeholder="e.g. 100.5, 101.2, 99.8, 102.3, 103.1...

or one per line:
100.5
101.2
99.8"></textarea>
                            </div>
                            <!-- Output (Enabled) -->
                            <div class="space-y-2">
                                <div class="flex justify-between items-center pb-2 border-b border-slate-200">
                                    <h3 class="font-bold text-sm text-slate-700 uppercase tracking-wide">Output Data (Result)</h3>
                                </div>
                                <textarea id="output-data" class="w-full h-24 p-2 text-xs font-mono border border-slate-300 rounded bg-slate-100 text-slate-600" readonly placeholder="Calculation results will appear here..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- ======================================================= -->
        <!-- MIDDLE SECTION: LOGIC & ARCHITECTURE (PORTED FROM 0117) -->
        <!-- ======================================================= -->
        <section id="logic-visualization" class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden scroll-mt-24">
            <!-- Section Header (Styled like Playground) -->
            <div class="border-b border-slate-200 bg-emerald-50 px-6 py-4">
                <h2 class="text-lg font-bold text-slate-800 flex items-center">
                    <span class="bg-emerald-600 text-white p-1 rounded mr-3 text-xs shadow-sm font-mono">L</span>
                    Logic & Code Architecture
                </h2>
                <p class="text-sm text-slate-600 mt-2">Visual flowchart showing how the indicator processes data.</p>
            </div>

            <!-- LOGIC FIGURE STRUCTURE -->
            <figure class="logic-figure" style="border: none; border-radius: 0;">
                <!-- 1. Code Panel Toggle Button -->
                <button id="code-panel-toggle-btn" onclick="toggleCodePanel()" title="View Source Code" class="font-bold text-xs">
                    CODE
                </button>

                <!-- 2. Infinite Canvas Layer -->
                <div id="canvas-container" class="chart-scroll-wrapper">
                    <div id="canvas-content" class="mermaid" style="position: absolute; top:0; left:0;">
                        flowchart TD;
subgraph INGESTION["Phase 1: Ingestion"];
A[/"Receive OHLC Price Data"/];
B["Capture Price Range Components"];
C["Define Channel Parameters"];
end;
subgraph EVALUATION["Phase 2: Evaluation"];
D["Calculate Trend Baseline via EMA"];
E["Measure True Range Volatility"];
F["Smooth Volatility via ATR"];
end;
subgraph WEIGHTING["Phase 3: Weighting"];
G["Apply Volatility Multiplier"];
H["Define Upper Boundary Offset"];
I["Define Lower Boundary Offset"];
end;
subgraph SYNTHESIS["Phase 4: Synthesis"];
J["Construct Upper Channel"];
K["Establish Center Line"];
L["Construct Lower Channel"];
end;
subgraph OUTCOME["Phase 5: Outcome"];
M{"Price Position Assessment?"};
N["Above Upper = Breakout/Overbought"];
O["Below Lower = Breakdown/Oversold"];
P["At Center = Fair Value Zone"];
Q[/"Generate Volatility Channel Signal"/];
end;
A --> B;
B --> C;
C --> D;
D --> E;
E --> F;
F --> G;
G --> H;
H --> I;
I --> J;
J --> K;
K --> L;
L --> M;
M -->|Breakout| N;
M -->|Breakdown| O;
M -->|Center| P;
N --> Q;
O --> Q;
P --> Q;
style INGESTION fill:#e3f2fd;
style EVALUATION fill:#fff3e0;
style WEIGHTING fill:#e8f5e9;
style SYNTHESIS fill:#fce4ec;
style OUTCOME fill:#f3e5f5;
                    </div>
                </div>

                <!-- 3. Canvas Controls (Zoom) -->
                <div class="absolute top-4 right-4 flex flex-col gap-2 z-20">
                    <button onclick="if(window.resetView) window.resetView()" class="p-2 bg-white rounded shadow border border-slate-200 hover:bg-slate-50 text-slate-600 font-mono text-xs" title="Reset View">R</button>
                    <button onclick="if(window.zoomAction) window.zoomAction('in')" class="p-2 bg-white rounded shadow border border-slate-200 hover:bg-slate-50 text-slate-600 font-mono text-xs" title="Zoom In">+</button>
                    <button onclick="if(window.zoomAction) window.zoomAction('out')" class="p-2 bg-white rounded shadow border border-slate-200 hover:bg-slate-50 text-slate-600 font-mono text-xs" title="Zoom Out">-</button>
                </div>

                <!-- 4. Code Panel Overlay (Slide-in) -->
                <div id="code-panel-overlay" class="panel-hidden" onmousedown="event.stopPropagation();">
                    <!-- Header -->
                    <div class="flex justify-between items-center p-3 border-b border-slate-200 bg-slate-50 shrink-0">
                        <div class="flex gap-2">
                            <button id="btn-lang-csharp" class="px-2 py-1 text-xs rounded transition-colors text-slate-500 hover:bg-slate-100" onclick="setLang('csharp')">C#</button>
                            <button id="btn-lang-python" class="px-2 py-1 text-xs rounded transition-colors text-slate-500 hover:bg-slate-100" onclick="setLang('python')">Python</button>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="btn-type-simple" class="text-xs text-slate-500 hover:text-indigo-600 transition-colors" onclick="setType('simple')">Simple</button>
                            <button id="btn-type-detailed" class="text-xs text-slate-500 hover:text-indigo-600 transition-colors" onclick="setType('detailed')">Detailed</button>
                            <!-- Copy -->
                            <button id="btn-copy-code" class="ml-2 text-slate-500 hover:text-slate-800 transition-colors" onclick="copyCode()" title="Copy Code">
                                <svg id="icon-copy" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                                <svg id="icon-copy-done" class="hidden text-green-600" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                            </button>
                            <!-- Expand/Collapse -->
                            <button id="btn-panel-expand" class="text-slate-500 hover:text-slate-800 transition-colors" onclick="toggleExpand()" title="Toggle Width">
                                <svg id="icon-expand" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M15 3h6v6" /><path d="M9 21H3v-6" /><path d="M21 3l-7 7" /><path d="M3 21l7-7" />
                                </svg>
                                <svg id="icon-collapse" class="hidden" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 14h6v6" /><path d="M20 10h-6V4" /><path d="M14 10l7-7" /><path d="M10 14l-7 7" />
                                </svg>
                            </button>
                            <!-- Close -->
                            <button class="text-slate-500 hover:text-red-600 transition-colors" onclick="toggleCodePanel()" title="Close Panel">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <!-- Body -->
                    <div class="code-panel-body custom-scrollbar p-4">
                        <div id="code-csharp-simple" class="code-content hidden"><div class="highlight"><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">1</span><span class="k">using</span> System;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">2</span><span class="k">using</span> System.Collections.Generic;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">3</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">4</span><span class="k">namespace</span> TechnicalIndicators</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">5</span>{</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">6</span>    <span class="c1">/// &lt;summary&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">7</span>    <span class="c1">/// Keltner Channel</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">8</span>    <span class="c1">/// &lt;/summary&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">9</span>    <span class="c1">/// &lt;remarks&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">10</span>    <span class="c1">/// Volatility-based bands using EMA and ATR.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">11</span>    <span class="c1">/// &lt;list type=&quot;bullet&quot;&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">12</span>    <span class="c1">/// &lt;item&gt;&lt;description&gt;Middle = EMA(Close)&lt;/description&gt;&lt;/item&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">13</span>    <span class="c1">/// &lt;item&gt;&lt;description&gt;Upper = Middle + Multiplier * ATR&lt;/description&gt;&lt;/item&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">14</span>    <span class="c1">/// &lt;item&gt;&lt;description&gt;Lower = Middle - Multiplier * ATR&lt;/description&gt;&lt;/item&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">15</span>    <span class="c1">/// &lt;/list&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">16</span>    <span class="c1">/// &lt;/remarks&gt;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">17</span>    <span class="k">public</span> <span class="k">class</span> <span class="nc">KeltnerChannel</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">18</span>    {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">19</span>        <span class="k">public</span> <span class="kt">int</span> EmaPeriod { <span class="k">get</span>; }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">20</span>        <span class="k">public</span> <span class="kt">int</span> AtrPeriod { <span class="k">get</span>; }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">21</span>        <span class="k">public</span> <span class="kt">decimal</span> Multiplier { <span class="k">get</span>; }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">22</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">23</span>        <span class="k">public</span> List&lt;<span class="kt">decimal?</span>&gt; UpperBand { <span class="k">get</span>; } = <span class="k">new</span>();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">24</span>        <span class="k">public</span> List&lt;<span class="kt">decimal?</span>&gt; MiddleBand { <span class="k">get</span>; } = <span class="k">new</span>();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">25</span>        <span class="k">public</span> List&lt;<span class="kt">decimal?</span>&gt; LowerBand { <span class="k">get</span>; } = <span class="k">new</span>();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">26</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">27</span>        <span class="k">public</span> KeltnerChannel(<span class="kt">int</span> emaPeriod = 20, <span class="kt">int</span> atrPeriod = 10, <span class="kt">decimal</span> multiplier = 2.0m)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">28</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">29</span>            EmaPeriod = emaPeriod;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">30</span>            AtrPeriod = atrPeriod;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">31</span>            Multiplier = multiplier;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">32</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">33</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">34</span>        <span class="k">public</span> <span class="k">void</span> Calculate(IEnumerable&lt;CandleData&gt; candles)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">35</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">36</span>            UpperBand.Clear(); MiddleBand.Clear(); LowerBand.Clear();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">37</span>            <span class="kt">var</span> candleList = <span class="k">new</span> List&lt;CandleData&gt;(candles);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">38</span>            <span class="k">if</span> (candleList.Count == 0) <span class="k">return</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">39</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">40</span>            <span class="c1">// Step 1: Middle Band (EMA)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">41</span>            <span class="kt">var</span> ema = CalculateEma(candleList, EmaPeriod);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">42</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">43</span>            <span class="c1">// Step 2: Volatility (ATR)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">44</span>            <span class="kt">var</span> atr = CalculateAtr(candleList, AtrPeriod);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">45</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">46</span>            <span class="c1">// Step 3: Bands</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">47</span>            <span class="k">for</span> (<span class="kt">int</span> i = 0; i &lt; candleList.Count; i++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">48</span>            {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">49</span>                <span class="k">if</span> (i &lt; ema.Count &amp;&amp; i &lt; atr.Count &amp;&amp; ema[i].HasValue &amp;&amp; atr[i].HasValue)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">50</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">51</span>                    MiddleBand.Add(ema[i]);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">52</span>                    UpperBand.Add(ema[i]!.Value + Multiplier * atr[i]!.Value);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">53</span>                    LowerBand.Add(ema[i]!.Value - Multiplier * atr[i]!.Value);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">54</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">55</span>                <span class="k">else</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">56</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">57</span>                    UpperBand.Add(<span class="k">null</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">58</span>                    MiddleBand.Add(<span class="k">null</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">59</span>                    LowerBand.Add(<span class="k">null</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">60</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">61</span>            }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">62</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">63</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">64</span>        <span class="k">private</span> <span class="k">static</span> List&lt;<span class="kt">decimal?</span>&gt; CalculateEma(List&lt;CandleData&gt; candles, <span class="kt">int</span> period)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">65</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">66</span>            <span class="kt">var</span> results = <span class="k">new</span> List&lt;<span class="kt">decimal?</span>&gt;();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">67</span>            <span class="kt">decimal</span> k = 2.0m / (period + 1);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">68</span>            <span class="kt">decimal?</span> prevEma = <span class="k">null</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">69</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">70</span>            <span class="k">for</span> (<span class="kt">int</span> i = 0; i &lt; candles.Count; i++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">71</span>            {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">72</span>                <span class="k">if</span> (i &lt; period - 1) { results.Add(<span class="k">null</span>); <span class="k">continue</span>; }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">73</span>                </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">74</span>                <span class="k">if</span> (i == period - 1)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">75</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">76</span>                    <span class="kt">decimal</span> sum = 0;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">77</span>                    <span class="k">for</span> (<span class="kt">int</span> j = 0; j &lt; period; j++) sum += candles[i - j].Close;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">78</span>                    prevEma = sum / period;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">79</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">80</span>                <span class="k">else</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">81</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">82</span>                    prevEma = (candles[i].Close - prevEma!.Value) * k + prevEma.Value;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">83</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">84</span>                results.Add(prevEma);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">85</span>            }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">86</span>            <span class="k">return</span> results;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">87</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">88</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">89</span>        <span class="k">private</span> <span class="k">static</span> List&lt;<span class="kt">decimal?</span>&gt; CalculateAtr(List&lt;CandleData&gt; candles, <span class="kt">int</span> period)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">90</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">91</span>            <span class="kt">var</span> results = <span class="k">new</span> List&lt;<span class="kt">decimal?</span>&gt;();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">92</span>            <span class="kt">var</span> trueRanges = <span class="k">new</span> List&lt;<span class="kt">decimal</span>&gt; { candles[0].High - candles[0].Low };</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">93</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">94</span>            <span class="k">for</span> (<span class="kt">int</span> i = 1; i &lt; candles.Count; i++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">95</span>            {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">96</span>                <span class="kt">decimal</span> tr1 = candles[i].High - candles[i].Low;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">97</span>                <span class="kt">decimal</span> tr2 = Math.Abs(candles[i].High - candles[i - 1].Close);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">98</span>                <span class="kt">decimal</span> tr3 = Math.Abs(candles[i].Low - candles[i - 1].Close);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">99</span>                trueRanges.Add(Math.Max(tr1, Math.Max(tr2, tr3)));</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">100</span>            }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">101</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">102</span>            <span class="k">for</span> (<span class="kt">int</span> i = 0; i &lt; candles.Count; i++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">103</span>            {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">104</span>                <span class="k">if</span> (i &lt; period - 1) { results.Add(<span class="k">null</span>); <span class="k">continue</span>; }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">105</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">106</span>                <span class="k">if</span> (i == period - 1)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">107</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">108</span>                    <span class="kt">decimal</span> sum = 0;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">109</span>                    <span class="k">for</span> (<span class="kt">int</span> j = 0; j &lt; period; j++) sum += trueRanges[j];</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">110</span>                    results.Add(sum / period);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">111</span>                    <span class="k">continue</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">112</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">113</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">114</span>                <span class="kt">decimal</span> prevAtr = results[i - 1]!.Value;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">115</span>                results.Add((prevAtr * (period - 1) + trueRanges[i]) / period);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">116</span>            }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">117</span>            <span class="k">return</span> results;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">118</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">119</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">120</span>        <span class="k">public</span> static (List&lt;<span class="kt">decimal?</span>&gt; upper, List&lt;<span class="kt">decimal?</span>&gt; middle, List&lt;<span class="kt">decimal?</span>&gt; lower) Calculate(</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">121</span>            IEnumerable&lt;CandleData&gt; candles, <span class="kt">int</span> emaPeriod = 20, <span class="kt">int</span> atrPeriod = 10, <span class="kt">decimal</span> multiplier = 2.0m)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">122</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">123</span>            <span class="kt">var</span> kc = <span class="k">new</span> KeltnerChannel(emaPeriod, atrPeriod, multiplier);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">124</span>            kc.Calculate(candles);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">125</span>            <span class="k">return</span> (kc.UpperBand, kc.MiddleBand, kc.LowerBand);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">126</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">127</span>    }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">128</span>}</div></div></div>
                        <div id="code-csharp-detailed" class="code-content hidden"><div class="highlight"><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">1</span><span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">2</span><span class="c1">// Logic Breakdown (KeltnerChannel)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">3</span><span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">4</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">5</span><span class="c1">// This document provides a &quot;Deep Dive&quot; into the internal logic of the</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">6</span><span class="c1">// Keltner Channel technical indicator.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">7</span><span class="c1">// We explain *why* code is written this way and *how* data transforms</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">8</span><span class="c1">// line-by-line, targeting programming beginners.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">9</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">10</span><span class="c1">// [Core Concepts]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">11</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">12</span><span class="c1">// 1. What is Keltner Channel?</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">13</span><span class="c1">//    [Origin]  Created by Chester Keltner in the 1960s, modernized by Linda Raschke.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">14</span><span class="c1">//    [Purpose] Volatility band that shows overbought/oversold conditions and trends.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">15</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">16</span><span class="c1">// 2. Keltner vs Bollinger Bands</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">17</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">18</span><span class="c1">//    | Feature      | Keltner Channel          | Bollinger Bands          |</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">19</span><span class="c1">//    |--------------|--------------------------|--------------------------|</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">20</span><span class="c1">//    | Center Line  | EMA                      | SMA                      |</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">21</span><span class="c1">//    | Band Width   | ATR (Average True Range) | Standard Deviation       |</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">22</span><span class="c1">//    | Stability    | More stable              | More volatile            |</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">23</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">24</span><span class="c1">//    [Why ATR?]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">25</span><span class="c1">//      ATR is based on True Range (considers gaps).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">26</span><span class="c1">//      Standard deviation can spike dramatically on single large moves.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">27</span><span class="c1">//      ATR provides a more stable measure of &quot;normal&quot; price movement.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">28</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">29</span><span class="c1">// 3. The Three Lines</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">30</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">31</span><span class="c1">//    [Formula]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">32</span><span class="c1">//      Middle = EMA(Close, EmaPeriod)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">33</span><span class="c1">//      Upper  = Middle + Multiplier  ATR</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">34</span><span class="c1">//      Lower  = Middle - Multiplier  ATR</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">35</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">36</span><span class="c1">//    [Visual]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">37</span><span class="c1">//        Upper Band</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">38</span><span class="c1">//            ~~~~@~~~~~@~~~       Price</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">39</span><span class="c1">//        Middle (EMA)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">40</span><span class="c1">//            ~~~~@~~~~~@~~~</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">41</span><span class="c1">//        Lower Band</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">42</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">43</span><span class="c1">// 4. Signal Interpretation</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">44</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">45</span><span class="c1">//    | Signal              | Meaning                      |</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">46</span><span class="c1">//    |---------------------|------------------------------|</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">47</span><span class="c1">//    | Break above Upper   | Strong uptrend / Overbought  |</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">48</span><span class="c1">//    | Break below Lower   | Strong downtrend / Oversold  |</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">49</span><span class="c1">//    | Channel narrowing   | Consolidation, expect move   |</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">50</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">51</span><span class="c1">// [Data Flow]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">52</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">53</span><span class="c1">//   Input: CandleData[N]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">54</span><span class="c1">//       </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">55</span><span class="c1">//   Step 1: Calculate EMA (EmaPeriod) -&gt; MiddleBand</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">56</span><span class="c1">//       </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">57</span><span class="c1">//   Step 2: Calculate ATR (AtrPeriod)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">58</span><span class="c1">//       </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">59</span><span class="c1">//   Step 3: Upper = EMA + Mult  ATR</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">60</span><span class="c1">//           Lower = EMA - Mult  ATR</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">61</span><span class="c1">//       </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">62</span><span class="c1">//   Output: (Upper[], Middle[], Lower[])</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">63</span><span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">64</span><span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">65</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">66</span><span class="k">using</span> System;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">67</span><span class="k">using</span> System.Collections.Generic;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">68</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">69</span><span class="k">namespace</span> TechnicalIndicators</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">70</span>{</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">71</span>    <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">72</span>    <span class="c1">// Logic Explanation: OHLCV Data Container</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">73</span>    <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">74</span>    <span class="k">public</span> <span class="k">readonly</span> <span class="k">record</span> <span class="k">struct</span> CandleData(</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">75</span>        DateTime Timestamp,</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">76</span>        <span class="kt">decimal</span> Open,</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">77</span>        <span class="kt">decimal</span> High,</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">78</span>        <span class="kt">decimal</span> Low,</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">79</span>        <span class="kt">decimal</span> Close,</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">80</span>        <span class="kt">long</span> Volume</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">81</span>    );</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">82</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">83</span>    <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">84</span>    <span class="c1">// Logic Explanation: Keltner Channel Class</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">85</span>    <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">86</span>    <span class="k">public</span> <span class="k">class</span> <span class="nc">KeltnerChannel</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">87</span>    {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">88</span>        <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">89</span>        <span class="c1">// Logic Explanation: Configuration</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">90</span>        <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">91</span>        <span class="c1">// [EmaPeriod]   Period for the center EMA line.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">92</span>        <span class="c1">// [AtrPeriod]   Period for ATR calculation.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">93</span>        <span class="c1">// [Multiplier]  How many ATRs to add/subtract for bands.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">94</span>        <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">95</span>        <span class="k">public</span> <span class="kt">int</span> EmaPeriod { <span class="k">get</span>; }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">96</span>        <span class="k">public</span> <span class="kt">int</span> AtrPeriod { <span class="k">get</span>; }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">97</span>        <span class="k">public</span> <span class="kt">decimal</span> Multiplier { <span class="k">get</span>; }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">98</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">99</span>        <span class="k">public</span> List&lt;<span class="kt">decimal?</span>&gt; UpperBand { <span class="k">get</span>; } = <span class="k">new</span>();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">100</span>        <span class="k">public</span> List&lt;<span class="kt">decimal?</span>&gt; MiddleBand { <span class="k">get</span>; } = <span class="k">new</span>();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">101</span>        <span class="k">public</span> List&lt;<span class="kt">decimal?</span>&gt; LowerBand { <span class="k">get</span>; } = <span class="k">new</span>();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">102</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">103</span>        <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">104</span>        <span class="c1">// Logic Explanation: Constructor</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">105</span>        <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">106</span>        <span class="k">public</span> KeltnerChannel(<span class="kt">int</span> emaPeriod = 20, <span class="kt">int</span> atrPeriod = 10, <span class="kt">decimal</span> multiplier = 2.0m)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">107</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">108</span>            EmaPeriod = emaPeriod;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">109</span>            AtrPeriod = atrPeriod;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">110</span>            Multiplier = multiplier;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">111</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">112</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">113</span>        <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">114</span>        <span class="c1">// Logic Explanation: Main Calculation Method</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">115</span>        <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">116</span>        <span class="k">public</span> <span class="k">void</span> Calculate(IEnumerable&lt;CandleData&gt; candles)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">117</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">118</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">119</span>            <span class="c1">// Step 1: Cleanup</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">120</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">121</span>            UpperBand.Clear();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">122</span>            MiddleBand.Clear();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">123</span>            LowerBand.Clear();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">124</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">125</span>            <span class="kt">var</span> candleList = <span class="k">new</span> List&lt;CandleData&gt;(candles);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">126</span>            <span class="k">if</span> (candleList.Count == 0) <span class="k">return</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">127</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">128</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">129</span>            <span class="c1">// Step 2: Calculate EMA (for Middle Band)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">130</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">131</span>            <span class="kt">var</span> ema = CalculateEma(candleList, EmaPeriod);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">132</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">133</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">134</span>            <span class="c1">// Step 3: Calculate ATR (for Band Width)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">135</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">136</span>            <span class="kt">var</span> atr = CalculateAtr(candleList, AtrPeriod);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">137</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">138</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">139</span>            <span class="c1">// Step 4: Combine to Create Bands</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">140</span>            <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">141</span>            <span class="c1">// [Formula]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">142</span>            <span class="c1">//   Middle = EMA</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">143</span>            <span class="c1">//   Upper  = EMA + Multiplier  ATR</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">144</span>            <span class="c1">//   Lower  = EMA - Multiplier  ATR</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">145</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">146</span>            <span class="k">for</span> (<span class="kt">int</span> i = 0; i &lt; candleList.Count; i++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">147</span>            {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">148</span>                <span class="k">if</span> (i &lt; ema.Count &amp;&amp; i &lt; atr.Count &amp;&amp; ema[i].HasValue &amp;&amp; atr[i].HasValue)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">149</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">150</span>                    MiddleBand.Add(ema[i]);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">151</span>                    UpperBand.Add(ema[i]!.Value + Multiplier * atr[i]!.Value);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">152</span>                    LowerBand.Add(ema[i]!.Value - Multiplier * atr[i]!.Value);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">153</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">154</span>                <span class="k">else</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">155</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">156</span>                    UpperBand.Add(<span class="k">null</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">157</span>                    MiddleBand.Add(<span class="k">null</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">158</span>                    LowerBand.Add(<span class="k">null</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">159</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">160</span>            }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">161</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">162</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">163</span>        <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">164</span>        <span class="c1">// Helper Method: CalculateEma</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">165</span>        <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">166</span>        <span class="c1">// [IPO Block]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">167</span>        <span class="c1">// Input:   List&lt;CandleData&gt; candles, int period</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">168</span>        <span class="c1">// Process: Standard EMA calculation using Close prices</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">169</span>        <span class="c1">// Output:  List&lt;decimal?&gt; of EMA values</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">170</span>        <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">171</span>        <span class="c1">// [Formula]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">172</span>        <span class="c1">//   k = 2 / (period + 1)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">173</span>        <span class="c1">//   EMA[i] = (Close - PrevEMA) * k + PrevEMA</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">174</span>        <span class="c1">//   First EMA = SMA of first &#x27;period&#x27; closes</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">175</span>        <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">176</span>        <span class="k">private</span> <span class="k">static</span> List&lt;<span class="kt">decimal?</span>&gt; CalculateEma(List&lt;CandleData&gt; candles, <span class="kt">int</span> period)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">177</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">178</span>            <span class="kt">var</span> results = <span class="k">new</span> List&lt;<span class="kt">decimal?</span>&gt;();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">179</span>            <span class="kt">decimal</span> k = 2.0m / (period + 1);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">180</span>            <span class="kt">decimal?</span> prevEma = <span class="k">null</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">181</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">182</span>            <span class="k">for</span> (<span class="kt">int</span> i = 0; i &lt; candles.Count; i++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">183</span>            {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">184</span>                <span class="c1">// [Phase A] Not enough data yet</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">185</span>                <span class="k">if</span> (i &lt; period - 1)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">186</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">187</span>                    results.Add(<span class="k">null</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">188</span>                    <span class="k">continue</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">189</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">190</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">191</span>                <span class="c1">// [Phase B] Bootstrap with SMA</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">192</span>                <span class="k">if</span> (i == period - 1)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">193</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">194</span>                    <span class="kt">decimal</span> sum = 0;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">195</span>                    <span class="k">for</span> (<span class="kt">int</span> j = 0; j &lt; period; j++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">196</span>                        sum += candles[i - j].Close;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">197</span>                    </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">198</span>                    prevEma = sum / period;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">199</span>                    results.Add(prevEma);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">200</span>                    <span class="k">continue</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">201</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">202</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">203</span>                <span class="c1">// [Phase C] Recursive EMA calculation</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">204</span>                <span class="k">if</span> (prevEma != <span class="k">null</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">205</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">206</span>                    <span class="kt">decimal</span> ema = (candles[i].Close - prevEma.Value) * k + prevEma.Value;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">207</span>                    results.Add(ema);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">208</span>                    prevEma = ema;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">209</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">210</span>                <span class="k">else</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">211</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">212</span>                    results.Add(<span class="k">null</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">213</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">214</span>            }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">215</span>            <span class="k">return</span> results;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">216</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">217</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">218</span>        <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">219</span>        <span class="c1">// Helper Method: CalculateAtr</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">220</span>        <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">221</span>        <span class="c1">// [IPO Block]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">222</span>        <span class="c1">// Input:   List&lt;CandleData&gt; candles, int period</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">223</span>        <span class="c1">// Process: Calculate True Range, then smooth with Wilder&#x27;s method</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">224</span>        <span class="c1">// Output:  List&lt;decimal?&gt; of ATR values</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">225</span>        <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">226</span>        <span class="c1">// [True Range Formula]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">227</span>        <span class="c1">//   TR = max(High - Low,</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">228</span>        <span class="c1">//            |High - PrevClose|,</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">229</span>        <span class="c1">//            |Low - PrevClose|)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">230</span>        <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">231</span>        <span class="c1">// [Why these 3?]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">232</span>        <span class="c1">//   - High - Low: Normal intraday range</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">233</span>        <span class="c1">//   - |High - PrevClose|: Gap up scenario</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">234</span>        <span class="c1">//   - |Low - PrevClose|: Gap down scenario</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">235</span>        <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">236</span>        <span class="c1">// [Visual: True Range Cases]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">237</span>        <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">238</span>        <span class="c1">//   Case 1: Normal        Case 2: Gap Up       Case 3: Gap Down</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">239</span>        <span class="c1">//     High             High           PrevClose </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">240</span>        <span class="c1">//                                                  Gap </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">241</span>        <span class="c1">//     Low            PrevClose             High</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">242</span>        <span class="c1">//                                                  </span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">243</span>        <span class="c1">//   TR = High - Low       TR = High - PrevClose    Low</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">244</span>        <span class="c1">//                                               TR = PrevClose - Low</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">245</span>        <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">246</span>        <span class="c1">// [ATR Smoothing] Wilder&#x27;s method:</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">247</span>        <span class="c1">//   ATR[i] = (ATR[i-1]  (period-1) + TR[i]) / period</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">248</span>        <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">249</span>        <span class="k">private</span> <span class="k">static</span> List&lt;<span class="kt">decimal?</span>&gt; CalculateAtr(List&lt;CandleData&gt; candles, <span class="kt">int</span> period)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">250</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">251</span>            <span class="kt">var</span> results = <span class="k">new</span> List&lt;<span class="kt">decimal?</span>&gt;();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">252</span>            <span class="k">if</span> (candles.Count == 0) <span class="k">return</span> results;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">253</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">254</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">255</span>            <span class="c1">// Step A: Calculate True Ranges for all candles</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">256</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">257</span>            <span class="kt">var</span> trueRanges = <span class="k">new</span> List&lt;<span class="kt">decimal</span>&gt;();</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">258</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">259</span>            <span class="c1">// First candle: No previous close, use High - Low</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">260</span>            trueRanges.Add(candles[0].High - candles[0].Low);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">261</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">262</span>            <span class="k">for</span> (<span class="kt">int</span> i = 1; i &lt; candles.Count; i++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">263</span>            {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">264</span>                <span class="kt">decimal</span> tr1 = candles[i].High - candles[i].Low;               <span class="c1">// Normal range</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">265</span>                <span class="kt">decimal</span> tr2 = Math.Abs(candles[i].High - candles[i - 1].Close); <span class="c1">// Gap up</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">266</span>                <span class="kt">decimal</span> tr3 = Math.Abs(candles[i].Low - candles[i - 1].Close);  <span class="c1">// Gap down</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">267</span>                </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">268</span>                trueRanges.Add(Math.Max(tr1, Math.Max(tr2, tr3)));</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">269</span>            }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">270</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">271</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">272</span>            <span class="c1">// Step B: Calculate ATR using Wilder&#x27;s Smoothing</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">273</span>            <span class="c1">// -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">274</span>            <span class="k">for</span> (<span class="kt">int</span> i = 0; i &lt; candles.Count; i++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">275</span>            {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">276</span>                <span class="c1">// [Phase A] Not enough data</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">277</span>                <span class="k">if</span> (i &lt; period - 1)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">278</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">279</span>                    results.Add(<span class="k">null</span>);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">280</span>                    <span class="k">continue</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">281</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">282</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">283</span>                <span class="c1">// [Phase B] First ATR is SMA of True Ranges</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">284</span>                <span class="k">if</span> (i == period - 1)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">285</span>                {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">286</span>                    <span class="kt">decimal</span> sum = 0;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">287</span>                    <span class="k">for</span> (<span class="kt">int</span> j = 0; j &lt; period; j++)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">288</span>                        sum += trueRanges[j];</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">289</span>                    </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">290</span>                    results.Add(sum / period);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">291</span>                    <span class="k">continue</span>;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">292</span>                }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">293</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">294</span>                <span class="c1">// [Phase C] Wilder&#x27;s smoothing</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">295</span>                <span class="kt">decimal</span> prevAtr = results[i - 1]!.Value;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">296</span>                results.Add((prevAtr * (period - 1) + trueRanges[i]) / period);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">297</span>            }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">298</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">299</span>            <span class="k">return</span> results;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">300</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">301</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">302</span>        <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">303</span>        <span class="c1">// Logic Explanation: Static Convenience Wrapper</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">304</span>        <span class="c1">//</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">305</span>        <span class="c1">// [IPO Block]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">306</span>        <span class="c1">// Input:   IEnumerable&lt;CandleData&gt;, parameters</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">307</span>        <span class="c1">// Process: Creates instance, runs Calculate()</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">308</span>        <span class="c1">// Output:  Tuple of (Upper, Middle, Lower) band lists</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">309</span>        <span class="c1">// =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">310</span>        <span class="k">public</span> static (List&lt;<span class="kt">decimal?</span>&gt; upper, List&lt;<span class="kt">decimal?</span>&gt; middle, List&lt;<span class="kt">decimal?</span>&gt; lower) Calculate(</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">311</span>            IEnumerable&lt;CandleData&gt; candles, <span class="kt">int</span> emaPeriod = 20, <span class="kt">int</span> atrPeriod = 10, <span class="kt">decimal</span> multiplier = 2.0m)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">312</span>        {</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">313</span>            <span class="kt">var</span> kc = <span class="k">new</span> KeltnerChannel(emaPeriod, atrPeriod, multiplier);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">314</span>            kc.Calculate(candles);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">315</span>            <span class="k">return</span> (kc.UpperBand, kc.MiddleBand, kc.LowerBand);</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">316</span>        }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">317</span>    }</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">318</span>}</div></div></div>
                        <div id="code-python-simple" class="code-content hidden"><div class="highlight"><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">1</span><span class="kn">import</span> math</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">2</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">3</span><span class="k">class</span> <span class="nc">KeltnerChannel</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">4</span>    <span class="sd">&quot;&quot;&quot;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">5</span><span class="sd">    Keltner Channel</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">6</span><span class="sd">    EMA +/- ATR Bands.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">7</span><span class="sd">    &quot;&quot;&quot;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">8</span>    <span class="k">def</span> __init__(self, ema_period=20, atr_period=10, multiplier=2.0):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">9</span>        self.ema_period = ema_period</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">10</span>        self.atr_period = atr_period</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">11</span>        self.multiplier = multiplier</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">12</span>        self.upper = []</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">13</span>        self.middle = []</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">14</span>        self.lower = []</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">15</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">16</span>    <span class="k">def</span> calculate(self, candles):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">17</span>        self.upper.clear()</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">18</span>        self.middle.clear()</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">19</span>        self.lower.clear()</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">20</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">21</span>        <span class="k">if</span> len(candles) == 0: <span class="k">return</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">22</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">23</span>        <span class="c1"># 1. EMA</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">24</span>        ema = self._calculate_ema(candles, self.ema_period)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">25</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">26</span>        <span class="c1"># 2. ATR</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">27</span>        atr = self._calculate_atr(candles, self.atr_period)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">28</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">29</span>        <span class="c1"># 3. Combine</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">30</span>        <span class="k">for</span> i <span class="ow">in</span> range(len(candles)):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">31</span>            <span class="k">if</span> i &lt; len(ema) <span class="ow">and</span> i &lt; len(atr) <span class="ow">and</span> ema[i] <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> atr[i] <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">32</span>                self.middle.append(ema[i])</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">33</span>                offset = self.multiplier * atr[i]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">34</span>                self.upper.append(ema[i] + offset)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">35</span>                self.lower.append(ema[i] - offset)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">36</span>            <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">37</span>                self.upper.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">38</span>                self.middle.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">39</span>                self.lower.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">40</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">41</span>    <span class="k">def</span> _calculate_ema(self, candles, period):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">42</span>        results = []</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">43</span>        k = 2.0 / (period + 1)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">44</span>        prev_ema = <span class="kc">None</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">45</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">46</span>        <span class="k">for</span> i <span class="ow">in</span> range(len(candles)):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">47</span>            <span class="k">if</span> i &lt; period - 1:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">48</span>                results.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">49</span>                <span class="k">continue</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">50</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">51</span>            <span class="k">if</span> i == period - 1:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">52</span>                s = sum(float(candles[i-j][<span class="s1">&#x27;</span><span class="s1">close</span><span class="s1">&#x27;</span>]) <span class="k">for</span> j <span class="ow">in</span> range(period))</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">53</span>                prev_ema = s / period</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">54</span>            <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">55</span>                prev_ema = (float(candles[i][<span class="s1">&#x27;</span><span class="s1">close</span><span class="s1">&#x27;</span>]) - prev_ema) * k + prev_ema</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">56</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">57</span>            results.append(prev_ema)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">58</span>        <span class="k">return</span> results</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">59</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">60</span>    <span class="k">def</span> _calculate_atr(self, candles, period):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">61</span>        results = []</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">62</span>        <span class="c1"># True Ranges</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">63</span>        tr_list = [float(candles[0][<span class="s1">&#x27;</span><span class="s1">high</span><span class="s1">&#x27;</span>]) - float(candles[0][<span class="s1">&#x27;</span><span class="s1">low</span><span class="s1">&#x27;</span>])]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">64</span>        <span class="k">for</span> i <span class="ow">in</span> range(1, len(candles)):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">65</span>            tr1 = float(candles[i][<span class="s1">&#x27;</span><span class="s1">high</span><span class="s1">&#x27;</span>]) - float(candles[i][<span class="s1">&#x27;</span><span class="s1">low</span><span class="s1">&#x27;</span>])</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">66</span>            tr2 = abs(float(candles[i][<span class="s1">&#x27;</span><span class="s1">high</span><span class="s1">&#x27;</span>]) - float(candles[i-1][<span class="s1">&#x27;</span><span class="s1">close</span><span class="s1">&#x27;</span>]))</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">67</span>            tr3 = abs(float(candles[i][<span class="s1">&#x27;</span><span class="s1">low</span><span class="s1">&#x27;</span>]) - float(candles[i-1][<span class="s1">&#x27;</span><span class="s1">close</span><span class="s1">&#x27;</span>]))</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">68</span>            tr_list.append(max(tr1, tr2, tr3))</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">69</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">70</span>        prev_atr = <span class="kc">None</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">71</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">72</span>        <span class="k">for</span> i <span class="ow">in</span> range(len(candles)):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">73</span>            <span class="k">if</span> i &lt; period - 1:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">74</span>                results.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">75</span>                <span class="k">continue</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">76</span>                </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">77</span>            <span class="k">if</span> i == period - 1:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">78</span>                s = sum(tr_list[j] <span class="k">for</span> j <span class="ow">in</span> range(period))</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">79</span>                prev_atr = s / period</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">80</span>                results.append(prev_atr)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">81</span>                <span class="k">continue</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">82</span>                </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">83</span>            prev_atr = (prev_atr * (period - 1) + tr_list[i]) / period</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">84</span>            results.append(prev_atr)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">85</span>        <span class="k">return</span> results</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">86</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">87</span><span class="k">def</span> calculate(candles, ema_period=20, atr_period=10, multiplier=2.0):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">88</span>    kc = KeltnerChannel(ema_period, atr_period, multiplier)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">89</span>    kc.calculate(candles)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">90</span>    <span class="k">return</span> kc.upper, kc.middle, kc.lower</div></div></div>
                        <div id="code-python-detailed" class="code-content hidden"><div class="highlight"><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">1</span><span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">2</span><span class="c1"># Logic Breakdown (Keltner Channel)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">3</span><span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">4</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">5</span><span class="c1"># This document provides a &quot;Deep Dive&quot; into the internal logic of the</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">6</span><span class="c1"># Keltner Channel. We explain *why* code is written this way and *how* data</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">7</span><span class="c1"># transforms line-by-line, targeting beginners.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">8</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">9</span><span class="c1"># [Core Concepts]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">10</span><span class="c1"># 1. Volatility Envelope</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">11</span><span class="c1">#    Channels enclose the &quot;normal&quot; price action.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">12</span><span class="c1">#    - Bollinger Bands use Standard Deviation (Statistical).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">13</span><span class="c1">#    - Keltner Channels use Average True Range (ATR) (Absolute movement).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">14</span><span class="c1">#    [Why] ATR is often smoother and less prone to &quot;ballooning&quot; on single gap-ups than StdDev.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">15</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">16</span><span class="c1"># 2. Composition</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">17</span><span class="c1">#    - Middle Band: Exponential Moving Average (EMA). Center of gravity.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">18</span><span class="c1">#    - Upper Band: Middle + (Multiplier * ATR).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">19</span><span class="c1">#    - Lower Band: Middle - (Multiplier * ATR).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">20</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">21</span><span class="c1"># 3. Interpretation</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">22</span><span class="c1">#    - Price &gt; Upper Band: Extremely Strong Trend (Breakout).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">23</span><span class="c1">#    - Price &lt; Lower Band: Extremely Weak Trend (Breakdown).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">24</span><span class="c1">#    - Flat Slope: Mean reversion expectation.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">25</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">26</span><span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">27</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">28</span><span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">29</span><span class="c1"># Type-Level Explanation: KeltnerChannel (class)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">30</span><span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">31</span><span class="c1"># [Why]  Combines two distinct indicators (EMA + ATR) into one system.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">32</span><span class="c1"># [What] Trend-following volatility channel.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">33</span><span class="c1"># [How]  Generates a volatility envelope above and below an Exponential Moving Average (EMA) using the Average True Range (ATR) multiplied by a factor.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">34</span><span class="c1"># [Who]  Trend Traders (Linda Raschke version).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">35</span><span class="c1"># [Where] Heap.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">36</span><span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">37</span><span class="k">class</span> <span class="nc">KeltnerChannel</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">38</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">39</span>    <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">40</span>    <span class="c1"># Logic Explanation: Indicator Configuration (Public Properties)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">41</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">42</span>    <span class="c1"># [Why]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">43</span>    <span class="c1"># Keltner requires settings for both the Center Line (EMA)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">44</span>    <span class="c1"># and the Envelope Width (ATR).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">45</span>    <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">46</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">47</span>    <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">48</span>    <span class="c1"># Constructor: __init__</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">49</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">50</span>    <span class="c1"># [Input]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">51</span>    <span class="c1"># - ema_period: int (Default 20) - For Middle Band.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">52</span>    <span class="c1"># - atr_period: int (Default 10) - For Box Width.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">53</span>    <span class="c1"># - multiplier: float (Default 2.0) - Width scaler.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">54</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">55</span>    <span class="c1"># [Why]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">56</span>    <span class="c1"># Initialize implementation constants.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">57</span>    <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">58</span>    <span class="k">def</span> __init__(self, ema_period=20, atr_period=10, multiplier=2.0):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">59</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">60</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">61</span>        <span class="c1"># Logic Step 1: Validation</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">62</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">63</span>        <span class="k">if</span> ema_period &lt;= 1:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">64</span>            <span class="k">raise</span> ValueError(<span class="s2">&quot;</span><span class="s2">EMA Period must be &gt; 1.</span><span class="s2">&quot;</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">65</span>        <span class="k">if</span> atr_period &lt;= 1:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">66</span>            <span class="k">raise</span> ValueError(<span class="s2">&quot;</span><span class="s2">ATR Period must be &gt; 1.</span><span class="s2">&quot;</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">67</span>        <span class="k">if</span> multiplier &lt;= 0:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">68</span>            <span class="k">raise</span> ValueError(<span class="s2">&quot;</span><span class="s2">Multiplier must be &gt; 0.</span><span class="s2">&quot;</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">69</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">70</span>        self.ema_period = ema_period</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">71</span>        self.atr_period = atr_period</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">72</span>        self.multiplier = multiplier</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">73</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">74</span>        <span class="c1"># Outputs</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">75</span>        self.upper_band = []</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">76</span>        self.middle_band = []</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">77</span>        self.lower_band = []</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">78</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">79</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">80</span>    <span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">81</span>    <span class="c1"># IPO: calculate</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">82</span>    <span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">83</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">84</span>    <span class="c1"># [Input]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">85</span>    <span class="c1"># - candles: list[dict] (Must have &#x27;high&#x27;, &#x27;low&#x27;, &#x27;close&#x27;)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">86</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">87</span>    <span class="c1"># [Process]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">88</span>    <span class="c1"># 1. Compute EMA series (Middle Band).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">89</span>    <span class="c1"># 2. Compute ATR series (Volatility Width).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">90</span>    <span class="c1"># 3. Combine: Middle +/- (Multiplier * ATR).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">91</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">92</span>    <span class="c1"># [Output]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">93</span>    <span class="c1"># - None (populates lists)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">94</span>    <span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">95</span>    <span class="k">def</span> calculate(self, candles):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">96</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">97</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">98</span>        <span class="c1"># Logic Step 1: Reset</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">99</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">100</span>        self.upper_band.clear()</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">101</span>        self.middle_band.clear()</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">102</span>        self.lower_band.clear()</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">103</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">104</span>        count = len(candles)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">105</span>        <span class="k">if</span> count == 0:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">106</span>            <span class="k">return</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">107</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">108</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">109</span>        <span class="c1"># Logic Step 2: Calculate Components</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">110</span>        <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">111</span>        <span class="c1"># [Why]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">112</span>        <span class="c1"># Decompose the complex indicator into simpler building blocks.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">113</span>        <span class="c1"># This keeps the main loop clean (Separation of Concerns).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">114</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">115</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">116</span>        <span class="c1"># A. Middle Band (EMA)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">117</span>        ema_values = self._calc_ema(candles, self.ema_period)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">118</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">119</span>        <span class="c1"># B. Volatility (ATR)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">120</span>        atr_values = self._calc_atr(candles, self.atr_period)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">121</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">122</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">123</span>        <span class="c1"># Logic Step 3: Combine and Generate Bands</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">124</span>        <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">125</span>        <span class="k">for</span> i <span class="ow">in</span> range(count):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">126</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">127</span>            <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">128</span>            <span class="c1"># Logic Step 3.1: Synchronization</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">129</span>            <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">130</span>            <span class="c1"># [Decision] Do we have valid EMA and ATR for this index?</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">131</span>            <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">132</span>            ema = ema_values[i]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">133</span>            atr = atr_values[i]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">134</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">135</span>            <span class="k">if</span> ema <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> atr <span class="ow">is</span> <span class="kc">None</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">136</span>                self.upper_band.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">137</span>                self.middle_band.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">138</span>                self.lower_band.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">139</span>                <span class="k">continue</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">140</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">141</span>            <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">142</span>            <span class="c1"># Logic Step 3.2: Band Construction</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">143</span>            <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">144</span>            <span class="c1"># [Formula]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">145</span>            <span class="c1"># Up   = EMA + (Mult * ATR)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">146</span>            <span class="c1"># Low  = EMA - (Mult * ATR)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">147</span>            <span class="c1"># -------------------------------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">148</span>            self.middle_band.append(ema)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">149</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">150</span>            width = self.multiplier * atr</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">151</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">152</span>            self.upper_band.append(ema + width)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">153</span>            self.lower_band.append(ema - width)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">154</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">155</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">156</span>    <span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">157</span>    <span class="c1"># IPO: _calc_ema (Helper)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">158</span>    <span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">159</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">160</span>    <span class="c1"># [Input]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">161</span>    <span class="c1"># - candles: list[dict]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">162</span>    <span class="c1"># - period: int</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">163</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">164</span>    <span class="c1"># [Process]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">165</span>    <span class="c1"># Standard Exponential Moving Average. Uses SMA for seed.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">166</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">167</span>    <span class="c1"># [Output]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">168</span>    <span class="c1"># - list[float or None]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">169</span>    <span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">170</span>    <span class="k">def</span> _calc_ema(self, candles, period):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">171</span>        results = []</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">172</span>        count = len(candles)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">173</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">174</span>        <span class="c1"># Multiplier K = 2 / (N + 1)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">175</span>        k = 2.0 / (period + 1.0)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">176</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">177</span>        prev_ema = <span class="kc">None</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">178</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">179</span>        <span class="k">for</span> i <span class="ow">in</span> range(count):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">180</span>            current_close = candles[i][<span class="s1">&#x27;</span><span class="s1">close</span><span class="s1">&#x27;</span>]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">181</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">182</span>            <span class="c1"># Case A: Wait for data</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">183</span>            <span class="k">if</span> i &lt; period - 1:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">184</span>                results.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">185</span>                <span class="k">continue</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">186</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">187</span>            <span class="c1"># Case B: First valid point (Seed with SMA)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">188</span>            <span class="k">if</span> i == period - 1:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">189</span>                <span class="c1"># Sum last N prices</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">190</span>                s = 0.0</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">191</span>                <span class="k">for</span> j <span class="ow">in</span> range(period):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">192</span>                    s += candles[i - j][<span class="s1">&#x27;</span><span class="s1">close</span><span class="s1">&#x27;</span>]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">193</span>                prev_ema = s / period</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">194</span>                results.append(prev_ema)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">195</span>                <span class="k">continue</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">196</span>                </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">197</span>            <span class="c1"># Case C: Recursive EMA</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">198</span>            <span class="c1"># Formula: (Price - Prev) * K + Prev</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">199</span>            <span class="k">if</span> prev_ema <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">200</span>                ema = (current_close - prev_ema) * k + prev_ema</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">201</span>                results.append(ema)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">202</span>                prev_ema = ema</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">203</span>            <span class="k">else</span>:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">204</span>                <span class="c1"># Should not reach here if logic is correct</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">205</span>                results.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">206</span>                </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">207</span>        <span class="k">return</span> results</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">208</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">209</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">210</span>    <span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">211</span>    <span class="c1"># IPO: _calc_atr (Helper)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">212</span>    <span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">213</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">214</span>    <span class="c1"># [Input]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">215</span>    <span class="c1"># - candles: list[dict]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">216</span>    <span class="c1"># - period: int</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">217</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">218</span>    <span class="c1"># [Process]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">219</span>    <span class="c1"># 1. Transform Candle -&gt; True Range (TR).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">220</span>    <span class="c1">#    TR = Max(High-Low, Abs(High-PrevClose), Abs(Low-PrevClose)).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">221</span>    <span class="c1"># 2. Smooth TR using Wilder&#x27;s Smoothing (Smoothed Moving Average).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">222</span>    <span class="c1">#</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">223</span>    <span class="c1"># [Output]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">224</span>    <span class="c1"># - list[float or None]</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">225</span>    <span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">226</span>    <span class="k">def</span> _calc_atr(self, candles, period):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">227</span>        results = []</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">228</span>        count = len(candles)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">229</span>        <span class="k">if</span> count == 0:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">230</span>            <span class="k">return</span> results</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">231</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">232</span>        <span class="c1"># -------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">233</span>        <span class="c1"># Step A: Calculate True Range (TR) Series</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">234</span>        <span class="c1"># -------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">235</span>        <span class="c1"># [Why] Volatility must account for GAPS between days.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">236</span>        <span class="c1">#       Standard High-Low range misses overnight moves.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">237</span>        <span class="c1"># -------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">238</span>        tr_values = []</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">239</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">240</span>        <span class="c1"># First bar TR is just High - Low (No prev close)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">241</span>        tr_values.append(candles[0][<span class="s1">&#x27;</span><span class="s1">high</span><span class="s1">&#x27;</span>] - candles[0][<span class="s1">&#x27;</span><span class="s1">low</span><span class="s1">&#x27;</span>])</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">242</span>        </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">243</span>        <span class="k">for</span> i <span class="ow">in</span> range(1, count):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">244</span>            h = candles[i][<span class="s1">&#x27;</span><span class="s1">high</span><span class="s1">&#x27;</span>]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">245</span>            l = candles[i][<span class="s1">&#x27;</span><span class="s1">low</span><span class="s1">&#x27;</span>]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">246</span>            prev_c = candles[i - 1][<span class="s1">&#x27;</span><span class="s1">close</span><span class="s1">&#x27;</span>]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">247</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">248</span>            <span class="c1"># TR definition</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">249</span>            range1 = h - l</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">250</span>            range2 = abs(h - prev_c)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">251</span>            range3 = abs(l - prev_c)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">252</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">253</span>            tr_values.append(max(range1, range2, range3))</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">254</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">255</span>        <span class="c1"># -------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">256</span>        <span class="c1"># Step B: Wilder Smoothing (SMMA)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">257</span>        <span class="c1"># -------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">258</span>        <span class="c1"># [Note] Wilder&#x27;s Smoothing is essentially EMA with alpha = 1 / N.</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">259</span>        <span class="c1"># -------------------------------------</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">260</span>        <span class="k">for</span> i <span class="ow">in</span> range(count):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">261</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">262</span>            <span class="c1"># Wait for data</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">263</span>            <span class="k">if</span> i &lt; period - 1:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">264</span>                results.append(<span class="kc">None</span>)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">265</span>                <span class="k">continue</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">266</span>                </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">267</span>            <span class="c1"># First value: SMA of TR</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">268</span>            <span class="k">if</span> i == period - 1:</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">269</span>                s = sum(tr_values[:period])</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">270</span>                results.append(s / period)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">271</span>                <span class="k">continue</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">272</span>                </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">273</span>            <span class="c1"># Recursive Step</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">274</span>            <span class="c1"># ATR = (PrevATR * (N-1) + CurrentTR) / N</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">275</span>            prev_atr = results[i - 1]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">276</span>            current_tr = tr_values[i]</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">277</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">278</span>            atr = (prev_atr * (period - 1) + current_tr) / period</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">279</span>            results.append(atr)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">280</span>            </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">281</span>        <span class="k">return</span> results</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">282</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">283</span>&#8203;</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">284</span><span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">285</span><span class="c1"># Functional Wrapper (Procedural Interface)</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">286</span><span class="c1"># =============================================================================</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">287</span><span class="k">def</span> calculate(candles, ema_period=20, atr_period=10, multiplier=2.0):</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">288</span>    <span class="sd">&quot;&quot;&quot;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">289</span><span class="sd">    Computes Keltner Channel (EMA Center, ATR Bands).</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">290</span><span class="sd">    &quot;&quot;&quot;</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">291</span>    <span class="c1"># 1. Instantiation</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">292</span>    instance = KeltnerChannel(ema_period, atr_period, multiplier)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">293</span>    </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">294</span>    <span class="c1"># 2. Execution</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">295</span>    instance.calculate(candles)</div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">296</span>    </div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">297</span>    <span class="c1"># 3. Extraction</span></div><div class="code-line" style="white-space: pre;"><span style="display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;">298</span>    <span class="k">return</span> instance.upper_band, instance.middle_band, instance.lower_band</div></div></div>
                    </div>
                </div>
            </figure>

            <!-- Legend (5-Step Model) -->
            <div class="logic-legend">
                <div class="legend-item"><span class="legend-dot l-ingestion"></span>Ingestion</div>
                <div class="legend-item"><span class="legend-dot l-evaluation"></span>Evaluation</div>
                <div class="legend-item"><span class="legend-dot l-weighting"></span>Weighting</div>
                <div class="legend-item"><span class="legend-dot l-synthesis"></span>Synthesis</div>
                <div class="legend-item"><span class="legend-dot l-outcome"></span>Outcome</div>
            </div>
        </section>

        <!-- ======================================================= -->
        <!-- BOTTOM SECTION: DOCS & TOC                              -->
        <!-- ======================================================= -->
        <section id="documentation" class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden scroll-mt-24">
            <!-- Documentation Header -->
            <div class="border-b border-orange-200 bg-orange-50 px-6 py-4">
                <h2 class="text-lg font-bold text-slate-900 flex items-center">
                    <span class="bg-indigo-600 text-white p-1 rounded mr-3 text-xs shadow-sm font-mono">D</span>
                    Technical Documentation
                </h2>
                <p class="text-slate-600 text-xs mt-1 ml-9">
                    Detailed technical explanation of the indicator's logic, math, and implementation details.
                </p>
            </div>
            <!-- Content Body -->
            <div class="p-6 flex flex-col lg:flex-row gap-12">
                <!-- Left: Article -->
                <article class="flex-1 min-w-0">
                    <div class="prose prose-slate max-w-none prose-headings:scroll-mt-24 prose-headings:font-bold prose-h2:text-2xl prose-h2:border-b prose-h2:pb-2 prose-h2:mt-8 prose-a:text-indigo-600 hover:prose-a:text-indigo-800">
                        <h1 id="keltner-channel">Keltner Channel</h1>

<p class="mb-4"><h2 class="text-2xl font-bold mt-12 mb-6 border-b pb-2">PART 1: MAIN GUIDE</h2></p>

<h2 id="1-identity">1. Identity</h2>

<p class="mb-4">Full Name: Keltner Channel  </p>
<p class="mb-4">Abbreviation: KC  </p>
<p class="mb-4">Category: Volatility Channel / Trend Overlay  </p>
<p class="mb-4">Creator: Chester W. Keltner (1960, original) / Linda Bradford Raschke (modern version)  </p>

<blockquote class="border-l-4 border-gray-300 pl-4 italic text-gray-700 my-4 bg-gray-50 py-2 pr-2 rounded-r">One-Sentence Definition: Keltner Channels are volatility-based envelopes set above and below an EMA using Average True Range (ATR), providing a stable framework for identifying trend breakouts and mean-reversion opportunities.</blockquote>

<hr class="border-[#2a2e39] my-8">

<h2 id="2-calculation-logic">2. Calculation Logic</h2>

<h3 id="formula-modern-raschke-version">Formula (Modern Raschke Version)</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Component</td><td class="px-4 py-2 border-b border-[#2a2e39]">Formula</td><td class="px-4 py-2 border-b border-[#2a2e39]">Purpose</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Center Line</td><td class="px-4 py-2 border-b border-[#2a2e39]">$EMA_{20}(Close)$</td><td class="px-4 py-2 border-b border-[#2a2e39]">Trend baseline</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">True Range</td><td class="px-4 py-2 border-b border-[#2a2e39]">$TR = \max(H-L, \</td><td class="px-4 py-2 border-b border-[#2a2e39]">H-C_{prev}\</td><td class="px-4 py-2 border-b border-[#2a2e39]">, \</td><td class="px-4 py-2 border-b border-[#2a2e39]">L-C_{prev}\</td><td class="px-4 py-2 border-b border-[#2a2e39]">)$</td><td class="px-4 py-2 border-b border-[#2a2e39]">Single-bar volatility</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">ATR</td><td class="px-4 py-2 border-b border-[#2a2e39]">$ATR = EMA(TR, Period)$</td><td class="px-4 py-2 border-b border-[#2a2e39]">Smoothed volatility</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Upper Band</td><td class="px-4 py-2 border-b border-[#2a2e39]">$Center + (Multiplier \times ATR)$</td><td class="px-4 py-2 border-b border-[#2a2e39]">Overbought/Breakout zone</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Lower Band</td><td class="px-4 py-2 border-b border-[#2a2e39]">$Center - (Multiplier \times ATR)$</td><td class="px-4 py-2 border-b border-[#2a2e39]">Oversold/Breakdown zone</td></tr>
</table></div>

<h3 id="true-range-calculation">True Range Calculation</h3>

<p class="mb-4">$$TR = \max\begin{cases} High - Low \\ |High - Close_{prev}| \\ |Low - Close_{prev}| \end{cases}$$</p>

<p class="mb-4">True Range accounts for overnight gaps, making it more robust than simple High-Low range.</p>

<h3 id="real-world-analogy">Real-World Analogy</h3>

<p class="mb-4">Think of Keltner Channels like traffic lanes on a highway. The center line (EMA) is the average speed of traffic. The outer bands (ATR-based) represent the fast lane and slow lane limits. When a car (price) breaks out of its lane, it signals aggressive acceleration (breakout) or deceleration (breakdown). Unlike Bollinger Bands (which adjust lane width dramatically), Keltner lanes stay relatively consistentmore like painted lines than flexible guardrails.</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="3-market-standards">3. Market Standards</h2>

<h3 id="default-parameters">Default Parameters</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Parameter</td><td class="px-4 py-2 border-b border-[#2a2e39]">Standard Value</td><td class="px-4 py-2 border-b border-[#2a2e39]">Rationale</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">EMA Period</td><td class="px-4 py-2 border-b border-[#2a2e39]">20</td><td class="px-4 py-2 border-b border-[#2a2e39]">Industry standard for intermediate trend</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">ATR Period</td><td class="px-4 py-2 border-b border-[#2a2e39]">10 or 20</td><td class="px-4 py-2 border-b border-[#2a2e39]">Raschke used 10; many platforms default to 20</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Multiplier</td><td class="px-4 py-2 border-b border-[#2a2e39]">2.0 or 2.5</td><td class="px-4 py-2 border-b border-[#2a2e39]">2.5 is stricter; 2.0 is standard</td></tr>
</table></div>

<h3 id="alternative-settings">Alternative Settings</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Strategy</td><td class="px-4 py-2 border-b border-[#2a2e39]">EMA</td><td class="px-4 py-2 border-b border-[#2a2e39]">ATR</td><td class="px-4 py-2 border-b border-[#2a2e39]">Multiplier</td><td class="px-4 py-2 border-b border-[#2a2e39]">Use Case</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Breakout</td><td class="px-4 py-2 border-b border-[#2a2e39]">20</td><td class="px-4 py-2 border-b border-[#2a2e39]">10</td><td class="px-4 py-2 border-b border-[#2a2e39]">2.5</td><td class="px-4 py-2 border-b border-[#2a2e39]">Filter only significant breaks</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Pullback</td><td class="px-4 py-2 border-b border-[#2a2e39]">20</td><td class="px-4 py-2 border-b border-[#2a2e39]">20</td><td class="px-4 py-2 border-b border-[#2a2e39]">1.5</td><td class="px-4 py-2 border-b border-[#2a2e39]">Inner channel for trend continuation</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Mean Reversion</td><td class="px-4 py-2 border-b border-[#2a2e39]">20</td><td class="px-4 py-2 border-b border-[#2a2e39]">10</td><td class="px-4 py-2 border-b border-[#2a2e39]">2.0</td><td class="px-4 py-2 border-b border-[#2a2e39]">Fading extremes in ranges</td></tr>
</table></div>

<h3 id="timeframe-recommendations">Timeframe Recommendations</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Trading Style</td><td class="px-4 py-2 border-b border-[#2a2e39]">Timeframe</td><td class="px-4 py-2 border-b border-[#2a2e39]">Notes</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Day Trading</td><td class="px-4 py-2 border-b border-[#2a2e39]">5-15 min</td><td class="px-4 py-2 border-b border-[#2a2e39]">May need shorter EMA (10-15)</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Swing Trading</td><td class="px-4 py-2 border-b border-[#2a2e39]">Daily</td><td class="px-4 py-2 border-b border-[#2a2e39]">Standard settings optimal</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Position Trading</td><td class="px-4 py-2 border-b border-[#2a2e39]">Weekly</td><td class="px-4 py-2 border-b border-[#2a2e39]">Longer EMA (50) for major trends</td></tr>
</table></div>

<hr class="border-[#2a2e39] my-8">

<h2 id="4-market-context">4. Market Context</h2>

<h3 id="best-conditions">Best Conditions</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Condition</td><td class="px-4 py-2 border-b border-[#2a2e39]">Why It Works</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Trend Continuation</td><td class="px-4 py-2 border-b border-[#2a2e39]">Upper band holds as dynamic support in uptrends</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Breakout Confirmation</td><td class="px-4 py-2 border-b border-[#2a2e39]">Clean breaks above/below bands signal momentum</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Mean Reversion in Ranges</td><td class="px-4 py-2 border-b border-[#2a2e39]">Band touches provide reversal zones</td></tr>
</table></div>

<h3 id="limitations">Limitations</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Condition</td><td class="px-4 py-2 border-b border-[#2a2e39]">Problem</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Extreme Volatility</td><td class="px-4 py-2 border-b border-[#2a2e39]">ATR expands, but bands may not keep pace with spikes</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Flat Markets</td><td class="px-4 py-2 border-b border-[#2a2e39]">ATR contracts, causing frequent band touches</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Gap-Driven Markets</td><td class="px-4 py-2 border-b border-[#2a2e39]">Gaps may penetrate bands without continuation</td></tr>
</table></div>

<h3 id="asset-class-suitability">Asset Class Suitability</h3>

<p class="mb-4">- Forex  Excellent for currency trends</p>
<p class="mb-4">- Equities  Strong for trending stocks</p>
<p class="mb-4">- Futures  Classic commodity application</p>
<p class="mb-4">- Crypto  Works but bands may feel narrow during wild swings</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="5-entry-signals">5. Entry Signals</h2>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Signal Type</td><td class="px-4 py-2 border-b border-[#2a2e39]">Condition</td><td class="px-4 py-2 border-b border-[#2a2e39]">Direction</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strength</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Breakout Up</td><td class="px-4 py-2 border-b border-[#2a2e39]">Close > Upper Band in uptrend</td><td class="px-4 py-2 border-b border-[#2a2e39]">Bullish</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strong</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Breakout Down</td><td class="px-4 py-2 border-b border-[#2a2e39]">Close < Lower Band in downtrend</td><td class="px-4 py-2 border-b border-[#2a2e39]">Bearish</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strong</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Mean Reversion (Long)</td><td class="px-4 py-2 border-b border-[#2a2e39]">Touch Lower Band in range, reversal candle</td><td class="px-4 py-2 border-b border-[#2a2e39]">Bullish</td><td class="px-4 py-2 border-b border-[#2a2e39]">Moderate</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Mean Reversion (Short)</td><td class="px-4 py-2 border-b border-[#2a2e39]">Touch Upper Band in range, reversal candle</td><td class="px-4 py-2 border-b border-[#2a2e39]">Bearish</td><td class="px-4 py-2 border-b border-[#2a2e39]">Moderate</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Pullback Entry</td><td class="px-4 py-2 border-b border-[#2a2e39]">Price returns to Center Line in trend</td><td class="px-4 py-2 border-b border-[#2a2e39]">Trend Continuation</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strong</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Channel Walk</td><td class="px-4 py-2 border-b border-[#2a2e39]">Price hugs Upper Band in strong uptrend</td><td class="px-4 py-2 border-b border-[#2a2e39]">Bullish Continuation</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strong</td></tr>
</table></div>

<h3 id="primary-buy-signal-breakout-mode">Primary Buy Signal (Breakout Mode)</h3>

<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
IF Close &gt; Upper Band
AND ADX(14) &gt; 25 (Trend present)
AND Center Line slope &gt; 0
THEN  BUY (Momentum Breakout)
</code></pre>

<h3 id="primary-sell-signal-mean-reversion-mode">Primary Sell Signal (Mean Reversion Mode)</h3>

<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
IF Price touches Upper Band
AND ADX(14) &lt; 20 (Range-bound)
AND Reversal candlestick pattern
THEN  SELL (Mean Reversion Short)
</code></pre>

<hr class="border-[#2a2e39] my-8">

<h2 id="6-filter-usage">6. Filter Usage</h2>

<p class="mb-4">Keltner Channels are dual-modethey can be used for breakout trading OR mean reversion, but not both simultaneously. Use a mode switch indicator.</p>

<h3 id="filter-rules">Filter Rules</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Rule</td><td class="px-4 py-2 border-b border-[#2a2e39]">Application</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]"><code>ADX > 30</code></td><td class="px-4 py-2 border-b border-[#2a2e39]">Enable Breakout Mode (trade band breaks)</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]"><code>ADX < 20</code></td><td class="px-4 py-2 border-b border-[#2a2e39]">Enable Mean Reversion Mode (fade band touches)</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]"><code>Center slope > 0</code></td><td class="px-4 py-2 border-b border-[#2a2e39]">Only long signals valid</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]"><code>Center slope < 0</code></td><td class="px-4 py-2 border-b border-[#2a2e39]">Only short signals valid</td></tr>
</table></div>

<h3 id="recommended-pairings">Recommended Pairings</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Partner Indicator</td><td class="px-4 py-2 border-b border-[#2a2e39]">Synergy Logic</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">ADX</td><td class="px-4 py-2 border-b border-[#2a2e39]">Determines Breakout vs. Mean Reversion mode</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Bollinger Bands</td><td class="px-4 py-2 border-b border-[#2a2e39]">Keltner + BB = "Squeeze" detection (TTM Squeeze)</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">RSI</td><td class="px-4 py-2 border-b border-[#2a2e39]">Confirm overbought/oversold at band touches</td></tr>
</table></div>

<h3 id="example-combined-strategy-dual-mode">Example Combined Strategy (Dual-Mode)</h3>

<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
MODE SWITCH:
&nbsp;&nbsp;IF ADX(14) &gt; 30:
&nbsp;&nbsp;&nbsp;&nbsp;// BREAKOUT MODE
&nbsp;&nbsp;&nbsp;&nbsp;BUY when Close &gt; Upper Band AND Center rising
&nbsp;&nbsp;&nbsp;&nbsp;SELL when Close &lt; Lower Band AND Center falling
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;IF ADX(14) &lt; 20:
&nbsp;&nbsp;&nbsp;&nbsp;// MEAN REVERSION MODE
&nbsp;&nbsp;&nbsp;&nbsp;BUY when Price touches Lower Band + Hammer candle
&nbsp;&nbsp;&nbsp;&nbsp;SELL when Price touches Upper Band + Shooting Star
</code></pre>

<hr class="border-[#2a2e39] my-8">

<h2 id="7-practical-cautions">7. Practical Cautions</h2>

<h3 id="lag-characteristics">Lag Characteristics</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Component</td><td class="px-4 py-2 border-b border-[#2a2e39]">Approximate Lag</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">EMA Center Line</td><td class="px-4 py-2 border-b border-[#2a2e39]">10-12 bars</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">ATR (for band width)</td><td class="px-4 py-2 border-b border-[#2a2e39]">10-20 bars</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Breakout Confirmation</td><td class="px-4 py-2 border-b border-[#2a2e39]">1-2 bars after break</td></tr>
</table></div>

<blockquote class="border-l-4 border-gray-300 pl-4 italic text-gray-700 my-4 bg-gray-50 py-2 pr-2 rounded-r">Reality Check: Keltner Channels don't predictthey define current volatility boundaries. Price breaking a band is not predictive; it's descriptive of current momentum.</blockquote>

<h3 id="false-signal-scenarios">False Signal Scenarios</h3>

<p class="mb-4">1. The Gap Trap  </p>
<p class="mb-4">   Price gaps above Upper Band, triggers breakout buy, then immediately reverses. Require close above band, not just wick.</p>

<p class="mb-4">2. Band Walk Exhaustion  </p>
<p class="mb-4">   In strong trends, price "walks" along the Upper Band for weeks. Don't short band touches in a trending market.</p>

<p class="mb-4">3. Mean Reversion in a Trend  </p>
<p class="mb-4">   Attempt to short at Upper Band when ADX > 30 = disaster. Check ADX before mode selection.</p>

<h3 id="mitigation-strategies">Mitigation Strategies</h3>

<p class="mb-4">- ADX Mode Switch: Only use mean reversion when ADX < 20</p>
<p class="mb-4">- Close Confirmation: Require candle close beyond band, not just touch</p>
<p class="mb-4">- Slope Filter: Never counter the Center Line slope direction</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="8-pro-insights">8. Pro Insights</h2>

<h3 id="the-ttm-squeeze-concept">The TTM Squeeze Concept</h3>

<p class="mb-4">The "TTM Squeeze" is a famous strategy combining Keltner and Bollinger Bands:</p>
<p class="mb-4">- When Bollinger Bands contract *inside* Keltner Channels  Squeeze ON (extreme low volatility)</p>
<p class="mb-4">- When Bollinger Bands expand *outside* Keltner Channels  Squeeze FIRED (volatility explosion imminent)</p>

<p class="mb-4">Trade the direction of the first breakout after the squeeze fires.</p>

<h3 id="the-pullback-entry">The Pullback Entry</h3>

<p class="mb-4">In strong uptrends, price often:</p>
<p class="mb-4">1. Breaks above Upper Band (momentum confirmation)</p>
<p class="mb-4">2. Pulls back to Center Line (EMA 20)</p>
<p class="mb-4">3. Bounces from Center Line and continues upward</p>

<p class="mb-4">The Center Line becomes dynamic support. This pullback entry offers better risk/reward than chasing breakouts.</p>

<h3 id="channel-width-as-volatility-indicator">Channel Width as Volatility Indicator</h3>

<p class="mb-4">Plot the difference between Upper and Lower bands (Channel Width):</p>
<p class="mb-4">- Narrowing = Volatility contraction (squeeze forming)</p>
<p class="mb-4">- Expanding = Volatility expansion (trend accelerating)</p>

<p class="mb-4">Use width changes to anticipate regime shifts.</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="9-summary">9. Summary</h2>

<blockquote class="border-l-4 border-gray-300 pl-4 italic text-gray-700 my-4 bg-gray-50 py-2 pr-2 rounded-r">"Keltner Channels draw the volatility envelope around the trendbreaks above signal power, touches at the edge signal extremes, and the center line is where value lives."</blockquote>

<p class="mb-4"><h2 class="text-2xl font-bold mt-12 mb-6 border-b pb-2">PART 2: SUPPLEMENTARY GUIDE</h2></p>

<h2 id="1-core-concept">1. Core Concept</h2>

<p class="mb-4">Keltner Channels answer: "What volatility boundaries contain current price action?"</p>

<p class="mb-4">Unlike Bollinger Bands (based on Standard Deviation), Keltner uses ATRa measure of *range* rather than *dispersion*. This creates smoother, more stable bands that don't expand explosively on gap days.</p>

<p class="mb-4">The three lines create a framework:</p>
<p class="mb-4">- Upper Band: Price at the upper edge of normal volatility</p>
<p class="mb-4">- Center (EMA): The "fair value" or trend baseline</p>
<p class="mb-4">- Lower Band: Price at the lower edge of normal volatility</p>

<p class="mb-4">When price breaks outside, it's doing something statistically unusualeither beginning a new trend or hitting an exhaustion point.</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="2-statistical-edge">2. Statistical Edge</h2>

<h3 id="keltner-vs-bollinger">Keltner vs. Bollinger</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Metric</td><td class="px-4 py-2 border-b border-[#2a2e39]">Keltner (ATR)</td><td class="px-4 py-2 border-b border-[#2a2e39]">Bollinger (StdDev)</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Width Volatility</td><td class="px-4 py-2 border-b border-[#2a2e39]">Stable</td><td class="px-4 py-2 border-b border-[#2a2e39]">Highly reactive</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Gap Response</td><td class="px-4 py-2 border-b border-[#2a2e39]">Moderate widening</td><td class="px-4 py-2 border-b border-[#2a2e39]">Extreme widening</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">False Touch Rate</td><td class="px-4 py-2 border-b border-[#2a2e39]">Lower</td><td class="px-4 py-2 border-b border-[#2a2e39]">Higher</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Mean Reversion</td><td class="px-4 py-2 border-b border-[#2a2e39]">More reliable</td><td class="px-4 py-2 border-b border-[#2a2e39]">Less reliable</td></tr>
</table></div>

<h3 id="why-it-works">Why It Works</h3>

<p class="mb-4">ATR-based bands provide more consistent boundaries because:</p>
<p class="mb-4">1. ATR uses True Range (gap-adjusted), not just intraday movement</p>
<p class="mb-4">2. ATR is smoothed (EMA), reducing spike impact</p>
<p class="mb-4">3. The multiplier (2.0-2.5) creates statistically meaningful boundaries</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="3-actionable-strategy">3. Actionable Strategy</h2>

<h3 id="strategy-name:-"keltner-breakout-+-pullback"">Strategy Name: "Keltner Breakout + Pullback"</h3>

<p class="mb-4">Concept: Catch breakouts, then add on pullbacks.</p>

<p class="mb-4">Phase 1 - Initial Entry:</p>
<p class="mb-4">1. Price closes above Upper Band</p>
<p class="mb-4">2. ADX(14) > 25</p>
<p class="mb-4">3. Center Line slope > 0</p>
<p class="mb-4">4.   BUY 50% position</p>

<p class="mb-4">Phase 2 - Add on Pullback:</p>
<p class="mb-4">1. Price pulls back to Center Line (EMA 20)</p>
<p class="mb-4">2. ADX still > 25</p>
<p class="mb-4">3. Center Line still rising</p>
<p class="mb-4">4.  BUY remaining 50%</p>

<p class="mb-4">Exit Rules:</p>
<p class="mb-4">1. Primary Exit: Price closes below Center Line</p>
<p class="mb-4">2. Stop Loss: Below Lower Band (or 2 ATR)</p>
<p class="mb-4">3. Take Profit: Trail using Center Line as stop</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="4-risks-&-limitations">4. Risks & Limitations</h2>

<h3 id="failure-patterns">Failure Patterns</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Pattern</td><td class="px-4 py-2 border-b border-[#2a2e39]">Description</td><td class="px-4 py-2 border-b border-[#2a2e39]">Mitigation</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Gap and Fade</td><td class="px-4 py-2 border-b border-[#2a2e39]">Morning gap above band, reverses by close</td><td class="px-4 py-2 border-b border-[#2a2e39]">Wait for close above, not just open</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Trend Mode Error</td><td class="px-4 py-2 border-b border-[#2a2e39]">Mean reversion trade in trending market</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strict ADX mode switching</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Width Collapse</td><td class="px-4 py-2 border-b border-[#2a2e39]">Ultra-low volatility makes bands meaningless</td><td class="px-4 py-2 border-b border-[#2a2e39]">Check ATR level before trading</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Chop Zone</td><td class="px-4 py-2 border-b border-[#2a2e39]">Price oscillates between bands frequently</td><td class="px-4 py-2 border-b border-[#2a2e39]">Require ADX > 20 for any trade</td></tr>
</table></div>

<h3 id="psychological-traps">Psychological Traps</h3>

<p class="mb-4">1. Mode Confusion  </p>
<p class="mb-4">   Switching between breakout and mean reversion strategies randomly leads to losses. Commit to a mode per ADX reading.</p>

<p class="mb-4">2. Chasing Band Walks  </p>
<p class="mb-4">   In strong trends, price hugs Upper Band for weeks. Shorting repeatedly destroys capital.</p>

<p class="mb-4">3. Ignoring the Slope  </p>
<p class="mb-4">   The Center Line slope is the trend direction. Trading against it fails.</p>

<hr class="border-[#2a2e39] my-8">

<h2 id="5-further-study">5. Further Study</h2>

<h3 id="creator-attribution">Creator Attribution</h3>

<p class="mb-4">Chester W. Keltner (19091998) introduced the original concept in 1960. Linda Bradford Raschke, a celebrated futures trader, modernized the indicator by replacing SMA with EMA and simple range with ATR. The modern version is sometimes called the "Raschke Keltner Channel."</p>

<h3 id="parent/child-indicators">Parent/Child Indicators</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Indicator</td><td class="px-4 py-2 border-b border-[#2a2e39]">Relationship</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">EMA</td><td class="px-4 py-2 border-b border-[#2a2e39]">Component  Center line</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">ATR (True Range)</td><td class="px-4 py-2 border-b border-[#2a2e39]">Component  Band width</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Bollinger Bands</td><td class="px-4 py-2 border-b border-[#2a2e39]">Related  Alternative volatility bands</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">TTM Squeeze</td><td class="px-4 py-2 border-b border-[#2a2e39]">Combination  Keltner + Bollinger</td></tr>
</table></div>

<h3 id="recommended-readings">Recommended Readings</h3>

<p class="mb-4">1. *Street Smarts*  Linda Bradford Raschke and Larry Connors</p>
<p class="mb-4">2. *How to Make Money in Commodities*  Chester Keltner</p>
<p class="mb-4">3. *Technical Analysis Using Multiple Timeframes*  Brian Shannon</p>

<hr class="border-[#2a2e39] my-8">

<h3 id="55-related-indicators-comparison">5.5 Related Indicators Comparison</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Feature</td><td class="px-4 py-2 border-b border-[#2a2e39]">Keltner Channel</td><td class="px-4 py-2 border-b border-[#2a2e39]">Bollinger Bands</td><td class="px-4 py-2 border-b border-[#2a2e39]">Donchian Channel</td><td class="px-4 py-2 border-b border-[#2a2e39]">Envelope</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Width Basis</td><td class="px-4 py-2 border-b border-[#2a2e39]">ATR</td><td class="px-4 py-2 border-b border-[#2a2e39]">Standard Deviation</td><td class="px-4 py-2 border-b border-[#2a2e39]">Highest High/Lowest Low</td><td class="px-4 py-2 border-b border-[#2a2e39]">Fixed %</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Center Line</td><td class="px-4 py-2 border-b border-[#2a2e39]">EMA</td><td class="px-4 py-2 border-b border-[#2a2e39]">SMA</td><td class="px-4 py-2 border-b border-[#2a2e39]">Midpoint</td><td class="px-4 py-2 border-b border-[#2a2e39]">SMA/EMA</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Reactivity</td><td class="px-4 py-2 border-b border-[#2a2e39]">Moderate</td><td class="px-4 py-2 border-b border-[#2a2e39]">High</td><td class="px-4 py-2 border-b border-[#2a2e39]">Low</td><td class="px-4 py-2 border-b border-[#2a2e39]">None</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">Best Use</td><td class="px-4 py-2 border-b border-[#2a2e39]">Trend + Volatility</td><td class="px-4 py-2 border-b border-[#2a2e39]">Volatility</td><td class="px-4 py-2 border-b border-[#2a2e39]">Breakouts</td><td class="px-4 py-2 border-b border-[#2a2e39]">Mean Reversion</td></tr>
</table></div>

<p class="mb-4">When to Use Which:</p>
<p class="mb-4">- Keltner  Balanced trend/volatility analysis; pullback entries</p>
<p class="mb-4">- Bollinger  Volatility expansion/contraction; squeeze detection</p>
<p class="mb-4">- Donchian  Pure price breakouts (turtle trading)</p>
<p class="mb-4">- Envelope  Simple mean reversion percentage bands</p>

<p class="mb-4"><h2 class="text-2xl font-bold mt-12 mb-6 border-b pb-2">PART 3: ADVANCED SIGNAL REFERENCE</h2></p>

<h2 id="advanced-signal-reference">Advanced Signal Reference</h2>

<h3 id="threshold-matrix">Threshold Matrix</h3>

<div class="overflow-x-auto my-4"><table class="min-w-full divide-y divide-[#2a2e39] text-sm text-left">
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">ADX Level</td><td class="px-4 py-2 border-b border-[#2a2e39]">Mode</td><td class="px-4 py-2 border-b border-[#2a2e39]">Upper Band Action</td><td class="px-4 py-2 border-b border-[#2a2e39]">Lower Band Action</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">> 35</td><td class="px-4 py-2 border-b border-[#2a2e39]">Strong Trend</td><td class="px-4 py-2 border-b border-[#2a2e39]">Trend continuation</td><td class="px-4 py-2 border-b border-[#2a2e39]">Counter-trend warning</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">25-35</td><td class="px-4 py-2 border-b border-[#2a2e39]">Moderate Trend</td><td class="px-4 py-2 border-b border-[#2a2e39]">Breakout entry</td><td class="px-4 py-2 border-b border-[#2a2e39]">Pullback buy zone</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">20-25</td><td class="px-4 py-2 border-b border-[#2a2e39]">Transition</td><td class="px-4 py-2 border-b border-[#2a2e39]">Caution</td><td class="px-4 py-2 border-b border-[#2a2e39]">Caution</td></tr>
<tr><td class="px-4 py-2 border-b border-[#2a2e39]">< 20</td><td class="px-4 py-2 border-b border-[#2a2e39]">Range</td><td class="px-4 py-2 border-b border-[#2a2e39]">Mean reversion short</td><td class="px-4 py-2 border-b border-[#2a2e39]">Mean reversion long</td></tr>
</table></div>

<h3 id="signal-patterns">Signal Patterns</h3>

<h4 id="breakout-buy-signal">Breakout Buy Signal</h4>

<p class="mb-4">This signal fires when price closes above the Upper Band with trend confirmation from ADX and rising center line. The triple confirmation ensures breakouts have genuine momentum behind themnot just noise spikes. This is the core Keltner breakout strategy used by Linda Raschke and other futures traders.</p>

<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-python">
def keltner_breakout_buy(close, upper_band, adx, center_slope):
&nbsp;&nbsp;&nbsp;&nbsp;above_band = close &gt; upper_band
&nbsp;&nbsp;&nbsp;&nbsp;trend_present = adx &gt; 25
&nbsp;&nbsp;&nbsp;&nbsp;center_rising = center_slope &gt; 0
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;return above_band and trend_present and center_rising
</code></pre>

<h4 id="mean-reversion-buy-signal">Mean Reversion Buy Signal</h4>

<p class="mb-4">This pattern identifies buying opportunities when price touches the Lower Band in range-bound markets (ADX < 20). Combined with a reversal candlestick pattern, it signals that selling pressure is exhausted. Critical: Only use in range-bound marketsfading bands in trends leads to significant losses.</p>

<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-python">
def keltner_reversion_buy(low, lower_band, adx, reversal_candle):
&nbsp;&nbsp;&nbsp;&nbsp;touch_lower = low &lt;= lower_band
&nbsp;&nbsp;&nbsp;&nbsp;range_market = adx &lt; 20
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;return touch_lower and range_market and reversal_candle
</code></pre>

<h4 id="pullback-entry-signal">Pullback Entry Signal</h4>

<p class="mb-4">This signal identifies re-entry opportunities in established uptrends when price retraces to the center line (EMA). The center line acts as dynamic support in strong trends. This pullback strategy offers superior risk/reward compared to chasing breakout extensions.</p>

<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-python">
def keltner_pullback_buy(close, center, upper_band, center_prev, adx):
&nbsp;&nbsp;&nbsp;&nbsp;in_uptrend = center &gt; center_prev and close &gt; upper_band_recent
&nbsp;&nbsp;&nbsp;&nbsp;at_center = abs(close - center) / center &lt; 0.01  # Within 1%
&nbsp;&nbsp;&nbsp;&nbsp;trend_valid = adx &gt; 25
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;return in_uptrend and at_center and trend_valid
</code></pre>

<h3 id="screening-filters">Screening Filters</h3>

<h4 id="breakout-scanner">Breakout Scanner</h4>
<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
Close &gt; UpperKeltner(20, 10, 2.5)
AND ADX(14) &gt; 25
AND EMA(20) &gt; EMA(20)[1]  // Center rising
AND Volume &gt; SMA(Volume, 20) * 1.5
</code></pre>

<h4 id="squeeze-scanner">Squeeze Scanner</h4>
<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
BollingerBand_Upper &lt; KeltnerChannel_Upper
AND BollingerBand_Lower &gt; KeltnerChannel_Lower
// Bollinger inside Keltner = Squeeze ON
</code></pre>

<h4 id="mean-reversion-setup">Mean Reversion Setup</h4>
<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
Low &lt; LowerKeltner(20, 10, 2.0)
AND ADX(14) &lt; 20
AND RSI(14) &lt; 30
// Oversold at lower band in range
</code></pre>

<h3 id="combination-strategies">Combination Strategies</h3>

<h4 id="keltner-+-adx-dual-mode-strategy">Keltner + ADX Dual Mode Strategy</h4>
<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
CALCULATE:
&nbsp;&nbsp;ADX(14)
&nbsp;&nbsp;KeltnerChannel(20, 10, 2.0)
&nbsp;&nbsp;
IF ADX &gt; 30:
&nbsp;&nbsp;// BREAKOUT MODE
&nbsp;&nbsp;LONG when Close &gt; Upper Band
&nbsp;&nbsp;STOP below Center Line
&nbsp;&nbsp;
IF ADX &lt; 20:
&nbsp;&nbsp;// MEAN REVERSION MODE
&nbsp;&nbsp;LONG when Low touches Lower Band + Hammer
&nbsp;&nbsp;TARGET Center Line
&nbsp;&nbsp;STOP 1 ATR below Lower Band
</code></pre>

<h4 id="keltner-+-bollinger-squeeze-strategy">Keltner + Bollinger Squeeze Strategy</h4>
<pre class="whitespace-pre overflow-x-auto bg-slate-800 text-slate-100 p-4 rounded"><code class="language-">
SQUEEZE_ON:
&nbsp;&nbsp;BB_Upper &lt; KC_Upper AND BB_Lower &gt; KC_Lower
&nbsp;&nbsp;
SQUEEZE_FIRE:
&nbsp;&nbsp;BB_Upper &gt; KC_Upper OR BB_Lower &lt; KC_Lower
&nbsp;&nbsp;
ENTRY:
&nbsp;&nbsp;When Squeeze fires, enter direction of first breakout
&nbsp;&nbsp;
CONFIRMATION:
&nbsp;&nbsp;ADX rising from below 20
</code></pre>





                    </div>
                </article>
                <!-- Right: Sticky TOC -->
                <aside class="hidden lg:block w-64 flex-shrink-0">
                    <div class="sticky top-24">
                        <h3 class="font-bold text-slate-900 mb-4 pb-2 border-b border-slate-100 text-sm uppercase tracking-wider">
                            On this page
                        </h3>
                        <nav id="toc-nav" class="space-y-1 text-sm text-slate-600">
                            <a href="#1-identity" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">1. Identity</a>
<a href="#2-calculation-logic" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">2. Calculation Logic</a>
<a href="#formula-modern-raschke-version" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Formula (Modern Raschke Version)</a>
<a href="#true-range-calculation" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">True Range Calculation</a>
<a href="#real-world-analogy" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Real-World Analogy</a>
<a href="#3-market-standards" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">3. Market Standards</a>
<a href="#default-parameters" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Default Parameters</a>
<a href="#alternative-settings" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Alternative Settings</a>
<a href="#timeframe-recommendations" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Timeframe Recommendations</a>
<a href="#4-market-context" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">4. Market Context</a>
<a href="#best-conditions" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Best Conditions</a>
<a href="#limitations" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Limitations</a>
<a href="#asset-class-suitability" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Asset Class Suitability</a>
<a href="#5-entry-signals" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">5. Entry Signals</a>
<a href="#primary-buy-signal-breakout-mode" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Primary Buy Signal (Breakout Mode)</a>
<a href="#primary-sell-signal-mean-reversion-mode" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Primary Sell Signal (Mean Reversion Mode)</a>
<a href="#6-filter-usage" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">6. Filter Usage</a>
<a href="#filter-rules" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Filter Rules</a>
<a href="#recommended-pairings" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Recommended Pairings</a>
<a href="#example-combined-strategy-dual-mode" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Example Combined Strategy (Dual-Mode)</a>
<a href="#7-practical-cautions" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">7. Practical Cautions</a>
<a href="#lag-characteristics" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Lag Characteristics</a>
<a href="#false-signal-scenarios" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">False Signal Scenarios</a>
<a href="#mitigation-strategies" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Mitigation Strategies</a>
<a href="#8-pro-insights" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">8. Pro Insights</a>
<a href="#the-ttm-squeeze-concept" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">The TTM Squeeze Concept</a>
<a href="#the-pullback-entry" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">The Pullback Entry</a>
<a href="#channel-width-as-volatility-indicator" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Channel Width as Volatility Indicator</a>
<a href="#9-summary" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">9. Summary</a>
<a href="#1-core-concept" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">1. Core Concept</a>
<a href="#2-statistical-edge" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">2. Statistical Edge</a>
<a href="#keltner-vs-bollinger" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Keltner vs. Bollinger</a>
<a href="#why-it-works" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Why It Works</a>
<a href="#3-actionable-strategy" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">3. Actionable Strategy</a>
<a href="#strategy-name:-"keltner-breakout-+-pullback"" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Strategy Name: "Keltner Breakout + Pullback"</a>
<a href="#4-risks-&-limitations" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">4. Risks & Limitations</a>
<a href="#failure-patterns" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Failure Patterns</a>
<a href="#psychological-traps" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Psychological Traps</a>
<a href="#5-further-study" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">5. Further Study</a>
<a href="#creator-attribution" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Creator Attribution</a>
<a href="#parent/child-indicators" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Parent/Child Indicators</a>
<a href="#recommended-readings" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Recommended Readings</a>
<a href="#55-related-indicators-comparison" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">5.5 Related Indicators Comparison</a>
<a href="#advanced-signal-reference" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors ">Advanced Signal Reference</a>
<a href="#threshold-matrix" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Threshold Matrix</a>
<a href="#signal-patterns" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Signal Patterns</a>
<a href="#screening-filters" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Screening Filters</a>
<a href="#combination-strategies" class="toc-link block py-1 px-2 rounded hover:bg-slate-50 transition-colors pl-4">Combination Strategies</a>

                        </nav>
                        <div class="mt-8 pt-4 border-t border-slate-100">
                            <a href="#" class="text-xs text-slate-400 hover:text-indigo-600 flex items-center transition-colors">
                                Back to Top
                            </a>
                        </div>
                    </div>
                </aside>
            </div>
        </section>


    </div>

    <!-- Footer -->
    <footer class="bg-white border-t border-slate-200 mt-12">
        <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
            <p class="text-center text-slate-400 text-sm">
                &copy; 2023-2025 I ant I Investigates. All rights reserved.
            </p>
        </div>
    </footer>

    <!-- ========================================== -->
    <!-- 1. DATA & LOGIC INJECTION                  -->
    <!-- ========================================== -->
    <script>
        window.IndicatorLogic = {
            name: "KeltnerChannel",
            params: [],
            calculate: null
        };
        (function() {
            try {
                const injectedCode = `
        window.IndicatorLogic = {
            calculate: (data, params) => {
                const close = data.map(d => d.close);
                const emaPeriod = params.emaPeriod || 20;
                const mult = params.multiplier || 2.0;
                // Simple visual stub - shows KC structure
                const middle = close.map((v, i, arr) => {
                    if (i < emaPeriod - 1) return null;
                    let sum = 0;
                    for (let j = 0; j < emaPeriod; j++) sum += arr[i - j];
                    return sum / emaPeriod;
                });
                // ATR approximation for visual test
                const atrFactor = 0.015 * mult;
                const upper = middle.map(m => m ? m * (1 + atrFactor) : null);
                const lower = middle.map(m => m ? m * (1 - atrFactor) : null);
                return { upper, middle, lower };
            }
        };
        `;
                const isTemplatePlaceholder = injectedCode.includes('{{') && injectedCode.includes('PLAYGROUND_LOGIC');
                if (injectedCode && injectedCode.trim().length > 0 && !isTemplatePlaceholder) {
                    new Function(injectedCode)();
                } else {
                    console.warn("Playground Logic: Running in Preview/Fallback mode.");
                    window.IndicatorLogic.calculate = () => []; 
                }
            } catch (e) {
                console.error("Critical Error in Logic Injection:", e);
                window.IndicatorLogic.calculate = () => [];
            }
        })();
    </script>

    <!-- ========================================== -->
    <!-- 2. VISUALIZATION ENGINE                    -->
    <!-- ========================================== -->
    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'neutral', securityLevel: 'loose' });
    </script>

    <!-- ========================================== -->
    <!-- 3. UI CONTROLLERS & APP INITIALIZATION     -->
    <!-- ========================================== -->
    <script src="../../assets/js/script.js" defer></script>
    <!-- INLINE UI CONTROLLERS (PORTED FROM 0117) -->
    <script>
        // --- 0. Indicator Data Injection ---
        // These are populated by the generator script
        var IndicatorLogic = {};
        var IndicatorConfig = [];
        var IndicatorDisplay = { isOverlay: false, plots: {} };

        // 1. Library Code (e.g. class definitions)
        // No library code for verification

        // 2. Configuration
        try {
            var rawConfig = '[{"id": "emaPeriod", "label": "EMA Period (20)", "type": "number", "value": 20, "min": 5, "max": 100}, {"id": "atrPeriod", "label": "ATR Period (10)", "type": "number", "value": 10, "min": 2, "max": 50}, {"id": "multiplier", "label": "ATR Multiplier (2.0)", "type": "number", "value": 2.0, "min": 0.5, "max": 5.0, "step": 0.1}]';
            if(rawConfig && !rawConfig.startsWith('{{')) IndicatorConfig = JSON.parse(rawConfig);
        } catch(e){ console.warn('Config parse error', e); }

        try {
            var rawDisplay = '{"isOverlay": true, "plots": {"upper": {"label": "Upper Band", "color": "#22c55e", "type": "line"}, "middle": {"label": "Middle (EMA)", "color": "#3b82f6", "type": "line"}, "lower": {"label": "Lower Band", "color": "#ef4444", "type": "line"}}}';
            if(rawDisplay && !rawDisplay.startsWith('{{')) IndicatorDisplay = JSON.parse(rawDisplay);
        } catch(e){ console.warn('Display parse error', e); }

        // 3. Logic Adapter
        window.IndicatorLogic = {
            calculate: (data, params) => {
                const close = data.map(d => d.close);
                const emaPeriod = params.emaPeriod || 20;
                const mult = params.multiplier || 2.0;
                // Simple visual stub - shows KC structure
                const middle = close.map((v, i, arr) => {
                    if (i < emaPeriod - 1) return null;
                    let sum = 0;
                    for (let j = 0; j < emaPeriod; j++) sum += arr[i - j];
                    return sum / emaPeriod;
                });
                // ATR approximation for visual test
                const atrFactor = 0.015 * mult;
                const upper = middle.map(m => m ? m * (1 + atrFactor) : null);
                const lower = middle.map(m => m ? m * (1 - atrFactor) : null);
                return { upper, middle, lower };
            }
        };
    </script>

    <script>
        // --- 1. Code Panel Logic ---
        const AppState = {
            activeLang: 'csharp',
            codeType: 'simple',
            isPanelVisible: false,  // Start hidden to show flowchart
            isPanelExpanded: false,
        };

        // --- 2. Canvas State (Full Pan/Zoom from 0117) ---
        const CanvasState = {
            scale: 1, panX: 0, panY: 0,
            isDragging: false, startX: 0, startY: 0,
            minScale: 0.1, maxScale: 5.0
        };

        // Element references (populated after DOM ready)
        let els = {};

        function updateView() {
            // 1. Code Content Visibility
            document.querySelectorAll('.code-content').forEach(el => el.classList.add('hidden'));
            const activeId = `code-${AppState.activeLang}-${AppState.codeType}`;
            const activeEl = document.getElementById(activeId);
            if (activeEl) activeEl.classList.remove('hidden');

            // 2. Overlay Visibility
            const overlay = document.getElementById('code-panel-overlay');
            if (overlay) {
                if (AppState.isPanelVisible) overlay.classList.remove('panel-hidden');
                else overlay.classList.add('panel-hidden');

                if (AppState.isPanelExpanded) {
                    overlay.classList.add('panel-expanded');
                    const iconExp = document.getElementById('icon-expand');
                    const iconCol = document.getElementById('icon-collapse');
                    if(iconExp) iconExp.classList.add('hidden');
                    if(iconCol) iconCol.classList.remove('hidden');
                } else {
                    overlay.classList.remove('panel-expanded');
                    const iconExp = document.getElementById('icon-expand');
                    const iconCol = document.getElementById('icon-collapse');
                    if(iconExp) iconExp.classList.remove('hidden');
                    if(iconCol) iconCol.classList.add('hidden');
                }
            }

            // 3. Button States
            const btnCs = document.getElementById('btn-lang-csharp');
            const btnPy = document.getElementById('btn-lang-python');
            [btnCs, btnPy].forEach(btn => {
                if(btn) btn.className = "px-2 py-1 text-xs rounded transition-colors text-slate-500 hover:bg-slate-100";
            });

            if (AppState.activeLang === 'csharp' && btnCs) {
                btnCs.className = "px-2 py-1 text-xs rounded transition-colors btn-lang-active";
            } else if (AppState.activeLang === 'python' && btnPy) {
                btnPy.className = "px-2 py-1 text-xs rounded transition-colors btn-lang-active";
            }

            const btnSimple = document.getElementById('btn-type-simple');
            const btnDetailed = document.getElementById('btn-type-detailed');
            if(btnSimple) btnSimple.className = `text-xs transition-colors ${AppState.codeType === 'simple' ? 'btn-type-active' : 'text-slate-500 hover:text-indigo-600'}`;
            if(btnDetailed) btnDetailed.className = `text-xs transition-colors ${AppState.codeType === 'detailed' ? 'btn-type-active' : 'text-slate-500 hover:text-indigo-600'}`;
        }

        // Global exports for inline onclick handlers
        window.setLang = (lang) => { AppState.activeLang = lang; updateView(); }
        window.setType = (type) => { AppState.codeType = type; updateView(); }
        window.toggleCodePanel = () => { AppState.isPanelVisible = !AppState.isPanelVisible; updateView(); }
        window.toggleExpand = () => { AppState.isPanelExpanded = !AppState.isPanelExpanded; updateView(); }
        window.copyCode = async () => {
            const activeId = `code-${AppState.activeLang}-${AppState.codeType}`;
            const el = document.getElementById(activeId);
            if (!el) return;
            let text = "";
            const lines = el.querySelectorAll('.code-line');
            if (lines.length > 0) {
                text = Array.from(lines).map(line => line.textContent).join('\n');
            } else {
                text = el.textContent;
            }
            try {
                await navigator.clipboard.writeText(text);
                const iconCopy = document.getElementById('icon-copy');
                const iconDone = document.getElementById('icon-copy-done');
                if (iconCopy && iconDone) {
                    iconCopy.classList.add('hidden');
                    iconDone.classList.remove('hidden');
                    setTimeout(() => {
                        iconCopy.classList.remove('hidden');
                        iconDone.classList.add('hidden');
                    }, 2000);
                }
            } catch (err) { console.error("Failed to copy:", err); }
        }

        // --- Canvas Transform Functions (Full Pan/Zoom) ---
        // PlaygroundController (Ported from template_0117.html)
        window.PlaygroundController = {
            instanceChart: null,
            showError: (msg) => {
                console.error('Playground Error:', msg);
                const outputEl = document.getElementById('output-data');
                if (outputEl) outputEl.value = 'Error: ' + msg;
            },
            clearError: () => {},
            init: () => {
                try {
                    // 1. Render Dynamic Settings if Config exists
                    const settingsContainer = document.getElementById('settings-container');
                    if (IndicatorConfig && Array.isArray(IndicatorConfig) && IndicatorConfig.length > 0 && settingsContainer) {
                        settingsContainer.innerHTML = ''; // Clear default "Period"
                        IndicatorConfig.forEach(cfg => {
                            const div = document.createElement('div');
                            div.className = "flex flex-col";
                            const label = document.createElement('label');
                            label.className = "text-xs text-slate-400 mb-1";
                            label.textContent = cfg.label;
                            const input = document.createElement('input');
                            input.id = `param-${cfg.id}`;
                            input.type = cfg.type || "number";
                            // Light theme styling to match textarea
                            input.className = "bg-white border border-slate-300 rounded px-2 py-1 text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow";
                            input.value = cfg.value;
                            if(cfg.min !== undefined) input.min = cfg.min;
                            if(cfg.max !== undefined) input.max = cfg.max;
                            // Add change listener to auto-update
                            input.addEventListener('change', PlaygroundController.update);
                            div.appendChild(label);
                            div.appendChild(input);
                            settingsContainer.appendChild(div);
                        });
                    }

                    // 2. Generate Initial Random Sample Data (Default to Single for simplicity, or OHLCV)
                    PlaygroundController.generateSample('ohlcv'); // Default to OHLCV for robustness
                } catch(e) { PlaygroundController.showError(e.message); }
            },
            generateSample: (type) => {
                 const sampleData = [];
                 const count = 150; 
                 let price = 100;
                 if (type === 'ohlcv') {
                    // OHLCV Generation
                    sampleData.push("Date,Open,High,Low,Close,Volume");
                    const now = new Date();
                    for (let i = 0; i < count; i++) {
                        const date = new Date(now.getTime() - (count - i) * 86400000).toISOString().split('T')[0];
                        const trend = Math.sin(i * 0.1) * 2;
                        const noise = (Math.random() - 0.5) * 2;
                        const close = 100 + trend + noise + (i * 0.1); 
                        const open = close + (Math.random() - 0.5);
                        const high = Math.max(open, close) + Math.random();
                        const low = Math.min(open, close) - Math.random();
                        const vol = Math.floor(1000 + Math.random() * 500);
                        sampleData.push(`${date},${open.toFixed(2)},${high.toFixed(2)},${low.toFixed(2)},${close.toFixed(2)},${vol}`);
                    }
                 } else { 
                    // Single Value Generation
                    for (let i = 0; i < count; i++) {
                        price = price + (Math.random() - 0.5) * 5;
                        sampleData.push(price.toFixed(2));
                    }
                 }
                 const inputEl = document.getElementById('input-data');
                 if (inputEl) inputEl.value = sampleData.join('\n');
                 PlaygroundController.update();
            },
            update: () => {
                PlaygroundController.clearError();
                // Dynamic Params Collection
                const params = {};
                if (IndicatorConfig && Array.isArray(IndicatorConfig) && IndicatorConfig.length > 0) {
                    IndicatorConfig.forEach(cfg => {
                        const el = document.getElementById(`param-${cfg.id}`);
                        if (el) params[cfg.id] = parseFloat(el.value);
                    });
                } else {
                    // Fallback to default Period if no config
                    const periodEl = document.getElementById('param-period');
                    params.period = periodEl ? parseInt(periodEl.value) || 14 : 14;
                }

                const rawData = document.getElementById('input-data').value.trim();
                let lines = [];
                // Robust split: handle comma, newline, or mixed
                if (rawData.includes('\n')) {
                    // Split by newline first
                    lines = rawData.split('\n').map(l => l.trim()).filter(l => l);
                    // If it's NOT multi-column (header check), and lines contain commas, try to flatten
                    const firstVal = parseFloat(lines[0].split(/[,\t]/)[0]);
                    const isHeader = isNaN(firstVal) && /[a-zA-Z]/.test(lines[0]);
                    if (!isHeader && lines.some(l => l.includes(','))) {
                        // Flatten mixed content like "100, 101\n102, 103"
                        lines = rawData.split(/[\n,]+/).map(l => l.trim()).filter(l => l);
                    }
                } else {
                    // Single line, split by comma
                    lines = rawData.split(',').map(l => l.trim()).filter(l => l);
                }

                let parsedData = [];
                const firstLine = lines[0] || "";
                const firstVal = parseFloat(firstLine.split(/[,\t]/)[0]);
                const isMultiColumn = isNaN(firstVal) && /[a-zA-Z]/.test(firstLine);

                if (isMultiColumn && lines.length > 1) {
                    const headers = firstLine.split(/[,\t]+/).map(h => h.trim().toLowerCase());
                    for (let i = 1; i < lines.length; i++) {
                        const parts = lines[i].split(/[,\t]+/).map(v => parseFloat(v));
                        if (parts.some(isNaN)) continue;
                        const row = { time: i - 1 };
                        headers.forEach((h, idx) => { row[h] = parts[idx]; });
                        if (row.close === undefined && row.c !== undefined) row.close = row.c;
                        parsedData.push(row);
                    }
                } else {
                    parsedData = lines.map((l, i) => {
                        const val = parseFloat(l);
                        return isNaN(val) ? null : { time: i, close: val };
                    }).filter(d => d);
                }

                if (parsedData.length < 2) {
                    PlaygroundController.showError("Insufficient data.");
                    return;
                }

                let indicatorValues = [];
                try {
                    if (typeof IndicatorLogic !== 'undefined' && IndicatorLogic.calculate) {
                        indicatorValues = IndicatorLogic.calculate(parsedData, params);
                    } else {
                        // Fallback: Simple RSI calculation for demo
                        indicatorValues = PlaygroundController.calculateRSI(parsedData, params.period);
                    }
                } catch (e) {
                    console.error("Calculation Error", e);
                    PlaygroundController.showError("Calculation Error: " + e.message);
                    return;
                }

                // --- Format Output (CSV/TSV for Excel) ---
                const outputEl = document.getElementById('output-data');
                // --- Format Output (CSV/TSV for Excel) ---
                if (outputEl) {
                    if (Array.isArray(indicatorValues)) {
                        // Single Array (e.g. RSI)
                        outputEl.value = indicatorValues.map(v => v === null ? "" : v).join('\n');
                    } else if (typeof indicatorValues === 'object') {
                        // Multi-line Object (e.g. Ichimoku)
                        const keys = Object.keys(indicatorValues);
                        if (keys.length === 0) {
                            outputEl.value = "";
                        } else {
                            const length = indicatorValues[keys[0]].length;
                            // Comma separated as requested by user
                            const separator = ','; 
                            let csv = keys.join(separator) + '\n';
                            for (let i = 0; i < length; i++) {
                                const row = keys.map(k => {
                                    const val = indicatorValues[k][i];
                                    // Handle missing/undefined
                                    return (val === null || val === undefined) ? "" : val;
                                });
                                csv += row.join(separator) + '\n';
                            }
                            outputEl.value = csv;
                        }
                    } else {
                        outputEl.value = JSON.stringify(indicatorValues, null, 2);
                    }
                }
                PlaygroundController.renderChart(parsedData, indicatorValues);
            },
            calculateRSI: (data, period) => {
                // Simple RSI fallback
                const values = [];
                values.push(null); // First value is null
                if (data.length < 2) return values;
                let sumGains = 0, sumLosses = 0;
                for (let i = 1; i < data.length; i++) {
                    const change = data[i].close - data[i-1].close;
                    const gain = change > 0 ? change : 0;
                    const loss = change < 0 ? -change : 0;
                    if (i < period) {
                        sumGains += gain; sumLosses += loss;
                        values.push(null);
                        continue;
                    }
                    if (i === period) {
                        sumGains += gain; sumLosses += loss;
                        const avgGain = sumGains / period;
                        const avgLoss = sumLosses / period;
                        const rs = avgLoss < 0.0001 ? 100 : avgGain / avgLoss;
                        values.push(100 - (100 / (1 + rs)));
                        sumGains = avgGain; sumLosses = avgLoss;
                        continue;
                    }
                    sumGains = (sumGains * (period - 1) + gain) / period;
                    sumLosses = (sumLosses * (period - 1) + loss) / period;
                    const rs = sumLosses < 0.0001 ? 100 : sumGains / sumLosses;
                    values.push(100 - (100 / (1 + rs)));
                }
                return values;
            },
            renderChart: (prices, indicatorValues) => {
                const canvas = document.getElementById('indicatorChart');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const labels = prices.map((_, i) => i);
                if (PlaygroundController.instanceChart) PlaygroundController.instanceChart.destroy();

                const datasets = [];
                // 1. Overlay: Close Price (if enabled)
                if (IndicatorDisplay && IndicatorDisplay.isOverlay) {
                    datasets.push({
                        label: 'Close Price',
                        data: prices.map(p => p.close),
                        borderColor: '#94a3b8', // slate-400
                        backgroundColor: 'transparent',
                        borderDash: [5, 5],
                        borderWidth: 1,
                        pointRadius: 0,
                        tension: 0.1
                    });
                }

                // 2. Indicator Data
                const defaultColors = ['#4F46E5', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'];
                if (Array.isArray(indicatorValues)) {
                    datasets.push({
                        label: 'Indicator',
                        data: indicatorValues,
                        borderColor: IndicatorDisplay.plots && IndicatorDisplay.plots.main ? IndicatorDisplay.plots.main.color : '#4F46E5',
                        backgroundColor: 'transparent',
                        tension: 0.1, pointRadius: 0, borderWidth: 2
                    });
                } else if (typeof indicatorValues === 'object' && indicatorValues !== null) {
                    // Multi-line indicator (e.g., Bollinger Bands, Parabolic SAR)
                    Object.keys(indicatorValues).forEach((key, idx) => {
                        const conf = (IndicatorDisplay.plots && IndicatorDisplay.plots[key]) || {};
                        const color = conf.color || defaultColors[idx % defaultColors.length];
                        const isScatter = conf.type === 'scatter';
                        // For scatter type, convert data to {x, y} format
                        let chartData;
                        if (isScatter) {
                            chartData = indicatorValues[key]
                                .map((val, i) => val !== null && val !== undefined ? { x: i, y: val } : null)
                                .filter(p => p !== null);
                        } else {
                            chartData = indicatorValues[key];
                        }
                        datasets.push({
                            label: conf.label || key,
                            data: chartData,
                            type: isScatter ? 'scatter' : (conf.type || 'line'),
                            borderColor: isScatter ? 'transparent' : color,
                            backgroundColor: isScatter ? color : 'transparent',
                            pointRadius: isScatter ? (conf.pointRadius || 5) : 0,
                            pointBorderWidth: 0,
                            tension: 0.1,
                            borderWidth: isScatter ? 0 : 2
                        });
                    });
                }

                PlaygroundController.instanceChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: labels, datasets: datasets },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        scales: {
                            y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Value' } }
                        }
                    }
                });
            }
        };

        function updateTransform() {
            if (els.content) {
                els.content.style.transform = `translate(${CanvasState.panX}px, ${CanvasState.panY}px) scale(${CanvasState.scale})`;
            }
        }

        function handleWheel(e) {
            e.preventDefault();
            const rect = els.container.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            const zoomSensitivity = 0.001;
            const delta = -e.deltaY * zoomSensitivity;
            let newScale = CanvasState.scale * (1 + delta);
            newScale = Math.max(CanvasState.minScale, Math.min(CanvasState.maxScale, newScale));
            const scaleRatio = newScale / CanvasState.scale;
            CanvasState.panX = mouseX - (mouseX - CanvasState.panX) * scaleRatio;
            CanvasState.panY = mouseY - (mouseY - CanvasState.panY) * scaleRatio;
            CanvasState.scale = newScale;
            updateTransform();
        }

        function startDrag(e) {
            if (e.button !== 0 && e.button !== 1) return;
            CanvasState.isDragging = true;
            CanvasState.startX = e.clientX;
            CanvasState.startY = e.clientY;
            els.container.style.cursor = 'grabbing';
        }

        function drag(e) {
            if (!CanvasState.isDragging) return;
            e.preventDefault();
            const dx = e.clientX - CanvasState.startX;
            const dy = e.clientY - CanvasState.startY;
            CanvasState.panX += dx;
            CanvasState.panY += dy;
            CanvasState.startX = e.clientX;
            CanvasState.startY = e.clientY;
            updateTransform();
        }

        function stopDrag() {
            CanvasState.isDragging = false;
            if (els.container) els.container.style.cursor = 'grab';
        }

        window.zoomAction = (direction) => {
            if (!els.container || !els.content) return;
            const factor = direction === 'in' ? 1.2 : 0.8;
            let newScale = CanvasState.scale * factor;
            newScale = Math.max(CanvasState.minScale, Math.min(CanvasState.maxScale, newScale));
            const rect = els.container.getBoundingClientRect();
            const cx = rect.width / 2;
            const cy = rect.height / 2;
            const scaleRatio = newScale / CanvasState.scale;
            CanvasState.panX = cx - (cx - CanvasState.panX) * scaleRatio;
            CanvasState.panY = cy - (cy - CanvasState.panY) * scaleRatio;
            CanvasState.scale = newScale;
            updateTransform();
        }

        window.resetView = () => { centerContent(); }

        function centerContent() {
            if (!els.content || !els.container) return;
            const containerRect = els.container.getBoundingClientRect();
            const unscaledWidth = els.content.scrollWidth;
            const unscaledHeight = els.content.scrollHeight;
            let initialScale = 1.0;
            if (unscaledWidth > containerRect.width) {
                initialScale = (containerRect.width / unscaledWidth) * 0.9;
            }
            initialScale = Math.max(0.5, Math.min(1.0, initialScale));
            CanvasState.scale = initialScale;
            CanvasState.panX = (containerRect.width - unscaledWidth * initialScale) / 2;
            CanvasState.panY = (containerRect.height - unscaledHeight * initialScale) / 2;
            CanvasState.panY = Math.max(20, CanvasState.panY);
            updateTransform();
        }

        // --- 3. Init ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Bind element references
            els.container = document.getElementById('canvas-container');
            els.content = document.getElementById('canvas-content');

            // Init code panel state
            updateView();

            // Init Playground
            if (window.PlaygroundController) PlaygroundController.init();

            // Mermaid rendering + center
            if (window.mermaid) {
                try {
                    const nodes = document.querySelectorAll('.mermaid');
                    if (nodes.length > 0) {
                        await mermaid.run({ nodes: nodes });
                        setTimeout(centerContent, 100);
                    }
                } catch (e) { console.error("Mermaid render failed", e); }
            }

            // Canvas Events (Wheel zoom + Drag pan)
            if (els.container) {
                els.container.addEventListener('wheel', handleWheel, { passive: false });
                els.container.addEventListener('mousedown', startDrag);
                window.addEventListener('mousemove', drag);
                window.addEventListener('mouseup', stopDrag);
            }

            // KaTeX Auto Render
            if (window.renderMathInElement) {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ],
                    throwOnError: false
                });
            }

            // TOC ScrollSpy
            const tocLinks = document.querySelectorAll('.toc-link');
            if (tocLinks.length > 0) {
                const headings = document.querySelectorAll('article h2[id], article h3[id]');
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            tocLinks.forEach(link => link.classList.remove('active'));
                            const id = entry.target.getAttribute('id');
                            const activeLink = document.querySelector(`.toc-link[href="#${id}"]`);
                            if (activeLink) activeLink.classList.add('active');
                        }
                    });
                }, { rootMargin: '-20% 0px -60% 0px' });
                headings.forEach(h => observer.observe(h));
            }

            // Load Sample buttons
            const btnOhlcv = document.getElementById('btn-load-sample-ohlcv');
            if (btnOhlcv) {
                btnOhlcv.addEventListener('click', () => {
                    if (window.PlaygroundController) PlaygroundController.generateSample('ohlcv');
                });
            }
            const btnSingle = document.getElementById('btn-load-sample-single');
            if (btnSingle) {
                btnSingle.addEventListener('click', () => {
                    if (window.PlaygroundController) PlaygroundController.generateSample('single');
                });
            }
            // Initialize Playground Controller
            if (window.PlaygroundController && PlaygroundController.init) {
                PlaygroundController.init();
            }
        });
    </script>
</body>
</html>