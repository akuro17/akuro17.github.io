window.registerIndicatorCode('RollingSpreadZScore', {"csharp_simple":"<div class=\"highlight\"><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">1</span><span class=\"k\">using</span> System;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">2</span><span class=\"k\">using</span> System.Collections.Generic;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">3</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">4</span><span class=\"k\">namespace</span> TechnicalIndicators</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">5</span>{</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">6</span>    <span class=\"c1\">/// &lt;summary&gt;</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">7</span>    <span class=\"c1\">/// Rolling Spread Z-Score</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">8</span>    <span class=\"c1\">/// &lt;/summary&gt;</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">9</span>    <span class=\"c1\">/// &lt;remarks&gt;</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">10</span>    <span class=\"c1\">/// Standardizes the spread between two assets (or any series) to mean 0 and std dev 1.</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">11</span>    <span class=\"c1\">/// &lt;list type=&quot;bullet&quot;&gt;</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">12</span>    <span class=\"c1\">/// &lt;item&gt;&lt;description&gt;Crucial for mean-reversion strategies.&lt;/description&gt;&lt;/item&gt;</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">13</span>    <span class=\"c1\">/// &lt;item&gt;&lt;description&gt;Z-Score = (CurrentSpread - MeanSpread) / StdDevSpread&lt;/description&gt;&lt;/item&gt;</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">14</span>    <span class=\"c1\">/// &lt;item&gt;&lt;description&gt;Signals: &gt; +2.0 (Sell Spread), &lt; -2.0 (Buy Spread).&lt;/description&gt;&lt;/item&gt;</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">15</span>    <span class=\"c1\">/// &lt;/list&gt;</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">16</span>    <span class=\"c1\">/// &lt;/remarks&gt;</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">17</span>    <span class=\"k\">public</span> <span class=\"k\">class</span> <span class=\"nc\">RollingSpreadZScore</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">18</span>    {</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">19</span>        <span class=\"k\">public</span> <span class=\"kt\">int</span> Period { <span class=\"k\">get</span>; }</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">20</span>        <span class=\"k\">public</span> List&lt;<span class=\"kt\">decimal?</span>&gt; Values { <span class=\"k\">get</span>; } = <span class=\"k\">new</span>();</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">21</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">22</span>        <span class=\"k\">public</span> RollingSpreadZScore(<span class=\"kt\">int</span> period = 20)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">23</span>        {</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">24</span>            <span class=\"k\">if</span> (period &lt;= 1) <span class=\"k\">throw</span> <span class=\"k\">new</span> ArgumentOutOfRangeException(<span class=\"k\">nameof</span>(period));</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">25</span>            Period = period;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">26</span>        }</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">27</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">28</span>        <span class=\"k\">public</span> <span class=\"k\">void</span> Calculate(IEnumerable&lt;<span class=\"kt\">decimal</span>&gt; spreadValues)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">29</span>        {</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">30</span>            Values.Clear();</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">31</span>            <span class=\"kt\">var</span> spreads = <span class=\"k\">new</span> List&lt;<span class=\"kt\">decimal</span>&gt;(spreadValues);</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">32</span>            <span class=\"k\">if</span> (spreads.Count == 0) <span class=\"k\">return</span>;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">33</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">34</span>            <span class=\"k\">for</span> (<span class=\"kt\">int</span> i = 0; i &lt; spreads.Count; i++)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">35</span>            {</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">36</span>                <span class=\"k\">if</span> (i &lt; Period - 1) { Values.Add(<span class=\"k\">null</span>); <span class=\"k\">continue</span>; }</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">37</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">38</span>                <span class=\"kt\">decimal</span> sum = 0;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">39</span>                <span class=\"k\">for</span> (<span class=\"kt\">int</span> j = 0; j &lt; Period; j++) sum += spreads[i - j];</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">40</span>                <span class=\"kt\">decimal</span> mean = sum / Period;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">41</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">42</span>                <span class=\"kt\">decimal</span> sumSq = 0;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">43</span>                <span class=\"k\">for</span> (<span class=\"kt\">int</span> j = 0; j &lt; Period; j++)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">44</span>                {</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">45</span>                    <span class=\"kt\">decimal</span> diff = spreads[i - j] - mean;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">46</span>                    sumSq += diff * diff;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">47</span>                }</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">48</span>                <span class=\"kt\">decimal</span> stdDev = (<span class=\"kt\">decimal</span>)Math.Sqrt((<span class=\"kt\">double</span>)(sumSq / Period));</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">49</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">50</span>                Values.Add(stdDev == 0 ? 0 : (spreads[i] - mean) / stdDev);</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">51</span>            }</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">52</span>        }</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">53</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">54</span>        <span class=\"k\">public</span> <span class=\"k\">void</span> CalculateFromPair(IEnumerable&lt;CandleData&gt; asset1, IEnumerable&lt;CandleData&gt; asset2, <span class=\"kt\">decimal</span> hedgeRatio = 1.0m)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">55</span>        {</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">56</span>            <span class=\"kt\">var</span> list1 = <span class=\"k\">new</span> List&lt;CandleData&gt;(asset1);</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">57</span>            <span class=\"kt\">var</span> list2 = <span class=\"k\">new</span> List&lt;CandleData&gt;(asset2);</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">58</span>            <span class=\"kt\">int</span> n = Math.Min(list1.Count, list2.Count);</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">59</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">60</span>            <span class=\"kt\">var</span> spreads = <span class=\"k\">new</span> List&lt;<span class=\"kt\">decimal</span>&gt;();</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">61</span>            <span class=\"k\">for</span> (<span class=\"kt\">int</span> i = 0; i &lt; n; i++)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">62</span>                spreads.Add(list1[i].Close - hedgeRatio * list2[i].Close);</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">63</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">64</span>            Calculate(spreads);</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">65</span>        }</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">66</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">67</span>        <span class=\"k\">public</span> <span class=\"k\">static</span> List&lt;<span class=\"kt\">decimal?</span>&gt; Calculate(IEnumerable&lt;<span class=\"kt\">decimal</span>&gt; spreads, <span class=\"kt\">int</span> period = 20)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">68</span>        {</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">69</span>            <span class=\"kt\">var</span> zs = <span class=\"k\">new</span> RollingSpreadZScore(period);</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">70</span>            zs.Calculate(spreads);</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">71</span>            <span class=\"k\">return</span> zs.Values;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">72</span>        }</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">73</span>    }</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">74</span>}</div></div>","csharp_detailed":"<div class=\"highlight\"><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">1</span><span class=\"c1\">// =============================================================================</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">2</span><span class=\"c1\">// Logic Breakdown (RollingSpreadZScore)</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">3</span><span class=\"c1\">// =============================================================================</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">4</span><span class=\"c1\">//</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">5</span><span class=\"c1\">// Calculates Z-score of a spread over a rolling window.</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">6</span><span class=\"c1\">// Formula: Z = (Spread - Mean) / StdDev</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">7</span><span class=\"c1\">// For pairs trading: |Z| &gt; 2 = potential entry, Z â†’ 0 = exit.</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">8</span><span class=\"c1\">//</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">9</span><span class=\"c1\">// [Core Concepts]</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">10</span><span class=\"c1\">// 1. Spread: Price difference between two assets (with hedge ratio)</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">11</span><span class=\"c1\">// 2. Z-Score: Standard deviations from mean (normalized)</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">12</span><span class=\"c1\">// 3. Mean Reversion: High Z-score suggests reversal potential</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">13</span><span class=\"c1\">//</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">14</span><span class=\"c1\">// =============================================================================</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">15</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">16</span><span class=\"k\">using</span> System;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">17</span><span class=\"k\">using</span> System.Collections.Generic;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">18</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">19</span><span class=\"k\">namespace</span> TechnicalIndicators</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">20</span>{</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">21</span>    <span class=\"k\">public</span> <span class=\"k\">readonly</span> <span class=\"k\">record</span> <span class=\"k\">struct</span> CandleData(</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">22</span>        DateTime Timestamp, <span class=\"kt\">decimal</span> Open, <span class=\"kt\">decimal</span> High,</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">23</span>        <span class=\"kt\">decimal</span> Low, <span class=\"kt\">decimal</span> Close, <span class=\"kt\">long</span> Volume</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">24</span>    );</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">25</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">26</span>    <span class=\"c1\">// =========================================================================</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">27</span>    <span class=\"c1\">// Rolling Spread Z-Score: Normalized spread for pairs trading signals</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">28</span>    <span class=\"c1\">// [Why] Identify overbought/oversold conditions in pairs relationship</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">29</span>    <span class=\"c1\">// =========================================================================</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">30</span>    <span class=\"k\">public</span> <span class=\"k\">class</span> <span class=\"nc\">RollingSpreadZScore</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">31</span>    {</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">32</span>        <span class=\"k\">public</span> <span class=\"kt\">int</span> Period { <span class=\"k\">get</span>; }</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">33</span>        <span class=\"k\">public</span> List&lt;<span class=\"kt\">decimal?</span>&gt; Values { <span class=\"k\">get</span>; } = <span class=\"k\">new</span>();</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">34</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">35</span>        <span class=\"k\">public</span> RollingSpreadZScore(<span class=\"kt\">int</span> period = 20)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">36</span>        {</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">37</span>            <span class=\"k\">if</span> (period &lt;= 1) <span class=\"k\">throw</span> <span class=\"k\">new</span> ArgumentOutOfRangeException(<span class=\"k\">nameof</span>(period));</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">38</span>            Period = period;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">39</span>        }</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">40</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">41</span>        <span class=\"c1\">// =================================================================</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">42</span>        <span class=\"c1\">// IPO: Calculate (from spread values directly)</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">43</span>        <span class=\"c1\">// [Input] spreadValues: Pre-computed spread series</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">44</span>        <span class=\"c1\">// [Process] Z = (Current - RollingMean) / RollingStdDev</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">45</span>        <span class=\"c1\">// [Output] Z-score for each position</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">46</span>        <span class=\"c1\">// =================================================================</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">47</span>        <span class=\"k\">public</span> <span class=\"k\">void</span> Calculate(IEnumerable&lt;<span class=\"kt\">decimal</span>&gt; spreadValues)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">48</span>        {</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">49</span>            Values.Clear();</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">50</span>            <span class=\"kt\">var</span> spreads = <span class=\"k\">new</span> List&lt;<span class=\"kt\">decimal</span>&gt;(spreadValues);</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">51</span>            <span class=\"k\">if</span> (spreads.Count == 0) <span class=\"k\">return</span>;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">52</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">53</span>            <span class=\"k\">for</span> (<span class=\"kt\">int</span> i = 0; i &lt; spreads.Count; i++)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">54</span>            {</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">55</span>                <span class=\"c1\">// Warm-up period</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">56</span>                <span class=\"k\">if</span> (i &lt; Period - 1) { Values.Add(<span class=\"k\">null</span>); <span class=\"k\">continue</span>; }</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">57</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">58</span>                <span class=\"c1\">// [Step 1] Calculate rolling mean</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">59</span>                <span class=\"kt\">decimal</span> sum = 0;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">60</span>                <span class=\"k\">for</span> (<span class=\"kt\">int</span> j = 0; j &lt; Period; j++) sum += spreads[i - j];</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">61</span>                <span class=\"kt\">decimal</span> mean = sum / Period;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">62</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">63</span>                <span class=\"c1\">// [Step 2] Calculate rolling std deviation</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">64</span>                <span class=\"kt\">decimal</span> sumSq = 0;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">65</span>                <span class=\"k\">for</span> (<span class=\"kt\">int</span> j = 0; j &lt; Period; j++)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">66</span>                {</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">67</span>                    <span class=\"kt\">decimal</span> diff = spreads[i - j] - mean;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">68</span>                    sumSq += diff * diff;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">69</span>                }</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">70</span>                <span class=\"kt\">decimal</span> stdDev = (<span class=\"kt\">decimal</span>)Math.Sqrt((<span class=\"kt\">double</span>)(sumSq / Period));</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">71</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">72</span>                <span class=\"c1\">// [Step 3] Calculate Z-score</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">73</span>                Values.Add(stdDev == 0 ? 0 : (spreads[i] - mean) / stdDev);</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">74</span>            }</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">75</span>        }</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">76</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">77</span>        <span class=\"c1\">// =================================================================</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">78</span>        <span class=\"c1\">// IPO: CalculateFromPair</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">79</span>        <span class=\"c1\">// [Input] asset1, asset2: OHLCV data, hedgeRatio</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">80</span>        <span class=\"c1\">// [Process] Create spread = asset1 - hedgeRatio * asset2, then Z</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">81</span>        <span class=\"c1\">// [Output] Z-scores via Calculate method</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">82</span>        <span class=\"c1\">// =================================================================</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">83</span>        <span class=\"k\">public</span> <span class=\"k\">void</span> CalculateFromPair(IEnumerable&lt;CandleData&gt; asset1, IEnumerable&lt;CandleData&gt; asset2, <span class=\"kt\">decimal</span> hedgeRatio = 1.0m)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">84</span>        {</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">85</span>            <span class=\"kt\">var</span> list1 = <span class=\"k\">new</span> List&lt;CandleData&gt;(asset1);</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">86</span>            <span class=\"kt\">var</span> list2 = <span class=\"k\">new</span> List&lt;CandleData&gt;(asset2);</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">87</span>            <span class=\"kt\">int</span> n = Math.Min(list1.Count, list2.Count);</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">88</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">89</span>            <span class=\"kt\">var</span> spreads = <span class=\"k\">new</span> List&lt;<span class=\"kt\">decimal</span>&gt;();</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">90</span>            <span class=\"k\">for</span> (<span class=\"kt\">int</span> i = 0; i &lt; n; i++)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">91</span>                spreads.Add(list1[i].Close - hedgeRatio * list2[i].Close);</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">92</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">93</span>            Calculate(spreads);</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">94</span>        }</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">95</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">96</span>        <span class=\"k\">public</span> <span class=\"k\">static</span> List&lt;<span class=\"kt\">decimal?</span>&gt; Calculate(IEnumerable&lt;<span class=\"kt\">decimal</span>&gt; spreads, <span class=\"kt\">int</span> period = 20)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">97</span>        {</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">98</span>            <span class=\"kt\">var</span> zs = <span class=\"k\">new</span> RollingSpreadZScore(period);</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">99</span>            zs.Calculate(spreads);</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">100</span>            <span class=\"k\">return</span> zs.Values;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">101</span>        }</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">102</span>    }</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">103</span>}</div></div>","python_simple":"<div class=\"highlight\"><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">1</span><span class=\"kn\">import</span> math</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">2</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">3</span><span class=\"k\">class</span> <span class=\"nc\">RollingSpreadZScore</span>:</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">4</span>    <span class=\"sd\">&quot;&quot;&quot;</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">5</span><span class=\"sd\">    Rolling Spread Z-Score</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">6</span><span class=\"sd\">    &quot;&quot;&quot;</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">7</span>    <span class=\"k\">def</span> __init__(self, period=20):</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">8</span>        <span class=\"k\">if</span> period &lt;= 1:</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">9</span>            <span class=\"k\">raise</span> ValueError(<span class=\"s2\">&quot;</span><span class=\"s2\">Period must be greater than 1</span><span class=\"s2\">&quot;</span>)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">10</span>        self.period = period</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">11</span>        self.values = []</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">12</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">13</span>    <span class=\"k\">def</span> calculate(self, spread_values):</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">14</span>        self.values.clear()</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">15</span>        spreads = list(spread_values) <span class=\"c1\"># Ensure list</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">16</span>        <span class=\"k\">if</span> <span class=\"ow\">not</span> spreads: <span class=\"k\">return</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">17</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">18</span>        <span class=\"k\">for</span> i <span class=\"ow\">in</span> range(len(spreads)):</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">19</span>            <span class=\"k\">if</span> i &lt; self.period - 1:</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">20</span>                self.values.append(<span class=\"kc\">None</span>)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">21</span>                <span class=\"k\">continue</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">22</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">23</span>            <span class=\"c1\"># Mean</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">24</span>            subset = spreads[i - self.period + 1 : i + 1]</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">25</span>            mean = sum(subset) / self.period</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">26</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">27</span>            <span class=\"c1\"># Std Dev</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">28</span>            sum_sq = sum([(x - mean)**2 <span class=\"k\">for</span> x <span class=\"ow\">in</span> subset])</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">29</span>            std_dev = math.sqrt(sum_sq / self.period)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">30</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">31</span>            <span class=\"k\">if</span> std_dev == 0:</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">32</span>                self.values.append(0.0)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">33</span>            <span class=\"k\">else</span>:</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">34</span>                self.values.append((spreads[i] - mean) / std_dev)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">35</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">36</span>    <span class=\"k\">def</span> calculate_from_pair(self, asset1_candles, asset2_candles, hedge_ratio=1.0):</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">37</span>        <span class=\"sd\">&quot;&quot;&quot;</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">38</span><span class=\"sd\">        Calculate Z-Score from two assets: Spread = Asset1 - HedgeRatio * Asset2</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">39</span><span class=\"sd\">        &quot;&quot;&quot;</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">40</span>        n = min(len(asset1_candles), len(asset2_candles))</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">41</span>        spreads = []</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">42</span>        <span class=\"k\">for</span> i <span class=\"ow\">in</span> range(n):</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">43</span>            c1 = float(asset1_candles[i][<span class=\"s1\">&#x27;</span><span class=\"s1\">close</span><span class=\"s1\">&#x27;</span>])</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">44</span>            c2 = float(asset2_candles[i][<span class=\"s1\">&#x27;</span><span class=\"s1\">close</span><span class=\"s1\">&#x27;</span>])</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">45</span>            spreads.append(c1 - hedge_ratio * c2)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">46</span>        </div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">47</span>        self.calculate(spreads)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">48</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">49</span><span class=\"k\">def</span> calculate(spread_values, period=20):</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">50</span>    obj = RollingSpreadZScore(period)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">51</span>    obj.calculate(spread_values)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">52</span>    <span class=\"k\">return</span> obj.values</div></div>","python_detailed":"<div class=\"highlight\"><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">1</span><span class=\"c1\"># =============================================================================</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">2</span><span class=\"c1\"># Logic Breakdown (Rolling Spread Z-Score)</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">3</span><span class=\"c1\"># =============================================================================</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">4</span><span class=\"c1\">#</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">5</span><span class=\"c1\"># This document provides a &quot;Deep Dive&quot; into the internal logic of the</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">6</span><span class=\"c1\"># Rolling Spread Z-Score.</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">7</span><span class=\"c1\">#</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">8</span><span class=\"c1\"># [Core Concepts]</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">9</span><span class=\"c1\"># 1. The &quot;Spread&quot;</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">10</span><span class=\"c1\">#    - In Pairs Trading, we create a synthetic asset:</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">11</span><span class=\"c1\">#      Spread = LongAsset - (HedgeRatio * ShortAsset).</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">12</span><span class=\"c1\">#    - We expect this Spread to be &quot;Mean Reverting&quot; (oscillate around 0).</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">13</span><span class=\"c1\">#</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">14</span><span class=\"c1\"># 2. Z-Score (Standardization)</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">15</span><span class=\"c1\">#    - Raw spread values ($0.50, $1.20) are hard to trade. Is $1.20 high?</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">16</span><span class=\"c1\">#    - Z-Score tells us how many Standard Deviations we are from the Mean.</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">17</span><span class=\"c1\">#    - Z = +2.0 -&gt; We are Very High (Sell).</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">18</span><span class=\"c1\">#    - Z = -2.0 -&gt; We are Very Low (Buy).</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">19</span><span class=\"c1\">#    - Z = 0.0  -&gt; We are at Equilibrium (Exit).</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">20</span><span class=\"c1\">#</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">21</span><span class=\"c1\"># 3. Formula</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">22</span><span class=\"c1\">#    - Z = (CurrentValue - RollingMean) / RollingStdDev.</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">23</span><span class=\"c1\">#</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">24</span><span class=\"c1\"># =============================================================================</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">25</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">26</span><span class=\"kn\">import</span> math</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">27</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">28</span><span class=\"c1\"># -------------------------------------------------------------</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">29</span><span class=\"c1\"># Type-Level Explanation: RollingSpreadZScore (class)</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">30</span><span class=\"c1\">#</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">31</span><span class=\"c1\"># [Why]  The primary signal generator for Mean Reversion strategies.</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">32</span><span class=\"c1\"># [What] Statistical Normalizer.</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">33</span><span class=\"c1\"># [How]  Calculates the Z-Score by subtracting the rolling mean from the current spread and dividing by the rolling standard deviation.</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">34</span><span class=\"c1\"># -------------------------------------------------------------</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">35</span><span class=\"k\">class</span> <span class=\"nc\">RollingSpreadZScore</span>:</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">36</span>    </div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">37</span>    <span class=\"c1\"># -------------------------------------------------------------</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">38</span>    <span class=\"c1\"># Constructor: __init__</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">39</span>    <span class=\"c1\"># [Why] Period determines the &quot;Memory&quot; of the mean.</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">40</span>    <span class=\"c1\"># -------------------------------------------------------------</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">41</span>    <span class=\"k\">def</span> __init__(self, period=20):</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">42</span>        <span class=\"k\">if</span> period &lt;= 1:</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">43</span>            <span class=\"k\">raise</span> ValueError(<span class=\"s2\">&quot;</span><span class=\"s2\">period must be &gt; 1 to calculate StdDev</span><span class=\"s2\">&quot;</span>)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">44</span>        self.period = period</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">45</span>        self.values = []</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">46</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">47</span>    <span class=\"c1\"># =============================================================================</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">48</span>    <span class=\"c1\"># IPO: calculate</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">49</span>    <span class=\"c1\"># =============================================================================</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">50</span>    <span class=\"c1\">#</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">51</span>    <span class=\"c1\"># [Input]</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">52</span>    <span class=\"c1\"># - spread_values: List[float] (Pre-calculated spread series)</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">53</span>    <span class=\"c1\">#</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">54</span>    <span class=\"c1\"># [Process]</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">55</span>    <span class=\"c1\"># 1. Slide window of size N.</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">56</span>    <span class=\"c1\"># 2. Calculate Mean of window.</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">57</span>    <span class=\"c1\"># 3. Calculate StdDev of window.</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">58</span>    <span class=\"c1\"># 4. Compute Z = (Current - Mean) / StdDev.</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">59</span>    <span class=\"c1\">#</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">60</span>    <span class=\"c1\"># [Output]</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">61</span>    <span class=\"c1\"># - None.</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">62</span>    <span class=\"c1\"># =============================================================================</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">63</span>    <span class=\"k\">def</span> calculate(self, spread_values):</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">64</span>        </div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">65</span>        <span class=\"c1\"># -------------------------------------------------------------</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">66</span>        <span class=\"c1\"># Logic Step 1: Reset</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">67</span>        <span class=\"c1\"># [Why]  Prepare clean state for new calculation.</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">68</span>        <span class=\"c1\"># -------------------------------------------------------------</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">69</span>        self.values.clear()</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">70</span>        </div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">71</span>        <span class=\"c1\"># Convert to list to ensure index access (if generator passed)</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">72</span>        spreads = list(spread_values)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">73</span>        </div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">74</span>        <span class=\"k\">if</span> len(spreads) == 0:</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">75</span>            <span class=\"k\">return</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">76</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">77</span>        <span class=\"c1\"># -------------------------------------------------------------</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">78</span>        <span class=\"c1\"># Logic Step 2: Main Loop</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">79</span>        <span class=\"c1\"># -------------------------------------------------------------</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">80</span>        <span class=\"k\">for</span> i <span class=\"ow\">in</span> range(len(spreads)):</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">81</span>            </div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">82</span>            <span class=\"c1\"># Logic Step 2.1: Wait for Window</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">83</span>            <span class=\"k\">if</span> i &lt; self.period - 1:</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">84</span>                self.values.append(<span class=\"kc\">None</span>)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">85</span>                <span class=\"k\">continue</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">86</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">87</span>            <span class=\"c1\"># -------------------------------------------------------------</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">88</span>            <span class=\"c1\"># Logic Step 2.2: Compute Mean (Simple Average)</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">89</span>            <span class=\"c1\"># [Why]  Determine the center point of the current window.</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">90</span>            <span class=\"c1\"># [How]  Sum of values / N.</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">91</span>            <span class=\"c1\"># -------------------------------------------------------------</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">92</span>            window_sum = 0.0</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">93</span>            </div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">94</span>            <span class=\"c1\"># [Visual]</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">95</span>            <span class=\"c1\"># Window: [10, 12, 11]. Sum=33. Mean=11.</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">96</span>            <span class=\"c1\"># Current (i) is the last element of the window.</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">97</span>            <span class=\"k\">for</span> j <span class=\"ow\">in</span> range(self.period):</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">98</span>                window_sum += spreads[i - j]</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">99</span>                </div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">100</span>            mean = window_sum / self.period</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">101</span>            </div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">102</span>            <span class=\"c1\"># -------------------------------------------------------------</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">103</span>            <span class=\"c1\"># Logic Step 2.3: Compute Standard Deviation</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">104</span>            <span class=\"c1\"># [Why]  Measure volatility to normalize the distance.</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">105</span>            <span class=\"c1\"># [How]  Sqrt( Sum((x - mean)^2) / N )</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">106</span>            <span class=\"c1\"># -------------------------------------------------------------</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">107</span>            sum_sq_diff = 0.0</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">108</span>            <span class=\"k\">for</span> j <span class=\"ow\">in</span> range(self.period):</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">109</span>                val = spreads[i - j]</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">110</span>                diff = val - mean</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">111</span>                sum_sq_diff += diff * diff</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">112</span>                </div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">113</span>            <span class=\"c1\"># Using Population StdDev for window (div by N), or Sample (N-1)?</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">114</span>            <span class=\"c1\"># Standard Bollinger logic uses N. We stick to N for consistency.</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">115</span>            std_dev = math.sqrt(sum_sq_diff / self.period)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">116</span>            </div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">117</span>            <span class=\"c1\"># -------------------------------------------------------------</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">118</span>            <span class=\"c1\"># Logic Step 2.4: Compute Z-Score</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">119</span>            <span class=\"c1\"># [Why]  Express value in terms of Standard Deviations from Mean.</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">120</span>            <span class=\"c1\"># [How]  (Value - Mean) / StdDev.</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">121</span>            <span class=\"c1\"># -------------------------------------------------------------</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">122</span>            <span class=\"k\">if</span> std_dev == 0:</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">123</span>                <span class=\"c1\"># Flat line -&gt; No deviation -&gt; Z-Score 0 (At mean)</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">124</span>                self.values.append(0.0)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">125</span>            <span class=\"k\">else</span>:</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">126</span>                <span class=\"c1\"># Current Value is spreads[i]</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">127</span>                z_score = (spreads[i] - mean) / std_dev</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">128</span>                self.values.append(z_score)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">129</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">130</span>    <span class=\"c1\"># =============================================================================</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">131</span>    <span class=\"c1\"># Helper: calculate_from_pair (Convenience Method)</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">132</span>    <span class=\"c1\"># =============================================================================</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">133</span>    <span class=\"c1\"># [Why] Allows user to pass raw asset prices instead of pre-calc spreads.</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">134</span>    <span class=\"c1\"># [Input] Asset1, Asset2, HedgeRatio.</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">135</span>    <span class=\"c1\"># [Process]</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">136</span>    <span class=\"c1\"># 1. Generate Spread = A - Beta*B.</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">137</span>    <span class=\"c1\"># 2. Call main calculate().</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">138</span>    <span class=\"c1\"># =============================================================================</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">139</span>    <span class=\"k\">def</span> calculate_from_pair(self, asset1, asset2, hedge_ratio=1.0):</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">140</span>        n = min(len(asset1), len(asset2))</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">141</span>        </div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">142</span>        <span class=\"c1\"># [Visual]</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">143</span>        <span class=\"c1\"># A=100, B=50. HR=2.0. Spread = 100 - 2*50 = 0.</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">144</span>        spreads = []</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">145</span>        <span class=\"k\">for</span> i <span class=\"ow\">in</span> range(n):</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">146</span>            val1 = asset1[i][<span class=\"s1\">&#x27;</span><span class=\"s1\">close</span><span class=\"s1\">&#x27;</span>]</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">147</span>            val2 = asset2[i][<span class=\"s1\">&#x27;</span><span class=\"s1\">close</span><span class=\"s1\">&#x27;</span>]</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">148</span>            spreads.append(val1 - hedge_ratio * val2)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">149</span>            </div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">150</span>        self.calculate(spreads)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">151</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">152</span>&#8203;</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">153</span><span class=\"c1\"># =============================================================================</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">154</span><span class=\"c1\"># Static Wrapper Function</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">155</span><span class=\"c1\"># =============================================================================</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">156</span><span class=\"c1\">#</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">157</span><span class=\"c1\"># [Why] Functional API.</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">158</span><span class=\"c1\"># [Usage] z_scores = calculate(spread_series, period=20)</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">159</span><span class=\"c1\"># =============================================================================</span></div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">160</span><span class=\"k\">def</span> calculate(spreads, period=20):</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">161</span>    instance = RollingSpreadZScore(period)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">162</span>    instance.calculate(spreads)</div><div class=\"code-line\" style=\"white-space: pre;\"><span style=\"display:inline-block; width:2em; text-align:right; margin-right:1em; color:#9ca3af; user-select:none;\">163</span>    <span class=\"k\">return</span> instance.values</div></div>"});